
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>4.1. Seasonal Prediction of Upper Ocean Heat Content Extremes &#8212; eqcbook</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css?v=9c3e77be" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js?v=1ae7504c"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'Seasonal_Forecasts/seasonal_seasonal-monthly-ocean_extremes-detection_q07';</script>
    <link rel="icon" href="../_static/C3S_favicon.png"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="5. Climate projections" href="../Climate_Projections/climate.html" />
    <link rel="prev" title="4. Seasonal forecasts" href="seasonal.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>
<aside class="bd-header-announcement" aria-label="Announcement">
  <div class="bd-header-announcement__content">‚ö†Ô∏èThis is under development!‚ö†Ô∏è</div>
</aside>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/C3S‚ÄìPOS‚ÄìLINE.png" class="logo__image only-light" alt="eqcbook - Home"/>
    <script>document.write(`<img src="../_static/C3S‚ÄìPOS‚ÄìLINE.png" class="logo__image only-dark" alt="eqcbook - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../intro.html">
                    C3S EQC quality assessments
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">‚û°Ô∏è Satellite Observations</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../Satellite_ECVs/satellite.html">1. Quality assessments for Satellite Observations</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../Satellite_ECVs/Atmosphere_Physics/Atmosphere_Physics.html">1.1. Atmosphere Physics</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="simple">
</ul>
</details></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../Satellite_ECVs/Atmospheric_Composition/Atmospheric_Composition.html">1.2. Atmospheric Composition</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="simple">
</ul>
</details></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../Satellite_ECVs/Cryosphere/Cryosphere.html">1.3. Cryosphere</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="simple">
</ul>
</details></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../Satellite_ECVs/Land_Biosphere/Land_Biosphere.html">1.4. Land Biosphere</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="simple">
</ul>
</details></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../Satellite_ECVs/Land_Hydrology/Land_Hydrology.html">1.5. Land Hydrology</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="simple">
</ul>
</details></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../Satellite_ECVs/Ocean/Ocean.html">1.6. Ocean</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="simple">
</ul>
</details></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">‚û°Ô∏è Insitu Observations</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../In_Situ/insitu.html">2. Quality assessments for Insitu Observations</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="simple">
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">‚û°Ô∏è Reanalysis</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../Reanalyses/reanalysis.html">3. Quality assessments for Reanalysis</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="simple">
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">‚û°Ô∏è Seasonal Forecasts</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 current active has-children"><a class="reference internal" href="seasonal.html">4. Quality assessments for Seasonal Forecasts</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="current">
<li class="toctree-l2 current active"><a class="current reference internal" href="#">4.1. Seasonal Prediction of Upper Ocean Heat Content Extremes</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">‚û°Ô∏è Climate Projections</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../Climate_Projections/climate.html">5. Quality assessments for Climate Projections</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../Climate_Projections/CMIP6/CMIP6.html">5.1. CMIP6</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="simple">
</ul>
</details></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../Climate_Projections/CORDEX/CORDEX.html">5.2. CORDEX</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="simple">
</ul>
</details></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">‚û°Ô∏è Climate Indicators</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../Indicators/indicator.html">6. Quality assessments for Climate Indicators</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="simple">
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">‚û°Ô∏è Derived Datasets</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../Derived_Datasets/derived.html">7. Quality assessments for Derived Datasets</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="simple">
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">‚û°Ô∏è Applications</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../Applications/application.html">8. Quality assessments for C3S Applications</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="simple">
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Quality assessment template</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../templates/template_instructions.html">Template instructions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../templates/template.html">Template</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/ecmwf-projects/c3s2-eqc-quality-assessment" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/ecmwf-projects/c3s2-eqc-quality-assessment/issues/new?title=Issue%20on%20page%20%2FSeasonal_Forecasts/seasonal_seasonal-monthly-ocean_extremes-detection_q07.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/Seasonal_Forecasts/seasonal_seasonal-monthly-ocean_extremes-detection_q07.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Seasonal Prediction of Upper Ocean Heat Content Extremes</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#use-case">üåç Use case:</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#quality-assessment-question">‚ùì Quality assessment question</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#quality-assessment-statement">üì¢ Quality assessment statement</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#methodology">üìã Methodology</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#pooling-and-grouping-strategies">Pooling and grouping strategies</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#sedi-the-symmetric-extremal-dependence-index">SEDI -  the Symmetric Extremal Dependence Index</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-brier-skill-score-bss">The Brier Skill Score (BSS)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#accuracy">Accuracy</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#analysis-and-results">üìà Analysis and results</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#data-preparation">1. Data Preparation</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#imports-and-settings">Imports and Settings</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#definition-of-parameters">Definition of Parameters</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#helper-functions-for-data-processing-and-plotting">Helper Functions for Data Processing and Plotting</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#data-loading">Data Loading</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#ohc-time-series-and-trend-analysis">2. OHC Time Series and Trend Analysis</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#figure-2">Figure 2</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#model-performance-vs-reanalysis">3. Model Performance vs. Reanalysis</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#correlation-of-ohc-anomalies">Correlation of OHC Anomalies</a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#figure-3">Figure 3</a></li>
</ul>
</li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#comparison-of-distributions">Comparison of distributions</a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#figure-4">Figure 4</a></li>
</ul>
</li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#comparison-of-heatwave-representation">Comparison of Heatwave Representation</a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#figure-5">Figure 5</a></li>
</ul>
</li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#diagnostic-plots-we-choose-1997-as-our-year-to-inspect-the-spatial-patterns-of-the-anomalies">Diagnostic Plots. We choose 1997 as our year to inspect the spatial patterns of the anomalies.</a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#figure-6">Figure 6</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#metrics-sedi-bss-accuracy">4. Metrics: SEDI, BSS, Accuracy</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#symmetric-extremal-dependence-index-sedi">Symmetric Extremal Dependence Index (SEDI)</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">The Brier Skill Score (BSS)</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#accuracy-assessment">Accuracy Assessment</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#pooling-strategy-for-skill-metrics-in-map-form">Pooling Strategy for Skill Metrics in Map Form</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#findings">Findings</a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#figure-7">Figure 7</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#contingency-table-analysis">5. Contingency Table Analysis</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#annual-variability-and-enso-influence">6. Annual Variability and ENSO Influence</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#annual-metrics-global">Annual metrics - global</a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#figure-8">Figure 8</a></li>
</ul>
</li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#annual-metrics-nino-3-4-region">Annual metrics - Ni√±o 3.4 region</a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#figure-9">Figure 9</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#summary-of-results">Summary of Results</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#i-if-you-want-to-know-more">‚ÑπÔ∏è If you want to know more</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#key-resources">Key resources</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#references">References</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <p><img alt="logo" src="../_images/LogoLine_horizon_C3S1.png" /></p>
<div class="alert alert-block alert-warning">
Please note that this repository is used for development and review, so quality assessments should be considered work in progress until they are merged into the main branch
</div><section class="tex2jax_ignore mathjax_ignore" id="seasonal-prediction-of-upper-ocean-heat-content-extremes">
<h1><span class="section-number">4.1. </span>Seasonal Prediction of Upper Ocean Heat Content Extremes<a class="headerlink" href="#seasonal-prediction-of-upper-ocean-heat-content-extremes" title="Link to this heading">#</a></h1>
<p>Production date: DD-02-2026</p>
<p>Produced by: Helene B. Erlandsen (METNorway)</p>
<section id="use-case">
<h2>üåç Use case:<a class="headerlink" href="#use-case" title="Link to this heading">#</a></h2>
<p>Investigating the potential for predicting upper ocean heat content extremes in seasonal forecasts.</p>
</section>
<section id="quality-assessment-question">
<h2>‚ùì Quality assessment question<a class="headerlink" href="#quality-assessment-question" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p><strong>What is the forecast skill of the seasonal prediction system in detecting extreme upper ocean heat content events (above the 90th percentile) for the NDJ season, based on an October 1st initialization?</strong></p></li>
</ul>
<p>This notebook evaluates the skill of the M√©t√©o-France System-9 seasonal forecasting system in predicting upper ocean heat content extremes. The analysis uses:</p>
<ul class="simple">
<li><p><strong>Seasonal Forecast Data</strong>: Monthly depth-averaged potential temperature for the upper 300 m, from M√©t√©o-France System-9 forecasts. <a class="reference external" href="https://doi.org/10.24381/cds.2f9be611" rel="noreferrer" target="_blank">[doi:10.24381/cds.2f9be611]</a></p></li>
<li><p><strong>Reanalysis Data</strong>: Ocean heat content from the ORAS5 global ocean and sea-ice reanalysis dataset. <a class="reference external" href="https://doi.org/10.24381/cds.67e8eeb7" rel="noreferrer" target="_blank">[doi:10.24381/cds.67e8eeb7]</a></p></li>
</ul>
<p>We consider the skill in predicting upper ocean heat content extremes in November, December, and January between 1993 and 2023 for (re-)forecasts with a nominal start date October 1st, using metrics such as the Symmetric Extremal Dependence Index (SEDI) and the Brier Skill Score (BSS). The metrics considered follow  Jacox et. al. 2022, <a class="reference external" href="https://doi.org/10.1038/s41586-022-04573-9" rel="noreferrer" target="_blank">[1]</a>, however in this work we look at upper ocean heat content and not sea surface temperature. Since ocean heat content (OHC) anomalies may persist for several months, this variable is an important component of seasonal predictability, containing relevant information even at a monthly time-scale (McAdam et. al. 2022, <a class="reference external" href="https://doi.org/10.1007/S00382-021-06101-3" rel="noreferrer" target="_blank">[2]</a>).</p>
</section>
<section id="quality-assessment-statement">
<h2>üì¢ Quality assessment statement<a class="headerlink" href="#quality-assessment-statement" title="Link to this heading">#</a></h2>
<div class="note admonition">
<p class="admonition-title">These are the key outcomes of this assessment</p>
<ul class="simple">
<li><p>The M√©t√©o-France System-9 forecast model demonstrates skill in detecting the risk of NDJ (November-January) upper ocean heatwaves. The model successfully captures 33% of observed heatwaves in November, with hit rates remaining consistent through December (30%) and January (27%).</p></li>
<li><p>The forecast is useful for identifying broad, large-scale patterns of risk, particularly during major El Ni√±o events. However, the Brier Skill Score (BSS) highlights that its probabilistic reliability varies by region. Using a multi-model forecast ensemble would likely increase the spread of the forecasts and provide more reliable results outside the ENSO region.</p></li>
<li><p>The system has potential as a tool for anticipating and building resilience to marine heatwaves, especially in ENSO-sensitive regions.</p></li>
</ul>
</div>
<figure class="align-default" id="id2">
<a class="reference internal image-reference" href="../_images/0fa94a15-3175-4725-863a-fc42e5bcb6c5.png"><img alt="../_images/0fa94a15-3175-4725-863a-fc42e5bcb6c5.png" src="../_images/0fa94a15-3175-4725-863a-fc42e5bcb6c5.png" style="height: 600px;" />
</a>
<figcaption>
<p><span class="caption-number">Fig. 4.1.1 </span><span class="caption-text">Figure 1: Spatial Forecast Skill for November-December-January (NDJ) Upper Ocean Heatwaves (1993‚Äì2023).
Skill of M√©t√©o-France System-9 forecasts (with nominal star date October 1st) verified against ORAS5 reanalysis. Heatwaves are defined as upper 300m ocean heat content (OHC) anomalies exceeding the 90th percentile within the 1993-2023 period. Rows show: (A) Symmetric Extremal Dependence Index (SEDI), (B) Brier Skill Score (BSS); and (C) Accuracy. In all maps, red areas indicate positive skill (forecast is better than the reference), while blue areas indicate negative skill. Masked areas are shown in grey. For the Accuracy maps (C) the areas with an accuracy lower than what would be expected by random chance (82%) are also shown with a grey color.</span><a class="headerlink" href="#id2" title="Link to this image">#</a></p>
</figcaption>
</figure>
</section>
<section id="methodology">
<h2>üìã Methodology<a class="headerlink" href="#methodology" title="Link to this heading">#</a></h2>
<p>The following steps were applied to evaluate the skill of the seasonal forecasting system in predicting heatwave extremes:</p>
<p><a class="reference internal" href="#seasonal-seasonal-monthly-ocean-extremes-detection-q07-seasonal-ohc-section-1"><span class="std std-ref">1. Data Preparation</span></a></p>
<p>This section includes:</p>
<ul class="simple">
<li><p>imports, settings, parameter definitions, and reusable functions required to initialize the analysis. Here the extent of the Nino3.4 area is given (5¬∞N‚Äì5¬∞S, 170¬∞‚Äì120¬∞W, also delineated in most map plots, e.g. <a class="reference internal" href="#seasonal-seasonal-monthly-ocean-extremes-detection-q07-fig-corr-map"><span class="std std-ref">Figure 3</span></a>). This area is selected to represent the tropical Pacific and ENSO, providing a key benchmark for seasonal predictability. The data is also loaded in this section.</p></li>
<li><p><strong>M√©t√©o-France System-9</strong>: The seasonal forecast data includes monthly depth-averaged potential temperature for the upper 300m. We use the hindcasts with a nominal start date of October 1st, between 1993 and 2023. For consistency only the hindcast period is used, since the model system has a different number of ensemble members in the forecast period compared to the hindcast period. <em>depth_average_potential_temperature_of_upper_300m</em> (<span class="math notranslate nohighlight">\(\bar{\Theta}\)</span>) was converted to OHC using the similar constants as used by ORAS5 (pers. comm.):
<span class="math notranslate nohighlight">\(\text{OHC} =\rho \, c_p \, \bar{ \Theta} \, dz \)</span>, where  <span class="math notranslate nohighlight">\(¬†\rho = 1026 \, \text{kg/m}^3\)</span>, <span class="math notranslate nohighlight">\( c_p = 3991 \, \text{J/kg/K} \)</span>, and  <span class="math notranslate nohighlight">\( dz = 300 \, \text{m} \)</span>.</p></li>
<li><p><strong>ORAS5</strong>: Reanalysis OHC for the upper 300m is used as the observational reference. Data is regridded to a common 1¬∞ spatial resolution using conservative normalization in xESMF.</p></li>
<li><p>The seasonal forecast and reanalysis data were processed for the period from <strong>1993 to 2023</strong>; and we consider forecasts <strong>with a nominal start date October 1st, valid for November, December, and January</strong>. For instance, the last season considers forecasts with a nominal start date October 1st 2023 for November and December 2023, and January 2024. By choosing an October initialization, we avoid compounding the task of extreme event detection with the lower predictability associated with other initialization windows, such as the boreal spring period in the Eastern Tropical Pacific (Jacox et. al. 2022, <a class="reference external" href="https://doi.org/10.1038/s41586-022-04573-9" rel="noreferrer" target="_blank">[1]</a>).</p></li>
<li><p><strong>Anomalies</strong>: Monthly anomalies are calculated by subtracting the calendar month climatology.</p></li>
<li><p>We also apply a common land mask to the interpolated products, also omitting areas where at any time the seasonal forecasts has temperatures below 0¬∞C (we could have used a lower threshold than 0¬∞C, but use this threshold as it at least will mask out all ice covered areas).</p></li>
<li><p>The seasonal forecast system (System 9) is initialized by nudging the ocean and sea-ice models towards the Mercator Ocean International GLORYS12V1 reanalysis, excpet for wihtin 225 km of coastlines or in the presence of sea ice (Specq et. al. 2024, <a class="reference external" href="https://doi.org/10.5281/zenodo.15518106" rel="noreferrer" target="_blank">[3]</a>). In contrast, ORAS5 is used as the reference reanalysis in this study. This makes the reference data somewhat independent, however, the data assimilated in ORAS5 and GLORYS12 likely overlap to a great extent. Differences in means will not affect the conclusions as anomalies are considered. Further, the limits for a heatwave is calculated seperatly for the seasonal forecast data and the reference data, allowing them to have different distributions.</p></li>
</ul>
<p><a class="reference internal" href="#seasonal-seasonal-monthly-ocean-extremes-detection-q07-seasonal-ohc-section-2"><span class="std std-ref">2. OHC Time Series and Trend Analysis</span></a></p>
<ul class="simple">
<li><p>We compare the data in map plots and in area aggregated time-series plots. Initial inspection showed strong temporal trends in OHC during the time period. The linear trends were removed from the raw data, so that the trends would not inflate the skill scores. Further, the strong temporal trends would skew the diagnosis of heatwaves to primarily occur in the more recent years.</p></li>
</ul>
<p><a class="reference internal" href="#seasonal-seasonal-monthly-ocean-extremes-detection-q07-seasonal-ohc-section-3"><span class="std std-ref">3. Model Performance vs. Reanalysis</span></a></p>
<p>The OHC anomalies based on detrended data were used to assess heatwaves. We show that the reference data and seasonal forecasting data have different data distributions. To align our diagnosed heatwaves, the defined percentiles of a heatwave are calculated separately depending on both the data source and the calendar month. To avoid unrealistic jumps, and to align our analysis with Jacox et. al. 2022, <a class="reference external" href="https://doi.org/10.1038/s41586-022-04573-9" rel="noreferrer" target="_blank">[1]</a> we use a three-month centered rolling window to set the monthly heatwave thresholds. For instance, January thresholds are derived from pooled December, January, and February anomalies. Heatwaves are defined as anomalies exceeding the 90th percentile.</p>
<p>In the subsequent sections we evaluate the forecast over different dimensions:</p>
<section id="pooling-and-grouping-strategies">
<h3>Pooling and grouping strategies<a class="headerlink" href="#pooling-and-grouping-strategies" title="Link to this heading">#</a></h3>
<div class="pst-scrollable-table-container"><table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>Analysis Goal</p></th>
<th class="head"><p>Grouping Strategy</p></th>
<th class="head"><p>Question It Answers</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Skill Maps</p></td>
<td><p>Pool time and ensemble for each grid point.</p></td>
<td><p>‚ÄúWhat is the forecast skill at this specific location over the entire 30-year period?‚Äù</p></td>
</tr>
<tr class="row-odd"><td><p>Annual Time Series</p></td>
<td><p>Pooled horizontally and over the ensemble for each year.</p></td>
<td><p>‚ÄúWhat was the overall global forecast accuracy in the year 1997?‚Äù</p></td>
</tr>
<tr class="row-even"><td><p>Summary Tables</p></td>
<td><p>Pool time, space, and ensemble for each lead-time (month).</p></td>
<td><p>‚ÄúWhat was the overall global forecast skill for all Novembers combined in the record?‚Äù</p></td>
</tr>
</tbody>
</table>
</div>
<p><a class="reference internal" href="#seasonal-seasonal-monthly-ocean-extremes-detection-q07-seasonal-ohc-section-4"><span class="std std-ref">4. Metrics: SEDI, BSS, Accuracy</span></a></p>
<p>We evaluate the forecasting system using the metrics outlined below.</p>
</section>
<section id="sedi-the-symmetric-extremal-dependence-index">
<h3>SEDI -  the Symmetric Extremal Dependence Index<a class="headerlink" href="#sedi-the-symmetric-extremal-dependence-index" title="Link to this heading">#</a></h3>
<p>SEDI quantifies the forecast skill for rare binary events (e.g., heatwaves). It is the Symmetric Extremal Dependence Index (Ferro &amp; Stephenson 2011 <a class="reference external" href="https://doi.org/10.1175/WAF-D-10-05030.1" rel="noreferrer" target="_blank">[4]</a>). SEDI has a maximum value of one, and a minimum value of -1. Scores above zero indicate a forecast better than random chance.</p>
<p>SEDI is built on the output of a contingency table. A contingency table provides:  sample size, n; base rate, p; hit rate, H; and false-alarm rate, F. The ensemble members are pooled and each adds to the counts in the contingency table before the SEDI score is calculated.</p>
<div class="pst-scrollable-table-container"><table class="table">
<thead>
<tr class="row-odd"><th class="head"><p></p></th>
<th class="head"><p>Event observed</p></th>
<th class="head"><p>Non-event observed</p></th>
<th class="head"><p></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Event forecasted</p></td>
<td><p>a = Hpn</p></td>
<td><p>b = F(1-p)n</p></td>
<td><p>a + b</p></td>
</tr>
<tr class="row-odd"><td><p>Non-event forecasted</p></td>
<td><p>c = (1-H)pn</p></td>
<td><p>d = (1-F)(1-p)n</p></td>
<td><p>c + d</p></td>
</tr>
<tr class="row-even"><td><p>Sum</p></td>
<td><p>a + c = pn</p></td>
<td><p>b + d = (1-p)n</p></td>
<td><p>n</p></td>
</tr>
</tbody>
</table>
</div>
<p>Hit rate (H) =  <span class="math notranslate nohighlight">\( \frac{a}{a+c} \)</span>, False alarm rate (F) =  <span class="math notranslate nohighlight">\( \frac{b}{b+d} \)</span></p>
<p>SEDI =  <span class="math notranslate nohighlight">\( \frac{logF - logH  -log(1-F) + log(1-H)}{logF + logH  +log(1-F) + log(1-H)} \)</span></p>
</section>
<section id="the-brier-skill-score-bss">
<h3>The Brier Skill Score (BSS)<a class="headerlink" href="#the-brier-skill-score-bss" title="Link to this heading">#</a></h3>
<p>The Brier Skill Score (BSS) compares the forecast skill against a reference forecast (e.g., climatology), which for heatwaves defined as values above 90% of those observed, would be that there always was about a 10% chance of a heatwave.</p>
<p>It is calculated as:
<span class="math notranslate nohighlight">\(
  \text{BSS} = 1 - \frac{\text{Brier Score (BrS)}}{\text{BrS}_{\text{ref}}}
  \)</span></p>
<p>It is based on the Brier Score, which measures the mean squared error between forecast probabilities and observed binary events.</p>
<p>The BSS‚Äôs upper limit is 1, meanwhile it has no lower limit. Scores above zero indicate a forecast better than the climatology, which is around a 10% chance.</p>
</section>
<section id="accuracy">
<h3>Accuracy<a class="headerlink" href="#accuracy" title="Link to this heading">#</a></h3>
<p>Accuracy measures the proportion of correct predictions (both true positives and true negatives) out of the total number of forecasts made. The formula is:</p>
<p><span class="math notranslate nohighlight">\( \text{Accuracy} = \frac{\text{True Positives (TP)} + \text{True Negatives (TN)}}{\text{Total Predictions (N)}} \)</span></p>
<p>For rare events like heatwaves (which occur about 10 % of the time in this study), a simple accuracy score can be misleading. A forecast that always predicts ‚Äúno heatwave‚Äù would be 90 % accurate but have zero skill. Therefore, we compare the forecast‚Äôs accuracy to a random chance benchmark. For an event with a 10% probability (p=0.1), the accuracy of a random forecast is calculated as:</p>
<p><span class="math notranslate nohighlight">\( \text{Random Accuracy}  =  p^2+(1‚àíp)^2 = 0.1^2+(0.9)^2 = 0.82 \)</span></p>
<p>This means the forecasting system must achieve an accuracy greater than 0.82 (or 82%) to be considered more skillful than random chance.</p>
<p><a class="reference internal" href="#seasonal-seasonal-monthly-ocean-extremes-detection-q07-seasonal-ohc-section-5"><span class="std std-ref">5. Contingency Table Analysis</span></a>
The contingency tables for all November, December, and January‚Äôs are presented and discussed.</p>
<p><a class="reference internal" href="#seasonal-seasonal-monthly-ocean-extremes-detection-q07-seasonal-ohc-section-6"><span class="std std-ref">6. Annual Variability and ENSO Influence</span></a>
Finally, we display the annual metrics as time-series, also showing the components of the contingency table, allowing a discussion of the components of the metrics.</p>
<p><a class="reference internal" href="#seasonal-seasonal-monthly-ocean-extremes-detection-q07-seasonal-ohc-section-7"><span class="std std-ref">Summary of Results</span></a></p>
</section>
</section>
<section id="analysis-and-results">
<h2>üìà Analysis and results<a class="headerlink" href="#analysis-and-results" title="Link to this heading">#</a></h2>
<section id="data-preparation">
<span id="seasonal-seasonal-monthly-ocean-extremes-detection-q07-seasonal-ohc-section-1"></span><h3>1. Data Preparation<a class="headerlink" href="#data-preparation" title="Link to this heading">#</a></h3>
<p>This section includes imports, settings, parameter definitions, and reusable functions required to initialize the analysis.</p>
<section id="imports-and-settings">
<h4>Imports and Settings<a class="headerlink" href="#imports-and-settings" title="Link to this heading">#</a></h4>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ### Imports and Settings</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.patches</span><span class="w"> </span><span class="kn">import</span> <span class="n">Patch</span> 
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">xarray</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">xr</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">c3s_eqc_automatic_quality_control</span><span class="w"> </span><span class="kn">import</span> <span class="n">diagnostics</span><span class="p">,</span> <span class="n">download</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">xskillscore</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">xs</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">cartopy</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">cartopy.crs</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">ccrs</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span><span class="o">,</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">gc</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pooch</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dask</span><span class="w"> </span><span class="kn">import</span> <span class="n">compute</span> <span class="k">as</span> <span class="n">dask_compute</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy</span><span class="w"> </span><span class="kn">import</span> <span class="n">stats</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">FutureWarning</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s2">&quot;seaborn-v0_8-notebook&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Select realizations for ensemble</span>
<span class="n">realizations</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

<span class="c1"># Whether to detrend anomalies or not</span>
<span class="n">detrend</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1"># Analysis time period</span>
<span class="n">start</span> <span class="o">=</span> <span class="s2">&quot;1993-10&quot;</span>
<span class="n">stop</span> <span class="o">=</span> <span class="s2">&quot;2023-10&quot;</span>
<span class="n">freq</span> <span class="o">=</span> <span class="s2">&quot;12MS&quot;</span>  <span class="c1"># Monthly frequency</span>
<span class="n">leadtimes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>  <span class="c1"># Lead times in months, 10, 11, 12, 1, 2</span>
<span class="n">months_to_do</span> <span class="o">=</span> <span class="p">[</span><span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="c1">#NDJ</span>

<span class="c1"># Use all realizations for ensemble</span>
<span class="n">realizations</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

<span class="c1">#Various parameters</span>
<span class="n">eps</span> <span class="o">=</span> <span class="mf">1e-12</span> 
<span class="n">spatial_chunks</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;latitude&#39;</span><span class="p">:</span> <span class="mi">32</span><span class="p">,</span> <span class="s1">&#39;longitude&#39;</span><span class="p">:</span> <span class="mi">64</span><span class="p">}</span> 
<span class="n">time_chunks</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;year&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;month&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">}</span><span class="c1"># -1 is no/one chunk</span>
<span class="n">reduce_dims</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="s1">&#39;realization&#39;</span><span class="p">]</span> 
<span class="n">Nino_3_4_lat</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">]</span>
<span class="n">Nino_3_4_lon</span> <span class="o">=</span> <span class="p">[</span><span class="mi">360</span><span class="o">-</span><span class="mi">170</span><span class="p">,</span><span class="mi">360</span><span class="o">-</span><span class="mi">120</span><span class="p">]</span> <span class="c1">#W</span>
<span class="n">nino_box</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">longitude</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">Nino_3_4_lon</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Nino_3_4_lon</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">latitude</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">Nino_3_4_lat</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Nino_3_4_lat</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

<span class="c1"># Physical constants for ocean heat content calculations as used in ORAS5</span>
<span class="n">cp</span> <span class="o">=</span> <span class="mf">3991.</span>  <span class="c1"># J/kg/K (specific heat of seawater)</span>
<span class="n">rho0</span> <span class="o">=</span> <span class="mf">1026.</span>  <span class="c1"># kg/m^3 (reference density of seawater)</span>
<span class="n">delta_level</span> <span class="o">=</span> <span class="mi">300</span>  <span class="c1"># m (upper ocean depth)</span>

<span class="c1"># Conversion factor for heat content (J/m^2)</span>
<span class="c1">#delta_level * cp * rho0 * (Seasonal_data - Tf)</span>
<span class="n">heat_content_factor</span> <span class="o">=</span> <span class="n">cp</span> <span class="o">*</span> <span class="n">rho0</span> <span class="o">*</span> <span class="n">delta_level</span>
</pre></div>
</div>
</div>
</details>
</div>
</section>
<section id="definition-of-parameters">
<h4>Definition of Parameters<a class="headerlink" href="#definition-of-parameters" title="Link to this heading">#</a></h4>
<p>We have chosen Meteo-France System-9, and focus on the hindcast period, which are available from 1993 until 2024, to have a consistent ensemble throughout the analysis.</p>
<p>We focus on the forecasts initiated October 1st every year, and consider one, two, and three months leadtimes - i.e. the forecasted values for November, December, and January. In the initial processing also October and February values are used, as the heatwave thresholds are centered a three-month month moving window.</p>
</section>
<section id="helper-functions-for-data-processing-and-plotting">
<h4>Helper Functions for Data Processing and Plotting<a class="headerlink" href="#helper-functions-for-data-processing-and-plotting" title="Link to this heading">#</a></h4>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># map plot helper</span>
<span class="k">def</span><span class="w"> </span><span class="nf">setup_map_plot</span><span class="p">(</span><span class="n">ax</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Applies consistent styling to a Cartopy map axes.</span>
<span class="sd">    - Sets the ocean color to gray.</span>
<span class="sd">    - Adds land, coastlines, and borders.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">(</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cartopy</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">LAND</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;lightgrey&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cartopy</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">COASTLINE</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cartopy</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">BORDERS</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">Nino_3_4_lon</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">Nino_3_4_lon</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">Nino_3_4_lon</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">Nino_3_4_lon</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">Nino_3_4_lon</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
                <span class="p">[</span><span class="n">Nino_3_4_lat</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">Nino_3_4_lat</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">Nino_3_4_lat</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">Nino_3_4_lat</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">Nino_3_4_lat</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> 
            <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span><span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">())</span> 
    
    
<span class="k">def</span><span class="w"> </span><span class="nf">add_bounds</span><span class="p">(</span><span class="n">ds</span><span class="p">):</span>
    <span class="c1"># From https://github.com/COSIMA/ocean-regrid/blob/master/nemo_grid.py</span>
    <span class="n">url</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;https://icdc.cen.uni-hamburg.de/thredds/fileServer/ftpthredds/&quot;</span>
        <span class="s2">&quot;EASYInit/oras5/ORCA025/mesh/mesh_mask.nc&quot;</span>
    <span class="p">)</span>
    <span class="n">known_hash</span> <span class="o">=</span> <span class="s2">&quot;ba88418bc8055972b675ceedbd4345b3827f0ede8cef04d53c97b66a5c7a46a7&quot;</span>
    <span class="n">fname</span> <span class="o">=</span> <span class="n">pooch</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">known_hash</span><span class="p">)</span>
    <span class="n">dg</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">chunks</span><span class="o">=</span><span class="p">{})</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># These are the top righ-hand corner of t cells.</span>
    <span class="n">glamf</span> <span class="o">=</span> <span class="n">dg</span><span class="o">.</span><span class="n">glamf</span>
    <span class="n">gphif</span> <span class="o">=</span> <span class="n">dg</span><span class="o">.</span><span class="n">gphif</span>

    <span class="c1"># Extend south so that Southern most cells can have bottom corners.</span>
    <span class="n">gphif_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">((</span><span class="n">gphif</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">gphif</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">gphif_new</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">gphif</span><span class="p">[:]</span>
    <span class="n">gphif_new</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">gphif</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="nb">abs</span><span class="p">(</span><span class="n">gphif</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">gphif</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:])</span>

    <span class="n">glamf_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">((</span><span class="n">glamf</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">glamf</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">glamf_new</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">glamf</span><span class="p">[:]</span>
    <span class="n">glamf_new</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">glamf</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>

    <span class="c1"># Repeat first longitude so that Western most cells have left corners.</span>
    <span class="n">gphif_new</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">gphif_new</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">glamf_new</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">glamf_new</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">gphif</span> <span class="o">=</span> <span class="n">gphif_new</span>
    <span class="n">glamf</span> <span class="o">=</span> <span class="n">glamf_new</span>

    <span class="c1"># Corners of t points. Index 0 is bottom left and then</span>
    <span class="c1"># anti-clockwise.</span>
    <span class="n">clon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">dg</span><span class="o">.</span><span class="n">tmask</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dg</span><span class="o">.</span><span class="n">tmask</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">4</span><span class="p">))</span>
    <span class="n">clon</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">clon</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">glamf</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">clon</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">glamf</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:]</span>
    <span class="n">clon</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">glamf</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="mi">1</span><span class="p">:]</span>
    <span class="n">clon</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">glamf</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">clon</span><span class="p">))</span>

    <span class="n">clat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">dg</span><span class="o">.</span><span class="n">tmask</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dg</span><span class="o">.</span><span class="n">tmask</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">4</span><span class="p">))</span>
    <span class="n">clat</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">clat</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">gphif</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">clat</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">gphif</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:]</span>
    <span class="n">clat</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">gphif</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="mi">1</span><span class="p">:]</span>
    <span class="n">clat</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">gphif</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">clat</span><span class="p">))</span>

    <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;latitude&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;bounds&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;latitude_bounds&quot;</span>
    <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;longitude&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;bounds&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;longitude_bounds&quot;</span>
    <span class="k">return</span> <span class="n">ds</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span>
        <span class="n">latitude_bounds</span><span class="o">=</span><span class="p">([</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;bound&quot;</span><span class="p">],</span> <span class="n">clat</span><span class="p">),</span>
        <span class="n">longitude_bounds</span><span class="o">=</span><span class="p">([</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;bound&quot;</span><span class="p">],</span> <span class="n">clon</span><span class="p">),</span>
    <span class="p">)</span>


<span class="c1"># Seasonal</span>

<span class="k">def</span><span class="w"> </span><span class="nf">preprocess_seasonal</span><span class="p">(</span><span class="n">ds</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    New preprocessing function:</span>
<span class="sd">    1. Swaps &#39;leadtime&#39; dimension for &#39;time&#39; coordinate.</span>
<span class="sd">    2. Cleans up metadata (bnds, realization).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># Check if &#39;leadtime&#39; is a dim, &#39;time&#39; is a coord, </span>
    <span class="c1"># and &#39;time&#39; is indexed by &#39;leadtime&#39;.</span>
    <span class="k">if</span> <span class="s1">&#39;leadtime&#39;</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">dims</span> <span class="ow">and</span> <span class="s1">&#39;time&#39;</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">coords</span> <span class="ow">and</span> <span class="s1">&#39;leadtime&#39;</span> <span class="ow">in</span> <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">swap_dims</span><span class="p">({</span><span class="s1">&#39;leadtime&#39;</span><span class="p">:</span> <span class="s1">&#39;time&#39;</span><span class="p">})</span>

    <span class="c1"># Set &#39;bnds&#39; variables as coordinates</span>
    <span class="n">bnd_vars</span> <span class="o">=</span> <span class="p">[</span><span class="n">var</span> <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">da</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">data_vars</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="s2">&quot;bnds&quot;</span> <span class="ow">in</span> <span class="n">da</span><span class="o">.</span><span class="n">dims</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">bnd_vars</span><span class="p">:</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">set_coords</span><span class="p">(</span><span class="n">bnd_vars</span><span class="p">)</span>
        
    <span class="c1"># Clean up &#39;realization&#39; coordinate and ensure it&#39;s a dimension</span>
    <span class="k">if</span> <span class="s1">&#39;realization&#39;</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">coords</span><span class="p">:</span>
        <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;realization&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;realization&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;realization&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
            <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="s2">&quot;realization&quot;</span><span class="p">)</span>
            
    <span class="k">return</span> <span class="n">ds</span>

    
<span class="k">def</span><span class="w"> </span><span class="nf">regrid_reanalysis</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">grid_request</span><span class="p">,</span> <span class="o">**</span><span class="n">xesmf_kwargs</span><span class="p">):</span>
    <span class="n">ds_seasonal</span> <span class="o">=</span> <span class="n">download</span><span class="o">.</span><span class="n">download_and_transform</span><span class="p">(</span>
        <span class="o">*</span><span class="n">grid_request</span><span class="p">,</span>
        <span class="n">preprocess</span><span class="o">=</span><span class="n">preprocess_seasonal</span><span class="p">,</span>
        <span class="n">invalidate_cache</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">decode_timedelta</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">mask_out</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">ds_seasonal</span><span class="p">[</span><span class="s2">&quot;thetaot300&quot;</span><span class="p">]</span>
        <span class="o">.</span><span class="n">isel</span><span class="p">(</span>
            <span class="p">{</span><span class="n">dim</span><span class="p">:</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;realization&quot;</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">)}</span>
        <span class="p">)</span>
        <span class="o">.</span><span class="n">reset_coords</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="o">.</span><span class="n">notnull</span><span class="p">()</span>
    <span class="p">)</span>
    <span class="n">grid_out</span> <span class="o">=</span> <span class="n">ds_seasonal</span><span class="o">.</span><span class="n">cf</span><span class="p">[[</span><span class="s2">&quot;latitude&quot;</span><span class="p">,</span> <span class="s2">&quot;longitude&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">mask</span><span class="o">=</span><span class="n">mask_out</span><span class="p">)</span>

    <span class="n">mask_in</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;sohtc300&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">reset_coords</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">notnull</span><span class="p">()</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">add_bounds</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">mask</span><span class="o">=</span><span class="n">mask_in</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">diagnostics</span><span class="o">.</span><span class="n">regrid</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">grid_out</span><span class="p">,</span> <span class="o">**</span><span class="n">xesmf_kwargs</span><span class="p">)</span>
    
<span class="k">def</span><span class="w"> </span><span class="nf">compute_anomalies_new</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">realizations</span><span class="p">,</span> <span class="n">grid_request</span><span class="p">,</span> <span class="n">detrend</span><span class="p">,</span> <span class="o">**</span><span class="n">xesmf_kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes standard monthly anomalies and detrends them </span>
<span class="sd">    month-by-month using a mean-preserving method.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">realizations</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">realization</span><span class="o">=</span><span class="n">realizations</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">grid_request</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">regrid_reanalysis</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">grid_request</span><span class="p">,</span> <span class="o">**</span><span class="n">xesmf_kwargs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="n">xesmf_kwargs</span>

    <span class="p">((</span><span class="n">name</span><span class="p">,</span> <span class="n">da</span><span class="p">),)</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">data_vars</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
    <span class="n">time_dim</span> <span class="o">=</span> <span class="s2">&quot;time&quot;</span>
    
    <span class="k">with</span> <span class="n">xr</span><span class="o">.</span><span class="n">set_options</span><span class="p">(</span><span class="n">keep_attrs</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        
        <span class="c1"># --- Standard Monthly Climatology ---</span>
        <span class="n">dims_to_mean</span> <span class="o">=</span> <span class="p">[</span><span class="n">time_dim</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;realization&quot;</span> <span class="ow">in</span> <span class="n">da</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
            <span class="n">dims_to_mean</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;realization&quot;</span><span class="p">)</span>

        <span class="c1"># Calculate mean for each month (Jan, Feb, etc.)</span>
        <span class="n">climatology</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">time_dim</span><span class="si">}</span><span class="s2">.month&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">dims_to_mean</span><span class="p">)</span>
        
        <span class="c1"># Calculate Anomalies</span>
        <span class="n">anomalies</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">time_dim</span><span class="si">}</span><span class="s2">.month&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">climatology</span>
        
        <span class="c1"># --- Month-by-Month Detrending ---</span>
        <span class="k">if</span> <span class="n">detrend</span><span class="p">:</span>
            <span class="c1"># 1. Group by month and fit trend using .map()</span>
            <span class="n">pf_ds</span> <span class="o">=</span> <span class="n">anomalies</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">time_dim</span><span class="si">}</span><span class="s2">.month&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">time_dim</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="p">)</span>
            
            <span class="c1"># Extract the coefficients DataArray. </span>
            <span class="n">coeff_name</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">pf_ds</span><span class="o">.</span><span class="n">data_vars</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">coeffs</span> <span class="o">=</span> <span class="n">pf_ds</span><span class="p">[</span><span class="n">coeff_name</span><span class="p">]</span>
            
            <span class="c1"># Reconstruct the full trend line (mx + c)</span>
            <span class="n">coeffs_expanded</span> <span class="o">=</span> <span class="n">coeffs</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">month</span><span class="o">=</span><span class="n">anomalies</span><span class="p">[</span><span class="n">time_dim</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span><span class="p">)</span>
            <span class="n">full_trend</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="n">anomalies</span><span class="p">[</span><span class="n">time_dim</span><span class="p">],</span> <span class="n">coeffs_expanded</span><span class="p">)</span>
            
            <span class="c1"># Isolate the slope component.</span>
            <span class="n">slope_component</span> <span class="o">=</span> <span class="n">full_trend</span> <span class="o">-</span> <span class="n">full_trend</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">time_dim</span><span class="p">)</span>
            
            <span class="c1"># Subtract the slope</span>
            <span class="n">anomalies</span> <span class="o">=</span> <span class="n">anomalies</span> <span class="o">-</span> <span class="n">slope_component</span>

    <span class="n">anomalies</span><span class="o">.</span><span class="n">encoding</span><span class="p">[</span><span class="s2">&quot;chunksizes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
        <span class="mi">1</span> <span class="k">if</span> <span class="n">dim</span> <span class="o">==</span> <span class="s2">&quot;realization&quot;</span> <span class="k">else</span> <span class="n">size</span>
        <span class="k">for</span> <span class="n">dim</span><span class="p">,</span> <span class="n">size</span> <span class="ow">in</span> <span class="n">anomalies</span><span class="o">.</span><span class="n">sizes</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">anomalies</span><span class="o">.</span><span class="n">to_dataset</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
    
    
<span class="k">def</span><span class="w"> </span><span class="nf">transform_seasonal_data</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">realizations</span><span class="p">,</span> <span class="n">detrend</span><span class="p">,</span> <span class="n">grid_request</span><span class="p">,</span> <span class="o">**</span><span class="n">xesmf_kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    1. Compute the anomalies</span>
<span class="sd">    2. Reindexe the data using reindex_seasonal.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">static_not_sea_ice_proxy_mask_s</span> <span class="o">=</span> <span class="p">(</span>
    <span class="p">(</span><span class="n">ds</span><span class="p">[</span><span class="s1">&#39;thetaot300&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">273.15</span><span class="p">)</span> <span class="c1"># </span>
    <span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;realization&#39;</span><span class="p">])</span> <span class="c1"># </span>
    <span class="p">)</span>
    <span class="n">static_not_sea_ice_proxy_mask_s</span> <span class="o">=</span> <span class="n">static_not_sea_ice_proxy_mask_s</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>

    <span class="c1">#print(f&quot;Number of &#39;True&#39; points in sesonal static_sea_ice_proxy_mask: {static_not_sea_ice_proxy_mask_s.sum().compute().item()}&quot;)</span>
    <span class="c1">#static_not_sea_ice_proxy_mask_s.plot()</span>
    <span class="c1"># Step 1: Compute anomalies</span>
    <span class="n">ds_anom</span> <span class="o">=</span> <span class="n">compute_anomalies_new</span><span class="p">(</span>
        <span class="n">ds</span><span class="p">,</span>
        <span class="n">realizations</span><span class="o">=</span><span class="n">realizations</span><span class="p">,</span>
        <span class="n">detrend</span><span class="o">=</span><span class="n">detrend</span><span class="p">,</span>
        <span class="n">grid_request</span><span class="o">=</span><span class="n">grid_request</span><span class="p">,</span>
        <span class="o">**</span><span class="n">xesmf_kwargs</span>
    <span class="p">)</span>
    <span class="c1">#apply the mask here</span>
    <span class="n">xr</span><span class="o">.</span><span class="n">set_options</span><span class="p">(</span><span class="n">keep_attrs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">ds_anom</span><span class="p">[</span><span class="s1">&#39;thetaot300&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds_anom</span><span class="p">[</span><span class="s1">&#39;thetaot300&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">static_not_sea_ice_proxy_mask_s</span><span class="p">)</span>

    <span class="n">ds_anom</span> <span class="o">=</span> <span class="n">ds_anom</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
    <span class="c1"># --------------------------</span>

    <span class="c1"># Step 2: Reindex to (year, month), assing year to fc_start</span>
    <span class="n">ds_reindexed</span> <span class="o">=</span> <span class="n">reindex_seasonal</span><span class="p">(</span>
        <span class="n">ds_anom</span><span class="p">,</span> 
        <span class="n">time_dim</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> 
        <span class="n">shift_months</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span> 
    <span class="p">)</span>
    
    <span class="k">return</span> <span class="n">ds_reindexed</span>

<span class="k">def</span><span class="w"> </span><span class="nf">transform_reanalysis_data</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">realizations</span><span class="p">,</span> <span class="n">detrend</span><span class="p">,</span> <span class="n">grid_request</span><span class="p">,</span> <span class="o">**</span><span class="n">xesmf_kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Wrapper function to process reanalysis data:</span>
<span class="sd">    1. Compute anomalies </span>
<span class="sd">    2. Reindexe the data using a fixed seasonal function.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Step 1: Compute anomalies</span>
    <span class="n">ds_anom</span> <span class="o">=</span> <span class="n">compute_anomalies_new</span><span class="p">(</span>  
        <span class="n">ds</span><span class="p">,</span>
        <span class="n">realizations</span><span class="o">=</span><span class="n">realizations</span><span class="p">,</span>
        <span class="n">detrend</span><span class="o">=</span><span class="n">detrend</span><span class="p">,</span>
        <span class="n">grid_request</span><span class="o">=</span><span class="n">grid_request</span><span class="p">,</span>
        <span class="o">**</span><span class="n">xesmf_kwargs</span>
    <span class="p">)</span>

    <span class="n">ds_anom</span> <span class="o">=</span> <span class="n">ds_anom</span><span class="o">.</span><span class="n">load</span><span class="p">()</span> 
    <span class="c1"># --------------------------</span>

    <span class="n">months_to_shift</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span> 
    <span class="n">ds_reindexed</span> <span class="o">=</span> <span class="n">reindex_seasonal</span><span class="p">(</span>
        <span class="n">ds_anom</span><span class="p">,</span> 
        <span class="n">time_dim</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> 
        <span class="n">shift_months</span><span class="o">=</span><span class="n">months_to_shift</span> 
    <span class="p">)</span>
    
    <span class="k">return</span> <span class="n">ds_reindexed</span>

    

<span class="k">def</span><span class="w"> </span><span class="nf">reindex_seasonal</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">time_dim</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="n">shift_months</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reindexes to (year, month) by shifting specified months.</span>
<span class="sd">    Assign all the fc months to the initialization year</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">calendar_year</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="n">time_dim</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span>
    <span class="n">calendar_month</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="n">time_dim</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span>
    
    <span class="c1"># Create the &#39;season_year&#39;</span>
    <span class="n">season_year</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="n">calendar_month</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">shift_months</span><span class="p">),</span>
        <span class="n">calendar_year</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">calendar_year</span>
    <span class="p">)</span>
    
    <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span>
        <span class="n">season_year</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="n">season_year</span><span class="o">.</span><span class="n">data</span><span class="p">),</span> 
        <span class="n">month</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="n">calendar_month</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
    <span class="p">)</span>
    
    <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;season_year&quot;</span><span class="p">,</span> <span class="s2">&quot;month&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">)</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;season_year&#39;</span><span class="p">:</span> <span class="s1">&#39;year&#39;</span><span class="p">})</span>
    
    <span class="c1"># the month coord will be [1, 2, 3, 4, 10, 11, 12]</span>
    <span class="k">return</span> <span class="n">ds</span>
</pre></div>
</div>
</div>
</details>
</div>
</section>
<section id="data-loading">
<h4>Data Loading<a class="headerlink" href="#data-loading" title="Link to this heading">#</a></h4>
<p>We download the reanalysis and seasonal forecast datasets, regridding the reanalysis data to align with the seasonal forecast grid, and computing the detrended anomalies.
These transformations are performed using the <em>c3s_eqc_automatic_quality_control</em> <em>download.download_and_transform</em> function and custom preprocessing steps. xesmf conservative regridding was used to transform the ORAS5 ORCA025 grid to a global 1x1 latlon grid. Sensitivity tests were conducted to ensure that the regridding process (comparing area-conservative interpolation used for ORAS5 vs. a version of the two step distance-weighted interpolation that System 9 underwent) produced similar changes to the mean and variance of the original data (not shown).</p>
<ul class="simple">
<li><p>The data is combined and reindexed so that year and calendar month are the dataset coordinates.</p></li>
<li><p>The long-term climatology and possibly the monthly trend is subtracted.</p></li>
<li><p>We apply a common land mask and also mask out areas where seasonal forecast data have values corresponding to a monthly mean potential temperature below 0¬∞C.</p></li>
<li><p>The seasonal forecast vertically integrated potential temperature is converted to OHC, following the convention used in ORAS5.</p></li>
<li><p>The variable names are changed to reflect their current state.</p></li>
</ul>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">collection_id_reanalysis</span> <span class="o">=</span> <span class="s2">&quot;reanalysis-oras5&quot;</span>
<span class="n">collection_id_seasonal</span> <span class="o">=</span> <span class="s2">&quot;seasonal-monthly-ocean&quot;</span>

<span class="c1">#requests_reanalysis = {leadtime: [] for leadtime in leadtimes}</span>
<span class="n">requests_seasonal</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">date</span> <span class="ow">in</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="n">freq</span><span class="p">):</span>
    <span class="n">requests_seasonal</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s2">&quot;originating_centre&quot;</span><span class="p">:</span> <span class="s2">&quot;meteo_france&quot;</span><span class="p">,</span>
            <span class="s2">&quot;system&quot;</span><span class="p">:</span> <span class="s2">&quot;9&quot;</span><span class="p">,</span>
            <span class="s2">&quot;variable&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;depth_average_potential_temperature_of_upper_300m&quot;</span><span class="p">],</span>
            <span class="s2">&quot;forecast_type&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;hindcast&quot;</span><span class="p">],</span>
            <span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="n">date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y&quot;</span><span class="p">),</span>
            <span class="s2">&quot;month&quot;</span><span class="p">:</span> <span class="n">date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%m&quot;</span><span class="p">),</span>
        <span class="p">}</span>
    <span class="p">)</span>


<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Building a flat list of unique reanalysis requests...&quot;</span><span class="p">)</span>
<span class="n">requests_reanalysis_flat</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">seen_requests</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span> <span class="c1"># To prevent duplicate requests</span>

<span class="k">for</span> <span class="n">date</span> <span class="ow">in</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="n">freq</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">leadtime</span> <span class="ow">in</span> <span class="n">leadtimes</span><span class="p">:</span>
        <span class="n">date_reanalysis</span> <span class="o">=</span> <span class="n">date</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="n">leadtime</span><span class="p">)</span>
        <span class="n">request</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;product_type&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;operational&quot;</span> <span class="k">if</span> <span class="n">date_reanalysis</span><span class="o">.</span><span class="n">year</span> <span class="o">&gt;</span> <span class="mi">2014</span> <span class="k">else</span> <span class="s2">&quot;consolidated&quot;</span>
            <span class="p">],</span>
            <span class="s2">&quot;vertical_resolution&quot;</span><span class="p">:</span> <span class="s2">&quot;single_level&quot;</span><span class="p">,</span>
            <span class="s2">&quot;variable&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;ocean_heat_content_for_the_upper_300m&quot;</span><span class="p">],</span>
            <span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="n">date_reanalysis</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y&quot;</span><span class="p">),</span>
            <span class="s2">&quot;month&quot;</span><span class="p">:</span> <span class="n">date_reanalysis</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%m&quot;</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="n">request_key</span> <span class="o">=</span> <span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">],</span> <span class="n">request</span><span class="p">[</span><span class="s2">&quot;month&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">request_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen_requests</span><span class="p">:</span>
            <span class="n">requests_reanalysis_flat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
            <span class="n">seen_requests</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">request_key</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">requests_reanalysis_flat</span><span class="p">)</span><span class="si">}</span><span class="s2"> unique months of reanalysis to download.&quot;</span><span class="p">)</span>

<span class="c1"># Seasonal</span>
<span class="n">ds_seasonal_trend</span> <span class="o">=</span> <span class="n">download</span><span class="o">.</span><span class="n">download_and_transform</span><span class="p">(</span>
    <span class="n">collection_id_seasonal</span><span class="p">,</span>
    <span class="n">requests_seasonal</span><span class="p">,</span>
    <span class="n">preprocess</span><span class="o">=</span><span class="n">preprocess_seasonal</span><span class="p">,</span>
    <span class="n">drop_variables</span><span class="o">=</span><span class="s2">&quot;hcrs&quot;</span><span class="p">,</span>
    <span class="n">transform_func</span><span class="o">=</span><span class="n">transform_seasonal_data</span><span class="p">,</span>
    <span class="n">invalidate_cache</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">transform_func_kwargs</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;realizations&quot;</span><span class="p">:</span> <span class="n">realizations</span><span class="p">,</span>
        <span class="s2">&quot;detrend&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;grid_request&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="n">transform_chunks</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">decode_timedelta</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">ds_seasonal_trend</span> <span class="o">=</span> <span class="n">ds_seasonal_trend</span><span class="o">.</span><span class="n">chunk</span><span class="p">({</span>
    <span class="s1">&#39;year&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> 
    <span class="s1">&#39;month&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> 
    <span class="s1">&#39;realization&#39;</span><span class="p">:</span> <span class="mi">1</span>  
<span class="p">})</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

<span class="c1"># Seasonal</span>
<span class="n">ds_seasonal</span> <span class="o">=</span> <span class="n">download</span><span class="o">.</span><span class="n">download_and_transform</span><span class="p">(</span>
    <span class="n">collection_id_seasonal</span><span class="p">,</span>
    <span class="n">requests_seasonal</span><span class="p">,</span>
    <span class="n">preprocess</span><span class="o">=</span><span class="n">preprocess_seasonal</span><span class="p">,</span>
    <span class="n">drop_variables</span><span class="o">=</span><span class="s2">&quot;hcrs&quot;</span><span class="p">,</span>
    <span class="n">transform_func</span><span class="o">=</span><span class="n">transform_seasonal_data</span><span class="p">,</span>
    <span class="n">invalidate_cache</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">transform_func_kwargs</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;realizations&quot;</span><span class="p">:</span> <span class="n">realizations</span><span class="p">,</span>
        <span class="s2">&quot;detrend&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s2">&quot;grid_request&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="n">transform_chunks</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">decode_timedelta</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">ds_seasonal</span> <span class="o">=</span> <span class="n">ds_seasonal</span><span class="o">.</span><span class="n">chunk</span><span class="p">({</span>
    <span class="s1">&#39;year&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> 
    <span class="s1">&#39;month&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> 
    <span class="s1">&#39;realization&#39;</span><span class="p">:</span> <span class="mi">1</span> 
<span class="p">})</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>


<span class="c1"># Reanalysis</span>
<span class="n">ds_reanalysis_trend</span> <span class="o">=</span> <span class="n">download</span><span class="o">.</span><span class="n">download_and_transform</span><span class="p">(</span>
    <span class="n">collection_id_reanalysis</span><span class="p">,</span>
    <span class="n">requests_reanalysis_flat</span><span class="p">,</span>  
    <span class="n">transform_func</span><span class="o">=</span><span class="n">transform_reanalysis_data</span><span class="p">,</span> 
    <span class="n">invalidate_cache</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">drop_variables</span><span class="o">=</span><span class="s2">&quot;time_counter_bnds&quot;</span><span class="p">,</span>
    <span class="n">transform_func_kwargs</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;realizations&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>  
        <span class="s2">&quot;detrend&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;grid_request&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">collection_id_seasonal</span><span class="p">,</span> <span class="n">requests_seasonal</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
        <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="s2">&quot;conservative_normed&quot;</span><span class="p">,</span>
        <span class="s2">&quot;periodic&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s2">&quot;ignore_degenerate&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="n">transform_chunks</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">ds_reanalysis_trend</span> <span class="o">=</span> <span class="n">ds_reanalysis_trend</span><span class="o">.</span><span class="n">chunk</span><span class="p">({</span><span class="s1">&#39;year&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;month&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">})</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

<span class="n">ds_reanalysis</span> <span class="o">=</span> <span class="n">download</span><span class="o">.</span><span class="n">download_and_transform</span><span class="p">(</span>
    <span class="n">collection_id_reanalysis</span><span class="p">,</span>
    <span class="n">requests_reanalysis_flat</span><span class="p">,</span>  
    <span class="n">transform_func</span><span class="o">=</span><span class="n">transform_reanalysis_data</span><span class="p">,</span> 
    <span class="n">invalidate_cache</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">drop_variables</span><span class="o">=</span><span class="s2">&quot;time_counter_bnds&quot;</span><span class="p">,</span>
    <span class="n">transform_func_kwargs</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;realizations&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> 
        <span class="s2">&quot;detrend&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s2">&quot;grid_request&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">collection_id_seasonal</span><span class="p">,</span> <span class="n">requests_seasonal</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
        <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="s2">&quot;conservative_normed&quot;</span><span class="p">,</span>
        <span class="s2">&quot;periodic&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s2">&quot;ignore_degenerate&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="n">transform_chunks</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">ds_reanalysis</span> <span class="o">=</span> <span class="n">ds_reanalysis</span><span class="o">.</span><span class="n">chunk</span><span class="p">({</span><span class="s1">&#39;year&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;month&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">})</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

<span class="c1"># post processing: conversion and applying the common mask </span>
<span class="c1"># (the seas fc has an additional mask now, removing cold areas, </span>
<span class="c1"># computed before converted to anomalies )</span>
<span class="n">mask1</span> <span class="o">=</span> <span class="n">ds_reanalysis</span><span class="p">[</span><span class="s1">&#39;sohtc300&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">month</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">year</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span>
<span class="n">mask2</span> <span class="o">=</span> <span class="n">ds_seasonal</span><span class="p">[</span><span class="s1">&#39;thetaot300&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">month</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">year</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">realization</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span>

<span class="n">landice_mask</span><span class="o">=</span><span class="n">mask1</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">mask1</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">mask2</span> <span class="o">&lt;</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span><span class="o">+</span><span class="mi">1</span>

<span class="n">comask</span> <span class="o">=</span> <span class="n">landice_mask</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>

<span class="c1"># convert the seasonal values to potential temperature expressed as OHC</span>
<span class="n">ds_seasonal</span> <span class="o">=</span> <span class="n">ds_seasonal</span> <span class="o">*</span> <span class="n">heat_content_factor</span>
<span class="n">ds_seasonal_trend</span> <span class="o">=</span> <span class="n">ds_seasonal_trend</span> <span class="o">*</span> <span class="n">heat_content_factor</span>
<span class="c1"># reaname the variables</span>

<span class="n">ds_seasonal</span> <span class="o">=</span> <span class="n">ds_seasonal</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;thetaot300&#39;</span><span class="p">:</span> <span class="s1">&#39;sohtc300_anomalies&#39;</span><span class="p">})</span>
<span class="n">ds_reanalysis_trend</span> <span class="o">=</span> <span class="n">ds_reanalysis_trend</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">ds_seasonal_trend</span> <span class="o">=</span> <span class="n">ds_seasonal_trend</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;thetaot300&#39;</span><span class="p">:</span> <span class="s1">&#39;sohtc300_anomalies&#39;</span><span class="p">})</span>
<span class="n">ds_reanalysis</span> <span class="o">=</span> <span class="n">ds_reanalysis</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;sohtc300&#39;</span><span class="p">:</span> <span class="s1">&#39;sohtc300_anomalies&#39;</span><span class="p">})</span>
<span class="n">ds_reanalysis_trend</span> <span class="o">=</span> <span class="n">ds_reanalysis_trend</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;sohtc300&#39;</span><span class="p">:</span> <span class="s1">&#39;sohtc300_anomalies&#39;</span><span class="p">})</span>

<span class="c1">#add inn the common mask again, also using an ice-proxy from the seasonal fc data</span>
<span class="n">xr</span><span class="o">.</span><span class="n">set_options</span><span class="p">(</span><span class="n">keep_attrs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ds_seasonal</span><span class="p">[</span><span class="s1">&#39;sohtc300_anomalies&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds_seasonal</span><span class="p">[</span><span class="s1">&#39;sohtc300_anomalies&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">comask</span>
<span class="n">ds_seasonal_trend</span><span class="p">[</span><span class="s1">&#39;sohtc300_anomalies&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds_seasonal_trend</span><span class="p">[</span><span class="s1">&#39;sohtc300_anomalies&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">comask</span>
<span class="n">ds_reanalysis</span><span class="p">[</span><span class="s1">&#39;sohtc300_anomalies&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds_reanalysis</span><span class="p">[</span><span class="s1">&#39;sohtc300_anomalies&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">comask</span>
<span class="n">ds_reanalysis_trend</span><span class="p">[</span><span class="s1">&#39;sohtc300_anomalies&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds_reanalysis_trend</span><span class="p">[</span><span class="s1">&#39;sohtc300_anomalies&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">comask</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Building a flat list of unique reanalysis requests...
Found 155 unique months of reanalysis to download.
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="ohc-time-series-and-trend-analysis">
<span id="seasonal-seasonal-monthly-ocean-extremes-detection-q07-seasonal-ohc-section-2"></span><h3>2. OHC Time Series and Trend Analysis<a class="headerlink" href="#ohc-time-series-and-trend-analysis" title="Link to this heading">#</a></h3>
<p>Compares the model‚Äôs OHC and heatwave representation against the reanalysis. The time series of globally averaged OHC anomalies clearly shows a strong positive trend over the 1993-2023 period (<a class="reference internal" href="#seasonal-seasonal-monthly-ocean-extremes-detection-q07-ffig-anom-ts"><span class="std std-ref">Figure 2</span></a>). This warming trend is present in both the ORAS5 reanalysis and the M√©t√©o-France System 9 seasonal forecasts, though it is slighly stornger in M√©t√©o-France System 9. Because this predictable, long-term signal could artificially inflate skill scores, the linear trend is removed from both datasets for all subsequent heatwave and skill analyses. The detrended time series shows the interannual variability, such as the strong El Ni√±o events, more clearly.</p>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Time series plotting</span>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_regional_timeseries</span><span class="p">(</span><span class="n">seasonal_da</span><span class="p">,</span> <span class="n">reanalysis_da</span><span class="p">,</span> <span class="n">nino_box</span><span class="p">,</span> <span class="n">trend_status</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generates a 2-panel plot of global and Nino3.4 time series.&quot;&quot;&quot;</span>
    
    <span class="n">month_order</span> <span class="o">=</span> <span class="p">[</span><span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> 
    <span class="n">month_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Nov&#39;</span><span class="p">,</span> <span class="s1">&#39;Dec&#39;</span><span class="p">,</span> <span class="s1">&#39;Jan&#39;</span><span class="p">]</span>
    <span class="n">month_map</span> <span class="o">=</span> <span class="p">{</span><span class="mi">11</span><span class="p">:</span> <span class="s1">&#39;Nov&#39;</span><span class="p">,</span> <span class="mi">12</span><span class="p">:</span> <span class="s1">&#39;Dec&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;Jan&#39;</span><span class="p">}</span>
    
    <span class="c1"># Sort the data </span>
    <span class="n">seasonal_da</span> <span class="o">=</span> <span class="n">seasonal_da</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">month</span><span class="o">=</span><span class="n">month_order</span><span class="p">)</span>
    <span class="n">reanalysis_da</span> <span class="o">=</span> <span class="n">reanalysis_da</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">month</span><span class="o">=</span><span class="n">month_order</span><span class="p">)</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">reanalysis_da</span><span class="p">[</span><span class="s1">&#39;latitude&#39;</span><span class="p">]))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">weights</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;weights&quot;</span>
    
    <span class="c1"># Perform the mean operations (using ensemble mean for forecast)</span>
    <span class="n">s_global</span> <span class="o">=</span> <span class="n">seasonal_da</span><span class="o">.</span><span class="n">weighted</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="s1">&#39;latitude&#39;</span><span class="p">,</span> <span class="s1">&#39;longitude&#39;</span><span class="p">])</span>
    <span class="n">r_global</span> <span class="o">=</span> <span class="n">reanalysis_da</span><span class="o">.</span><span class="n">weighted</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="s1">&#39;latitude&#39;</span><span class="p">,</span> <span class="s1">&#39;longitude&#39;</span><span class="p">])</span>
    <span class="n">s_nino</span> <span class="o">=</span> <span class="n">seasonal_da</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="o">**</span><span class="n">nino_box</span><span class="p">)</span><span class="o">.</span><span class="n">weighted</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="s1">&#39;latitude&#39;</span><span class="p">,</span> <span class="s1">&#39;longitude&#39;</span><span class="p">])</span>
    <span class="n">r_nino</span> <span class="o">=</span> <span class="n">reanalysis_da</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="o">**</span><span class="n">nino_box</span><span class="p">)</span><span class="o">.</span><span class="n">weighted</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="s1">&#39;latitude&#39;</span><span class="p">,</span> <span class="s1">&#39;longitude&#39;</span><span class="p">])</span>

    <span class="c1"># --- Compute Monthly Correlations ---</span>
    <span class="c1"># We take the ensemble mean of the forecast first, then correlate with reanalysis per month</span>
    <span class="n">s_global_mean</span> <span class="o">=</span> <span class="n">s_global</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s1">&#39;realization&#39;</span><span class="p">)</span>
    <span class="n">s_nino_mean</span> <span class="o">=</span> <span class="n">s_nino</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s1">&#39;realization&#39;</span><span class="p">)</span>

    <span class="c1"># This produces a correlation value for each month [11, 12, 1]</span>
    <span class="n">corr_global_monthly</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">r_global</span><span class="p">,</span> <span class="n">s_global_mean</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="s1">&#39;year&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
    <span class="n">corr_nino_monthly</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">r_nino</span><span class="p">,</span> <span class="n">s_nino_mean</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="s1">&#39;year&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>

    <span class="c1"># Format the correlation strings for the title</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">format_corr_str</span><span class="p">(</span><span class="n">corr_da</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">month_map</span><span class="p">[</span><span class="n">m</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">corr_da</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">month</span><span class="o">=</span><span class="n">m</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">month_order</span><span class="p">])</span>

    <span class="n">title_global</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Global Mean | r = </span><span class="si">{</span><span class="n">format_corr_str</span><span class="p">(</span><span class="n">corr_global_monthly</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">title_nino</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Ni√±o 3.4 Region | r = </span><span class="si">{</span><span class="n">format_corr_str</span><span class="p">(</span><span class="n">corr_nino_monthly</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="c1"># --- Plotting ---</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;NDJ OHC Anomalies (</span><span class="si">{</span><span class="n">trend_status</span><span class="si">}</span><span class="s2">) - Forecasts vs. ORAS5 (bold)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>

    <span class="c1"># Convert to DataFrames for seaborn</span>
    <span class="n">s_global_df</span> <span class="o">=</span> <span class="n">s_global</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;anomaly&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span> 
    <span class="n">r_global_df</span> <span class="o">=</span> <span class="n">r_global</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;anomaly&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="n">s_nino_df</span> <span class="o">=</span> <span class="n">s_nino</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;anomaly&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="n">r_nino_df</span> <span class="o">=</span> <span class="n">r_nino</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;anomaly&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="p">[</span><span class="n">s_global_df</span><span class="p">,</span> <span class="n">r_global_df</span><span class="p">,</span> <span class="n">s_nino_df</span><span class="p">,</span> <span class="n">r_nino_df</span><span class="p">]:</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;month_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;month&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">month_map</span><span class="p">),</span> <span class="n">categories</span><span class="o">=</span><span class="n">month_names</span><span class="p">,</span> <span class="n">ordered</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Panel 0: Global</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">stripplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">s_global_df</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;year&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;anomaly&quot;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s2">&quot;month_name&quot;</span><span class="p">,</span> <span class="n">dodge</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">.3</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="s2">&quot;muted&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">stripplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">r_global_df</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;year&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;anomaly&quot;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s2">&quot;month_name&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">palette</span><span class="o">=</span><span class="s2">&quot;dark&quot;</span><span class="p">,</span> <span class="n">dodge</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title_global</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;OHC Anomaly [J/m¬≤]&quot;</span><span class="p">)</span>

    <span class="c1"># Panel 1: Nino 3.4</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">stripplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">s_nino_df</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;year&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;anomaly&quot;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s2">&quot;month_name&quot;</span><span class="p">,</span> <span class="n">dodge</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">.3</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="s2">&quot;muted&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">stripplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">r_nino_df</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;year&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;anomaly&quot;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s2">&quot;month_name&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">palette</span><span class="o">=</span><span class="s2">&quot;dark&quot;</span><span class="p">,</span> <span class="n">dodge</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title_nino</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;OHC Anomaly [J/m¬≤]&quot;</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">rect</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">])</span>

<span class="c1"># --- Execute plotting ---</span>
<span class="n">ds_s_trend_ndj</span> <span class="o">=</span> <span class="n">ds_seasonal_trend</span><span class="p">[</span><span class="s1">&#39;sohtc300_anomalies&#39;</span><span class="p">]</span>
<span class="n">ds_r_trend_ndj</span> <span class="o">=</span> <span class="n">ds_reanalysis_trend</span><span class="p">[</span><span class="s1">&#39;sohtc300_anomalies&#39;</span><span class="p">]</span>

<span class="n">ds_s_trend_ndj</span> <span class="o">=</span> <span class="n">ds_s_trend_ndj</span><span class="o">.</span><span class="n">chunk</span><span class="p">({</span><span class="s1">&#39;year&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;month&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;realization&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
<span class="n">ds_r_trend_ndj</span> <span class="o">=</span> <span class="n">ds_r_trend_ndj</span><span class="o">.</span><span class="n">chunk</span><span class="p">({</span><span class="s1">&#39;year&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;month&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">})</span>
 
<span class="n">plot_regional_timeseries</span><span class="p">(</span><span class="n">ds_s_trend_ndj</span><span class="p">,</span> <span class="n">ds_r_trend_ndj</span><span class="p">,</span> <span class="n">nino_box</span><span class="p">,</span> <span class="n">trend_status</span><span class="o">=</span><span class="s2">&quot;With Trend&quot;</span><span class="p">)</span>

<span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">();</span>

<span class="n">ds_s_ndj</span> <span class="o">=</span> <span class="n">ds_seasonal</span><span class="p">[</span><span class="s1">&#39;sohtc300_anomalies&#39;</span><span class="p">]</span>
<span class="n">ds_r_ndj</span> <span class="o">=</span> <span class="n">ds_reanalysis</span><span class="p">[</span><span class="s1">&#39;sohtc300_anomalies&#39;</span><span class="p">]</span>

<span class="n">ds_s_ndj</span> <span class="o">=</span> <span class="n">ds_s_ndj</span><span class="o">.</span><span class="n">chunk</span><span class="p">({</span><span class="s1">&#39;year&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;month&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;realization&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
<span class="n">ds_r_ndj</span> <span class="o">=</span> <span class="n">ds_r_ndj</span><span class="o">.</span><span class="n">chunk</span><span class="p">({</span><span class="s1">&#39;year&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;month&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">})</span>

<span class="n">plot_regional_timeseries</span><span class="p">(</span><span class="n">ds_s_ndj</span><span class="p">,</span> <span class="n">ds_r_ndj</span><span class="p">,</span> <span class="n">nino_box</span><span class="p">,</span> <span class="n">trend_status</span><span class="o">=</span><span class="s2">&quot;Detrended&quot;</span><span class="p">)</span>

<span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">();</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/1188bfa58cbcdf291abffef346e70bfd9f48e5cbc1c59c70ccd3a8e9e8dc31b3.png" src="../_images/1188bfa58cbcdf291abffef346e70bfd9f48e5cbc1c59c70ccd3a8e9e8dc31b3.png" />
<img alt="../_images/0497ad76cd93ad3f87d57561311bf81ee732fd4f1bcc8656a5f8be443837ce4e.png" src="../_images/0497ad76cd93ad3f87d57561311bf81ee732fd4f1bcc8656a5f8be443837ce4e.png" />
</div>
</div>
<section id="figure-2">
<span id="seasonal-seasonal-monthly-ocean-extremes-detection-q07-ffig-anom-ts"></span><h4>Figure 2<a class="headerlink" href="#figure-2" title="Link to this heading">#</a></h4>
<p>Annual time series of reanalysis and forecast anomalies according to calendar month. The forceast fields have a nominal start date October 1st. The single dots with a stronger color shows the reanalysis data, while the more lightly colored plot clouds show the seasonal forecasts (one dot per realization). The upper two rows show the anomalies in the original time-series for the global and Ni√±o3.4 area, while the lower panels show the detrended data. The subplot-titles provide the Pearson correlation coefficients of the area averaged anomalies. Note that the y-axis range varies.</p>
<hr class="docutils" />
</section>
</section>
<section id="model-performance-vs-reanalysis">
<span id="seasonal-seasonal-monthly-ocean-extremes-detection-q07-seasonal-ohc-section-3"></span><h3>3. Model Performance vs. Reanalysis<a class="headerlink" href="#model-performance-vs-reanalysis" title="Link to this heading">#</a></h3>
<p>This section directly compares the model‚Äôs OHC and heatwave representation against the reanalysis, after having detrended both.</p>
<section id="correlation-of-ohc-anomalies">
<h4>Correlation of OHC Anomalies<a class="headerlink" href="#correlation-of-ohc-anomalies" title="Link to this heading">#</a></h4>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">del</span>  <span class="n">ds_seasonal_trend</span><span class="p">,</span> <span class="n">ds_reanalysis_trend</span><span class="p">,</span> <span class="n">ds_r_trend_ndj</span><span class="p">,</span><span class="n">ds_s_trend_ndj</span>

<span class="c1"># --- 1. Compute monthly correlations ---</span>
<span class="c1"># Compute Pearson correlation between reanalysis and forecast ensemble mean per calendar month</span>
<span class="n">months_to_do</span> <span class="o">=</span> <span class="p">[</span><span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">month_names</span> <span class="o">=</span> <span class="p">{</span><span class="mi">11</span><span class="p">:</span> <span class="s1">&#39;November &#39;</span><span class="p">,</span> <span class="mi">12</span><span class="p">:</span> <span class="s1">&#39;December &#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;January &#39;</span><span class="p">}</span>

<span class="n">correlation_maps</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span>
    <span class="n">ds_reanalysis</span><span class="p">[</span><span class="s1">&#39;sohtc300_anomalies&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">month</span><span class="o">=</span><span class="n">months_to_do</span><span class="p">),</span>
    <span class="n">ds_seasonal</span><span class="p">[</span><span class="s1">&#39;sohtc300_anomalies&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">month</span><span class="o">=</span><span class="n">months_to_do</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s1">&#39;realization&#39;</span><span class="p">),</span>
    <span class="n">dim</span><span class="o">=</span><span class="s1">&#39;year&#39;</span>
<span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>  <span class="c1"># Keeps &#39;month&#39; dimension for lead-time comparison</span>

<span class="c1"># --- 2. Visualization (3-panel plot) ---</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
    <span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">22</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span> 
    <span class="n">subplot_kw</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;projection&#39;</span><span class="p">:</span> <span class="n">ccrs</span><span class="o">.</span><span class="n">Robinson</span><span class="p">()}</span>
<span class="p">)</span>

<span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;viridis&#39;</span><span class="p">)</span>
<span class="n">cmap</span><span class="o">.</span><span class="n">set_bad</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span> <span class="c1"># Handle land/mask values</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">month</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">months_to_do</span><span class="p">):</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    
    <span class="c1"># Extract correlation map for the specific lead month</span>
    <span class="n">curr_corr</span> <span class="o">=</span> <span class="n">correlation_maps</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">month</span><span class="o">=</span><span class="n">month</span><span class="p">)</span>
    
    <span class="c1"># Plot correlation</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">curr_corr</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
        <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> 
        <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">(),</span> 
        <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> 
        <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">add_colorbar</span><span class="o">=</span><span class="kc">False</span> <span class="c1"># Shared colorbar added below</span>
    <span class="p">)</span>
    
    <span class="c1"># Map configuration</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">coastlines</span><span class="p">()</span>
    <span class="k">if</span> <span class="s1">&#39;setup_map_plot&#39;</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span>
        <span class="n">setup_map_plot</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
    
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">month_names</span><span class="p">[</span><span class="n">month</span><span class="p">],</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>

<span class="c1"># Add shared horizontal colorbar at the bottom</span>
<span class="n">cbar_ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.03</span><span class="p">])</span> <span class="c1"># [left, bottom, width, height]</span>
<span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cbar_ax</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;horizontal&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Pearson&#39;s r&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;1994-2023 OHC ACC per Calendar Month&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.95</span><span class="p">)</span>

<span class="c1"># Clean up memory</span>
<span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">();</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/data/common/miniforge3/envs/wp3/lib/python3.12/site-packages/dask/array/numpy_compat.py:58: RuntimeWarning: invalid value encountered in divide
  x = np.divide(x1, x2, out)
</pre></div>
</div>
<img alt="../_images/b46d23453ee10927c05daec19df2f41331e187932b8f62616d39a6d6eba4886f.png" src="../_images/b46d23453ee10927c05daec19df2f41331e187932b8f62616d39a6d6eba4886f.png" />
</div>
</div>
<section id="figure-3">
<span id="seasonal-seasonal-monthly-ocean-extremes-detection-q07-fig-corr-map"></span><h5>Figure 3<a class="headerlink" href="#figure-3" title="Link to this heading">#</a></h5>
<p>Map plot showing the temporal anomaly correlation coefficients (Pearson‚Äôs) between the forecast ensemble mean and the reanalysis 1993-2023 NDJ OHC every valid grid box.</p>
</section>
</section>
<hr class="docutils" />
<section id="comparison-of-distributions">
<h4>Comparison of distributions<a class="headerlink" href="#comparison-of-distributions" title="Link to this heading">#</a></h4>
<p>We inspect the OHC anomalies in the two data sources to see if they share a similar distribution. We look at November, December, and January simultaneously and pool the seasonal forecast ensemble members. Identical distributions and tails would allow for the use of the same physical magnitudes for a heatwave threshold.</p>
<p>The differences in the probability density functions, the longer tails in the reanalysis versus the more blunt tails in the forecasts justify the use of relative heatwave thresholds depending on the specific data source.</p>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">compare_anomaly_statistics_weighted</span><span class="p">(</span><span class="n">ds_seasonal</span><span class="p">,</span> <span class="n">ds_reanalysis</span><span class="p">,</span> <span class="n">comask</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compares the distribution of OHC anomalies using area-weighting and subsampling.</span>
<span class="sd">    Includes Kurtosis to describe the &#39;Leptokurtic&#39; (thin) vs &#39;Platykurtic&#39; (not-thin) </span>
<span class="sd">    nature of the variability tails. </span>
<span class="sd">    The data is spatially subsampled to reduce the computational cost.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting statistical analysis (subsampling step: </span><span class="si">{</span><span class="n">step</span><span class="si">}</span><span class="s2">)...&quot;</span><span class="p">)</span>

    <span class="c1"># 1. Data Selection (NDJ) and Masking</span>
    <span class="c1"># Selecting late autumn/winter months and applying the common ocean mask</span>
    <span class="n">da_s</span> <span class="o">=</span> <span class="n">ds_seasonal</span><span class="p">[</span><span class="s1">&#39;sohtc300_anomalies&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">month</span><span class="o">=</span><span class="p">[</span><span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">comask</span><span class="o">.</span><span class="n">notnull</span><span class="p">())</span>
    <span class="n">da_r</span> <span class="o">=</span> <span class="n">ds_reanalysis</span><span class="p">[</span><span class="s1">&#39;sohtc300_anomalies&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">month</span><span class="o">=</span><span class="p">[</span><span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">comask</span><span class="o">.</span><span class="n">notnull</span><span class="p">())</span>

    <span class="c1"># 2. Spatial Subsampling</span>
    <span class="c1"># Compute early to bring data into memory for weighted statistics and quantiles</span>
    <span class="n">da_s_sub</span> <span class="o">=</span> <span class="n">da_s</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">latitude</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">step</span><span class="p">),</span> <span class="n">longitude</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">step</span><span class="p">))</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
    <span class="n">da_r_sub</span> <span class="o">=</span> <span class="n">da_r</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">latitude</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">step</span><span class="p">),</span> <span class="n">longitude</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">step</span><span class="p">))</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>

    <span class="c1"># 3. Area Weights Calculation</span>
    <span class="c1"># Using cosine of latitude to account for grid cell area convergence at poles</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">da_s_sub</span><span class="o">.</span><span class="n">latitude</span><span class="p">))</span>
    
    <span class="c1"># Broadcast weights to match the 2D/3D shape of the data for flattening</span>
    <span class="n">weights_s</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">broadcast_like</span><span class="p">(</span><span class="n">da_s_sub</span><span class="p">)</span>
    <span class="n">weights_r</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">broadcast_like</span><span class="p">(</span><span class="n">da_r_sub</span><span class="p">)</span>

    <span class="c1"># 4. Compute Weighted Statistics</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Computing weighted statistics...&quot;</span><span class="p">)</span>
    <span class="n">std_s</span> <span class="o">=</span> <span class="n">da_s_sub</span><span class="o">.</span><span class="n">weighted</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
    <span class="n">std_r</span> <span class="o">=</span> <span class="n">da_r_sub</span><span class="o">.</span><span class="n">weighted</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>

    <span class="c1"># Calculate weighted quantiles for the Q-Q plot (focusing on the extreme upper tail)</span>
    <span class="n">q_levels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.85</span><span class="p">,</span> <span class="mf">0.99</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
    <span class="n">s_quant</span> <span class="o">=</span> <span class="n">da_s_sub</span><span class="o">.</span><span class="n">weighted</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">q_levels</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
    <span class="n">r_quant</span> <span class="o">=</span> <span class="n">da_r_sub</span><span class="o">.</span><span class="n">weighted</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">q_levels</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>

    <span class="c1"># 5. Prepare Data for PDF/Kurtosis (flattening and dropping NaNs)</span>
    <span class="n">s_vals</span> <span class="o">=</span> <span class="n">da_s_sub</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">s_w</span>    <span class="o">=</span> <span class="n">weights_s</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">mask_s</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">s_vals</span><span class="p">)</span>
    <span class="n">s_vals</span><span class="p">,</span> <span class="n">s_w</span> <span class="o">=</span> <span class="n">s_vals</span><span class="p">[</span><span class="n">mask_s</span><span class="p">],</span> <span class="n">s_w</span><span class="p">[</span><span class="n">mask_s</span><span class="p">]</span>

    <span class="n">r_vals</span> <span class="o">=</span> <span class="n">da_r_sub</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">r_w</span>    <span class="o">=</span> <span class="n">weights_r</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">mask_r</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">r_vals</span><span class="p">)</span>
    <span class="n">r_vals</span><span class="p">,</span> <span class="n">r_w</span> <span class="o">=</span> <span class="n">r_vals</span><span class="p">[</span><span class="n">mask_r</span><span class="p">],</span> <span class="n">r_w</span><span class="p">[</span><span class="n">mask_r</span><span class="p">]</span>

    <span class="c1"># Calculate Fisher Kurtosis (Normal distribution = 0)</span>
    <span class="c1"># Positive = Leptokurtic (fat tails), Negative = Platykurtic (thin tails)</span>
    <span class="n">kurt_s</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">kurtosis</span><span class="p">(</span><span class="n">s_vals</span><span class="p">)</span>
    <span class="n">kurt_r</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">kurtosis</span><span class="p">(</span><span class="n">r_vals</span><span class="p">)</span>

    <span class="c1"># Kolmogorov-Smirnov test (unweighted) to check if distributions are identical</span>
    <span class="n">ks_stat</span><span class="p">,</span> <span class="n">ks_p</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">ks_2samp</span><span class="p">(</span><span class="n">s_vals</span><span class="p">,</span> <span class="n">r_vals</span><span class="p">)</span>

    <span class="c1"># Calculate the number of ensemble members</span>
    <span class="n">n_members</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ds_seasonal</span><span class="o">.</span><span class="n">realization</span><span class="p">)</span>
    
    <span class="c1"># Calculate points per realization for the forecast</span>
    <span class="n">points_per_member</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s_vals</span><span class="p">)</span> <span class="o">/</span> <span class="n">n_members</span>

    <span class="c1"># Printing Results Table</span>
    <span class="n">stats_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="s1">&#39;Metric&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;StdDev (J/m¬≤)&#39;</span><span class="p">,</span> <span class="s1">&#39;Kurtosis&#39;</span><span class="p">,</span> <span class="s1">&#39;Total Points&#39;</span><span class="p">,</span> <span class="s1">&#39;Points per Member&#39;</span><span class="p">],</span>
        <span class="s1">&#39;Forecast (S9)&#39;</span><span class="p">:</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">std_s</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">kurt_s</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">s_vals</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">points_per_member</span><span class="p">)],</span>
        <span class="s1">&#39;Reanalysis (ORAS5)&#39;</span><span class="p">:</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">std_r</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">kurt_r</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">r_vals</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">r_vals</span><span class="p">)]</span>
    <span class="p">})</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Statistics Summary ---&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">stats_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;K-S Test p-value: </span><span class="si">{</span><span class="n">ks_p</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># 7. Visualization</span>
    <span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
    
    <span class="c1"># Left: Area-Weighted Probability Density Function (KDE)</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">s_vals</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">s_w</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Forecast (System 9)&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">r_vals</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">r_w</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Reanalysis (ORAS5)&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Area-Weighted Anomaly PDFs&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;OHC Anomaly [J/m¬≤]&quot;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    
    <span class="c1"># Right: Q-Q Plot for the Upper Tail Comparison</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">r_quant</span><span class="p">,</span> <span class="n">s_quant</span><span class="p">,</span> <span class="s1">&#39;ko-&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Weighted Quantiles&#39;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="nb">min</span><span class="p">(</span><span class="n">r_quant</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">r_quant</span><span class="p">)],</span> <span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">r_quant</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">r_quant</span><span class="p">)],</span> <span class="s1">&#39;r--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;1:1 Line&#39;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Upper Tail Comparison (85th to 99th percentile)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Reanalysis Quantiles [J/m¬≤]&quot;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Forecast Quantiles [J/m¬≤]&quot;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Execution call</span>
<span class="n">compare_anomaly_statistics_weighted</span><span class="p">(</span><span class="n">ds_seasonal</span><span class="p">,</span> <span class="n">ds_reanalysis</span><span class="p">,</span> <span class="n">comask</span><span class="o">=</span><span class="n">comask</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Starting statistical analysis (subsampling step: 5)...
Computing weighted statistics...

--- Statistics Summary ---
           Metric Forecast (S9) Reanalysis (ORAS5)
    StdDev (J/m¬≤)      6.40e+08           6.71e+08
         Kurtosis          4.18               6.50
     Total Points       3687357             118947
Points per Member        118947             118947
K-S Test p-value: 1.73e-47
</pre></div>
</div>
<img alt="../_images/3dc66e2cf7d4c27583713dd7d66f28638f276855228b25684469875a34d73683.png" src="../_images/3dc66e2cf7d4c27583713dd7d66f28638f276855228b25684469875a34d73683.png" />
</div>
</div>
<section id="figure-4">
<span id="seasonal-seasonal-monthly-ocean-extremes-detection-q07-fig-pdfs"></span><h5>Figure 4<a class="headerlink" href="#figure-4" title="Link to this heading">#</a></h5>
<p>Distribution analysis of pooled OHC anomalies for the NDJ season. The left plot shows the area-weighted probability density functions (PDFs) for the forecast (blue) and reanalysis (red), where the broader ‚Äúshoulders‚Äù of the blue curve indicate a blunter distribution. The right plot shows a quantile-quantile comparison of the upper tail (<span class="math notranslate nohighlight">\(P_{85}\)</span> to <span class="math notranslate nohighlight">\(P_{99}\)</span>) of the two data sources. The black line falling below the diagonal indicate higher intensity values (longer tails) in the reanalysis data compared to the forecast.</p>
</section>
</section>
<hr class="docutils" />
<section id="comparison-of-heatwave-representation">
<h4>Comparison of Heatwave Representation<a class="headerlink" href="#comparison-of-heatwave-representation" title="Link to this heading">#</a></h4>
<p><strong>Heatwaves</strong> are defined as monthly anomalies exceeding a 90th percentile threshold. The thresholds are calculated from a three-month centered moving window, and separately for each data source. For reanalysis data, the threshold is calculated across all years at each grid point. For the seasonal forecast, the threshold is calculated across all years and all ensemble members at each grid point.</p>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">calculate_heatwave_masks</span><span class="p">(</span><span class="n">ds_seasonal</span><span class="p">,</span> <span class="n">ds_reanalysis</span><span class="p">,</span> <span class="n">comask</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates binary heatwave masks using a 90th percentile threshold </span>
<span class="sd">    derived from a 3-month centered rolling window.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># --- 1. Data Preparation ---</span>
    <span class="n">da_r</span> <span class="o">=</span> <span class="n">ds_reanalysis</span><span class="p">[</span><span class="s1">&#39;sohtc300_anomalies&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">chunk</span><span class="p">({</span><span class="o">**</span><span class="n">spatial_chunks</span><span class="p">,</span> <span class="o">**</span><span class="n">time_chunks</span><span class="p">})</span>
    <span class="n">da_s</span> <span class="o">=</span> <span class="n">ds_seasonal</span><span class="p">[</span><span class="s1">&#39;sohtc300_anomalies&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">chunk</span><span class="p">({</span><span class="o">**</span><span class="n">spatial_chunks</span><span class="p">,</span> <span class="s1">&#39;realization&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">time_chunks</span><span class="p">})</span>

    <span class="c1"># --- 2. Threshold Calculation (Centered Windows) ---</span>
    <span class="n">months</span> <span class="o">=</span> <span class="p">[</span><span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">month_labels</span> <span class="o">=</span> <span class="p">{</span><span class="mi">11</span><span class="p">:</span> <span class="s1">&#39;Nov &#39;</span><span class="p">,</span> <span class="mi">12</span><span class="p">:</span> <span class="s1">&#39;Dec &#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;Jan &#39;</span><span class="p">}</span>

    <span class="c1"># Reanalysis thresholds (ORAS5 reference)</span>
    <span class="n">p90_r_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">da_r</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">month</span><span class="o">=</span><span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">])</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;month&#39;</span><span class="p">,</span> <span class="s1">&#39;year&#39;</span><span class="p">],</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;higher&quot;</span><span class="p">),</span>
        <span class="n">da_r</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">month</span><span class="o">=</span><span class="p">[</span><span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;month&#39;</span><span class="p">,</span> <span class="s1">&#39;year&#39;</span><span class="p">],</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;higher&quot;</span><span class="p">),</span>
        <span class="n">da_r</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">month</span><span class="o">=</span><span class="p">[</span><span class="mi">12</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;month&#39;</span><span class="p">,</span> <span class="s1">&#39;year&#39;</span><span class="p">],</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;higher&quot;</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="n">p90_r_lazy</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">p90_r_list</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="s1">&#39;month&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">month</span><span class="o">=</span><span class="n">months</span><span class="p">)</span>

    <span class="c1"># Seasonal Forecast thresholds (System 9)</span>
    <span class="n">p90_s_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">da_s</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">month</span><span class="o">=</span><span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">])</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;month&#39;</span><span class="p">,</span> <span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="s1">&#39;realization&#39;</span><span class="p">]),</span>
        <span class="n">da_s</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">month</span><span class="o">=</span><span class="p">[</span><span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;month&#39;</span><span class="p">,</span> <span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="s1">&#39;realization&#39;</span><span class="p">]),</span>
        <span class="n">da_s</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">month</span><span class="o">=</span><span class="p">[</span><span class="mi">12</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;month&#39;</span><span class="p">,</span> <span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="s1">&#39;realization&#39;</span><span class="p">])</span>
    <span class="p">]</span>
    <span class="n">p90_s_lazy</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">p90_s_list</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="s1">&#39;month&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">month</span><span class="o">=</span><span class="n">months</span><span class="p">)</span>

    <span class="c1"># Compute p90 values</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Computing p90 thresholds...&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="n">p90_r</span><span class="p">,</span> <span class="n">p90_s</span><span class="p">)</span> <span class="o">=</span> <span class="n">dask_compute</span><span class="p">(</span><span class="n">p90_r_lazy</span><span class="p">,</span> <span class="n">p90_s_lazy</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Thresholds computed.&quot;</span><span class="p">)</span>

    <span class="c1"># --- 3. Unified Scaling and Plotting (2x3 Grid) ---</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
        <span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">22</span><span class="p">,</span> <span class="mi">12</span><span class="p">),</span>
        <span class="n">subplot_kw</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;projection&#39;</span><span class="p">:</span> <span class="n">ccrs</span><span class="o">.</span><span class="n">Robinson</span><span class="p">()}</span>
    <span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;p90 Threshold Comparison: Reanalysis (top) vs. Forecast (bottom)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    
    <span class="c1"># Unified color limits for all 6 panels to ensure fair comparison</span>
    <span class="n">combined_data</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">p90_r</span><span class="p">,</span> <span class="n">p90_s</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="s1">&#39;src&#39;</span><span class="p">)</span>
    <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanpercentile</span><span class="p">(</span><span class="n">combined_data</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">98</span><span class="p">])</span> 
    
    <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;viridis&#39;</span><span class="p">)</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">p90_r</span><span class="p">[</span><span class="s1">&#39;latitude&#39;</span><span class="p">]))</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">months</span><span class="p">):</span>
        <span class="c1"># Row 0: Reanalysis Reference (ORAS5)</span>
        <span class="n">ax_r</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">p90_r</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">month</span><span class="o">=</span><span class="n">m</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">ax</span><span class="o">=</span><span class="n">ax_r</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">(),</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> 
            <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span> <span class="n">add_colorbar</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="n">r_mean</span> <span class="o">=</span> <span class="n">p90_r</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">month</span><span class="o">=</span><span class="n">m</span><span class="p">)</span><span class="o">.</span><span class="n">weighted</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="n">ax_r</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reanalysis </span><span class="si">{</span><span class="n">month_labels</span><span class="p">[</span><span class="n">m</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">Global Mean: </span><span class="si">{</span><span class="n">r_mean</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">setup_map_plot</span><span class="p">(</span><span class="n">ax_r</span><span class="p">)</span>

        <span class="c1"># Row 1: Forecast Thresholds (System 9)</span>
        <span class="n">ax_s</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span>
        <span class="n">p90_s</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">month</span><span class="o">=</span><span class="n">m</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">ax</span><span class="o">=</span><span class="n">ax_s</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">(),</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> 
            <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span> <span class="n">add_colorbar</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="n">s_mean</span> <span class="o">=</span> <span class="n">p90_s</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">month</span><span class="o">=</span><span class="n">m</span><span class="p">)</span><span class="o">.</span><span class="n">weighted</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="n">ax_s</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Forecast </span><span class="si">{</span><span class="n">month_labels</span><span class="p">[</span><span class="n">m</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">Global Mean: </span><span class="si">{</span><span class="n">s_mean</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">setup_map_plot</span><span class="p">(</span><span class="n">ax_s</span><span class="p">)</span>

    <span class="c1"># Shared colorbar for all subplots</span>
    <span class="n">cbar_ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.08</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">])</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cbar_ax</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;horizontal&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;OHC Anomaly [J/m¬≤]&#39;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">bottom</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="mf">0.92</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

    <span class="c1"># --- 4. Mask Generation ---</span>
    <span class="n">fill_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">(</span><span class="o">-</span><span class="mi">99</span><span class="p">)</span>
    <span class="n">da_r_ndj</span> <span class="o">=</span> <span class="n">da_r</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">month</span><span class="o">=</span><span class="n">months</span><span class="p">)</span>
    <span class="n">da_s_ndj</span> <span class="o">=</span> <span class="n">da_s</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">month</span><span class="o">=</span><span class="n">months</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Generating heatwave masks...&quot;</span><span class="p">)</span>
    <span class="n">masks_s_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">da_s</span><span class="p">[</span><span class="s1">&#39;realization&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
        <span class="n">m_s</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">da_s_ndj</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">realization</span><span class="o">=</span><span class="n">r</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">p90_s</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="n">m_s</span> <span class="o">=</span> <span class="n">m_s</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">comask</span><span class="o">.</span><span class="n">notnull</span><span class="p">())</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">fill_value</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
        <span class="n">masks_s_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m_s</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">realization</span><span class="o">=</span><span class="p">[</span><span class="n">r</span><span class="p">]))</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

    <span class="n">heatwave_mask_forecast</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">masks_s_list</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="s1">&#39;realization&#39;</span><span class="p">)</span>
    
    <span class="n">mask_r_lazy</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">da_r_ndj</span> <span class="o">&gt;</span> <span class="n">p90_r</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
    <span class="n">heatwave_mask_reanalysis</span> <span class="o">=</span> <span class="n">mask_r_lazy</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">comask</span><span class="o">.</span><span class="n">notnull</span><span class="p">())</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">fill_value</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
 
    <span class="n">heatwave_mask_reanalysis</span><span class="o">.</span><span class="n">encoding</span><span class="p">[</span><span class="s1">&#39;_FillValue&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fill_value</span>
    <span class="n">heatwave_mask_forecast</span><span class="o">.</span><span class="n">encoding</span><span class="p">[</span><span class="s1">&#39;_FillValue&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fill_value</span>
    
    <span class="k">return</span> <span class="n">heatwave_mask_forecast</span><span class="p">,</span> <span class="n">heatwave_mask_reanalysis</span>

<span class="c1"># --- Call the function ---</span>
<span class="n">heatwave_mask_forecast</span><span class="p">,</span> <span class="n">heatwave_mask_reanalysis</span> <span class="o">=</span> <span class="n">calculate_heatwave_masks</span><span class="p">(</span>
    <span class="n">ds_seasonal</span><span class="p">,</span>  
    <span class="n">ds_reanalysis</span><span class="p">,</span>     
    <span class="n">comask</span>
<span class="p">)</span>

<span class="c1"># Clean up</span>
<span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">();</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Computing p90 thresholds...
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/data/common/miniforge3/envs/wp3/lib/python3.12/site-packages/numpy/lib/_nanfunctions_impl.py:1617: RuntimeWarning: All-NaN slice encountered
  return fnb._ureduce(a,
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Thresholds computed.
Generating heatwave masks...
</pre></div>
</div>
<img alt="../_images/aa74452e7078d8072ade0acf45346d2e7baac3d59925a34b2e6f988f18149efc.png" src="../_images/aa74452e7078d8072ade0acf45346d2e7baac3d59925a34b2e6f988f18149efc.png" />
</div>
</div>
<section id="figure-5">
<h5>Figure 5<a class="headerlink" href="#figure-5" title="Link to this heading">#</a></h5>
<p>Map plot showing the definition of heatwave (or the grid cell threshold to be exceeded) in the OHC anomalies for the seasonal forecasts (left) and the reanalysis (right).</p>
</section>
</section>
<hr class="docutils" />
<section id="diagnostic-plots-we-choose-1997-as-our-year-to-inspect-the-spatial-patterns-of-the-anomalies">
<h4>Diagnostic Plots. We choose 1997 as our year to inspect the spatial patterns of the anomalies.<a class="headerlink" href="#diagnostic-plots-we-choose-1997-as-our-year-to-inspect-the-spatial-patterns-of-the-anomalies" title="Link to this heading">#</a></h4>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">plot_monthly_anomalies_3x3</span><span class="p">(</span><span class="n">ds_seasonal</span><span class="p">,</span> <span class="n">ds_reanalysis</span><span class="p">,</span> <span class="n">year</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plots a 3x3 grid for a specific year (e.g., 1997).</span>
<span class="sd">    Columns: November, December, January</span>
<span class="sd">    Rows: Forecast, Reanalysis, Difference</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">months</span> <span class="o">=</span> <span class="p">[</span><span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">month_names</span> <span class="o">=</span> <span class="p">{</span><span class="mi">11</span><span class="p">:</span> <span class="s1">&#39;November&#39;</span><span class="p">,</span> <span class="mi">12</span><span class="p">:</span> <span class="s1">&#39;December&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;January&#39;</span><span class="p">}</span>
    
    <span class="c1"># --- 1. Selection &amp; Computation ---</span>
    <span class="n">da_s</span> <span class="o">=</span> <span class="n">ds_seasonal</span><span class="p">[</span><span class="s1">&#39;sohtc300_anomalies&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="o">=</span><span class="n">months</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s1">&#39;realization&#39;</span><span class="p">)</span>
    <span class="n">da_r</span> <span class="o">=</span> <span class="n">ds_reanalysis</span><span class="p">[</span><span class="s1">&#39;sohtc300_anomalies&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="o">=</span><span class="n">months</span><span class="p">)</span>
    <span class="n">da_diff</span> <span class="o">=</span> <span class="n">da_s</span> <span class="o">-</span> <span class="n">da_r</span>

    <span class="c1"># Bring small spatial slices into memory</span>
    <span class="n">da_s</span><span class="p">,</span> <span class="n">da_r</span><span class="p">,</span> <span class="n">da_diff</span> <span class="o">=</span> <span class="n">dask_compute</span><span class="p">(</span><span class="n">da_s</span><span class="p">,</span> <span class="n">da_r</span><span class="p">,</span> <span class="n">da_diff</span><span class="p">)</span>

    <span class="c1"># --- 2. Figure Setup ---</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
        <span class="n">nrows</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">22</span><span class="p">,</span> <span class="mi">14</span><span class="p">),</span>
        <span class="n">subplot_kw</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;projection&#39;</span><span class="p">:</span> <span class="n">ccrs</span><span class="o">.</span><span class="n">Robinson</span><span class="p">()}</span>
    <span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;OHC Anomalies: </span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2"> Monthly Progression&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">22</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.96</span><span class="p">)</span>

    <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;RdBu_r&#39;</span><span class="p">)</span>
    <span class="n">cmap</span><span class="o">.</span><span class="n">set_bad</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="c1"># Consistent scale for rows 1 &amp; 2</span>
    <span class="n">combined_vals</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">da_s</span><span class="p">,</span> <span class="n">da_r</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="s1">&#39;tmp&#39;</span><span class="p">)</span>
    <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanpercentile</span><span class="p">(</span><span class="n">combined_vals</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">98</span><span class="p">])</span>
    
    <span class="c1"># Separate scale for the difference row</span>
    <span class="n">diff_lim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanpercentile</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">da_diff</span><span class="o">.</span><span class="n">values</span><span class="p">),</span> <span class="mi">98</span><span class="p">)</span>

    <span class="c1"># --- 3. Plotting Grid ---</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">months</span><span class="p">):</span>
        <span class="c1"># Row 1: Forecast (M√©t√©o-France System 9)</span>
        <span class="n">im_s</span> <span class="o">=</span> <span class="n">da_s</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">month</span><span class="o">=</span><span class="n">m</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span> <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">(),</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> 
                                      <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span> <span class="n">add_colorbar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">month_names</span><span class="p">[</span><span class="n">m</span><span class="p">],</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="o">-</span><span class="mf">0.07</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;Forecast&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> 
                                  <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>

        <span class="c1"># Row 2: Reanalysis (ORAS5)</span>
        <span class="n">im_r</span> <span class="o">=</span> <span class="n">da_r</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">month</span><span class="o">=</span><span class="n">m</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span> <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">(),</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> 
                                      <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span> <span class="n">add_colorbar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="c1"># Keep top title as column header</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="o">-</span><span class="mf">0.07</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;Reanalysis&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> 
                                  <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>

        <span class="c1"># Row 3: Difference (Bias)</span>
        <span class="n">im_d</span> <span class="o">=</span> <span class="n">da_diff</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">month</span><span class="o">=</span><span class="n">m</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span> <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">(),</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;PuOr&#39;</span><span class="p">,</span> 
                                         <span class="n">vmin</span><span class="o">=-</span><span class="n">diff_lim</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">diff_lim</span><span class="p">,</span> <span class="n">add_colorbar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="o">-</span><span class="mf">0.07</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;Difference&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> 
                                  <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>

    <span class="c1"># Styling and horizontal colorbars</span>
    <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axs</span><span class="o">.</span><span class="n">flat</span><span class="p">:</span>
        <span class="n">setup_map_plot</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
        
    <span class="c1"># Positioning colorbars at the bottom</span>
    <span class="n">cbar_ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.08</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">])</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im_s</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cbar_ax1</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;horizontal&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Anomaly [J/m¬≤]&#39;</span><span class="p">)</span>
    
    <span class="n">cbar_ax2</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mf">0.55</span><span class="p">,</span> <span class="mf">0.08</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">])</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im_d</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cbar_ax2</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;horizontal&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Difference [J/m¬≤]&#39;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">bottom</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.15</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Run the plot</span>
<span class="n">plot_monthly_anomalies_3x3</span><span class="p">(</span><span class="n">ds_seasonal</span><span class="p">,</span> <span class="n">ds_reanalysis</span><span class="p">,</span> <span class="n">year</span><span class="o">=</span><span class="mi">1997</span><span class="p">)</span>
<span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">();</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/de4af9c5a02c8a4128aad5d1c631bd3d4e6d407cac8e4433b94e54d30f8618a4.png" src="../_images/de4af9c5a02c8a4128aad5d1c631bd3d4e6d407cac8e4433b94e54d30f8618a4.png" />
</div>
</div>
<section id="figure-6">
<h5>Figure 6<a class="headerlink" href="#figure-6" title="Link to this heading">#</a></h5>
<p>Map plot showing the OHC anomalies for the seasonal forecasts with a nominal start date October 1st 1997 (upper row) and for the reanalysis (center row), and their differences (bottom row).</p>
<hr class="docutils" />
</section>
</section>
</section>
<section id="metrics-sedi-bss-accuracy">
<span id="seasonal-seasonal-monthly-ocean-extremes-detection-q07-seasonal-ohc-section-4"></span><h3>4. Metrics: SEDI, BSS, Accuracy<a class="headerlink" href="#metrics-sedi-bss-accuracy" title="Link to this heading">#</a></h3>
<p>This section presents the primary skill scores (SEDI, BSS, Accuracy).</p>
<section id="symmetric-extremal-dependence-index-sedi">
<h4>Symmetric Extremal Dependence Index (SEDI)<a class="headerlink" href="#symmetric-extremal-dependence-index-sedi" title="Link to this heading">#</a></h4>
<p>SEDI (Ferro &amp; Stephenson 2011, <a class="reference external" href="https://doi.org/10.1175/WAF-D-10-05030.1" rel="noreferrer" target="_blank">[4]</a>) is calculated using the hit rate (H) and false alarm rate (F), as can be found in a contingency table:</p>
<p><span class="math notranslate nohighlight">\(
  \text{SEDI} = \frac{\log(F) - \log(H) - \log(1-F) + \log(1-H)}{\log(F) + \log(H) + \log(1-F) + \log(1-H)}
  \)</span></p>
<p>To avoid numerical issues, logarithms are computed using a lower bound of <span class="math notranslate nohighlight">\(10^{-6}\)</span>.</p>
</section>
<section id="id1">
<h4>The Brier Skill Score (BSS)<a class="headerlink" href="#id1" title="Link to this heading">#</a></h4>
<p>The Brier Skill Score (BSS) here compares the forecast‚Äôs Brier score against the Brier score of using the climatology of the reference data set as a forecast. The climatologically based heatwave forecast is near a 10% chance, but is here calculated explicitly per grid point. The BSS‚Äôs upper limit is 1, meanwhile it has no lower limit. Scores above zero indicate a forecast better than climatology.</p>
</section>
<section id="accuracy-assessment">
<h4>Accuracy Assessment<a class="headerlink" href="#accuracy-assessment" title="Link to this heading">#</a></h4>
<p>Proportion of correct predictions relative to total events. Forecast accuracy was calculated as:
<span class="math notranslate nohighlight">\(
  \text{Accuracy} = \frac{\text{True Positives} + \text{True Negatives}}{N}
  \)</span>
where <span class="math notranslate nohighlight">\(N\)</span> is the total number of events. Accuracy above a random threshold (e.g., 0.82 for a base rate of 0.1) indicates skill better than chance.</p>
</section>
<section id="pooling-strategy-for-skill-metrics-in-map-form">
<h4>Pooling Strategy for Skill Metrics in Map Form<a class="headerlink" href="#pooling-strategy-for-skill-metrics-in-map-form" title="Link to this heading">#</a></h4>
<p>To calculate robust skill scores, data is pooled in different ways depending on the metric. The BSS pools the ensemble members at once, while this is done in a later step for SEDI and Accuracy:</p>
<ul class="simple">
<li><p><strong>For SEDI and Accuracy</strong>: These metrics are calculated from a contingency table (i.e., hits, misses, false alarms, correct rejections). For these every <strong>ensemble member</strong> in every <strong>year</strong> is treated as an independent event. This means we are <strong>pooling across the time dimension (1993-2023) and the ensemble dimension</strong>. This results in a single, robust skill score map that represents the overall performance for that calendar month across the entire period.</p></li>
<li><p><strong>For the Brier Skill Score (BSS)</strong>: This metric evaluates the performance of a probabilistic forecast compared to a reference forecast (here climatology) for each calendar month and grid cell. The calculation is done in steps:</p>
<ol class="arabic simple">
<li><p>First, for each year, the ensemble members are pooled to create a single <strong>forecast probability</strong> for that year (e.g., if 5 of 25 members predict a heatwave, the probability is 0.2).</p></li>
<li><p>The Brier Score is then calculated for each year by comparing that probability to the single observed outcome (<code class="docutils literal notranslate"><span class="pre">1</span></code> or <code class="docutils literal notranslate"><span class="pre">0</span></code>).</p></li>
<li><p>Finally, these annual Brier Scores are averaged across all years to get the final score. The BSS then compares this to the reference score from climatology.</p></li>
</ol>
</li>
</ul>
</section>
<section id="findings">
<h4>Findings<a class="headerlink" href="#findings" title="Link to this heading">#</a></h4>
<p>A key finding of this analysis is a divergence between the metrics in several regions (<a class="reference internal" href="#seasonal-seasonal-monthly-ocean-extremes-detection-q07-fig-global-maps"><span class="std std-ref">Figure 7</span></a>). The SEDI and Accuracy scores ( &gt; 0.82) indicate that the forecast is better than a reference climatology, while BSS is weakly negative in many regions. A negative BSS indicates that the forecast is less skillful than the long-term climatological average, i.e. assuming a ~10% chance of a heatwave everywhere, every year.</p>
<p>This suggests that while the model has the ability to correctly identify many heatwave events (demonstrated in the positive SEDI), it likely forecasts with too much confidence or has a high ‚Äúfalse alarm rate,‚Äù where it predicts heatwaves that don‚Äôt occur. The BSS penalizes this lack of reliability, while SEDI, which focuses only on the co-occurrence of extreme events, is less sensitive to it.</p>
<p>The highest skill (SEDI &gt; 0.5) is consistently found in the tropical Pacific Ocean. This region‚Äôs variability is dominated by the El Ni√±o-Southern Oscillation (ENSO), the primary source of seasonal predictability in the climate system. The model successfully captures the OHC anomalies associated with strong ENSO events.
The skill is lower in the mid-to-high latitudes. These regions are governed by more chaotic and faster-moving atmospheric and oceanic processes, making them more difficult to predict months in advance.</p>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Function to compute skill score maps</span>

<span class="k">def</span><span class="w"> </span><span class="nf">calculate_skill_maps</span><span class="p">(</span><span class="n">forecast_mask</span><span class="p">,</span> <span class="n">obs_mask</span><span class="p">,</span> <span class="n">comask</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes skill maps in a two-step process.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">eps</span> <span class="o">=</span> <span class="mf">1e-12</span> 
    <span class="n">fill_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">(</span><span class="o">-</span><span class="mi">99</span><span class="p">)</span>
    
    <span class="c1"># --- Step 1: Brier Skill Score  ---</span>
    
    <span class="c1"># float32 conversion</span>
    <span class="n">obs_mask_float</span> <span class="o">=</span> <span class="n">obs_mask</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">obs_mask</span> <span class="o">!=</span> <span class="n">fill_value</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">forecast_mask_float</span> <span class="o">=</span> <span class="n">forecast_mask</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">forecast_mask</span> <span class="o">!=</span> <span class="n">fill_value</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    
    <span class="c1"># Calculate probabilities</span>
    <span class="n">fct_prob</span> <span class="o">=</span> <span class="n">forecast_mask_float</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s1">&#39;realization&#39;</span><span class="p">)</span>
    <span class="n">climatology_prob</span> <span class="o">=</span> <span class="n">obs_mask_float</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;year&#39;</span><span class="p">)</span>
    
    <span class="c1"># Calculate Brier Scores</span>
    <span class="n">bs_forecast</span> <span class="o">=</span> <span class="n">xs</span><span class="o">.</span><span class="n">brier_score</span><span class="p">(</span><span class="n">obs_mask_float</span><span class="p">,</span> <span class="n">fct_prob</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="s1">&#39;year&#39;</span><span class="p">)</span>
    <span class="n">bs_reference</span> <span class="o">=</span> <span class="n">xs</span><span class="o">.</span><span class="n">brier_score</span><span class="p">(</span><span class="n">obs_mask_float</span><span class="p">,</span> <span class="n">climatology_prob</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="s1">&#39;year&#39;</span><span class="p">)</span>
    
    <span class="c1"># Calculate final BSS</span>
    <span class="n">bss_lazy</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">bs_reference</span> <span class="o">&gt;</span> <span class="n">eps</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">bs_forecast</span> <span class="o">/</span> <span class="n">bs_reference</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    
    <span class="c1"># --- Execute the BSS calculation ---</span>
    <span class="p">(</span><span class="n">bss</span><span class="p">,)</span> <span class="o">=</span> <span class="n">dask_compute</span><span class="p">(</span><span class="n">bss_lazy</span><span class="p">)</span>

    <span class="c1"># --- Free memory ---</span>
    <span class="k">del</span> <span class="n">obs_mask_float</span><span class="p">,</span> <span class="n">forecast_mask_float</span><span class="p">,</span> <span class="n">fct_prob</span><span class="p">,</span> <span class="n">climatology_prob</span>
    <span class="k">del</span> <span class="n">bs_forecast</span><span class="p">,</span> <span class="n">bs_reference</span><span class="p">,</span> <span class="n">bss_lazy</span>
    <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">();</span>

    <span class="c1"># --- Step 2: SEDI and Accuracy ---</span>
    
    <span class="c1"># lazy and uses int8</span>
    <span class="n">category_map</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="n">obs_mask</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">forecast_mask</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">(</span><span class="mi">2</span><span class="p">)),</span>  <span class="c1"># (TP) or (FN)</span>
        <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">obs_mask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>
            <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">forecast_mask</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">(</span><span class="mi">4</span><span class="p">)),</span>  <span class="c1"># (FP) or (TN)</span>
            <span class="n">fill_value</span>  <span class="c1"># This is the land/ice mask</span>
        <span class="p">)</span>
    <span class="p">)</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="n">obs_mask</span><span class="o">.</span><span class="n">chunks</span><span class="p">)</span>

    <span class="c1"># Sum over &#39;year&#39; and &#39;realization&#39; to create the maps</span>
    <span class="n">dims_to_sum</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="s1">&#39;realization&#39;</span><span class="p">]</span>
    <span class="n">TP_lazy</span> <span class="o">=</span> <span class="p">(</span><span class="n">category_map</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">dims_to_sum</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
    <span class="n">FN_lazy</span> <span class="o">=</span> <span class="p">(</span><span class="n">category_map</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">dims_to_sum</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
    <span class="n">FP_lazy</span> <span class="o">=</span> <span class="p">(</span><span class="n">category_map</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">dims_to_sum</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
    <span class="n">TN_lazy</span> <span class="o">=</span> <span class="p">(</span><span class="n">category_map</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">dims_to_sum</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
    
    <span class="c1"># --- Execute the SEDI/Accuracy calculation ---</span>
    <span class="p">(</span><span class="n">TP</span><span class="p">,</span> <span class="n">FN</span><span class="p">,</span> <span class="n">FP</span><span class="p">,</span> <span class="n">TN</span><span class="p">)</span> <span class="o">=</span> <span class="n">dask_compute</span><span class="p">(</span><span class="n">TP_lazy</span><span class="p">,</span> <span class="n">FN_lazy</span><span class="p">,</span> <span class="n">FP_lazy</span><span class="p">,</span> <span class="n">TN_lazy</span><span class="p">)</span>

    <span class="c1"># --- Calculate final metrics---</span>
    <span class="n">H</span> <span class="o">=</span> <span class="n">TP</span> <span class="o">/</span> <span class="p">(</span><span class="n">TP</span> <span class="o">+</span> <span class="n">FN</span> <span class="o">+</span> <span class="n">eps</span><span class="p">)</span>
    <span class="n">F</span> <span class="o">=</span> <span class="n">FP</span> <span class="o">/</span> <span class="p">(</span><span class="n">FP</span> <span class="o">+</span> <span class="n">TN</span> <span class="o">+</span> <span class="n">eps</span><span class="p">)</span>
    <span class="n">logH</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">eps</span><span class="p">))</span>
    <span class="n">logF</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">eps</span><span class="p">))</span>
    <span class="n">log1mH</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">H</span><span class="p">,</span> <span class="n">eps</span><span class="p">))</span>
    <span class="n">log1mF</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">F</span><span class="p">,</span> <span class="n">eps</span><span class="p">))</span>
    <span class="n">sedi</span> <span class="o">=</span> <span class="p">(</span><span class="n">logF</span> <span class="o">-</span> <span class="n">logH</span> <span class="o">-</span> <span class="n">log1mF</span> <span class="o">+</span> <span class="n">log1mH</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">logF</span> <span class="o">+</span> <span class="n">logH</span> <span class="o">+</span> <span class="n">log1mF</span> <span class="o">+</span> <span class="n">log1mH</span><span class="p">)</span>
    <span class="n">accuracy</span> <span class="o">=</span> <span class="p">(</span><span class="n">TP</span> <span class="o">+</span> <span class="n">TN</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">TP</span> <span class="o">+</span> <span class="n">TN</span> <span class="o">+</span> <span class="n">FP</span> <span class="o">+</span> <span class="n">FN</span> <span class="o">+</span> <span class="n">eps</span><span class="p">)</span>

    <span class="c1"># --- Combine ---</span>
    <span class="n">skill_ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">({</span>
        <span class="s1">&#39;SEDI&#39;</span><span class="p">:</span> <span class="n">sedi</span><span class="p">,</span>
        <span class="s1">&#39;BSS&#39;</span><span class="p">:</span> <span class="n">bss</span><span class="p">,</span>  
        <span class="s1">&#39;Accuracy&#39;</span><span class="p">:</span> <span class="n">accuracy</span>
    <span class="p">})</span>
    
    <span class="c1"># Apply mask </span>
    <span class="n">skill_ds</span> <span class="o">=</span> <span class="n">skill_ds</span> <span class="o">*</span> <span class="n">comask</span>
    
    <span class="k">return</span> <span class="n">skill_ds</span>

<span class="c1"># --- Execute the skill calculation ---</span>
<span class="n">skill_maps</span> <span class="o">=</span> <span class="n">calculate_skill_maps</span><span class="p">(</span>
    <span class="n">heatwave_mask_forecast</span><span class="p">,</span> 
    <span class="n">heatwave_mask_reanalysis</span><span class="p">,</span> 
    <span class="n">comask</span><span class="o">=</span><span class="n">comask</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># The main plotting cell with mean values in titles</span>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_skill_maps_with_means</span><span class="p">(</span><span class="n">skill_maps</span><span class="p">,</span> <span class="n">comask</span><span class="p">):</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
        <span class="n">nrows</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
        <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
        <span class="n">subplot_kw</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;projection&#39;</span><span class="p">:</span> <span class="n">ccrs</span><span class="o">.</span><span class="n">Robinson</span><span class="p">()}</span>
    <span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span> 

    <span class="c1"># dictionaries</span>
    <span class="n">metrics</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;SEDI&#39;</span><span class="p">,</span> <span class="s1">&#39;BSS&#39;</span><span class="p">,</span> <span class="s1">&#39;Accuracy&#39;</span><span class="p">]</span>
    <span class="n">cmaps_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;SEDI&#39;</span><span class="p">:</span> <span class="s1">&#39;coolwarm&#39;</span><span class="p">,</span> <span class="s1">&#39;BSS&#39;</span><span class="p">:</span> <span class="s1">&#39;coolwarm&#39;</span><span class="p">,</span> <span class="s1">&#39;Accuracy&#39;</span><span class="p">:</span> <span class="s1">&#39;Reds&#39;</span><span class="p">}</span>
    <span class="n">vmins</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;SEDI&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="s1">&#39;BSS&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;Accuracy&#39;</span><span class="p">:</span> <span class="mf">0.82</span><span class="p">}</span>
    <span class="n">vmaxs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;SEDI&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span> <span class="s1">&#39;BSS&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;Accuracy&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">}</span>
    <span class="n">month_labels</span> <span class="o">=</span> <span class="p">{</span><span class="mi">11</span><span class="p">:</span><span class="s1">&#39;November&#39;</span><span class="p">,</span> <span class="mi">12</span><span class="p">:</span><span class="s1">&#39;December&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="s1">&#39;January&#39;</span><span class="p">}</span>
    <span class="c1"># Define the labels you want for each row</span>
    <span class="n">panel_labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">]</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">comask</span><span class="o">.</span><span class="n">latitude</span><span class="p">))</span> <span class="c1"># Define weights once</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">metric</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">metrics</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">metric</span> <span class="o">==</span> <span class="s1">&#39;BSS&#39;</span><span class="p">:</span>
            <span class="n">extend_setting</span> <span class="o">=</span> <span class="s1">&#39;min&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">extend_setting</span> <span class="o">=</span> <span class="s1">&#39;neither&#39;</span>
            
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">month</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">months_to_do</span><span class="p">):</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
            
            <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="n">panel_labels</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> 
                        <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
            <span class="c1"># -------------------------</span>
            
            <span class="n">data_to_plot</span> <span class="o">=</span> <span class="n">skill_maps</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">month</span><span class="o">=</span><span class="n">month</span><span class="p">)</span>
            
            <span class="n">mean_val</span> <span class="o">=</span> <span class="n">data_to_plot</span><span class="o">.</span><span class="n">weighted</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="n">title_with_mean</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">month_labels</span><span class="p">[</span><span class="n">month</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">(Mean: </span><span class="si">{</span><span class="n">mean_val</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">)&quot;</span>
            
            <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">cmaps_dict</span><span class="p">[</span><span class="n">metric</span><span class="p">])</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">cmap</span><span class="o">.</span><span class="n">set_bad</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">metric</span> <span class="o">==</span> <span class="s1">&#39;Accuracy&#39;</span><span class="p">:</span>
                <span class="n">data_to_plot</span> <span class="o">=</span> <span class="n">data_to_plot</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">data_to_plot</span> <span class="o">&gt;</span> <span class="n">vmins</span><span class="p">[</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">])</span>

            <span class="n">im</span> <span class="o">=</span> <span class="n">data_to_plot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">(),</span>
                <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmins</span><span class="p">[</span><span class="n">metric</span><span class="p">],</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmaxs</span><span class="p">[</span><span class="n">metric</span><span class="p">],</span>
                <span class="n">add_colorbar</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>
            <span class="n">setup_map_plot</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title_with_mean</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">(Mean: </span><span class="si">{</span><span class="n">mean_val</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:],</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;vertical&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">metric</span><span class="p">,</span>  
                     <span class="n">extend</span><span class="o">=</span><span class="n">extend_setting</span><span class="p">,</span> <span class="n">fraction</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
        
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">panel_labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mf">0.84</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;metrics_panels_NDJ.png&#39;</span><span class="p">,</span><span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">,</span> <span class="n">pad_inches</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>



<span class="n">plot_skill_maps_with_means</span><span class="p">(</span><span class="n">skill_maps</span><span class="p">,</span> <span class="n">comask</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/b4e3a734df9af82fe1d149cee26d1d7821610da362d7d6776bb5c2292bab9fb8.png" src="../_images/b4e3a734df9af82fe1d149cee26d1d7821610da362d7d6776bb5c2292bab9fb8.png" />
</div>
</div>
<section id="figure-7">
<span id="seasonal-seasonal-monthly-ocean-extremes-detection-q07-fig-global-maps"></span><h5>Figure 7<a class="headerlink" href="#figure-7" title="Link to this heading">#</a></h5>
<p>Skill of M√©t√©o-France System-9 forecasts with a nominal start data October 1st for November, December, and January, using the ORAS5 reanalysis as the reference dataset. Heatwaves are defined as upper 300m ocean heat content (OHC) anomalies exceeding the 90th percentile within the 1993-2023 period. Rows show: (A) Symmetric Extremal Dependence Index (SEDI), (B) Brier Skill Score (BSS); and (C) Accuracy. In all maps, red areas indicate positive skill (forecast is better than the reference), while blue areas indicate negative skill. Masked areas are shown in grey. For the Accuracy maps (C) the areas with an accuracy lower than what would be expected by random chance (82%) are also shown with a grey color.</p>
<hr class="docutils" />
</section>
</section>
</section>
<section id="contingency-table-analysis">
<span id="seasonal-seasonal-monthly-ocean-extremes-detection-q07-seasonal-ohc-section-5"></span><h3>5. Contingency Table Analysis<a class="headerlink" href="#contingency-table-analysis" title="Link to this heading">#</a></h3>
<p>We examine the spatially-pooled contingency tables for each month to better understand the forecast behavior.</p>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">generate_contingency_tables_optimized</span><span class="p">(</span><span class="n">forecast_mask</span><span class="p">,</span> <span class="n">obs_mask</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates a dictionary of contingency tables for each month.</span>
<span class="sd">    Uses int8.</span>
<span class="sd">    &quot;&quot;&quot;</span>
      
    <span class="c1"># Create boolean fields. </span>
    <span class="n">obs_yes</span> <span class="o">=</span> <span class="p">(</span><span class="n">obs_mask</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">obs_no</span>  <span class="o">=</span> <span class="p">(</span><span class="n">obs_mask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">fcst_yes</span> <span class="o">=</span> <span class="p">(</span><span class="n">forecast_mask</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">fcst_no</span>  <span class="o">=</span> <span class="p">(</span><span class="n">forecast_mask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Define dimensions to sum over</span>
    <span class="n">dims_to_sum</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="s1">&#39;realization&#39;</span><span class="p">,</span> <span class="s1">&#39;latitude&#39;</span><span class="p">,</span> <span class="s1">&#39;longitude&#39;</span><span class="p">]</span>

    <span class="n">TP_by_month</span> <span class="o">=</span> <span class="p">(</span><span class="n">obs_yes</span> <span class="o">&amp;</span> <span class="n">fcst_yes</span><span class="p">)</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;month&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">dims_to_sum</span><span class="p">)</span>
    <span class="n">FN_by_month</span> <span class="o">=</span> <span class="p">(</span><span class="n">obs_yes</span> <span class="o">&amp;</span> <span class="n">fcst_no</span><span class="p">)</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;month&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">dims_to_sum</span><span class="p">)</span>
    <span class="n">FP_by_month</span> <span class="o">=</span> <span class="p">(</span><span class="n">obs_no</span>  <span class="o">&amp;</span> <span class="n">fcst_yes</span><span class="p">)</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;month&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">dims_to_sum</span><span class="p">)</span>
    <span class="n">TN_by_month</span> <span class="o">=</span> <span class="p">(</span><span class="n">obs_no</span>  <span class="o">&amp;</span> <span class="n">fcst_no</span><span class="p">)</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;month&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">dims_to_sum</span><span class="p">)</span>

    <span class="c1"># Execute all calculations in a single Dask operation</span>
    <span class="c1">#print(&quot;Computing contingency table&quot;)</span>
    <span class="n">TP</span><span class="p">,</span> <span class="n">FN</span><span class="p">,</span> <span class="n">FP</span><span class="p">,</span> <span class="n">TN</span> <span class="o">=</span> <span class="n">dask_compute</span><span class="p">(</span><span class="n">TP_by_month</span><span class="p">,</span> <span class="n">FN_by_month</span><span class="p">,</span> <span class="n">FP_by_month</span><span class="p">,</span> <span class="n">TN_by_month</span><span class="p">)</span>

    <span class="n">raw_tables</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">norm_tables</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">normalize</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="k">for</span> <span class="n">month_num</span> <span class="ow">in</span> <span class="n">TP</span><span class="p">[</span><span class="s1">&#39;month&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
        <span class="n">month_name</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">month_num</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;%m&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">month_name</span><span class="p">()</span>
        
        <span class="n">tp_val</span> <span class="o">=</span> <span class="n">TP</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">month</span><span class="o">=</span><span class="n">month_num</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="n">fn_val</span> <span class="o">=</span> <span class="n">FN</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">month</span><span class="o">=</span><span class="n">month_num</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="n">fp_val</span> <span class="o">=</span> <span class="n">FP</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">month</span><span class="o">=</span><span class="n">month_num</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="n">tn_val</span> <span class="o">=</span> <span class="n">TN</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">month</span><span class="o">=</span><span class="n">month_num</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        
        <span class="n">table</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="p">[[</span><span class="n">tp_val</span><span class="p">,</span> <span class="n">fp_val</span><span class="p">],</span> <span class="p">[</span><span class="n">fn_val</span><span class="p">,</span> <span class="n">tn_val</span><span class="p">]],</span>
            <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Event Observed&#39;</span><span class="p">,</span> <span class="s1">&#39;Non-event Observed&#39;</span><span class="p">],</span>
            <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Event Forecasted&#39;</span><span class="p">,</span> <span class="s1">&#39;Non-event Forecasted&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        
        <span class="n">table</span><span class="p">[</span><span class="s1">&#39;Total (Forecast)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;Total (Observed)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="n">raw_tables</span><span class="p">[</span><span class="n">month_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
            <span class="n">grand_total</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;Total (Observed)&#39;</span><span class="p">,</span> <span class="s1">&#39;Total (Forecast)&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">grand_total</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">norm_table</span> <span class="o">=</span> <span class="p">(</span><span class="n">table</span> <span class="o">/</span> <span class="n">grand_total</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
                <span class="n">norm_tables</span><span class="p">[</span><span class="n">month_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">norm_table</span>
            
    <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">raw_tables</span><span class="p">,</span> <span class="n">norm_tables</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">raw_tables</span>
        

<span class="n">raw_tables</span><span class="p">,</span> <span class="n">percent_tables</span> <span class="o">=</span> <span class="n">generate_contingency_tables_optimized</span><span class="p">(</span>
    <span class="n">heatwave_mask_forecast</span><span class="p">,</span> 
    <span class="n">heatwave_mask_reanalysis</span><span class="p">,</span> 
    <span class="n">normalize</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Contingency Tables in Percent (%) ---&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">month_name</span><span class="p">,</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">percent_tables</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">month_name</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
    <span class="c1"># Format to 2 decimal places with a &#39;%&#39; sign</span>
    <span class="n">display</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:.1f}</span><span class="s2">%&quot;</span><span class="p">))</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>--- Contingency Tables in Percent (%) ---

November:
</pre></div>
</div>
<div class="output text_html"><style type="text/css">
</style>
<table id="T_b8e18">
  <thead>
    <tr>
      <th class="blank level0" >&nbsp;</th>
      <th id="T_b8e18_level0_col0" class="col_heading level0 col0" >Event Observed</th>
      <th id="T_b8e18_level0_col1" class="col_heading level0 col1" >Non-event Observed</th>
      <th id="T_b8e18_level0_col2" class="col_heading level0 col2" >Total (Forecast)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_b8e18_level0_row0" class="row_heading level0 row0" >Event Forecasted</th>
      <td id="T_b8e18_row0_col0" class="data row0 col0" >3.2%</td>
      <td id="T_b8e18_row0_col1" class="data row0 col1" >6.8%</td>
      <td id="T_b8e18_row0_col2" class="data row0 col2" >10.0%</td>
    </tr>
    <tr>
      <th id="T_b8e18_level0_row1" class="row_heading level0 row1" >Non-event Forecasted</th>
      <td id="T_b8e18_row1_col0" class="data row1 col0" >6.6%</td>
      <td id="T_b8e18_row1_col1" class="data row1 col1" >83.5%</td>
      <td id="T_b8e18_row1_col2" class="data row1 col2" >90.0%</td>
    </tr>
    <tr>
      <th id="T_b8e18_level0_row2" class="row_heading level0 row2" >Total (Observed)</th>
      <td id="T_b8e18_row2_col0" class="data row2 col0" >9.7%</td>
      <td id="T_b8e18_row2_col1" class="data row2 col1" >90.3%</td>
      <td id="T_b8e18_row2_col2" class="data row2 col2" >100.0%</td>
    </tr>
  </tbody>
</table>
</div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>December:
</pre></div>
</div>
<div class="output text_html"><style type="text/css">
</style>
<table id="T_a0201">
  <thead>
    <tr>
      <th class="blank level0" >&nbsp;</th>
      <th id="T_a0201_level0_col0" class="col_heading level0 col0" >Event Observed</th>
      <th id="T_a0201_level0_col1" class="col_heading level0 col1" >Non-event Observed</th>
      <th id="T_a0201_level0_col2" class="col_heading level0 col2" >Total (Forecast)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_a0201_level0_row0" class="row_heading level0 row0" >Event Forecasted</th>
      <td id="T_a0201_row0_col0" class="data row0 col0" >2.9%</td>
      <td id="T_a0201_row0_col1" class="data row0 col1" >7.1%</td>
      <td id="T_a0201_row0_col2" class="data row0 col2" >9.9%</td>
    </tr>
    <tr>
      <th id="T_a0201_level0_row1" class="row_heading level0 row1" >Non-event Forecasted</th>
      <td id="T_a0201_row1_col0" class="data row1 col0" >6.8%</td>
      <td id="T_a0201_row1_col1" class="data row1 col1" >83.2%</td>
      <td id="T_a0201_row1_col2" class="data row1 col2" >90.1%</td>
    </tr>
    <tr>
      <th id="T_a0201_level0_row2" class="row_heading level0 row2" >Total (Observed)</th>
      <td id="T_a0201_row2_col0" class="data row2 col0" >9.7%</td>
      <td id="T_a0201_row2_col1" class="data row2 col1" >90.3%</td>
      <td id="T_a0201_row2_col2" class="data row2 col2" >100.0%</td>
    </tr>
  </tbody>
</table>
</div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>January:
</pre></div>
</div>
<div class="output text_html"><style type="text/css">
</style>
<table id="T_7c8e8">
  <thead>
    <tr>
      <th class="blank level0" >&nbsp;</th>
      <th id="T_7c8e8_level0_col0" class="col_heading level0 col0" >Event Observed</th>
      <th id="T_7c8e8_level0_col1" class="col_heading level0 col1" >Non-event Observed</th>
      <th id="T_7c8e8_level0_col2" class="col_heading level0 col2" >Total (Forecast)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_7c8e8_level0_row0" class="row_heading level0 row0" >Event Forecasted</th>
      <td id="T_7c8e8_row0_col0" class="data row0 col0" >2.6%</td>
      <td id="T_7c8e8_row0_col1" class="data row0 col1" >7.4%</td>
      <td id="T_7c8e8_row0_col2" class="data row0 col2" >10.0%</td>
    </tr>
    <tr>
      <th id="T_7c8e8_level0_row1" class="row_heading level0 row1" >Non-event Forecasted</th>
      <td id="T_7c8e8_row1_col0" class="data row1 col0" >7.0%</td>
      <td id="T_7c8e8_row1_col1" class="data row1 col1" >83.0%</td>
      <td id="T_7c8e8_row1_col2" class="data row1 col2" >90.0%</td>
    </tr>
    <tr>
      <th id="T_7c8e8_level0_row2" class="row_heading level0 row2" >Total (Observed)</th>
      <td id="T_7c8e8_row2_col0" class="data row2 col0" >9.6%</td>
      <td id="T_7c8e8_row2_col1" class="data row2 col1" >90.4%</td>
      <td id="T_7c8e8_row2_col2" class="data row2 col2" >100.0%</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>For all Novembers (one month leadtime, or 1-2 months, to be exact), when the model predicts a marine heatwave, that prediction is correct 32% of the time (Precision). Conversely, the False Discovery Rate is 68%, meaning roughly two-thirds of forecasted heatwaves did not materialize in observations. The predictive skill degrades slightly with lead time; by January (three month leadtime), the probability of a forecasted heatwave actually occurring drops to 26%.</p>
<p>Regarding the capture of observed events (Hit Rate), the model successfully anticipates 33% of the heatwaves that occurred in November. This capability decreases marginally to 30% in December and 27% in January. Overall, the system demonstrates an ability to capture approximately one-third of heatwave events at a one-month lead time, though users must be mindful of the high false alarm ratio.</p>
</section>
<section id="annual-variability-and-enso-influence">
<span id="seasonal-seasonal-monthly-ocean-extremes-detection-q07-seasonal-ohc-section-6"></span><h3>6. Annual Variability and ENSO Influence<a class="headerlink" href="#annual-variability-and-enso-influence" title="Link to this heading">#</a></h3>
<p>We now investigate the year-to-year skill for each month and its potential connection to ENSO.</p>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">calculate_annual_skill_and_rates</span><span class="p">(</span><span class="n">forecast_mask</span><span class="p">,</span> <span class="n">obs_mask</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates all annual time series in a two-step process.</span>
<span class="sd">    Step 1: Computes float-based metrics (BSS, MHW Occ.). </span>
<span class="sd">    We here use the teoretical BSSref of 0.1</span>
<span class="sd">    Step 2: Clears memory, then computes intiger-based metrics (SEDI, Rates)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">fill_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">(</span><span class="o">-</span><span class="mi">99</span><span class="p">)</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">obs_mask</span><span class="o">.</span><span class="n">latitude</span><span class="p">))</span>
    <span class="n">weights</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;weights&quot;</span>

    <span class="c1"># ---BSS in float ---</span>
    <span class="n">obs_mask_float</span> <span class="o">=</span> <span class="n">obs_mask</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">obs_mask</span> <span class="o">!=</span> <span class="n">fill_value</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">fcst_mask_float</span> <span class="o">=</span> <span class="n">forecast_mask</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">forecast_mask</span> <span class="o">!=</span> <span class="n">fill_value</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

    <span class="n">mhw_occurrence_lazy</span> <span class="o">=</span> <span class="n">obs_mask_float</span><span class="o">.</span><span class="n">weighted</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="s1">&#39;latitude&#39;</span><span class="p">,</span> <span class="s1">&#39;longitude&#39;</span><span class="p">]</span>
                                                               <span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
    
    <span class="n">fct_prob</span> <span class="o">=</span> <span class="n">fcst_mask_float</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s1">&#39;realization&#39;</span><span class="p">)</span>
    <span class="n">bs_forecast</span> <span class="o">=</span> <span class="n">xs</span><span class="o">.</span><span class="n">brier_score</span><span class="p">(</span><span class="n">obs_mask_float</span><span class="p">,</span> <span class="n">fct_prob</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;latitude&#39;</span><span class="p">,</span> <span class="s1">&#39;longitude&#39;</span><span class="p">],</span> 
                                 <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">)</span>
    <span class="n">bs_reference_theoretical</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mf">0.1</span><span class="p">)</span>  <span class="c1"># 0.09</span>
    <span class="n">bss_theoretical_lazy</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">bs_forecast</span> <span class="o">/</span> <span class="n">bs_reference_theoretical</span><span class="p">)</span>

    <span class="n">mhw</span><span class="p">,</span> <span class="n">bss</span> <span class="o">=</span> <span class="n">dask_compute</span><span class="p">(</span><span class="n">mhw_occurrence_lazy</span><span class="p">,</span> <span class="n">bss_theoretical_lazy</span><span class="p">)</span>

    <span class="c1"># --- free memory ---</span>
    <span class="k">del</span> <span class="n">obs_mask_float</span><span class="p">,</span> <span class="n">fcst_mask_float</span><span class="p">,</span> <span class="n">mhw_occurrence_lazy</span>
    <span class="k">del</span> <span class="n">fct_prob</span><span class="p">,</span> <span class="n">bs_forecast</span><span class="p">,</span> <span class="n">bss_theoretical_lazy</span>
    <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">();</span>
    <span class="c1"># -------------------</span>

    <span class="c1"># SEDI &amp; Rates from the int8 arrays</span>
    <span class="n">category_map</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="n">obs_mask</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">forecast_mask</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">(</span><span class="mi">2</span><span class="p">)),</span>  <span class="c1"># (TP) or (FN)</span>
        <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">obs_mask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>
            <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">forecast_mask</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">(</span><span class="mi">4</span><span class="p">)),</span>  <span class="c1"># (FP) or (TN)</span>
            <span class="n">fill_value</span>
        <span class="p">)</span>
    <span class="p">)</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="n">obs_mask</span><span class="o">.</span><span class="n">chunks</span><span class="p">)</span>

    <span class="n">dims_to_sum</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;realization&#39;</span><span class="p">,</span> <span class="s1">&#39;latitude&#39;</span><span class="p">,</span> <span class="s1">&#39;longitude&#39;</span><span class="p">]</span>
    <span class="n">TP_ym_lazy</span> <span class="o">=</span> <span class="p">(</span><span class="n">category_map</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;year&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">dims_to_sum</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> 
    <span class="n">FN_ym_lazy</span> <span class="o">=</span> <span class="p">(</span><span class="n">category_map</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;year&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">dims_to_sum</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
    <span class="n">FP_ym_lazy</span> <span class="o">=</span> <span class="p">(</span><span class="n">category_map</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;year&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">dims_to_sum</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
    <span class="n">TN_ym_lazy</span> <span class="o">=</span> <span class="p">(</span><span class="n">category_map</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;year&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">dims_to_sum</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>

    <span class="c1"># The int-based computations</span>
    <span class="n">tp</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">tn</span> <span class="o">=</span> <span class="n">dask_compute</span><span class="p">(</span><span class="n">TP_ym_lazy</span><span class="p">,</span> <span class="n">FN_ym_lazy</span><span class="p">,</span> <span class="n">FP_ym_lazy</span><span class="p">,</span> <span class="n">TN_ym_lazy</span><span class="p">)</span>
    
    <span class="c1"># --- free mem ---</span>
    <span class="k">del</span> <span class="n">category_map</span><span class="p">,</span> <span class="n">TP_ym_lazy</span><span class="p">,</span> <span class="n">FN_ym_lazy</span><span class="p">,</span> <span class="n">FP_ym_lazy</span><span class="p">,</span> <span class="n">TN_ym_lazy</span>
    <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">();</span>
    <span class="c1"># -------------------</span>

    <span class="c1"># --- STEP 3: Combine results -------</span>
    <span class="n">eps</span> <span class="o">=</span> <span class="mf">1e-12</span>
    <span class="n">H</span> <span class="o">=</span> <span class="n">tp</span> <span class="o">/</span> <span class="p">(</span><span class="n">tp</span> <span class="o">+</span> <span class="n">fn</span> <span class="o">+</span> <span class="n">eps</span><span class="p">)</span> <span class="c1"># Hit Rate</span>
    <span class="n">F</span> <span class="o">=</span> <span class="n">fp</span> <span class="o">/</span> <span class="p">(</span><span class="n">fp</span> <span class="o">+</span> <span class="n">tn</span> <span class="o">+</span> <span class="n">eps</span><span class="p">)</span> <span class="c1"># False Alarm Rate</span>
    <span class="n">FN_rate</span> <span class="o">=</span> <span class="n">fn</span> <span class="o">/</span> <span class="p">(</span><span class="n">tp</span> <span class="o">+</span> <span class="n">fn</span> <span class="o">+</span> <span class="n">eps</span><span class="p">)</span> <span class="c1"># Miss Rate</span>
    <span class="n">TN_rate</span> <span class="o">=</span> <span class="n">tn</span> <span class="o">/</span> <span class="p">(</span><span class="n">fp</span> <span class="o">+</span> <span class="n">tn</span> <span class="o">+</span> <span class="n">eps</span><span class="p">)</span> <span class="c1"># Correct Rejection Rate</span>
    
    <span class="n">logH</span><span class="p">,</span> <span class="n">logF</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">eps</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">eps</span><span class="p">))</span>
    <span class="n">log1mH</span><span class="p">,</span> <span class="n">log1mF</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">H</span><span class="p">,</span> <span class="n">eps</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">F</span><span class="p">,</span> <span class="n">eps</span><span class="p">))</span>
    <span class="n">sedi</span> <span class="o">=</span> <span class="p">(</span><span class="n">logF</span> <span class="o">-</span> <span class="n">logH</span> <span class="o">-</span> <span class="n">log1mF</span> <span class="o">+</span> <span class="n">log1mH</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">logF</span> <span class="o">+</span> <span class="n">logH</span> <span class="o">+</span> <span class="n">log1mF</span> <span class="o">+</span> <span class="n">log1mH</span><span class="p">)</span>
    
    <span class="c1"># --- combine and format ---</span>
    <span class="n">month_map</span> <span class="o">=</span> <span class="p">{</span><span class="mi">11</span><span class="p">:</span> <span class="s1">&#39;November&#39;</span><span class="p">,</span> <span class="mi">12</span><span class="p">:</span> <span class="s1">&#39;December&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;January&#39;</span><span class="p">}</span>
    
    <span class="n">df_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">all_metrics</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;MHW_Occurrence&#39;</span><span class="p">:</span> <span class="n">mhw</span><span class="p">,</span> <span class="s1">&#39;BSS&#39;</span><span class="p">:</span> <span class="n">bss</span><span class="p">,</span> <span class="s1">&#39;SEDI&#39;</span><span class="p">:</span> <span class="n">sedi</span><span class="p">,</span>
        <span class="s1">&#39;True_Pos&#39;</span><span class="p">:</span> <span class="n">H</span><span class="p">,</span> <span class="s1">&#39;False_Pos&#39;</span><span class="p">:</span> <span class="n">F</span><span class="p">,</span> <span class="s1">&#39;False_Neg&#39;</span><span class="p">:</span> <span class="n">FN_rate</span><span class="p">,</span> <span class="s1">&#39;True_Neg&#39;</span><span class="p">:</span> <span class="n">TN_rate</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">da</span> <span class="ow">in</span> <span class="n">all_metrics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;val&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;metric&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;month&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">month_map</span><span class="p">)</span>
        <span class="n">df_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        
    <span class="n">final_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">df_list</span><span class="p">)</span>
    <span class="n">pivot_df</span> <span class="o">=</span> <span class="n">final_df</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;metric&#39;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s1">&#39;val&#39;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">pivot_df</span>
</pre></div>
</div>
</div>
</details>
</div>
<section id="annual-metrics-global">
<h4>Annual metrics - global<a class="headerlink" href="#annual-metrics-global" title="Link to this heading">#</a></h4>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">plot_jacox_style_figure</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">enso_years</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">month_to_plot</span><span class="o">=</span><span class="s1">&#39;November&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates a 3-panel figure similar to the one in Jacox et al. (2022),</span>
<span class="sd">    including a split legend on the top panel for line metrics and ENSO events.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">,</span> <span class="n">ax3</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">),</span> 
                                        <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span> 

    <span class="n">months</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;November&#39;</span><span class="p">,</span> <span class="s1">&#39;December&#39;</span><span class="p">,</span> <span class="s1">&#39;January&#39;</span><span class="p">]</span>
    <span class="n">styles</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;November&#39;</span><span class="p">:</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;December&#39;</span><span class="p">:</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="s1">&#39;January&#39;</span><span class="p">:</span> <span class="s1">&#39;:&#39;</span><span class="p">}</span>
    
    <span class="c1"># --- Panel A: MHW Occurrence---</span>
    <span class="k">for</span> <span class="n">month</span> <span class="ow">in</span> <span class="n">months</span><span class="p">:</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;MHW_Occurrence_</span><span class="si">{</span><span class="n">month</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">],</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">styles</span><span class="p">[</span><span class="n">month</span><span class="p">],</span> 
                 <span class="n">label</span><span class="o">=</span><span class="n">month</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;MHW Occurrence (%)&quot;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
    
    <span class="n">line_handles</span><span class="p">,</span> <span class="n">line_labels</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>
    <span class="n">leg1</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">line_handles</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">line_labels</span><span class="p">,</span> 
                      <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Month&quot;</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">add_artist</span><span class="p">(</span><span class="n">leg1</span><span class="p">)</span> 

    <span class="n">enso_colors</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Eastern&#39;</span><span class="p">:</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="s1">&#39;Central&#39;</span><span class="p">:</span> <span class="s1">&#39;orange&#39;</span><span class="p">}</span>
    <span class="n">patch_handles</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="s1">&#39;Eastern&#39;</span> <span class="ow">in</span> <span class="n">enso_years</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="n">patch_handles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Patch</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">enso_colors</span><span class="p">[</span><span class="s1">&#39;Eastern&#39;</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> 
                                   <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Eastern El Ni√±o&#39;</span><span class="p">))</span>
    <span class="k">if</span> <span class="s1">&#39;Central&#39;</span> <span class="ow">in</span> <span class="n">enso_years</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="n">patch_handles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Patch</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">enso_colors</span><span class="p">[</span><span class="s1">&#39;Central&#39;</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> 
                                   <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Central El Ni√±o&#39;</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">patch_handles</span><span class="p">:</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">patch_handles</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Event Type&quot;</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower left&#39;</span><span class="p">)</span>

    <span class="c1"># --- Panel B: Skill Scores ---</span>
    <span class="k">for</span> <span class="n">month</span> <span class="ow">in</span> <span class="n">months</span><span class="p">:</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;SEDI_</span><span class="si">{</span><span class="n">month</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;C1&#39;</span><span class="p">,</span> 
                 <span class="n">linestyle</span><span class="o">=</span><span class="n">styles</span><span class="p">[</span><span class="n">month</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;SEDI_</span><span class="si">{</span><span class="n">month</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="sa">f</span><span class="s1">&#39;BSS_Theoretical_</span><span class="si">{</span><span class="n">month</span><span class="si">}</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;BSS_Theoretical_</span><span class="si">{</span><span class="n">month</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;C4&#39;</span><span class="p">,</span> 
                     <span class="n">linestyle</span><span class="o">=</span><span class="n">styles</span><span class="p">[</span><span class="n">month</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;BSS_Theoretical_</span><span class="si">{</span><span class="n">month</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="sa">f</span><span class="s1">&#39;BSS_</span><span class="si">{</span><span class="n">month</span><span class="si">}</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span> 
             <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;BSS_</span><span class="si">{</span><span class="n">month</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;C4&#39;</span><span class="p">,</span> 
                      <span class="n">linestyle</span><span class="o">=</span><span class="n">styles</span><span class="p">[</span><span class="n">month</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;BSS_</span><span class="si">{</span><span class="n">month</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
             
    <span class="n">ax2</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Skill Score&quot;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;Metric / Month&quot;</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
    
    <span class="c1"># --- Panel C: Contingency Rates ---</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;True_Pos_</span><span class="si">{</span><span class="n">month_to_plot</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;C0&#39;</span><span class="p">,</span> 
             <span class="n">label</span><span class="o">=</span><span class="s1">&#39;True Pos. (Hit Rate)&#39;</span><span class="p">)</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;True_Neg_</span><span class="si">{</span><span class="n">month_to_plot</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;C3&#39;</span><span class="p">,</span> 
             <span class="n">label</span><span class="o">=</span><span class="s1">&#39;True Neg. Rate&#39;</span><span class="p">)</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;False_Pos_</span><span class="si">{</span><span class="n">month_to_plot</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;C2&#39;</span><span class="p">,</span> 
             <span class="n">label</span><span class="o">=</span><span class="s1">&#39;False Pos. (False Alarm Rate)&#39;</span><span class="p">)</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;False_Neg_</span><span class="si">{</span><span class="n">month_to_plot</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;C5&#39;</span><span class="p">,</span> 
             <span class="n">label</span><span class="o">=</span><span class="s1">&#39;False Neg. (Miss Rate)&#39;</span><span class="p">)</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Rate&quot;</span><span class="p">)</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Year&quot;</span><span class="p">)</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Rates for </span><span class="si">{</span><span class="n">month_to_plot</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">)</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
    
    <span class="c1"># Add ENSO shading to all panels</span>
    <span class="n">enso_alpha</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Eastern&#39;</span><span class="p">:</span> <span class="mf">0.15</span><span class="p">,</span> <span class="s1">&#39;Central&#39;</span><span class="p">:</span> <span class="mf">0.08</span><span class="p">}</span>
    <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="p">[</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">,</span> <span class="n">ax3</span><span class="p">]:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">year_str</span><span class="p">,</span> <span class="n">enso_type</span> <span class="ow">in</span> <span class="n">enso_years</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">year</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">year_str</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">year</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">year</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">year</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">enso_colors</span><span class="p">[</span><span class="n">enso_type</span><span class="p">],</span> 
                           <span class="n">alpha</span><span class="o">=</span><span class="n">enso_alpha</span><span class="p">[</span><span class="n">enso_type</span><span class="p">],</span> 
                           <span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;_nolegend_&#39;</span><span class="p">)</span> 

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">rect</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.03</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># 1. Define ENSO years (as before)</span>
<span class="n">enso_years</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;1997&#39;</span><span class="p">:</span> <span class="s1">&#39;Eastern&#39;</span><span class="p">,</span> <span class="s1">&#39;1998&#39;</span><span class="p">:</span> <span class="s1">&#39;Eastern&#39;</span><span class="p">,</span> <span class="c1"># The 97-98 event</span>
    <span class="s1">&#39;2002&#39;</span><span class="p">:</span> <span class="s1">&#39;Central&#39;</span><span class="p">,</span> <span class="c1"># The 02-03 event</span>
    <span class="s1">&#39;2009&#39;</span><span class="p">:</span> <span class="s1">&#39;Central&#39;</span><span class="p">,</span> <span class="c1"># The 09-10 event</span>
    <span class="s1">&#39;2015&#39;</span><span class="p">:</span> <span class="s1">&#39;Eastern&#39;</span><span class="p">,</span> <span class="s1">&#39;2016&#39;</span><span class="p">:</span> <span class="s1">&#39;Eastern&#39;</span><span class="p">,</span> <span class="c1"># The 15-16 event</span>
    <span class="s1">&#39;2023&#39;</span><span class="p">:</span> <span class="s1">&#39;Eastern&#39;</span><span class="p">,</span> <span class="s1">&#39;2024&#39;</span><span class="p">:</span> <span class="s1">&#39;Eastern&#39;</span> <span class="c1"># The recent 23-24 event</span>
<span class="p">}</span>

<span class="c1"># 2. Run global calculation and plot</span>
<span class="n">global_jacox_df</span> <span class="o">=</span> <span class="n">calculate_annual_skill_and_rates</span><span class="p">(</span>
    <span class="n">heatwave_mask_forecast</span><span class="p">,</span> 
    <span class="n">heatwave_mask_reanalysis</span>
<span class="p">)</span>
<span class="n">plot_jacox_style_figure</span><span class="p">(</span>
    <span class="n">global_jacox_df</span><span class="p">,</span> 
    <span class="n">enso_years</span><span class="p">,</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Annual Forecast Skill for NDJ Heatwaves (Global Average)&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<figure class="align-default" id="fig-global-ts-in">
<img alt="../_images/d48e62e3a490eac81e6944695ffc23bb6e7b1ad46928ddd84c25b6cc194f39ee.png" src="../_images/d48e62e3a490eac81e6944695ffc23bb6e7b1ad46928ddd84c25b6cc194f39ee.png" />
<figcaption>
<p><span class="caption-number">Fig. 4.1.2 </span><span class="caption-text">Annual time series of globally-averaged forecast performance for the NDJ season. The upper panel (A) depticts marine heatwave (MHW) occurrence each year (%). Panel B shows the SEDI and the BSS in NDJ averaged over the valid ocean region. Panel C shows the contingency table components, the False or True Positives and Negatives each year. The figure is similar to Extended Data Fig. 5 in Jacox et. al. 2022, <a class="reference external" href="https://doi.org/10.1038/s41586-022-04573-9" rel="noreferrer" target="_blank">[1]</a>. Occurrence of El Ni√±o is shown with a red (Eastern type) or yellow (Central type, Modoki) background color.</span><a class="headerlink" href="#fig-global-ts-in" title="Link to this image">#</a></p>
</figcaption>
</figure>
</div>
</div>
<section id="figure-8">
<span id="seasonal-seasonal-monthly-ocean-extremes-detection-q07-fig-global-ts-in"></span><h5>Figure 8<a class="headerlink" href="#figure-8" title="Link to this heading">#</a></h5>
<p>Annual time series of globally-averaged forecast performance for the NDJ season. The upper panel (A) depicts marine heatwave (MHW) occurrence each year, i.e. the percentage of gridcells in heatwave conditions. Panel B shows the SEDI and the BSS in NDJ averaged over the valid ocean region. Panel C shows the contingency table components, the False or True Positives and Negatives each year. The figure is similar to Extended Data Fig. 5 in Jacox et. al. 2022, <a class="reference external" href="https://doi.org/10.1038/s41586-022-04573-9" rel="noreferrer" target="_blank">[1]</a>. Occurrence of El Ni√±o is shown with a red (Eastern type) or yellow (Central type, Modoki) background color.</p>
<hr class="docutils" />
<p>An analysis of global year-to-year variability in SEDI and BSS (<a class="reference internal" href="#seasonal-seasonal-monthly-ocean-extremes-detection-q07-fig-global-ts-in"><span class="std std-ref">Figure 8</span></a>) reveals a divergence in skill metrics. The SEDI scores (orange lines) remain positive and notably peak during major Eastern El Ni√±o events (e.g., 1997-98, 2015-16). This indicates that the forecast system is highly effective at signal detection; it successfully identifies high-risk periods during these major climate drivers. Conversely, the BSS (purple lines), which measures probabilistic skill, often deteriorates during these same events. This might indicate that the single-model system is overconfident. The distribution analysis (<a class="reference internal" href="#seasonal-seasonal-monthly-ocean-extremes-detection-q07-fig-pdfs"><span class="std std-ref">Figure 4</span></a>) shows that the reference reanalysis exhibits a sharper tail than the forecast ensemble. While the model often captures the correct warming signal, this lower extreme-tail variability may be linked to the observed overconfidence in its probabilistic assignments.</p>
<p>While the model correctly predicts the risk of a heatwave (high SEDI), the probability it assigns is less accurate. This is a common limitation of single-model systems, where the ensemble spread is insufficient to represent true uncertainty. Transitioning to a multi-model ensemble would likely improve reliability for decision-making by increasing that spread.</p>
<p>We focus on a key area: the Ni√±o 3.4 region (5¬∞N-5¬∞S, 170-120¬∞W). The Ni√±o 3.4 region was chosen as it represents the tropical pacific and the ENSO.</p>
</section>
</section>
<section id="annual-metrics-nino-3-4-region">
<h4>Annual metrics - Ni√±o 3.4 region<a class="headerlink" href="#annual-metrics-nino-3-4-region" title="Link to this heading">#</a></h4>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--- Running Case Study: Ni√±o 3.4 Region ---&quot;</span><span class="p">)</span>

<span class="c1"># 1. Select the data for the Ni√±o 3.4 region </span>
<span class="n">nino34_mask_forecast</span> <span class="o">=</span> <span class="n">heatwave_mask_forecast</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="o">**</span><span class="n">nino_box</span><span class="p">)</span>
<span class="n">nino34_mask_reanalysis</span> <span class="o">=</span> <span class="n">heatwave_mask_reanalysis</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="o">**</span><span class="n">nino_box</span><span class="p">)</span> 


<span class="n">nino34_jacox_df</span> <span class="o">=</span> <span class="n">calculate_annual_skill_and_rates</span><span class="p">(</span>
    <span class="n">nino34_mask_forecast</span><span class="p">,</span> 
    <span class="n">nino34_mask_reanalysis</span>
<span class="p">)</span>
<span class="n">plot_jacox_style_figure</span><span class="p">(</span>
    <span class="n">nino34_jacox_df</span><span class="p">,</span> 
    <span class="n">enso_years</span><span class="p">,</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Annual Forecast Skill for NDJ Heatwaves in the Ni√±o 3.4 Region&quot;</span>
<span class="p">)</span>

<span class="c1"># 4. Clean up large intermediate masks</span>
<span class="k">del</span> <span class="n">nino34_mask_forecast</span><span class="p">,</span> <span class="n">nino34_mask_reanalysis</span>
<span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">();</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>--- Running Case Study: Ni√±o 3.4 Region ---
</pre></div>
</div>
<img alt="../_images/50e97389bf3903457a2e0aab3ca427ce5c8785ae36df6541ce809b077c68dc5c.png" src="../_images/50e97389bf3903457a2e0aab3ca427ce5c8785ae36df6541ce809b077c68dc5c.png" />
</div>
</div>
<section id="figure-9">
<span id="seasonal-seasonal-monthly-ocean-extremes-detection-q07-fig-nino-ts"></span><h5>Figure 9<a class="headerlink" href="#figure-9" title="Link to this heading">#</a></h5>
<p>As in <a class="reference internal" href="#seasonal-seasonal-monthly-ocean-extremes-detection-q07-fig-global-ts-in"><span class="std std-ref">Figure 8</span></a>, but for the Ni√±o 3.4 region.</p>
<hr class="docutils" />
<p>In contrast, the skill within the Ni√±o 3.4 region (<a class="reference internal" href="#seasonal-seasonal-monthly-ocean-extremes-detection-q07-fig-nino-ts"><span class="std std-ref">Figure 9</span></a>) is much higher and more reliable. Although the time-series exhibits higher variability, which is expected a dynamic and smaller region, the BSS is consistently positive, approaching 1.0 during the major 1997-98 and 2015-16 events. The high SEDI scores further confirm the model‚Äôs ability to capture these extremes. This confirms that the probabilistic forecasts are both skillful and reliable regarding marine heatwaves during ENSO events, which are the primary driver of seasonal predictability.</p>
</section>
</section>
</section>
<section id="summary-of-results">
<span id="seasonal-seasonal-monthly-ocean-extremes-detection-q07-seasonal-ohc-section-7"></span><h3>Summary of Results<a class="headerlink" href="#summary-of-results" title="Link to this heading">#</a></h3>
<p>This study compares the M√©t√©o-France System-9 seasonal forecasts against the ORAS5 ocean reanalysis for forecasts initialized around October 1st for mean monthly values in November, December, and January. The analysis focused on the forecast skill for extreme upper OHC events (anomalies &gt;90th percentile) after removing long-term trends from both datasets. By looking at anomalies, detrending the data, and applying lead-time (or calendar month) dependent percentiles we do or best to match the seasonal data with the reference data. We assess skill 1‚Äì3 months after the forecasts nominal start date using metrics such as the Symmetric Extremal Dependence Index (SEDI) and the Brier Skill Score (BSS). The metrics considered follow  Jacox et al. (2022) <a class="reference external" href="https://doi.org/10.1038/s41586-022-04573-9" rel="noreferrer" target="_blank">[1]</a>, however, in this work we look at OHC and not SST. It should be noted that this evaluation and use-case considers a single ocean reanalysis as a reference dataset. Using an ensemble of observational datasets could provide a more robust assessment.</p>
<p>The forecast system demonstrates clear, positive skill in detecting events. The Symmetric Extremal Dependence Index (SEDI) is positive globally and spikes during major Eastern El Ni√±o events (e.g., 1997-98, 2015-16). This is corroborated by the contingency rate analysis (<a class="reference internal" href="#seasonal-seasonal-monthly-ocean-extremes-detection-q07-fig-global-ts-in"><span class="std std-ref">Figure 8</span></a> panel C), which shows the True Positive (Hit) Rate increasing dramatically in these years, confirming the model successfully captures the El Ni√±o signal, and the corresponding effect on the MHW index derived from the ocean heat content.</p>
<p>The system provides a valuable tool for anticipation of NDJ upper ocean heatwaves, with its utility and reliability being highest in ENSO-dominated regions. However, outside this region the Brier Skill Score (BSS) is often negative, indicating that the forecast probabilities are less reliable than the static climatological reference forecast (always a 10% chance). This might indicate that the model has too little ensemble spread in these regions. This makes the forecast a good ‚Äúheads-up‚Äù warning for high-risk periods, but for higher reliability outside the main ENSO regions a multi-model system might be useful.</p>
</section>
</section>
<section id="i-if-you-want-to-know-more">
<h2>‚ÑπÔ∏è If you want to know more<a class="headerlink" href="#i-if-you-want-to-know-more" title="Link to this heading">#</a></h2>
<section id="key-resources">
<h3>Key resources<a class="headerlink" href="#key-resources" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Seasonal forecast monthly averages of ocean variables DOI: <a class="reference external" href="https://doi.org/10.24381/cds.2f9be611" rel="noreferrer" target="_blank">10.24381/cds.2f9be611</a></p></li>
</ul>
<ul class="simple">
<li><p>ORAS5 global ocean reanalysis monthly data from 1958 to present DOI:  <a class="reference external" href="https://doi.org/10.24381/cds.67e8eeb7" rel="noreferrer" target="_blank">10.24381/cds.67e8eeb7</a></p></li>
</ul>
<p>Code libraries used:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/bopen/c3s-eqc-automatic-quality-control/tree/main/c3s_eqc_automatic_quality_control" rel="noreferrer" target="_blank">C3S EQC custom functions</a>, <code class="docutils literal notranslate"><span class="pre">c3s_eqc_automatic_quality_control</span></code>, prepared and advised on by <a class="reference external" href="https://www.bopen.eu/" rel="noreferrer" target="_blank">B-Open</a></p></li>
<li><p>xesmf</p></li>
<li><p><a class="reference external" href="https://github.com/COSIMA/ocean-regrid/tree/master" rel="noreferrer" target="_blank">ocean-regrid</a> <code class="docutils literal notranslate"><span class="pre">make_corners</span></code> to provide cell edge coordinates for the ORCA025 tripolar grid</p></li>
<li><p>xskillscore</p></li>
<li><p>dask</p></li>
<li><p>xarray</p></li>
<li><p>pandas</p></li>
<li><p>matplotlib</p></li>
<li><p>seaborn</p></li>
<li><p>scipy</p></li>
<li><p>numpy</p></li>
<li><p>cartopy</p></li>
</ul>
</section>
<section id="references">
<h3>References<a class="headerlink" href="#references" title="Link to this heading">#</a></h3>
<p><a class="reference external" href="https://doi.org/10.1038/s41586-022-04573-9" rel="noreferrer" target="_blank">[1]</a> Jacox, M. G., Alexander, M. A., Amaya, D., Becker, E., Bograd, S. J., Brodie, S., Hazen, E. L., Pozo Buil, M., &amp; Tommasi, D. (2022). Global seasonal forecasts of marine heatwaves. Nature, 604(7906), 486‚Äì490.</p>
<p><a class="reference external" href="https://doi.org/10.1007/S00382-021-06101-3" rel="noreferrer" target="_blank">[2]</a> McAdam, R., Masina, S., Balmaseda, M., Gualdi, S., Senan, R., &amp; Mayer, M. (2022). Seasonal forecast skill of upper-ocean heat content in coupled high-resolution systems. Climate Dynamics, 58(11‚Äì12), 3335‚Äì3350.</p>
<p><a class="reference external" href="https://doi.org/10.5281/zenodo.15518106" rel="noreferrer" target="_blank">[3]</a> Specq, D., Dorel, L., Beuvier, J., Ardilouze, C., &amp; Batt√©, L. (2024). Documentation of the M√©t√©o-France seasonal forecasting system 9. Zenodo.</p>
<p><a class="reference external" href="https://doi.org/10.1175/WAF-D-10-05030.1" rel="noreferrer" target="_blank">[4]</a> Ferro, C. A. T., &amp; Stephenson, D. B. (2011). Extremal Dependence Indices: Improved Verification Measures for Deterministic Forecasts of Rare Binary Events. Weather and Forecasting, 26(5), 699‚Äì713.</p>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./Seasonal_Forecasts"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="seasonal.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title"><span class="section-number">4. </span>Seasonal forecasts</p>
      </div>
    </a>
    <a class="right-next"
       href="../Climate_Projections/climate.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title"><span class="section-number">5. </span>Climate projections</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#use-case">üåç Use case:</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#quality-assessment-question">‚ùì Quality assessment question</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#quality-assessment-statement">üì¢ Quality assessment statement</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#methodology">üìã Methodology</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#pooling-and-grouping-strategies">Pooling and grouping strategies</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#sedi-the-symmetric-extremal-dependence-index">SEDI -  the Symmetric Extremal Dependence Index</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-brier-skill-score-bss">The Brier Skill Score (BSS)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#accuracy">Accuracy</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#analysis-and-results">üìà Analysis and results</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#data-preparation">1. Data Preparation</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#imports-and-settings">Imports and Settings</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#definition-of-parameters">Definition of Parameters</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#helper-functions-for-data-processing-and-plotting">Helper Functions for Data Processing and Plotting</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#data-loading">Data Loading</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#ohc-time-series-and-trend-analysis">2. OHC Time Series and Trend Analysis</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#figure-2">Figure 2</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#model-performance-vs-reanalysis">3. Model Performance vs. Reanalysis</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#correlation-of-ohc-anomalies">Correlation of OHC Anomalies</a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#figure-3">Figure 3</a></li>
</ul>
</li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#comparison-of-distributions">Comparison of distributions</a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#figure-4">Figure 4</a></li>
</ul>
</li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#comparison-of-heatwave-representation">Comparison of Heatwave Representation</a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#figure-5">Figure 5</a></li>
</ul>
</li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#diagnostic-plots-we-choose-1997-as-our-year-to-inspect-the-spatial-patterns-of-the-anomalies">Diagnostic Plots. We choose 1997 as our year to inspect the spatial patterns of the anomalies.</a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#figure-6">Figure 6</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#metrics-sedi-bss-accuracy">4. Metrics: SEDI, BSS, Accuracy</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#symmetric-extremal-dependence-index-sedi">Symmetric Extremal Dependence Index (SEDI)</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">The Brier Skill Score (BSS)</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#accuracy-assessment">Accuracy Assessment</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#pooling-strategy-for-skill-metrics-in-map-form">Pooling Strategy for Skill Metrics in Map Form</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#findings">Findings</a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#figure-7">Figure 7</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#contingency-table-analysis">5. Contingency Table Analysis</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#annual-variability-and-enso-influence">6. Annual Variability and ENSO Influence</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#annual-metrics-global">Annual metrics - global</a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#figure-8">Figure 8</a></li>
</ul>
</li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#annual-metrics-nino-3-4-region">Annual metrics - Ni√±o 3.4 region</a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#figure-9">Figure 9</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#summary-of-results">Summary of Results</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#i-if-you-want-to-know-more">‚ÑπÔ∏è If you want to know more</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#key-resources">Key resources</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#references">References</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By the Copernicus Climate Change Service (C3S), entrusted to ECMWF (European Centre for Medium-Range Weather Forecasts)
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      ¬© Copyright 2024.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>