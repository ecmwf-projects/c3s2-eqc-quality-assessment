
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>2.1. Reference Upper-Air Network for trend analysis &#8212; eqcbook</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'In_Situ/insitu_insitu-observations-gruan-reference-network_resolution_q02';</script>
    <link rel="icon" href="../_static/C3S_favicon.png"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="3. Reanalysis" href="../Reanalyses/reanalysis.html" />
    <link rel="prev" title="2. Insitu Observations" href="insitu.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>
<aside class="bd-header-announcement" aria-label="Announcement">
  <div class="bd-header-announcement__content">‚ö†Ô∏èThis is under development!‚ö†Ô∏è</div>
</aside>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/C3S‚ÄìPOS‚ÄìLINE.png" class="logo__image only-light" alt="eqcbook - Home"/>
    <script>document.write(`<img src="../_static/C3S‚ÄìPOS‚ÄìLINE.png" class="logo__image only-dark" alt="eqcbook - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../intro.html">
                    C3S EQC quality assessments
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">‚û°Ô∏è Satellite Observations</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../Satellite_ECVs/satellite.html">1. Quality assessments for Satellite Observations</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../Satellite_ECVs/Atmosphere_Physics/Atmosphere_Physics.html">1.1. Atmosphere Physics</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="simple">
</ul>
</details></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../Satellite_ECVs/Atmospheric_Composition/Atmospheric_Composition.html">1.2. Atmospheric Composition</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="simple">
</ul>
</details></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../Satellite_ECVs/Cryosphere/Cryosphere.html">1.3. Cryosphere</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="simple">
</ul>
</details></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../Satellite_ECVs/Land_Biosphere/Land_Biosphere.html">1.4. Land Biosphere</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="simple">
</ul>
</details></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../Satellite_ECVs/Land_Hydrology/Land_Hydrology.html">1.5. Land Hydrology</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="simple">
</ul>
</details></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../Satellite_ECVs/Ocean/Ocean.html">1.6. Ocean</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="simple">
</ul>
</details></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">‚û°Ô∏è Insitu Observations</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 current active has-children"><a class="reference internal" href="insitu.html">2. Quality assessments for Insitu Observations</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="current">
<li class="toctree-l2 current active"><a class="current reference internal" href="#">2.1. Reference Upper-Air Network for trend analysis</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">‚û°Ô∏è Reanalysis</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../Reanalyses/reanalysis.html">3. Quality assessments for Reanalysis</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="simple">
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">‚û°Ô∏è Seasonal Forecasts</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../Seasonal_Forecasts/seasonal.html">4. Quality assessments for Seasonal Forecasts</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="simple">
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">‚û°Ô∏è Climate Projections</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../Climate_Projections/climate.html">5. Quality assessments for Climate Projections</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../Climate_Projections/CMIP6/CMIP6.html">5.1. CMIP6</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="simple">
</ul>
</details></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../Climate_Projections/CORDEX/CORDEX.html">5.2. CORDEX</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="simple">
</ul>
</details></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">‚û°Ô∏è Climate Indicators</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../Indicators/indicator.html">6. Quality assessments for Climate Indicators</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="simple">
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">‚û°Ô∏è Derived Datasets</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../Derived_Datasets/derived.html">7. Quality assessments for Derived Datasets</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="simple">
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">‚û°Ô∏è Applications</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../Applications/application.html">8. Quality assessments for C3S Applications</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="simple">
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Quality assessment template</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../templates/template_instructions.html">Template instructions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../templates/template.html">Template</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/ecmwf-projects/c3s2-eqc-quality-assessment" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/ecmwf-projects/c3s2-eqc-quality-assessment/issues/new?title=Issue%20on%20page%20%2FIn_Situ/insitu_insitu-observations-gruan-reference-network_resolution_q02.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/In_Situ/insitu_insitu-observations-gruan-reference-network_resolution_q02.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Reference Upper-Air Network for trend analysis</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#use-case-a-study-on-changing-temperature-over-the-arctic-region">üåç Use case: A study on changing temperature over the Arctic region</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#quality-assessment-question">‚ùì Quality assessment question</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#quality-assessment-statement">üì¢ Quality assessment statement</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#methodology">üìã Methodology</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#analysis-and-results">üìà Analysis and results</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#set-up-and-data-retrieval-for-the-three-stations-nya-sod-and-bar">1. Set up and data retrieval for the three stations (NYA, SOD and BAR).</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#import-packages">Import packages</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#define-parameters">Define Parameters</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#define-request">Define request</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#functions-to-cache">Functions to cache</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#download-and-transform">Download and transform</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#monthly-mean-temperature-and-seasonal-profiles">2. Monthly mean temperature and seasonal profiles</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#temperature-anomalies-and-trends">3.Temperature anomalies and trends</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#specific-humidity-and-iwv-anomalies-and-trends">4. Specific humidity and IWV anomalies and trends</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#specific-humidity-seasonal-profiles-and-monthly-mean-trends">Specific humidity seasonal profiles and monthly mean trends</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#i-if-you-want-to-know-more">‚ÑπÔ∏è If you want to know more</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#key-resources">Key resources</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#references">References</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <p><img alt="logo" src="../_images/LogoLine_horizon_C3S1.png" /></p>
<div class="alert alert-block alert-warning">
Please note that this repository is used for development and review, so quality assessments should be considered work in progress until they are merged into the main branch
</div><section class="tex2jax_ignore mathjax_ignore" id="reference-upper-air-network-for-trend-analysis">
<h1><span class="section-number">2.1. </span>Reference Upper-Air Network for trend analysis<a class="headerlink" href="#reference-upper-air-network-for-trend-analysis" title="Link to this heading">#</a></h1>
<p>Production date: 11-11-2024</p>
<p>Produced by: V. Ciardini (ENEA), P. Grigioni (ENEA), G. Pace (ENEA), C. Scarchilli (ENEA)</p>
<section id="use-case-a-study-on-changing-temperature-over-the-arctic-region">
<h2>üåç Use case: A study on changing temperature over the Arctic region<a class="headerlink" href="#use-case-a-study-on-changing-temperature-over-the-arctic-region" title="Link to this heading">#</a></h2>
</section>
<section id="quality-assessment-question">
<h2>‚ùì Quality assessment question<a class="headerlink" href="#quality-assessment-question" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p><strong>Is the tropospheric Arctic warming amplification consistently detectable (across sites) in the GRUAN measurements?</strong></p></li>
</ul>
<p>The evidences, both direct and indirect, indicate a substantial tropospheric warming of the Arctic over recent decades. Furthermore, models project that the region will warm more rapidly than the global average over the remainder of this century, with likely considerable impacts on the environment, ecosystems and human activities. Amplifying feedback mechanisms are based on atmosphere-cryosphere-ocean interactions, with the diminishing of the Arctic Sea ice cover playing a leading role.
Understanding the climate change, and the underlying causes, requires an understanding not just of changes at the surface of the Earth, but throughout the atmospheric column.</p>
</section>
<section id="quality-assessment-statement">
<h2>üì¢ Quality assessment statement<a class="headerlink" href="#quality-assessment-statement" title="Link to this heading">#</a></h2>
<div class="note admonition">
<p class="admonition-title">These are the key outcomes of this assessment</p>
<ul class="simple">
<li><p>GRUAN provides reference-quality measurements with documented uncertainties, making it well-suited to the detailed analysis of Arctic atmospheric column characteristics. Analysis confirms that tropospheric Arctic warming is detectable in GRUAN measurements, though its magnitude and statistical significance vary across sites and seasons, reflecting regional heterogeneity in Arctic amplification. Temporal coverage can also constrain trend analysis, as it depends on when each station joined GRUAN. Nevertheless, the observational frequency is generally high, ranging from two to three launches per week to two to four launches per day, ensuring robust sampling of the atmospheric column.</p></li>
<li><p>Positive temperature trends dominate the lower troposphere at all three Arctic stations, with Sodankyl√§ exhibiting the strongest and most significant warming signal. Ny-√Ölesund exhibits more uniform but weaker warming, while Barrow shows mixed signals with seasonal cooling episodes.</p></li>
<li><p>Stratospheric trends are generally weak and  less consistent, with only isolated significant signals (e.g. cooling at 13‚Äì15 km over Sodankyl√§), indicating that robust detection of stratospheric changes requires a longer time series.</p></li>
<li><p>Specific humidity trends are more variable than temperature trends. Sodankyl√§ shows clear moistening in the free troposphere and a statistically significant increase in integrated water vapour (IWV). Ny-√Ölesund and Barrow, however, exhibit weaker and mostly non-significant trends.</p></li>
</ul>
</div>
</section>
<section id="methodology">
<h2>üìã Methodology<a class="headerlink" href="#methodology" title="Link to this heading">#</a></h2>
<p>To answer the proposed question, we intend to focus on observations at Ny-√Ölesund, Sodankyla and Barrow, the three Arctic GRUAN stations, following part of the methodology of <a class="reference external" href="https://doi.org/10.1007/s00704-016-1864-0" rel="noreferrer" target="_blank">[1]</a>, where a homogenised 22-year Ny-√Ölesund radiosonde dataset was analysed to infer changes in vertical temperature and humidity profiles over two decades (1993 to 2014). It should be noted that Ny-√Ölesund has been the first radiosonde station certified by GRUAN. The authors found that in NYA, the integrated water vapour (IWV) calculated from radiosonde humidity measurements over two decades, indicates an increase in atmospheric moisture over the years (much faster in winter) and a corresponding warming of the atmospheric column in January and February.</p>
<p>The analysis and results are organised in the following steps, which are detailed in the sections below:</p>
<p><strong><a class="reference internal" href="#insitu-insitu-observations-gruan-reference-network-resolution-q02-section-1"><span class="std std-ref">1. Set up and data retrieval for the three stations (NYA, SOD and BAR).</span></a></strong></p>
<p><strong><a class="reference internal" href="#insitu-insitu-observations-gruan-reference-network-resolution-q02-section-2"><span class="std std-ref">2. Monthly mean temperature and seasonal profiles</span></a></strong></p>
<ul class="simple">
<li><p>Radiosounding data are interpolated on a regular altitude grid with 50 m vertical resolution; the seasonal profile and standard deviation of temperature and specific humidity are calculated</p></li>
</ul>
<p><strong><a class="reference internal" href="#insitu-insitu-observations-gruan-reference-network-resolution-q02-section-3"><span class="std std-ref">3.Temperature anomalies and trends</span></a></strong></p>
<p><strong><a class="reference internal" href="#insitu-insitu-observations-gruan-reference-network-resolution-q02-section-4"><span class="std std-ref">4. Specific humidity and IWV anomalies and trends</span></a></strong></p>
</section>
<section id="analysis-and-results">
<h2>üìà Analysis and results<a class="headerlink" href="#analysis-and-results" title="Link to this heading">#</a></h2>
<section id="set-up-and-data-retrieval-for-the-three-stations-nya-sod-and-bar">
<span id="insitu-insitu-observations-gruan-reference-network-resolution-q02-section-1"></span><h3>1. Set up and data retrieval for the three stations (NYA, SOD and BAR).<a class="headerlink" href="#set-up-and-data-retrieval-for-the-three-stations-nya-sod-and-bar" title="Link to this heading">#</a></h3>
<p>The User will be working with data in netcdf format. To konw more about the GRUAN dataset see <a class="reference external" href="https://cds.climate.copernicus.eu/datasets/insitu-observations-gruan-reference-network?tab=documentation" rel="noreferrer" target="_blank">CDS entries documentation section</a>.</p>
<p><strong>Code:</strong></p>
<ul class="simple">
<li><p>Import CDSAPI credential and packages;</p></li>
<li><p>define parameters (time period, stations, downloaded file directory);</p></li>
<li><p>define request and functions to cache;</p></li>
<li><p>read data and compute functions.</p></li>
</ul>
<section id="import-packages">
<h4>Import packages<a class="headerlink" href="#import-packages" title="Link to this heading">#</a></h4>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">cdsapi</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.dates</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mdates</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">cartopy.crs</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">ccrs</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">cartopy.feature</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">cfeature</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">scipy.stats</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">xarray</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">xr</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">linregress</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">c3s_eqc_automatic_quality_control</span><span class="w"> </span><span class="kn">import</span> <span class="n">download</span>

<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s2">&quot;seaborn-v0_8-notebook&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
</div>
</section>
<section id="define-parameters">
<h4>Define Parameters<a class="headerlink" href="#define-parameters" title="Link to this heading">#</a></h4>
<p>Time range of data series can be set by the User; different stations can be selected by means of Station acronyms (list of GRUAN station acronyms, locations, geographical coordinates and WMO n. are reported in the Product User Guide and Specification for GRUAN Temperature, Relative Humidity and Wind profiles available at <a class="reference external" href="https://dast.copernicus-climate.eu/documents/in-situ/PUG_GRUAN-1.pdf" rel="noreferrer" target="_blank">[2]</a>).</p>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Time period</span>
<span class="n">start</span> <span class="o">=</span> <span class="s2">&quot;2006-05&quot;</span>
<span class="n">stop</span> <span class="o">=</span> <span class="s2">&quot;2020-03&quot;</span>

<span class="c1"># Stations</span>
<span class="n">stations</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;BAR&quot;</span><span class="p">,</span> <span class="s2">&quot;SOD&quot;</span><span class="p">,</span> <span class="s2">&quot;NYA&quot;</span><span class="p">]</span>  <span class="c1"># Use None to analyse all stations</span>
<span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stations</span><span class="p">,</span> <span class="nb">list</span> <span class="o">|</span> <span class="kc">None</span><span class="p">)</span>

<span class="c1"># Directory for csv files</span>
<span class="n">csv_dir</span> <span class="o">=</span> <span class="s2">&quot;./csv_files&quot;</span>

<span class="c1"># CDS credentials</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;CDSAPI_RC&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s2">&quot;~/ciardini_virginia/.cdsapirc&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
</div>
</section>
<section id="define-request">
<h4>Define request<a class="headerlink" href="#define-request" title="Link to this heading">#</a></h4>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">collection_id</span> <span class="o">=</span> <span class="s2">&quot;insitu-observations-gruan-reference-network&quot;</span>
<span class="n">request</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;1_0_0&quot;</span><span class="p">,</span>
    <span class="s2">&quot;variable&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;air_temperature&quot;</span><span class="p">,</span>
        <span class="s2">&quot;relative_humidity&quot;</span><span class="p">,</span>
        <span class="s2">&quot;air_pressure&quot;</span><span class="p">,</span>
        <span class="s2">&quot;altitude&quot;</span><span class="p">,</span>
        <span class="s2">&quot;water_vapour_volume_mixing_ratio&quot;</span><span class="p">,</span>
    <span class="p">],</span>
    <span class="s2">&quot;data_format&quot;</span><span class="p">:</span> <span class="s2">&quot;netcdf&quot;</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">client</span> <span class="o">=</span> <span class="n">cdsapi</span><span class="o">.</span><span class="n">Client</span><span class="p">(</span><span class="n">sleep_max</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">requests</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">date</span> <span class="ow">in</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s2">&quot;1MS&quot;</span><span class="p">):</span>
    <span class="n">time_request</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="n">date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y&quot;</span><span class="p">),</span> <span class="s2">&quot;month&quot;</span><span class="p">:</span> <span class="n">date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%m&quot;</span><span class="p">)}</span>
    <span class="n">time_request</span><span class="p">[</span><span class="s2">&quot;day&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">apply_constraints</span><span class="p">(</span>
        <span class="n">collection_id</span><span class="p">,</span> <span class="n">request</span> <span class="o">|</span> <span class="n">time_request</span>
    <span class="p">)[</span><span class="s2">&quot;day&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">time_request</span><span class="p">[</span><span class="s2">&quot;day&quot;</span><span class="p">]:</span>
        <span class="n">requests</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">request</span> <span class="o">|</span> <span class="n">time_request</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-30 15:11:34,365 INFO [2025-12-03T00:00:00Z] To improve our C3S service, we need to hear from you! Please complete this very short [survey](https://confluence.ecmwf.int/x/E7uBEQ/). Thank you.
</pre></div>
</div>
</div>
</div>
</section>
<section id="functions-to-cache">
<h4>Functions to cache<a class="headerlink" href="#functions-to-cache" title="Link to this heading">#</a></h4>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">_reorganize_dataset</span><span class="p">(</span><span class="n">ds</span><span class="p">):</span>
    <span class="c1"># Rename</span>
    <span class="p">(</span><span class="n">varname</span><span class="p">,)</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;observed_variable&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">observation_value</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">varname</span><span class="p">))</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s2">&quot;observed_variable&quot;</span><span class="p">)</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="n">var</span><span class="p">:</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">varname</span><span class="p">,</span> <span class="n">var</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_value&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)])</span>
            <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">data_vars</span>
            <span class="k">if</span> <span class="n">var</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;uncertainty&quot;</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">)</span>
    <span class="c1"># Update attrs</span>
    <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">da</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">data_vars</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">match</span> <span class="n">var</span><span class="p">:</span>
            <span class="k">case</span> <span class="s2">&quot;pressure&quot;</span><span class="p">:</span>
                <span class="n">da</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;long_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Pressure&quot;</span>
            <span class="k">case</span> <span class="s2">&quot;air_temperature&quot;</span><span class="p">:</span>
                <span class="n">da</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;long_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Temperature&quot;</span>
            <span class="k">case</span> <span class="s2">&quot;altitude&quot;</span><span class="p">:</span>
                <span class="n">da</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;long_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Altitude&quot;</span>
            <span class="k">case</span> <span class="s2">&quot;relative_humidity&quot;</span><span class="p">:</span>
                <span class="n">da</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;long_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Relative&quot;</span>
            <span class="k">case</span> <span class="s2">&quot;water_vapour_mixing_ratio&quot;</span><span class="p">:</span>
                <span class="n">da</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;long_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Mixing&quot;</span>
        <span class="k">for</span> <span class="n">string</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;units&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">string</span> <span class="ow">in</span> <span class="n">var</span><span class="p">:</span>
                <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
                <span class="p">(</span><span class="n">value</span><span class="p">,)</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">da</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
                <span class="n">attrs_var</span> <span class="o">=</span> <span class="n">varname</span> <span class="k">if</span> <span class="n">var</span> <span class="o">==</span> <span class="n">string</span> <span class="k">else</span> <span class="n">var</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">string</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">ds</span><span class="p">[</span><span class="n">attrs_var</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">string</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
    <span class="k">return</span> <span class="n">ds</span>


<span class="k">def</span><span class="w"> </span><span class="nf">reorganize_dataset</span><span class="p">(</span><span class="n">ds</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">da</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">data_vars</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">da</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">bytes_</span><span class="p">):</span>
            <span class="n">ds</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">char</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">da</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">ds</span><span class="o">.</span><span class="n">sizes</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">ds</span>

    <span class="n">datasets</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">ds</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;observed_variable&quot;</span><span class="p">):</span>
        <span class="n">datasets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_reorganize_dataset</span><span class="p">(</span><span class="n">ds</span><span class="p">))</span>
    <span class="k">with</span> <span class="n">xr</span><span class="o">.</span><span class="n">set_options</span><span class="p">(</span><span class="n">use_new_combine_kwarg_defaults</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">xr</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">datasets</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">compute_specific_humidity_from_water_vapour_mixing_ratio</span><span class="p">(</span>
    <span class="n">water_vapour_mixing_ratio</span><span class="p">,</span>
    <span class="n">molar_mass_water</span><span class="o">=</span><span class="mf">18.01528</span><span class="p">,</span>
    <span class="n">molar_mass_dry_air</span><span class="o">=</span><span class="mf">28.9647</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">specific_humidity</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">molar_mass_water</span> <span class="o">*</span> <span class="n">water_vapour_mixing_ratio</span><span class="p">)</span>
        <span class="o">/</span> <span class="p">(</span><span class="n">molar_mass_dry_air</span> <span class="o">+</span> <span class="n">molar_mass_water</span> <span class="o">*</span> <span class="n">water_vapour_mixing_ratio</span><span class="p">)</span>
        <span class="o">*</span> <span class="mi">1000</span>
    <span class="p">)</span>
    <span class="n">specific_humidity</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;long_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Specific Humidity&quot;</span><span class="p">,</span> <span class="s2">&quot;units&quot;</span><span class="p">:</span> <span class="s2">&quot;g/kg&quot;</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">specific_humidity</span>


<span class="k">def</span><span class="w"> </span><span class="nf">compute_integrated_water_vapour</span><span class="p">(</span><span class="n">specific_humidity</span><span class="p">):</span>
    <span class="n">specific_humidity</span> <span class="o">=</span> <span class="n">specific_humidity</span> <span class="o">/</span> <span class="mf">1.0e3</span>  <span class="c1"># g/kg ‚Üí kg/kg</span>
    <span class="n">delta_altitude</span> <span class="o">=</span> <span class="n">specific_humidity</span><span class="p">[</span><span class="s2">&quot;altitude&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="s2">&quot;altitude&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># m</span>

    <span class="n">integrated_water_vapour</span> <span class="o">=</span> <span class="p">(</span><span class="n">specific_humidity</span> <span class="o">*</span> <span class="n">delta_altitude</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="s2">&quot;altitude&quot;</span><span class="p">)</span>
    <span class="n">integrated_water_vapour</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;long_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Integrated Water Vapour&quot;</span><span class="p">,</span>
        <span class="s2">&quot;units&quot;</span><span class="p">:</span> <span class="s2">&quot;kg/m¬≤&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">integrated_water_vapour</span>


<span class="k">def</span><span class="w"> </span><span class="nf">compute_insitu_profiles</span><span class="p">(</span><span class="n">ds</span><span class="p">):</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">reorganize_dataset</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span>

    <span class="c1"># Add variables</span>
    <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;specific_humidity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">compute_specific_humidity_from_water_vapour_mixing_ratio</span><span class="p">(</span>
        <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;water_vapour_mixing_ratio&quot;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;index&quot;</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;report_timestamp&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

    <span class="c1"># Compute profiles</span>
    <span class="n">subset</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;air_temperature&quot;</span><span class="p">,</span> <span class="s2">&quot;relative_humidity&quot;</span><span class="p">,</span> <span class="s2">&quot;specific_humidity&quot;</span><span class="p">,</span> <span class="s2">&quot;altitude&quot;</span><span class="p">]</span>
    <span class="n">profiles</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">station</span><span class="p">,</span> <span class="n">ds_station</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;primary_station_id&quot;</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">time</span><span class="p">,</span> <span class="n">profile</span> <span class="ow">in</span> <span class="n">ds_station</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">):</span>
            <span class="n">profile</span> <span class="o">=</span> <span class="n">profile</span><span class="o">.</span><span class="n">swap_dims</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s2">&quot;altitude&quot;</span><span class="p">)[</span><span class="n">subset</span><span class="p">]</span>
            <span class="n">profile</span> <span class="o">=</span> <span class="n">profile</span><span class="o">.</span><span class="n">sortby</span><span class="p">(</span><span class="s2">&quot;altitude&quot;</span><span class="p">)</span>
            <span class="n">profile</span> <span class="o">=</span> <span class="n">profile</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="s2">&quot;altitude&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;any&quot;</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="n">subset</span><span class="p">)</span>
            <span class="n">profile</span> <span class="o">=</span> <span class="n">profile</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="s2">&quot;altitude&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">profile</span><span class="p">[</span><span class="s2">&quot;altitude&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="s2">&quot;altitude&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2_000</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="k">continue</span>
            <span class="n">profile</span> <span class="o">=</span> <span class="n">profile</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">altitude</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">30_001</span><span class="p">,</span> <span class="mi">50</span><span class="p">))</span>
            <span class="n">profile</span> <span class="o">=</span> <span class="n">profile</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="p">[</span><span class="n">time</span><span class="p">])</span>
            <span class="n">profile</span> <span class="o">=</span> <span class="n">profile</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">station</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">station</span><span class="p">]))</span>
            <span class="n">profiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">profile</span><span class="p">)</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">profiles</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">)</span>

    <span class="c1"># Add integrated water vapour</span>
    <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;integrated_water_vapour&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">compute_integrated_water_vapour</span><span class="p">(</span>
        <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;specific_humidity&quot;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">ds</span>
</pre></div>
</div>
</div>
</details>
</div>
</section>
<section id="download-and-transform">
<h4>Download and transform<a class="headerlink" href="#download-and-transform" title="Link to this heading">#</a></h4>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ds</span> <span class="o">=</span> <span class="n">download</span><span class="o">.</span><span class="n">download_and_transform</span><span class="p">(</span>
    <span class="n">collection_id</span><span class="p">,</span>
    <span class="n">requests</span><span class="p">,</span>
    <span class="n">chunks</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;month&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
    <span class="n">transform_func</span><span class="o">=</span><span class="n">compute_insitu_profiles</span><span class="p">,</span>
    <span class="n">cached_open_mfdataset_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;concat_dim&quot;</span><span class="p">:</span> <span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="s2">&quot;combine&quot;</span><span class="p">:</span> <span class="s2">&quot;nested&quot;</span><span class="p">},</span>
<span class="p">)</span>
<span class="k">if</span> <span class="n">stations</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;station&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">stations</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">(),</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 167/167 [00:10&lt;00:00, 16.05it/s]
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">STATIONS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Barrow (Utqiaƒ°vik)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;abbr&quot;</span><span class="p">:</span> <span class="s2">&quot;BAR&quot;</span><span class="p">,</span>
        <span class="s2">&quot;lat&quot;</span><span class="p">:</span> <span class="mf">71.29</span><span class="p">,</span>
        <span class="s2">&quot;lon&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mf">156.79</span><span class="p">,</span>
        <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span>
        <span class="s2">&quot;marker&quot;</span><span class="p">:</span> <span class="s2">&quot;*&quot;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Ny-√Ölesund&quot;</span><span class="p">,</span>
        <span class="s2">&quot;abbr&quot;</span><span class="p">:</span> <span class="s2">&quot;NYA&quot;</span><span class="p">,</span>
        <span class="s2">&quot;lat&quot;</span><span class="p">:</span> <span class="mf">78.923</span><span class="p">,</span>
        <span class="s2">&quot;lon&quot;</span><span class="p">:</span> <span class="mf">11.923</span><span class="p">,</span>
        <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span>
        <span class="s2">&quot;marker&quot;</span><span class="p">:</span> <span class="s2">&quot;*&quot;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Sodankyl√§&quot;</span><span class="p">,</span>
        <span class="s2">&quot;abbr&quot;</span><span class="p">:</span> <span class="s2">&quot;SOD&quot;</span><span class="p">,</span>
        <span class="s2">&quot;lat&quot;</span><span class="p">:</span> <span class="mf">67.37</span><span class="p">,</span>
        <span class="s2">&quot;lon&quot;</span><span class="p">:</span> <span class="mf">26.63</span><span class="p">,</span>
        <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span>
        <span class="s2">&quot;marker&quot;</span><span class="p">:</span> <span class="s2">&quot;*&quot;</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">]</span>

<span class="k">def</span><span class="w"> </span><span class="nf">plot_arctic_three_stations</span><span class="p">(</span>
    <span class="n">extent</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">180</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span> <span class="mi">90</span><span class="p">),</span>
    <span class="n">land_color</span><span class="o">=</span><span class="s2">&quot;#d9d9d9&quot;</span><span class="p">,</span>
    <span class="n">ocean_color</span><span class="o">=</span><span class="s2">&quot;#e6f2ff&quot;</span><span class="p">,</span>
    <span class="n">savepath</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Crea una mappa polare artica con BAR, NYA e SOD.&quot;&quot;&quot;</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
    <span class="n">proj</span> <span class="o">=</span> <span class="n">ccrs</span><span class="o">.</span><span class="n">NorthPolarStereo</span><span class="p">()</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="n">proj</span><span class="p">)</span>

    <span class="c1"># Estensione geografica (Nord del ~55¬∞N)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_extent</span><span class="p">(</span><span class="n">extent</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">())</span>

    <span class="c1"># Layer geografici</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">LAND</span><span class="o">.</span><span class="n">with_scale</span><span class="p">(</span><span class="s2">&quot;110m&quot;</span><span class="p">),</span> <span class="n">facecolor</span><span class="o">=</span><span class="n">land_color</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">OCEAN</span><span class="o">.</span><span class="n">with_scale</span><span class="p">(</span><span class="s2">&quot;110m&quot;</span><span class="p">),</span> <span class="n">facecolor</span><span class="o">=</span><span class="n">ocean_color</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">COASTLINE</span><span class="o">.</span><span class="n">with_scale</span><span class="p">(</span><span class="s2">&quot;110m&quot;</span><span class="p">),</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">BORDERS</span><span class="o">.</span><span class="n">with_scale</span><span class="p">(</span><span class="s2">&quot;110m&quot;</span><span class="p">),</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

    <span class="c1"># Graticola (solo linee, senza etichette)</span>
    <span class="n">gl</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">gridlines</span><span class="p">(</span><span class="n">crs</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">(),</span> <span class="n">draw_labels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                      <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">)</span>

    <span class="c1"># Cerchi di latitudine (60¬∞, 70¬∞, 80¬∞)</span>
    <span class="k">for</span> <span class="n">lat_circle</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span> <span class="mi">80</span><span class="p">):</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">360</span><span class="p">,</span> <span class="mi">361</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="p">[</span><span class="n">lat_circle</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">theta</span><span class="p">),</span>
                <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">Geodetic</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;lightgray&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>

    <span class="c1"># PIAZZAMENTO STAZIONI</span>
    <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">STATIONS</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">st</span><span class="p">[</span><span class="s2">&quot;lon&quot;</span><span class="p">],</span> <span class="n">st</span><span class="p">[</span><span class="s2">&quot;lat&quot;</span><span class="p">],</span> <span class="n">st</span><span class="p">[</span><span class="s2">&quot;marker&quot;</span><span class="p">],</span>
                <span class="n">color</span><span class="o">=</span><span class="n">st</span><span class="p">[</span><span class="s2">&quot;color&quot;</span><span class="p">],</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
                <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">(),</span> <span class="n">label</span><span class="o">=</span><span class="n">st</span><span class="p">[</span><span class="s2">&quot;abbr&quot;</span><span class="p">])</span>
        <span class="c1"># Etichette leggermente spostate per evitare sovrapposizioni</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">st</span><span class="p">[</span><span class="s2">&quot;lon&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">st</span><span class="p">[</span><span class="s2">&quot;lat&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">st</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span>
                <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">(),</span>
                <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s2">&quot;bottom&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
                <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">boxstyle</span><span class="o">=</span><span class="s2">&quot;round,pad=0.2&quot;</span><span class="p">,</span> <span class="n">fc</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span> <span class="n">ec</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">))</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Arctic map: Ny-√Ölesund (NYA), Sodankyl√§ (SOD), Barrow/Utqiaƒ°vik (BAR)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">savepath</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">savepath</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_arctic_three_stations</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/7b26fd242369e414f7385334c6470c3a4ebbae6c2776a8f0c174c9ba25ac8d10.png" src="../_images/7b26fd242369e414f7385334c6470c3a4ebbae6c2776a8f0c174c9ba25ac8d10.png" />
</div>
</div>
<p><strong>Figure 1</strong>. The figure shows a map of the three Arctic GRUAN sites, which represent distinct regional environments within the Arctic.</p>
<p>Although Arctic amplification affects the entire Arctic region, its magnitude varies among different sectors and is strongest in the Eurasian sector of the Arctic Ocean. In general, the greatest amplification occurs in regions experiencing the strongest reductions in sea-ice extent, where albedo-feedback processes are particularly effective. However, regional variations in atmospheric circulation <a class="reference external" href="https://doi.org/10.1038/s43247-024-01605-2" rel="noreferrer" target="_blank">[3]</a>, water vapour, cloudiness, and geographical setting <a class="reference external" href="https://www.mdpi.com/2072-4292/15/4/1095" rel="noreferrer" target="_blank">[4]</a> also contribute to spatial heterogeneity in Arctic amplification.
The three Arctic GRUAN stations‚ÄîBarrow (BAR), Sodankyl√§ (SOD), and Ny-√Ölesund (NYA)‚Äîare located in different environments and therefore provide complementary perspectives on the Arctic atmosphere, particularly in the lower troposphere where interactions with the surface are more intense. NYA is directly influenced by the Arctic Ocean and by the seasonal presence or absence of sea ice. BAR is also affected by conditions over the nearby Beaufort Sea <a class="reference external" href="https://journals.ametsoc.org/view/journals/clim/36/13/JCLI-D-22-0434.1.xml" rel="noreferrer" target="_blank">[5]</a>, although its coastal location means that it is also influenced by the Alaskan interior. In contrast, SOD is located inland on the Scandinavian Peninsula, more than 250 km from the coast, and is therefore only indirectly affected by the Arctic Ocean.</p>
</section>
</section>
<section id="monthly-mean-temperature-and-seasonal-profiles">
<span id="insitu-insitu-observations-gruan-reference-network-resolution-q02-section-2"></span><h3>2. Monthly mean temperature and seasonal profiles<a class="headerlink" href="#monthly-mean-temperature-and-seasonal-profiles" title="Link to this heading">#</a></h3>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;station&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)),</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">dataarrays</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">station</span><span class="p">:</span> <span class="n">da</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="s2">&quot;1MS&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">station</span><span class="p">,</span> <span class="n">da</span> <span class="ow">in</span> <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;air_temperature&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;station&quot;</span><span class="p">)</span>
<span class="p">}</span>
<span class="n">vmin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">da</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">values</span> <span class="k">for</span> <span class="n">da</span> <span class="ow">in</span> <span class="n">dataarrays</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
<span class="n">vmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">da</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">values</span> <span class="k">for</span> <span class="n">da</span> <span class="ow">in</span> <span class="n">dataarrays</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
<span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="p">(</span><span class="n">station</span><span class="p">,</span> <span class="n">da_station</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axs</span><span class="p">,</span> <span class="n">dataarrays</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
    <span class="n">da_station</span> <span class="o">=</span> <span class="n">da_station</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">)</span>
    <span class="n">pcm</span> <span class="o">=</span> <span class="n">da_station</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
        <span class="n">x</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;coolwarm&quot;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">add_colorbar</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Station: </span><span class="si">{</span><span class="n">station</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">mdates</span><span class="o">.</span><span class="n">DateFormatter</span><span class="p">(</span><span class="s2">&quot;%Y-%m&quot;</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s2">&quot;vertical&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Temperature [K]&quot;</span><span class="p">)</span>
<span class="c1">#_= fig.suptitle(&quot;Monthly Mean Temperature&quot;)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/ebec0e5590e42985465db2d7c0f6cc063a6b66ae20e2fdb34ab4e3265720b578.png" src="../_images/ebec0e5590e42985465db2d7c0f6cc063a6b66ae20e2fdb34ab4e3265720b578.png" />
</div>
</div>
<p><strong>Figure 2</strong>. Monthly mean temperature profiles for the three GRUAN stations (BAR, NYA, and SOD), shown in separate panels. Due to limited data availability for SOD prior to 2011, the time series used in the analysis starts from 2011.</p>
<p>The monthly mean temperature profiles exhibit distinct annual cycles at the three Arctic stations. SOD shows the most pronounced annual cycle in tropospheric temperature, consistent with its more continental like climate, whereas NYA displays the weakest annual amplitude due to its oceanic background. A further difference in the vertical temperature structure among the sites appears in the stratosphere, where BAR shows a much weaker annual cycle than NYA and SOD.
These differences are highlighted by the seasonal profiles (Figure 3), which reveal contrasting near-surface thermal structures.</p>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">season_colors</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;DJF&quot;</span><span class="p">:</span> <span class="s2">&quot;tab:blue&quot;</span><span class="p">,</span>
    <span class="s2">&quot;MAM&quot;</span><span class="p">:</span> <span class="s2">&quot;tab:green&quot;</span><span class="p">,</span>
    <span class="s2">&quot;JJA&quot;</span><span class="p">:</span> <span class="s2">&quot;tab:orange&quot;</span><span class="p">,</span>
    <span class="s2">&quot;SON&quot;</span><span class="p">:</span> <span class="s2">&quot;tab:red&quot;</span><span class="p">,</span>
<span class="p">}</span>

<span class="c1"># Setup figure</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;station&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)),</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="p">(</span><span class="n">station</span><span class="p">,</span> <span class="n">ds_station</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axs</span><span class="p">,</span> <span class="n">ds</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;station&quot;</span><span class="p">)):</span>
    <span class="c1"># Compute seasonal mean</span>
    <span class="n">da</span> <span class="o">=</span> <span class="n">ds_station</span><span class="p">[</span><span class="s2">&quot;air_temperature&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="mf">273.15</span>  <span class="c1"># ¬∞C</span>
    <span class="n">grouped</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;time.season&quot;</span><span class="p">)</span>
    <span class="n">ds_seasonal</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">merge</span><span class="p">([</span><span class="n">grouped</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;mean&quot;</span><span class="p">),</span> <span class="n">grouped</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;std&quot;</span><span class="p">)])</span>
    <span class="k">for</span> <span class="n">season</span><span class="p">,</span> <span class="n">color</span> <span class="ow">in</span> <span class="n">season_colors</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="c1"># Plot</span>
        <span class="n">ds_season</span> <span class="o">=</span> <span class="n">ds_seasonal</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">season</span><span class="o">=</span><span class="n">season</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">ds_season</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">],</span> <span class="n">ds_season</span><span class="p">[</span><span class="s2">&quot;altitude&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">season</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span>
        <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">fill_betweenx</span><span class="p">(</span>
            <span class="n">ds_season</span><span class="p">[</span><span class="s2">&quot;altitude&quot;</span><span class="p">],</span>
            <span class="n">ds_season</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">ds_season</span><span class="p">[</span><span class="s2">&quot;std&quot;</span><span class="p">],</span>
            <span class="n">ds_season</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">ds_season</span><span class="p">[</span><span class="s2">&quot;std&quot;</span><span class="p">],</span>
            <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="c1"># Ax settings</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">station</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Temperature [¬∞C]&quot;</span><span class="p">)</span>
   <span class="c1"># ax.set_ylabel(&quot;Altitude [m]&quot;)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;Season&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mi">80</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
<span class="c1"># Figure settings</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Altitude [m]&quot;</span><span class="p">)</span>
<span class="c1">#_ = fig.suptitle(&quot;Seasonal profiles ¬±1œÉ&quot;)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/083862fcad43814b0ce8f927131e1befb82fa98f0b184d664eb604a3ed584a82.png" src="../_images/083862fcad43814b0ce8f927131e1befb82fa98f0b184d664eb604a3ed584a82.png" />
</div>
</div>
<p><strong>Figure 3</strong>. Seasonal vertical profiles of air temperature (¬∞C) for each station. Lines indicate the seasonal mean (DJF = blue, MAM = green, JJA = orange, SON = red); shaded bands denote ¬±1 standard deviation computed within each season.</p>
<p>BAR exhibits persistent surface-based inversions throughout the year, except in autumn when both inversion depth and strength decrease markedly. This seasonal weakening is consistent with previous studies attributing reduced inversion intensity to ocean heat release and delayed sea ice formation (e.g.<a class="reference external" href="https://journals.ametsoc.org/view/journals/clim/36/13/JCLI-D-22-0434.1.xml" rel="noreferrer" target="_blank">[5]</a>, <a class="reference external" href="https://onlinelibrary.wiley.com/doi/abs/10.1111/j.1600-0870.2009.00421.x" rel="noreferrer" target="_blank">[6]</a>, <a class="reference external" href="https://tc.copernicus.org/articles/3/11/2009/" rel="noreferrer" target="_blank">[7]</a>). SOD shows weaker winter inversions than BAR and maintains higher near-surface temperatures than both BAR and NYA across all seasons, consistent with its inland location and reduced maritime cooling (e.g. <a class="reference external" href="https://doi.org/10.1002/qj.4941?af=R" rel="noreferrer" target="_blank">[8]</a>).
At NYA, the evidence of persistent near-surface inversions is generally absent in seasonal profiles; however, previous studies report frequent shallow inversions (‚âà 80 % of profiles) under a variety of meteorological conditions (<a class="reference external" href="https://doi.org/10.1007/s00704-016-1864-0" rel="noreferrer" target="_blank">[1]</a>, <a class="reference external" href="https://www.sciencedirect.com/science/article/abs/pii/S016980952100082X" rel="noreferrer" target="_blank">[9]</a>).
Above about 8 km, near the tropopause and in the lower stratosphere, the thermal structure differs among the three stations, likely reflecting stratospheric circulation and polar-vortex dynamics <a class="reference external" href="https://doi.org/10.1007/s00704-016-1864-0" rel="noreferrer" target="_blank">[1]</a>. BAR tends to exhibit slightly warmer tropopause temperatures and a reduced amplitude of the stratospheric annual cycle, whereas NYA and SOD show more similar stratospheric conditions, consistent with a stronger and more persistent influence of the winter polar vortex in those regions.</p>
</section>
<section id="temperature-anomalies-and-trends">
<span id="insitu-insitu-observations-gruan-reference-network-resolution-q02-section-3"></span><h3>3.Temperature anomalies and trends<a class="headerlink" href="#temperature-anomalies-and-trends" title="Link to this heading">#</a></h3>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># --- Monthly temperature anomaly trend per station &amp; altitude (SOD from 2011, hatch where significant) ---</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span>
    <span class="s2">&quot;ignore&quot;</span><span class="p">,</span>
    <span class="n">message</span><span class="o">=</span><span class="s2">&quot;The figure layout has changed to tight&quot;</span><span class="p">,</span>
    <span class="n">category</span><span class="o">=</span><span class="ne">UserWarning</span><span class="p">,</span>
    <span class="n">module</span><span class="o">=</span><span class="s2">&quot;xarray.plot.facetgrid&quot;</span>
<span class="p">)</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">xarray</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">xr</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">scipy.stats</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mpl</span>

<span class="c1"># ---------- Linear regression helper: slope (per year) and significance (p-value &lt;= alpha) ----------</span>
<span class="k">def</span><span class="w"> </span><span class="nf">linregress_slope_significant</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Perform linear regression of y vs x and return slope (per year) and significance (p &lt;= alpha).</span>
<span class="sd">    Inputs:</span>
<span class="sd">      x: 1D array (numeric years, e.g., 2011, 2012, ...)</span>
<span class="sd">      y: 1D array (monthly temperature anomalies aligned with x)</span>
<span class="sd">      alpha: significance level (default 0.1)</span>
<span class="sd">    Returns:</span>
<span class="sd">      slope (units of y per unit of x, here ¬∞C/year), significant (bool)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mask</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="kc">False</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">linregress</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">mask</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">res</span><span class="o">.</span><span class="n">slope</span><span class="p">,</span> <span class="nb">bool</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">pvalue</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">pvalue</span> <span class="o">&lt;=</span> <span class="n">alpha</span><span class="p">))</span>

<span class="c1"># ---------- Per-station time filter: remove data before 2011 for SOD (APPLIED BEFORE anomalies) ----------</span>
<span class="c1"># Only SOD is filtered from 2011; other stations keep the full available range.</span>
<span class="n">station_time_filters</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;SOD&quot;</span><span class="p">:</span> <span class="s2">&quot;2011-01-01&quot;</span><span class="p">,</span>
<span class="p">}</span>

<span class="c1"># ---------- Build trend dataset for monthly temperature anomalies (¬∞C/year) ----------</span>
<span class="n">datasets</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">station</span><span class="p">,</span> <span class="n">da_station</span> <span class="ow">in</span> <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;air_temperature&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;station&quot;</span><span class="p">):</span>
    <span class="c1"># Convert to Celsius and compute monthly means (1MS = month start)</span>
    <span class="n">da_c</span> <span class="o">=</span> <span class="p">(</span><span class="n">da_station</span> <span class="o">-</span> <span class="mf">273.15</span><span class="p">)</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="s2">&quot;1MS&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Apply station-specific filter BEFORE computing anomalies:</span>
    <span class="c1"># this ensures climatology and anomalies are computed on the filtered period.</span>
    <span class="k">if</span> <span class="n">station</span> <span class="ow">in</span> <span class="n">station_time_filters</span><span class="p">:</span>
        <span class="n">da_c</span> <span class="o">=</span> <span class="n">da_c</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">station_time_filters</span><span class="p">[</span><span class="n">station</span><span class="p">],</span> <span class="kc">None</span><span class="p">))</span>

    <span class="c1"># Group by calendar month to regress within each month across years</span>
    <span class="k">for</span> <span class="n">month</span><span class="p">,</span> <span class="n">da_month</span> <span class="ow">in</span> <span class="n">da_c</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;time.month&quot;</span><span class="p">):</span>
        <span class="c1"># Monthly anomalies for this calendar month (remove mean over years on filtered data)</span>
        <span class="n">clim</span> <span class="o">=</span> <span class="n">da_month</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># month-specific climatology after filter</span>
        <span class="n">da_anom</span> <span class="o">=</span> <span class="n">da_month</span> <span class="o">-</span> <span class="n">clim</span>                       <span class="c1"># anomalies for this month across years</span>

        <span class="c1"># Vectorized regression per altitude (and any other non-time dims)</span>
        <span class="n">slope</span><span class="p">,</span> <span class="n">significant</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">apply_ufunc</span><span class="p">(</span>
            <span class="n">linregress_slope_significant</span><span class="p">,</span>
            <span class="n">da_month</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">,</span>  <span class="c1"># x: numeric years</span>
            <span class="n">da_anom</span><span class="p">,</span>                   <span class="c1"># y: monthly anomalies (¬∞C)</span>
            <span class="n">input_core_dims</span><span class="o">=</span><span class="p">[[</span><span class="s2">&quot;time&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]],</span>
            <span class="n">output_core_dims</span><span class="o">=</span><span class="p">[[],</span> <span class="p">[]],</span>
            <span class="n">vectorize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">dask</span><span class="o">=</span><span class="s2">&quot;parallelized&quot;</span><span class="p">,</span>
            <span class="n">output_dtypes</span><span class="o">=</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">bool</span><span class="p">],</span>  <span class="c1"># boolean significance</span>
        <span class="p">)</span>

        <span class="n">ds_slope</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;slope&quot;</span><span class="p">:</span> <span class="n">slope</span><span class="p">,</span>            <span class="c1"># ¬∞C per year</span>
                <span class="s2">&quot;significant&quot;</span><span class="p">:</span> <span class="n">significant</span> <span class="c1"># boolean</span>
            <span class="p">}</span>
        <span class="p">)</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">month</span><span class="o">=</span><span class="p">[</span><span class="n">month</span><span class="p">],</span> <span class="n">station</span><span class="o">=</span><span class="p">[</span><span class="n">station</span><span class="p">])</span>

        <span class="n">datasets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ds_slope</span><span class="p">)</span>

<span class="c1"># Combine across stations and months by coordinates</span>
<span class="n">ds_slope</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">combine_by_coords</span><span class="p">(</span><span class="n">datasets</span><span class="p">)</span>

<span class="c1"># Copy altitude attributes if present and set metadata</span>
<span class="k">if</span> <span class="s2">&quot;altitude&quot;</span> <span class="ow">in</span> <span class="n">ds</span><span class="p">:</span>
    <span class="n">ds_slope</span><span class="p">[</span><span class="s2">&quot;altitude&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;altitude&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span>

<span class="n">ds_slope</span><span class="p">[</span><span class="s2">&quot;slope&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;long_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Monthly temperature anomaly trend&quot;</span><span class="p">,</span>
    <span class="s2">&quot;units&quot;</span><span class="p">:</span> <span class="s2">&quot;¬∞C per year&quot;</span><span class="p">,</span>
    <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="s2">&quot;Linear regression of monthly anomalies by calendar month using years as x (SOD from 2011)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;significance_alpha&quot;</span><span class="p">:</span> <span class="mf">0.1</span>
<span class="p">}</span>
<span class="n">ds_slope</span><span class="p">[</span><span class="s2">&quot;significant&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;long_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Trend significance (p-value &lt;= alpha)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;boolean&quot;</span>
<span class="p">}</span>

<span class="c1"># ---------- Robust symmetric color limits for consistent colorbar ----------</span>
<span class="n">qlo</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ds_slope</span><span class="p">[</span><span class="s2">&quot;slope&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.02</span><span class="p">))</span>
<span class="n">qhi</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ds_slope</span><span class="p">[</span><span class="s2">&quot;slope&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.98</span><span class="p">))</span>
<span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">qlo</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">qhi</span><span class="p">):</span>
    <span class="n">max_abs</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">qlo</span><span class="p">),</span> <span class="nb">abs</span><span class="p">(</span><span class="n">qhi</span><span class="p">))</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">max_abs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ds_slope</span><span class="p">[</span><span class="s2">&quot;slope&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
<span class="n">VMIN</span><span class="p">,</span> <span class="n">VMAX</span> <span class="o">=</span> <span class="o">-</span><span class="n">max_abs</span><span class="p">,</span> <span class="n">max_abs</span>  <span class="c1"># symmetric around zero</span>

<span class="c1"># ---------- Facet plot WITHOUT internal colorbar; add a thin external colorbar ----------</span>
<span class="n">facet</span> <span class="o">=</span> <span class="n">ds_slope</span><span class="p">[</span><span class="s2">&quot;slope&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">col</span><span class="o">=</span><span class="s2">&quot;station&quot;</span><span class="p">,</span>
    <span class="n">x</span><span class="o">=</span><span class="s2">&quot;month&quot;</span><span class="p">,</span>
    <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
    <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;coolwarm&quot;</span><span class="p">,</span>
    <span class="n">add_colorbar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>     <span class="c1"># add external colorbar to avoid overlap</span>
    <span class="n">vmin</span><span class="o">=</span><span class="n">VMIN</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">VMAX</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">facet</span><span class="o">.</span><span class="n">fig</span>
<span class="c1"># Reserve room for a slim colorbar and a top title</span>
<span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">right</span><span class="o">=</span><span class="mf">0.86</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="mf">0.90</span><span class="p">)</span>

<span class="c1"># Y-label only on the first panel (first station column)</span>
<span class="n">first_station</span> <span class="o">=</span> <span class="n">facet</span><span class="o">.</span><span class="n">col_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">facet</span><span class="p">,</span> <span class="s2">&quot;col_names&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>

<span class="c1"># Overlay hatching where SIGNIFICANT; set y-limit; month ticks/labels; grid</span>
<span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">sel_dict</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">facet</span><span class="o">.</span><span class="n">axs</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">facet</span><span class="o">.</span><span class="n">name_dicts</span><span class="o">.</span><span class="n">flatten</span><span class="p">()):</span>
    <span class="n">ds_station</span> <span class="o">=</span> <span class="n">ds_slope</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">sel_dict</span><span class="p">)</span>

    <span class="c1"># Coordinates</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">ds_station</span><span class="p">[</span><span class="s2">&quot;month&quot;</span><span class="p">]</span>      <span class="c1"># 1..12</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">ds_station</span><span class="p">[</span><span class="s2">&quot;altitude&quot;</span><span class="p">]</span>   <span class="c1"># meters</span>

    <span class="c1"># 2D arrays in (altitude, month) order</span>
    <span class="n">slope_2d</span>  <span class="o">=</span> <span class="n">ds_station</span><span class="p">[</span><span class="s2">&quot;slope&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="s2">&quot;altitude&quot;</span><span class="p">,</span> <span class="s2">&quot;month&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
    <span class="n">signif_2d</span> <span class="o">=</span> <span class="n">ds_station</span><span class="p">[</span><span class="s2">&quot;significant&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="s2">&quot;altitude&quot;</span><span class="p">,</span> <span class="s2">&quot;month&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>

    <span class="c1"># Hatch SIGNIFICANT cells (/// = significant): unmask where significant -&gt; hatch drawn there</span>
    <span class="n">z_masked</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">(</span><span class="n">slope_2d</span><span class="p">,</span> <span class="n">mask</span><span class="o">=~</span><span class="n">signif_2d</span><span class="p">)</span>

    <span class="c1"># Transparent faces with hatch pattern overlay</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">pcolor</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z_masked</span><span class="p">,</span> <span class="n">hatch</span><span class="o">=</span><span class="s2">&quot;///&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Style: y-limit, ticks/labels, grid</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10000</span><span class="p">)</span>  <span class="c1"># y-axis 0‚Äì10,000 m</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Month&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">13</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s2">&quot;Jan&quot;</span><span class="p">,</span><span class="s2">&quot;Feb&quot;</span><span class="p">,</span><span class="s2">&quot;Mar&quot;</span><span class="p">,</span><span class="s2">&quot;Apr&quot;</span><span class="p">,</span><span class="s2">&quot;May&quot;</span><span class="p">,</span><span class="s2">&quot;Jun&quot;</span><span class="p">,</span><span class="s2">&quot;Jul&quot;</span><span class="p">,</span><span class="s2">&quot;Aug&quot;</span><span class="p">,</span><span class="s2">&quot;Sep&quot;</span><span class="p">,</span><span class="s2">&quot;Oct&quot;</span><span class="p">,</span><span class="s2">&quot;Nov&quot;</span><span class="p">,</span><span class="s2">&quot;Dec&quot;</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

    <span class="c1"># Y-label only on first panel</span>
    <span class="k">if</span> <span class="n">first_station</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">sel_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;station&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">first_station</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Altitude [m]&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

<span class="c1"># ---------- External thin colorbar on a dedicated axis ----------</span>
<span class="n">norm</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">VMIN</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">VMAX</span><span class="p">)</span>
<span class="n">mappable</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">ScalarMappable</span><span class="p">(</span><span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;coolwarm&quot;</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">)</span>
<span class="n">mappable</span><span class="o">.</span><span class="n">set_array</span><span class="p">([])</span>  <span class="c1"># required for Matplotlib colorbar</span>

<span class="c1"># Thin colorbar width (adjust if needed)</span>
<span class="n">cax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mf">0.88</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.012</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">])</span>  <span class="c1"># [left, bottom, width, height]</span>
<span class="n">cb</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">mappable</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">)</span>
<span class="n">cb</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s2">&quot;¬∞C per year&quot;</span><span class="p">)</span>

<span class="c1"># ---------- Title and show ----------</span>
<span class="c1">#fig.suptitle(&quot;Temperature Monthly Anomaly Trend (¬∞C per year)&quot;, fontsize=16)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/34dd87a99e99bfea3a81f28599f659d54c39ce226a05a8b7349813efd66783c7.png" src="../_images/34dd87a99e99bfea3a81f28599f659d54c39ce226a05a8b7349813efd66783c7.png" />
</div>
</div>
<p><strong>Figure 4</strong>: Monthly temperature anomaly trends (¬∞C per year) as a function of altitude for the GRUAN stations Barrow (BAR), Ny-√Ölesund (NYA), and Sodankyl√§ (SOD). Red shading indicates positive trends (warming), blue shading negative trends (cooling), and hatched areas denote statistical significance.</p>
<p>The monthly tropospheric temperature anomaly trends also differ among the three stations. SOD shows the strongest and most statistically significant warming, concentrated between April and December. However, significant cooling is evident in June and October (with June being statistically significant), indicating complex month-to-month variability in temperature trends.
At NYA, trends are generally weaker, but more consistently uniform throughout the year, with a predominance of positive values and statistically significant tropospheric warming between September and October. Only in December the trends become slightly negative between 2.5 km and 4 km, before returning to positive values in January and February, consistently with <a class="reference external" href="https://doi.org/10.1007/s00704-016-1864-0" rel="noreferrer" target="_blank">[1]</a>.
At BAR, the annual variability of the monthly trends is also high, with a pronounced and statistically significant cooling in June, like SOD. However, unlike SOD, BAR shows tropospheric warming in February and March.</p>
<p>To investigate the vertical structure of the trends, linear trends were computed for four altitude layers representing the near-surface region (0‚Äì1 km), the full troposphere (0‚Äì6 km), and the lower (13‚Äì15 km) and middle (16‚Äì23 km) stratosphere. Vertical means were determined by selecting specific altitude intervals and calculating the monthly averages. Monthly anomalies were calculated by removing the climatological average for each month over the entire period. The linear trend of the anomalies was then estimated, including a significance test.</p>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># -------------------------</span>
<span class="c1"># INPUT DATA AND PARAMETERS</span>
<span class="c1"># -------------------------</span>
<span class="c1"># Convert air temperature from K to ¬∞C</span>
<span class="n">da_temp</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;air_temperature&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="mf">273.15</span>

<span class="n">intervals</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;0-1 km&quot;</span><span class="p">:</span>  <span class="p">(</span><span class="mi">0</span><span class="p">,</span>      <span class="mi">1_000</span><span class="p">),</span>
    <span class="s2">&quot;0-8 km&quot;</span><span class="p">:</span>  <span class="p">(</span><span class="mi">0</span><span class="p">,</span>      <span class="mi">8_000</span><span class="p">),</span>
    <span class="s2">&quot;13-15 km&quot;</span><span class="p">:(</span><span class="mi">13_000</span><span class="p">,</span> <span class="mi">15_000</span><span class="p">),</span>
    <span class="s2">&quot;16-23 km&quot;</span><span class="p">:(</span><span class="mi">16_000</span><span class="p">,</span> <span class="mi">23_000</span><span class="p">),</span>
<span class="p">}</span>

<span class="c1"># Results dictionary: results[interval_label][station] = {...}</span>
<span class="n">results</span> <span class="o">=</span> <span class="p">{</span><span class="n">label</span><span class="p">:</span> <span class="p">{}</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">intervals</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>

<span class="c1"># ---------------------------------------</span>
<span class="c1"># BUILD ANOMALIES AND LINEAR TREND BY BOX</span>
<span class="c1"># ---------------------------------------</span>
<span class="k">for</span> <span class="n">station</span><span class="p">,</span> <span class="n">da_station</span> <span class="ow">in</span> <span class="n">da_temp</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;station&quot;</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="p">(</span><span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">)</span> <span class="ow">in</span> <span class="n">intervals</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="c1"># Select altitude interval. Prefer sel(slice) if altitude is monotonic.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">da_interval</span> <span class="o">=</span> <span class="n">da_station</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">altitude</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">da_interval</span><span class="o">.</span><span class="n">sizes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;altitude&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># Fallback to where in case altitude is not sorted</span>
                <span class="n">da_interval</span> <span class="o">=</span> <span class="n">da_station</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">da_station</span><span class="p">[</span><span class="s2">&quot;altitude&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">low</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">da_station</span><span class="p">[</span><span class="s2">&quot;altitude&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">high</span><span class="p">),</span>
                    <span class="n">drop</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">da_interval</span> <span class="o">=</span> <span class="n">da_station</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                <span class="p">(</span><span class="n">da_station</span><span class="p">[</span><span class="s2">&quot;altitude&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">low</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">da_station</span><span class="p">[</span><span class="s2">&quot;altitude&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">high</span><span class="p">),</span>
                <span class="n">drop</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>

        <span class="c1"># Skip if no data in interval</span>
        <span class="k">if</span> <span class="n">da_interval</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">da_interval</span><span class="o">.</span><span class="n">sizes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;altitude&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># Vertical mean over altitude</span>
        <span class="n">da_mean_profile</span> <span class="o">=</span> <span class="n">da_interval</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;altitude&quot;</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Monthly mean (1MS = month start)</span>
        <span class="n">da_monthly</span> <span class="o">=</span> <span class="n">da_mean_profile</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="s2">&quot;1MS&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Station-specific time filter: exclude data before 2011 for BAR</span>
        <span class="k">if</span> <span class="n">station</span> <span class="o">==</span> <span class="s2">&quot;SOD&quot;</span><span class="p">:</span>
            <span class="n">da_monthly</span> <span class="o">=</span> <span class="n">da_monthly</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="s2">&quot;2011-01-01&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>

        <span class="c1"># Convert to pandas DataFrame</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="p">{</span><span class="s2">&quot;temp&quot;</span><span class="p">:</span> <span class="n">da_monthly</span><span class="o">.</span><span class="n">values</span><span class="p">},</span>
            <span class="n">index</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">da_monthly</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>

        <span class="c1"># Skip short or empty series</span>
        <span class="k">if</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;temp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># -------------------------</span>
        <span class="c1"># MONTHLY ANOMALIES</span>
        <span class="c1"># -------------------------</span>
        <span class="c1"># Monthly climatology over the whole series</span>
        <span class="n">clim</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span><span class="p">)[</span><span class="s2">&quot;temp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="c1"># Vectorized anomaly: T - monthly climatology</span>
        <span class="n">anomalies</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">anomalies</span><span class="p">[</span><span class="s2">&quot;anom&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;temp&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">clim</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>

        <span class="c1"># -------------------------</span>
        <span class="c1"># LINEAR TREND ON ANOMALIES</span>
        <span class="c1"># -------------------------</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">mdates</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">anomalies</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>      <span class="c1"># x in days (Matplotlib date numbers)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">anomalies</span><span class="p">[</span><span class="s2">&quot;anom&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

        <span class="n">mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mask</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">slope_day</span><span class="p">,</span> <span class="n">intercept</span><span class="p">,</span> <span class="n">r_value</span><span class="p">,</span> <span class="n">p_value</span><span class="p">,</span> <span class="n">std_err</span> <span class="o">=</span> <span class="n">linregress</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">mask</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">slope_day</span><span class="p">,</span> <span class="n">intercept</span><span class="p">,</span> <span class="n">r_value</span><span class="p">,</span> <span class="n">p_value</span><span class="p">,</span> <span class="n">std_err</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

        <span class="c1"># Trend line evaluated on the full x axis</span>
        <span class="n">trend_line</span> <span class="o">=</span> <span class="n">intercept</span> <span class="o">+</span> <span class="n">slope_day</span> <span class="o">*</span> <span class="n">x</span>

        <span class="c1"># Significance at 10%</span>
        <span class="n">significant</span> <span class="o">=</span> <span class="p">(</span><span class="n">p_value</span> <span class="o">&lt;=</span> <span class="mf">0.1</span><span class="p">)</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">p_value</span><span class="p">)</span> <span class="k">else</span> <span class="kc">False</span>

        <span class="c1"># Save results for plotting</span>
        <span class="n">results</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="n">station</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">anomalies</span><span class="p">,</span>            <span class="c1"># DataFrame with columns: temp, anom</span>
            <span class="s2">&quot;slope_day&quot;</span><span class="p">:</span> <span class="n">slope_day</span><span class="p">,</span>       <span class="c1"># ¬∞C/day</span>
            <span class="s2">&quot;slope_year&quot;</span><span class="p">:</span> <span class="n">slope_day</span> <span class="o">*</span> <span class="mf">365.25</span><span class="p">,</span>  <span class="c1"># ¬∞C/year (converted)</span>
            <span class="s2">&quot;intercept&quot;</span><span class="p">:</span> <span class="n">intercept</span><span class="p">,</span>
            <span class="s2">&quot;p_value&quot;</span><span class="p">:</span> <span class="n">p_value</span><span class="p">,</span>
            <span class="s2">&quot;r_value&quot;</span><span class="p">:</span> <span class="n">r_value</span><span class="p">,</span>
            <span class="s2">&quot;std_err&quot;</span><span class="p">:</span> <span class="n">std_err</span><span class="p">,</span>
            <span class="s2">&quot;trend_line&quot;</span><span class="p">:</span> <span class="n">trend_line</span><span class="p">,</span>     <span class="c1"># numpy array aligned with anomalies.index</span>
            <span class="s2">&quot;significant&quot;</span><span class="p">:</span> <span class="n">significant</span><span class="p">,</span>
        <span class="p">}</span>

<span class="c1"># -------------------------</span>
<span class="c1"># PLOTTING</span>
<span class="c1"># -------------------------</span>
<span class="c1"># Station and interval labels</span>
<span class="n">station_labels</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">({</span><span class="n">s</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">keys</span><span class="p">()})</span>
<span class="n">interval_labels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">intervals</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">station_labels</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No valid data for the requested station-interval combinations.&quot;</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">station_labels</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">interval_labels</span><span class="p">),</span>
                        <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">15</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Ensure axs is 2D even if one row/column</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">station_labels</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">interval_labels</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
    <span class="n">axs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">axs</span><span class="p">]])</span>
<span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">station_labels</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
    <span class="n">axs</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>
<span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">interval_labels</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
    <span class="n">axs</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">station</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">station_labels</span><span class="p">):</span>        <span class="c1"># rows = stations</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">interval_labels</span><span class="p">):</span>     <span class="c1"># columns = altitude intervals</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>

        <span class="c1"># Hide panel if combination is missing</span>
        <span class="k">if</span> <span class="n">station</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">results</span><span class="p">[</span><span class="n">label</span><span class="p">]:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="n">station</span><span class="p">]</span>
        <span class="n">df_station</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span>
        <span class="n">trend_line</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;trend_line&quot;</span><span class="p">]</span>
        <span class="n">signif</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;significant&quot;</span><span class="p">]</span>

        <span class="c1"># Plot anomalies</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_station</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df_station</span><span class="p">[</span><span class="s2">&quot;anom&quot;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;tab:blue&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Anomaly&quot;</span><span class="p">)</span>

        <span class="c1"># Plot linear trend</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_station</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">trend_line</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;tab:red&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Trend&quot;</span><span class="p">)</span>

        <span class="c1"># Highlight significant panels (p &lt;= 0.1)</span>
        <span class="k">if</span> <span class="n">signif</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">(</span><span class="s2">&quot;#b3ffb3&quot;</span><span class="p">)</span>  <span class="c1"># green background</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="mf">0.4</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">spine</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">spine</span><span class="o">.</span><span class="n">set_edgecolor</span><span class="p">(</span><span class="s2">&quot;green&quot;</span><span class="p">)</span>
                <span class="n">spine</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">(</span><span class="s2">&quot;white&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">spine</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">spine</span><span class="o">.</span><span class="n">set_edgecolor</span><span class="p">(</span><span class="s2">&quot;gray&quot;</span><span class="p">)</span>
                <span class="n">spine</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># --- Trend label in the bottom-right corner inside each panel ---</span>
        <span class="n">slope_year</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;slope_year&quot;</span><span class="p">]</span>
        
        <span class="c1"># Only annotate if slope is finite and we have a time axis</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">slope_year</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="s2">&quot;trend_line&quot;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Text to display (prefix &#39;slope:&#39; as requested)</span>
            <span class="n">label_txt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;slope: </span><span class="si">{</span><span class="n">slope_year</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> ¬∞C/year&quot;</span>
        
            <span class="c1"># Place it inside the axes, bottom-right, using axes-fraction coordinates</span>
            <span class="c1"># (x, y) = (0.98, 0.04) puts the text near the bottom-right with a small margin</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
                <span class="mf">0.98</span><span class="p">,</span> <span class="mf">0.04</span><span class="p">,</span> <span class="n">label_txt</span><span class="p">,</span>
                <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span>            <span class="c1"># axes fraction coordinates (0..1)</span>
                <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s2">&quot;bottom&quot;</span><span class="p">,</span>
                <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;tab:red&quot;</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">,</span>
                <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.85</span><span class="p">,</span> <span class="n">boxstyle</span><span class="o">=</span><span class="s2">&quot;round,pad=0.2&quot;</span><span class="p">),</span>
                <span class="n">zorder</span><span class="o">=</span><span class="mi">5</span>
            <span class="p">)</span>


        <span class="c1"># Panel title and grid</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">station</span><span class="si">}</span><span class="s2"> | </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="c1"># Common axis labels</span>
<span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]:</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Year&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axs</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]:</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Temperature anomaly [¬∞C]&quot;</span><span class="p">)</span>

<span class="c1"># Date formatting</span>
<span class="n">fig</span><span class="o">.</span><span class="n">autofmt_xdate</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/cb310d9b041b9827f2fb749acaf93e53f83507382caf61b22db65ad6863463ba.png" src="../_images/cb310d9b041b9827f2fb749acaf93e53f83507382caf61b22db65ad6863463ba.png" />
</div>
</div>
<p><strong>Figure 5</strong>: Time series of monthly temperature anomalies at four altitude layers (0‚Äì1 km, 0‚Äì6 km, 13‚Äì15 km, and 16‚Äì23 km) for the GRUAN stations Barrow (BAR, top row), Ny-√Ölesund (NYA, middle row), and Sodankyl√§ (SOD, bottom row). Blue lines represent anomalies, and red dashed lines indicate linear trends, with slopes (¬∞C per year) shown in red text.</p>
<p>Positive trends dominate both SOD and NYA, both below 1 km and throughout the troposphere. BAR also exhibits positive tropospheric trends, albeit of a smaller magnitude than at the other two stations.
In the stratosphere, however, neither the magnitude nor the spatial consistency of the trends indicates a clear, consistent signal across the three stations. The only robust feature is the statistically significant negative trend of ‚àí0.19 ¬∞C yr‚Åª¬π between 13 km and 15 km at SOD.</p>
</section>
<section id="specific-humidity-and-iwv-anomalies-and-trends">
<span id="insitu-insitu-observations-gruan-reference-network-resolution-q02-section-4"></span><h3>4. Specific humidity and IWV anomalies and trends<a class="headerlink" href="#specific-humidity-and-iwv-anomalies-and-trends" title="Link to this heading">#</a></h3>
<section id="specific-humidity-seasonal-profiles-and-monthly-mean-trends">
<h4>Specific humidity seasonal profiles and monthly mean trends<a class="headerlink" href="#specific-humidity-seasonal-profiles-and-monthly-mean-trends" title="Link to this heading">#</a></h4>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#specific humidity (g/kg)</span>
<span class="n">fig_q</span><span class="p">,</span> <span class="n">axs_q</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;station&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)),</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span><span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="p">(</span><span class="n">station</span><span class="p">,</span> <span class="n">ds_station</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axs_q</span><span class="p">,</span> <span class="n">ds</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;station&quot;</span><span class="p">)):</span>
 
    <span class="n">da_q</span> <span class="o">=</span> <span class="n">ds_station</span><span class="p">[</span><span class="s2">&quot;specific_humidity&quot;</span><span class="p">]</span>  <span class="c1"># g/kg</span>

    <span class="n">grouped_q</span> <span class="o">=</span> <span class="n">da_q</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;time.season&quot;</span><span class="p">)</span>
    <span class="n">ds_seasonal_q</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">merge</span><span class="p">([</span>
        <span class="n">grouped_q</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;mean&quot;</span><span class="p">),</span>
        <span class="n">grouped_q</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;std&quot;</span><span class="p">),</span>
    <span class="p">])</span>

    <span class="k">for</span> <span class="n">season</span><span class="p">,</span> <span class="n">color</span> <span class="ow">in</span> <span class="n">season_colors</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">ds_season_q</span> <span class="o">=</span> <span class="n">ds_seasonal_q</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">season</span><span class="o">=</span><span class="n">season</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">ds_season_q</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">],</span> <span class="n">ds_season_q</span><span class="p">[</span><span class="s2">&quot;altitude&quot;</span><span class="p">],</span>
            <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">season</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span>
        <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">fill_betweenx</span><span class="p">(</span>
            <span class="n">ds_season_q</span><span class="p">[</span><span class="s2">&quot;altitude&quot;</span><span class="p">],</span>
            <span class="n">ds_season_q</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">ds_season_q</span><span class="p">[</span><span class="s2">&quot;std&quot;</span><span class="p">],</span>
            <span class="n">ds_season_q</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">ds_season_q</span><span class="p">[</span><span class="s2">&quot;std&quot;</span><span class="p">],</span>
            <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Station: </span><span class="si">{</span><span class="n">station</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Specific Humidity [g/kg]&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;Season&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10000</span><span class="p">)</span> 

<span class="n">axs_q</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Altitude [m]&quot;</span><span class="p">)</span>
<span class="c1">#_ = fig_q.suptitle(&quot;Seasonal specific humidity profiles ¬±1œÉ&quot;)</span>
<span class="c1">#plt.tight_layout()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/8a09addb93361a455240d73e50ce6d50ed257e017b7cbc50104a2fa3c5cb2398.png" src="../_images/8a09addb93361a455240d73e50ce6d50ed257e017b7cbc50104a2fa3c5cb2398.png" />
</div>
</div>
<p><strong>Figure 6</strong>. Seasonal vertical profiles of specific humidity (g/kg) for each station. For each season (DJF = blue, MAM = green, JJA = orange, SON = red), the solid line shows the seasonal mean and the shaded band indicates ¬±1 standard deviation at each altitude.</p>
<p>The seasonal vertical profiles of specific humidity up to 10 km altitude show clear spatial and seasonal contrasts among the three GRUAN stations. SOD consistently reports higher humidity across all altitudes and seasons than BAR and NYA, mainly because of its inland location and reduced direct influence from the Arctic Ocean. Consistent with the seasonal temperature structure, NYA exhibits the weakest annual variability in specific humidity, reflecting the dominant role of the surrounding ocean.
At all stations, summer (JJA) shows the highest humidity, with steep vertical gradients below about 2 km, likely driven by enhanced surface heating and evaporation. Winter (DJF) presents the driest conditions, particularly above 2 km, due to strong static stability and the limited water vapour holding capacity of cold air. Variability bands widen in summer, suggesting an enhanced role of synoptic-scale systems and local convection. Seasonal humidity profiles in the Arctic are influenced by a combination of large-scale circulation and local processes such as radiation, cloud formation, and turbulence <a class="reference external" href="https://wcd.copernicus.org/articles/2/1263/2021/" rel="noreferrer" target="_blank">[10]</a>.</p>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># --- Specific humidity monthly anomaly trend per station &amp; altitude (same style as temperature, thinner colorbar) ---</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span>
    <span class="s2">&quot;ignore&quot;</span><span class="p">,</span>
    <span class="n">message</span><span class="o">=</span><span class="s2">&quot;The figure layout has changed to tight&quot;</span><span class="p">,</span>
    <span class="n">category</span><span class="o">=</span><span class="ne">UserWarning</span><span class="p">,</span>
    <span class="n">module</span><span class="o">=</span><span class="s2">&quot;xarray.plot.facetgrid&quot;</span>
<span class="p">)</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">xarray</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">xr</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">scipy.stats</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mpl</span>

<span class="c1"># ---------- Helper: linear regression returning slope and significance (p-value &lt;= alpha) ----------</span>
<span class="k">def</span><span class="w"> </span><span class="nf">linregress_slope_significant</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Perform linear regression of y vs x and return slope and significance.</span>
<span class="sd">    Inputs:</span>
<span class="sd">      x: 1D array (years: 2011, 2012, ...)</span>
<span class="sd">      y: 1D array (specific humidity values aligned with x)</span>
<span class="sd">      alpha: significance level, default 0.1</span>
<span class="sd">    Returns:</span>
<span class="sd">      slope (units of y per unit of x), significant (bool, True if p-value &lt;= alpha)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mask</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="kc">False</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">linregress</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">mask</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">res</span><span class="o">.</span><span class="n">slope</span><span class="p">,</span> <span class="nb">bool</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">pvalue</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">pvalue</span> <span class="o">&lt;=</span> <span class="n">alpha</span><span class="p">))</span>

<span class="c1"># ---------- Per-station time filters (start date inclusive) ----------</span>
<span class="n">station_time_filters</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;SOD&quot;</span><span class="p">:</span> <span class="s2">&quot;2011-01-01&quot;</span><span class="p">,</span>   <span class="c1"># apply SOD from 2011 as requested</span>
    <span class="c1"># add others if needed, e.g., &quot;BAR&quot;: &quot;2011-01-01&quot;</span>
<span class="p">}</span>

<span class="c1"># ---------- Build trend dataset for specific humidity (assumed in g/kg) ----------</span>
<span class="n">datasets_q</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">station</span><span class="p">,</span> <span class="n">da_station</span> <span class="ow">in</span> <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;specific_humidity&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;station&quot;</span><span class="p">):</span>
    <span class="c1"># Monthly mean (1MS = month start); keep native units (g/kg)</span>
    <span class="n">da_q</span> <span class="o">=</span> <span class="n">da_station</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="s2">&quot;1MS&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">)</span>

    <span class="c1"># Apply station-specific time filter if defined</span>
    <span class="k">if</span> <span class="n">station</span> <span class="ow">in</span> <span class="n">station_time_filters</span><span class="p">:</span>
        <span class="n">da_q</span> <span class="o">=</span> <span class="n">da_q</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">station_time_filters</span><span class="p">[</span><span class="n">station</span><span class="p">],</span> <span class="kc">None</span><span class="p">))</span>

    <span class="c1"># Group by calendar month: compute one slope per (altitude, month)</span>
    <span class="k">for</span> <span class="n">month</span><span class="p">,</span> <span class="n">da_month</span> <span class="ow">in</span> <span class="n">da_q</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;time.month&quot;</span><span class="p">):</span>
        <span class="n">slope</span><span class="p">,</span> <span class="n">significant</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">apply_ufunc</span><span class="p">(</span>
            <span class="n">linregress_slope_significant</span><span class="p">,</span>
            <span class="n">da_month</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">,</span>    <span class="c1"># x: numeric years</span>
            <span class="n">da_month</span><span class="p">,</span>                    <span class="c1"># y: specific humidity (g/kg)</span>
            <span class="n">input_core_dims</span><span class="o">=</span><span class="p">[[</span><span class="s2">&quot;time&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]],</span>
            <span class="n">output_core_dims</span><span class="o">=</span><span class="p">[[],</span> <span class="p">[]],</span>
            <span class="n">vectorize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">dask</span><span class="o">=</span><span class="s2">&quot;parallelized&quot;</span><span class="p">,</span>
            <span class="n">output_dtypes</span><span class="o">=</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">bool</span><span class="p">],</span>  <span class="c1"># boolean significance</span>
        <span class="p">)</span>

        <span class="n">ds_slope_q</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;slope&quot;</span><span class="p">:</span> <span class="n">slope</span><span class="p">,</span>            <span class="c1"># g/kg per year (since x=year)</span>
                <span class="s2">&quot;significant&quot;</span><span class="p">:</span> <span class="n">significant</span> <span class="c1"># boolean</span>
            <span class="p">}</span>
        <span class="p">)</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">month</span><span class="o">=</span><span class="p">[</span><span class="n">month</span><span class="p">],</span> <span class="n">station</span><span class="o">=</span><span class="p">[</span><span class="n">station</span><span class="p">])</span>

        <span class="n">datasets_q</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ds_slope_q</span><span class="p">)</span>

<span class="c1"># Combine all partial datasets by coordinates</span>
<span class="n">ds_slope_q</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">combine_by_coords</span><span class="p">(</span><span class="n">datasets_q</span><span class="p">)</span>

<span class="c1"># Copy altitude attributes if present and add metadata to variables</span>
<span class="k">if</span> <span class="s2">&quot;altitude&quot;</span> <span class="ow">in</span> <span class="n">ds</span><span class="p">:</span>
    <span class="n">ds_slope_q</span><span class="p">[</span><span class="s2">&quot;altitude&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;altitude&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span>

<span class="n">ds_slope_q</span><span class="p">[</span><span class="s2">&quot;slope&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;long_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Specific humidity trend&quot;</span><span class="p">,</span>
    <span class="s2">&quot;units&quot;</span><span class="p">:</span> <span class="s2">&quot;g/kg per year&quot;</span><span class="p">,</span>
    <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="s2">&quot;Linear regression on monthly series by calendar month using years as x&quot;</span><span class="p">,</span>
    <span class="s2">&quot;significance_alpha&quot;</span><span class="p">:</span> <span class="mf">0.1</span>
<span class="p">}</span>
<span class="n">ds_slope_q</span><span class="p">[</span><span class="s2">&quot;significant&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;long_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Trend significance (p-value &lt;= alpha)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;boolean&quot;</span>
<span class="p">}</span>

<span class="c1"># ---------- Compute robust symmetric color limits (ensure consistent external colorbar) ----------</span>
<span class="n">qlo</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ds_slope_q</span><span class="p">[</span><span class="s2">&quot;slope&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.02</span><span class="p">))</span>
<span class="n">qhi</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ds_slope_q</span><span class="p">[</span><span class="s2">&quot;slope&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.98</span><span class="p">))</span>
<span class="n">max_abs</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">qlo</span><span class="p">),</span> <span class="nb">abs</span><span class="p">(</span><span class="n">qhi</span><span class="p">))</span>
<span class="n">VMIN</span><span class="p">,</span> <span class="n">VMAX</span> <span class="o">=</span> <span class="o">-</span><span class="n">max_abs</span><span class="p">,</span> <span class="n">max_abs</span>  <span class="c1"># symmetric color limits around zero</span>

<span class="c1"># ---------- Facet plot WITHOUT internal colorbar; add an external colorbar (same layout as temperature) ----------</span>
<span class="n">facet_q</span> <span class="o">=</span> <span class="n">ds_slope_q</span><span class="p">[</span><span class="s2">&quot;slope&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">col</span><span class="o">=</span><span class="s2">&quot;station&quot;</span><span class="p">,</span>
    <span class="n">x</span><span class="o">=</span><span class="s2">&quot;month&quot;</span><span class="p">,</span>
    <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
    <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;coolwarm&quot;</span><span class="p">,</span>
    <span class="n">add_colorbar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>      <span class="c1"># avoid overlap; we will add a right-side colorbar</span>
    <span class="n">vmin</span><span class="o">=</span><span class="n">VMIN</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">VMAX</span><span class="p">,</span>    <span class="c1"># use robust symmetric limits computed above</span>
<span class="p">)</span>

<span class="c1"># Reserve right margin for colorbar and top margin for title (same as temperature)</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">facet_q</span><span class="o">.</span><span class="n">fig</span>
<span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">right</span><span class="o">=</span><span class="mf">0.86</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="mf">0.90</span><span class="p">)</span>

<span class="c1"># Identify the first station (first column) to set y-label only there</span>
<span class="n">first_station</span> <span class="o">=</span> <span class="n">facet_q</span><span class="o">.</span><span class="n">col_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">facet_q</span><span class="p">,</span> <span class="s2">&quot;col_names&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>

<span class="c1"># Overlay hatching on SIGNIFICANT cells; limit y-axis; set month ticks/labels; add grid</span>
<span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">sel_dict</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">facet_q</span><span class="o">.</span><span class="n">axs</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">facet_q</span><span class="o">.</span><span class="n">name_dicts</span><span class="o">.</span><span class="n">flatten</span><span class="p">()):</span>
    <span class="n">ds_station_q</span> <span class="o">=</span> <span class="n">ds_slope_q</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">sel_dict</span><span class="p">)</span>

    <span class="c1"># Coordinates</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">ds_station_q</span><span class="p">[</span><span class="s2">&quot;month&quot;</span><span class="p">]</span>            <span class="c1"># 1..12</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">ds_station_q</span><span class="p">[</span><span class="s2">&quot;altitude&quot;</span><span class="p">]</span>         <span class="c1"># altitude in meters</span>

    <span class="c1"># 2D arrays as (altitude, month)</span>
    <span class="n">slope_2d</span>  <span class="o">=</span> <span class="n">ds_station_q</span><span class="p">[</span><span class="s2">&quot;slope&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="s2">&quot;altitude&quot;</span><span class="p">,</span> <span class="s2">&quot;month&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
    <span class="n">signif_2d</span> <span class="o">=</span> <span class="n">ds_station_q</span><span class="p">[</span><span class="s2">&quot;significant&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="s2">&quot;altitude&quot;</span><span class="p">,</span> <span class="s2">&quot;month&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>

    <span class="c1"># Hatch SIGNIFICANT cells (/// = significant): unmask where significant -&gt; hatch drawn there</span>
    <span class="n">z_masked</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">(</span><span class="n">slope_2d</span><span class="p">,</span> <span class="n">mask</span><span class="o">=~</span><span class="n">signif_2d</span><span class="p">)</span>

    <span class="c1"># Draw transparent faces with hatch pattern on the same grid</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">pcolor</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z_masked</span><span class="p">,</span> <span class="n">hatch</span><span class="o">=</span><span class="s2">&quot;///&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Match temperature plot styling</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10000</span><span class="p">)</span>  <span class="c1"># y-axis 0‚Äì10,000 m</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Month&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">13</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s2">&quot;Jan&quot;</span><span class="p">,</span><span class="s2">&quot;Feb&quot;</span><span class="p">,</span><span class="s2">&quot;Mar&quot;</span><span class="p">,</span><span class="s2">&quot;Apr&quot;</span><span class="p">,</span><span class="s2">&quot;May&quot;</span><span class="p">,</span><span class="s2">&quot;Jun&quot;</span><span class="p">,</span><span class="s2">&quot;Jul&quot;</span><span class="p">,</span><span class="s2">&quot;Aug&quot;</span><span class="p">,</span><span class="s2">&quot;Sep&quot;</span><span class="p">,</span><span class="s2">&quot;Oct&quot;</span><span class="p">,</span><span class="s2">&quot;Nov&quot;</span><span class="p">,</span><span class="s2">&quot;Dec&quot;</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

    <span class="c1"># Y-label only on the first panel (first station column)</span>
    <span class="k">if</span> <span class="n">first_station</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">sel_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;station&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">first_station</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Altitude [m]&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

<span class="c1"># ---------- External colorbar on a dedicated axis (thinner width) ----------</span>
<span class="n">norm</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">VMIN</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">VMAX</span><span class="p">)</span>
<span class="n">mappable</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">ScalarMappable</span><span class="p">(</span><span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;coolwarm&quot;</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">)</span>
<span class="n">mappable</span><span class="o">.</span><span class="n">set_array</span><span class="p">([])</span>  <span class="c1"># required for Matplotlib colorbar</span>

<span class="c1"># Make the colorbar thinner by reducing its axis width (from 0.02 to 0.012)</span>
<span class="n">cax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mf">0.88</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.012</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">])</span>  <span class="c1"># [left, bottom, width, height] (thinner width)</span>
<span class="n">cb</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">mappable</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">)</span>
<span class="n">cb</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s2">&quot;g/kg per year&quot;</span><span class="p">)</span>

<span class="c1"># ---------- Title and show ----------</span>
<span class="c1">#fig.suptitle(&quot;Specific Humidity Monthly Trend (g/kg per year)&quot;, fontsize=16)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/4e064b0162c6cdd94bc51c896ade799322c484ee67342b711395de1fe61abe19.png" src="../_images/4e064b0162c6cdd94bc51c896ade799322c484ee67342b711395de1fe61abe19.png" />
</div>
</div>
<p><strong>Figure 7</strong>. Monthly trends of specific humidity (g/kg per year) as a function of altitude for the GRUAN stations Barrow (BAR), Ny-√Ölesund (NYA), and Sodankyl√§ (SOD). Red shading indicates positive trends (increasing humidity), blue shading negative trends (decreasing humidity), and hatched areas denote statistical significance.</p>
<p>In general, the trends in specific humidity show much greater variability than the temperature trends (Figure 7), in terms of both magnitude and vertical structure.
SOD exhibits pronounced positive trends in spring and late summer at most altitudes, whereas NYA shows weaker, more uniform moistening throughout the year. Notably, six months out of twelve show statistically significant positive trends between 4 km and 10 km at SOD, indicating a clear increase in free-tropospheric water vapour content, especially during the months preceding and following the short Arctic summer (April‚ÄìMay and August‚ÄìSeptember).
By contrast, BAR exhibits more variable behaviour, with alternating moistening and drying signals in different months and at different altitudes.</p>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># --- IWV from dataset ---</span>
<span class="n">da_iwv</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;integrated_water_vapour&quot;</span><span class="p">]</span>

<span class="n">results_iwv</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">for</span> <span class="n">station</span><span class="p">,</span> <span class="n">da_station</span> <span class="ow">in</span> <span class="n">da_iwv</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;station&quot;</span><span class="p">):</span>
    <span class="c1"># Monthly mean (1MS = month start)</span>
    <span class="n">da_monthly</span> <span class="o">=</span> <span class="n">da_station</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="s2">&quot;1MS&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

    <span class="c1"># --- Station-specific time filter: remove data before 2011 for SOD ---</span>
    <span class="c1"># Apply BEFORE climatology/anomalies to keep computations consistent with the target period.</span>
    <span class="k">if</span> <span class="n">station</span> <span class="o">==</span> <span class="s2">&quot;SOD&quot;</span><span class="p">:</span>
        <span class="n">da_monthly</span> <span class="o">=</span> <span class="n">da_monthly</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="s2">&quot;2011-01-01&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>

    <span class="c1"># Convert to pandas DataFrame</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
        <span class="p">{</span><span class="s2">&quot;iwv&quot;</span><span class="p">:</span> <span class="n">da_monthly</span><span class="o">.</span><span class="n">values</span><span class="p">},</span>
        <span class="n">index</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">da_monthly</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    <span class="p">)</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>

    <span class="c1"># Skip short series</span>
    <span class="k">if</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;iwv&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">continue</span>

    <span class="c1"># --- Monthly climatology over the filtered period ---</span>
    <span class="n">climatology</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span><span class="p">)[</span><span class="s2">&quot;iwv&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

    <span class="c1"># --- Monthly anomalies (vectorized) ---</span>
    <span class="n">anomalies</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">anomalies</span><span class="p">[</span><span class="s2">&quot;anom&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;iwv&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">climatology</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>

    <span class="c1"># --- Linear trend on anomalies using Matplotlib date numbers (days) ---</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">mdates</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">anomalies</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>  <span class="c1"># x in days</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">anomalies</span><span class="p">[</span><span class="s2">&quot;anom&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>          <span class="c1"># anomalies in kg/m¬≤</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">mask</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">slope_day</span><span class="p">,</span> <span class="n">intercept</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">p_value</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">linregress</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">mask</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">slope_day</span><span class="p">,</span> <span class="n">intercept</span><span class="p">,</span> <span class="n">p_value</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

    <span class="c1"># Trend line (evaluate on full x)</span>
    <span class="n">trend_line</span> <span class="o">=</span> <span class="n">intercept</span> <span class="o">+</span> <span class="n">slope_day</span> <span class="o">*</span> <span class="n">x</span>

    <span class="c1"># Convert slope from kg/m¬≤ per day to kg/m¬≤ per year</span>
    <span class="n">slope_year</span> <span class="o">=</span> <span class="n">slope_day</span> <span class="o">*</span> <span class="mf">365.25</span>

    <span class="n">results_iwv</span><span class="p">[</span><span class="n">station</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">anomalies</span><span class="p">,</span>
        <span class="s2">&quot;trend_line&quot;</span><span class="p">:</span> <span class="n">trend_line</span><span class="p">,</span>
        <span class="s2">&quot;slope_year&quot;</span><span class="p">:</span> <span class="n">slope_year</span><span class="p">,</span>    <span class="c1"># kg/m¬≤ per year</span>
        <span class="s2">&quot;p_value&quot;</span><span class="p">:</span> <span class="n">p_value</span><span class="p">,</span>
        <span class="s2">&quot;significant&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">p_value</span> <span class="o">&lt;=</span> <span class="mf">0.1</span><span class="p">)</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">p_value</span><span class="p">)</span> <span class="k">else</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">}</span>

<span class="c1"># --- Plot (use constrained_layout to avoid tight_layout warnings) ---</span>
<span class="n">n_panels</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">results_iwv</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
    <span class="n">n_panels</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
    <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span>  <span class="c1"># &lt;- use constrained layout instead of tight_layout</span>
<span class="p">)</span>

<span class="c1"># Normalize axs to list if single panel</span>
<span class="k">if</span> <span class="n">n_panels</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
    <span class="n">axs</span> <span class="o">=</span> <span class="p">[</span><span class="n">axs</span><span class="p">]</span>

<span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="p">(</span><span class="n">station</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axs</span><span class="p">,</span> <span class="n">results_iwv</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
    <span class="n">anomalies</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span>
    <span class="n">slope_year</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;slope_year&quot;</span><span class="p">]</span>
    <span class="n">p_value</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;p_value&quot;</span><span class="p">]</span>
    <span class="n">signif</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;significant&quot;</span><span class="p">]</span>
    <span class="n">trend_line</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;trend_line&quot;</span><span class="p">]</span>

    <span class="c1"># Plot anomalies</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">anomalies</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">anomalies</span><span class="p">[</span><span class="s2">&quot;anom&quot;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;tab:blue&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;IWV anomaly&quot;</span><span class="p">)</span>

    <span class="c1"># Plot linear trend</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">anomalies</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">trend_line</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;tab:red&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Trend&quot;</span><span class="p">)</span>

    <span class="c1"># Panel title in English</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Station: </span><span class="si">{</span><span class="n">station</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Grid and legend</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

    <span class="c1"># --- Bottom-right annotation inside each panel ---</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">slope_year</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">trend_line</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">label_txt</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;slope: </span><span class="si">{</span><span class="n">slope_year</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> kg/m¬≤/year</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;p-value: </span><span class="si">{</span><span class="n">p_value</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;Significant&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">signif</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;Not significant&#39;</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
            <span class="mf">0.98</span><span class="p">,</span> <span class="mf">0.04</span><span class="p">,</span> <span class="n">label_txt</span><span class="p">,</span>
            <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span>
            <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s2">&quot;bottom&quot;</span><span class="p">,</span>
            <span class="n">fontsize</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;tab:red&quot;</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">,</span>
            <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.85</span><span class="p">,</span> <span class="n">boxstyle</span><span class="o">=</span><span class="s2">&quot;round,pad=0.25&quot;</span><span class="p">),</span>
            <span class="n">zorder</span><span class="o">=</span><span class="mi">5</span>
        <span class="p">)</span>

<span class="c1"># Common axis labels (English)</span>
<span class="n">axs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Year&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axs</span><span class="p">:</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;IWV anomaly [kg/m¬≤]&quot;</span><span class="p">)</span>

<span class="c1"># Date formatting</span>
<span class="n">fig</span><span class="o">.</span><span class="n">autofmt_xdate</span><span class="p">()</span>

<span class="c1"># Optional figure title (works fine with constrained_layout)</span>
<span class="c1"># fig.suptitle(&quot;IWV anomalies and linear trend by station&quot;, fontsize=16)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/c26109b22ebed88b597705a62092fdc93c5fb301ed5e8c5ebdc523a2da07212e.png" src="../_images/c26109b22ebed88b597705a62092fdc93c5fb301ed5e8c5ebdc523a2da07212e.png" />
</div>
</div>
<p><strong>Figure 8</strong>. Time series of monthly anomalies of integrated water vapor (IWV, kg/m¬≤) for the GRUAN stations Barrow (BAR, top), Ny-√Ölesund (NYA, middle), and Sodankyl√§ (SOD, bottom). Blue lines represent IWV anomalies, and red dashed lines indicate linear trends, with slope and p-value reported in red text.</p>
<p>In conclusion, the analysis of trends in specific humidity was performed by computing the monthly anomalies and linear trends of integrated water vapour (IWV) for the three stations. While trends at BAR and NYA are weak and not statistically significant, SOD exhibits a statistically significant positive trend (0.205 kg m‚Åª¬≤ yr‚Åª¬π, p = 0.021). This finding aligns with the observed monthly specific humidity trends, suggesting an overall increase in atmospheric moisture at this continental location.</p>
</section>
</section>
</section>
<section id="i-if-you-want-to-know-more">
<h2>‚ÑπÔ∏è If you want to know more<a class="headerlink" href="#i-if-you-want-to-know-more" title="Link to this heading">#</a></h2>
<section id="key-resources">
<h3>Key resources<a class="headerlink" href="#key-resources" title="Link to this heading">#</a></h3>
<p><a class="reference external" href="https://cds.climate.copernicus.eu/datasets/insitu-observations-gruan-reference-network?tab=overview" rel="noreferrer" target="_blank">CDS entries</a>, <code class="docutils literal notranslate"><span class="pre">In</span> <span class="pre">situ</span> <span class="pre">temperature,</span> <span class="pre">relative</span> <span class="pre">humidity</span> <span class="pre">and</span> <span class="pre">wind</span> <span class="pre">profiles</span> <span class="pre">from</span> <span class="pre">2006</span> <span class="pre">to</span> <span class="pre">March</span> <span class="pre">2020</span> <span class="pre">from</span> <span class="pre">the</span> <span class="pre">GRUAN</span> <span class="pre">reference</span> <span class="pre">network</span></code></p>
<p>external pages:</p>
<p><a class="reference external" href="https://www.gruan.org/" rel="noreferrer" target="_blank">GRUAN website</a>, <code class="docutils literal notranslate"><span class="pre">GCOS</span> <span class="pre">Reference</span> <span class="pre">Upper-Air</span> <span class="pre">Network</span></code></p>
<p>Code libraries used:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/bopen/c3s-eqc-automatic-quality-control/tree/main/c3s_eqc_automatic_quality_control" rel="noreferrer" target="_blank">C3S EQC custom functions</a>, <code class="docutils literal notranslate"><span class="pre">c3s_eqc_automatic_quality_control</span></code>,  prepared by <a class="reference external" href="https://www.bopen.eu/" rel="noreferrer" target="_blank">B-Open</a></p></li>
<li><p><a class="reference external" href="https://pypi.org/project/xarray/" rel="noreferrer" target="_blank">Xarray</a> for working with multidimensional arrays in Python</p></li>
<li><p><a class="reference external" href="https://pypi.org/project/matplotlib/" rel="noreferrer" target="_blank">Matplotlib</a> for visualization in Python</p></li>
<li><p><a class="reference external" href="https://pypi.org/project/scipy/" rel="noreferrer" target="_blank">Scipy</a> for statistics in Python</p></li>
</ul>
</section>
<section id="references">
<h3>References<a class="headerlink" href="#references" title="Link to this heading">#</a></h3>
<p><a class="reference external" href="https://doi.org/10.1007/s00704-016-1864-0" rel="noreferrer" target="_blank">[1]</a> Maturilli, M., Kayser, M. Arctic warming, moisture increase and circulation changes observed in the Ny-√Ölesund homogenized radiosonde record. Theor Appl Climatol 130, 1‚Äì17 (2017). <a class="reference external" href="https://doi.org/10.1007/s00704-016-1864-0" rel="noreferrer" target="_blank">https://doi.org/10.1007/s00704-016-1864-0</a></p>
<p><a class="reference external" href="https://dast.copernicus-climate.eu/documents/in-situ/PUG_GRUAN-1.pdf" rel="noreferrer" target="_blank">[2]</a> Product User Guide and Specification for GRUAN Temperature, Relative Humidity and Wind profiles.</p>
<p><a class="reference external" href="https://doi.org/10.1038/s43247-024-01605-2" rel="noreferrer" target="_blank">[3]</a> Yu, Q., Wu, B. &amp; Zhang, W. The atmospheric connection between the Arctic and Eurasia is underestimated in simulations with prescribed sea ice. Commun Earth Environ 5, 435 (2024). <a class="reference external" href="https://doi.org/10.1038/s43247-024-01605-2" rel="noreferrer" target="_blank">https://doi.org/10.1038/s43247-024-01605-2</a></p>
<p><a class="reference external" href="https://www.mdpi.com/2072-4292/15/4/1095" rel="noreferrer" target="_blank">[4]</a> Yang, M., Qiu, Y., Huang, L., Cheng, M., Chen, J., Cheng, B., &amp; Jiang, Z. (2023). Changes in Sea Surface Temperature and Sea Ice Concentration in the Arctic Ocean over the Past Two Decades. Remote Sensing, 15(4), 1095. <a class="reference external" href="https://doi.org/10.3390/rs15041095" rel="noreferrer" target="_blank">https://doi.org/10.3390/rs15041095</a></p>
<p><a class="reference external" href="https://journals.ametsoc.org/view/journals/clim/36/13/JCLI-D-22-0434.1.xml" rel="noreferrer" target="_blank">[5]</a> Ballinger, T. J., U. S. Bhatt, P.A. Bieniek, B. Brettschneider, R. T. Lader, J.S. Littell, R.L. Thoman, C.F. Waigl, J. E. Walsh, M. A. Webster (2023) Alaska Terrestrial and Marine Climate Trends, 1957‚Äì2021. J. Climate, 36, 4375‚Äì4391, <a class="reference external" href="https://doi.org/10.1175/JCLI-D-22-0434.1" rel="noreferrer" target="_blank">https://doi.org/10.1175/JCLI-D-22-0434.1</a></p>
<p><a class="reference external" href="https://onlinelibrary.wiley.com/doi/abs/10.1111/j.1600-0870.2009.00421.x" rel="noreferrer" target="_blank">[6]</a> Overland, J.E. and Wang, M. (2010), Large-scale atmospheric circulation changes are associated with the recent loss of Arctic sea ice. Tellus A, 62: 1-9. <a class="reference external" href="https://doi.org/10.1111/j.1600-0870.2009.00421.x" rel="noreferrer" target="_blank">https://doi.org/10.1111/j.1600-0870.2009.00421.x</a></p>
<p><a class="reference external" href="https://tc.copernicus.org/articles/3/11/2009/" rel="noreferrer" target="_blank">[7]</a> Serreze, M. C., Barrett, A. P., Stroeve, J. C., Kindig, D. N., and Holland, M. M.: The emergence of surface-based Arctic amplification, The Cryosphere, 3, 11‚Äì19, <a class="reference external" href="https://doi.org/10.5194/tc-3-11-2009" rel="noreferrer" target="_blank">https://doi.org/10.5194/tc-3-11-2009</a>, 2009.</p>
<p><a class="reference external" href="https://doi.org/10.1002/qj.4941?af=R" rel="noreferrer" target="_blank">[8]</a> Remes, T., K√∏ltzow, M., &amp; K√§hnert, M. (2025). Spatial variability of near‚Äêsurface air temperature in the Copernicus Arctic regional reanalysis. Quarterly Journal of the Royal Meteorological Society, 151.</p>
<p><a class="reference external" href="https://www.sciencedirect.com/science/article/abs/pii/S016980952100082X" rel="noreferrer" target="_blank">[9]</a> Wang, D., Guo, J., Xu, H., Li, J., Lv, Y., Solanki, R., ‚Ä¶ &amp; Rinke, A. (2021). Vertical structures of temperature inversions and clouds derived from high-resolution radiosonde measurements at Ny-√Ölesund, Svalbard. Atmospheric Research, 254, 105530.</p>
<p><a class="reference external" href="https://wcd.copernicus.org/articles/2/1263/2021/" rel="noreferrer" target="_blank">[10]</a> Nyg√•rd, T., Tjernstr√∂m, M., &amp; Naakka, T. (2021). Winter thermodynamic vertical structure in the Arctic atmosphere linked to large scale circulation.</p>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./In_Situ"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="insitu.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title"><span class="section-number">2. </span>Insitu Observations</p>
      </div>
    </a>
    <a class="right-next"
       href="../Reanalyses/reanalysis.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title"><span class="section-number">3. </span>Reanalysis</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#use-case-a-study-on-changing-temperature-over-the-arctic-region">üåç Use case: A study on changing temperature over the Arctic region</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#quality-assessment-question">‚ùì Quality assessment question</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#quality-assessment-statement">üì¢ Quality assessment statement</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#methodology">üìã Methodology</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#analysis-and-results">üìà Analysis and results</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#set-up-and-data-retrieval-for-the-three-stations-nya-sod-and-bar">1. Set up and data retrieval for the three stations (NYA, SOD and BAR).</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#import-packages">Import packages</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#define-parameters">Define Parameters</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#define-request">Define request</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#functions-to-cache">Functions to cache</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#download-and-transform">Download and transform</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#monthly-mean-temperature-and-seasonal-profiles">2. Monthly mean temperature and seasonal profiles</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#temperature-anomalies-and-trends">3.Temperature anomalies and trends</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#specific-humidity-and-iwv-anomalies-and-trends">4. Specific humidity and IWV anomalies and trends</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#specific-humidity-seasonal-profiles-and-monthly-mean-trends">Specific humidity seasonal profiles and monthly mean trends</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#i-if-you-want-to-know-more">‚ÑπÔ∏è If you want to know more</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#key-resources">Key resources</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#references">References</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By the Copernicus Climate Change Service (C3S), entrusted to ECMWF (European Centre for Medium-Range Weather Forecasts)
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      ¬© Copyright 2024.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>