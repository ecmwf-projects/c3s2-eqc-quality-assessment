
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>1.2.1. Assessment of the resolution capability of SLSTR AOD (1°) to identify pollution hotspots (2018–2022). &#8212; eqcbook</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'Satellite_ECVs/Atmospheric_Composition/satellite_satellite-aerosol-properties_consistency_q03';</script>
    <link rel="icon" href="../../_static/C3S_favicon.png"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="1.3. Cryosphere" href="../Cryosphere/Cryosphere.html" />
    <link rel="prev" title="1.2. Atmospheric Composition" href="Atmospheric_Composition.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>
<aside class="bd-header-announcement" aria-label="Announcement">
  <div class="bd-header-announcement__content">⚠️This is under development!⚠️</div>
</aside>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/C3S–POS–LINE.png" class="logo__image only-light" alt="eqcbook - Home"/>
    <script>document.write(`<img src="../../_static/C3S–POS–LINE.png" class="logo__image only-dark" alt="eqcbook - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../intro.html">
                    C3S EQC quality assessments
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">➡️ Satellite Observations</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 current active has-children"><a class="reference internal" href="../satellite.html">1. Quality assessments for Satellite Observations</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="current">
<li class="toctree-l2 has-children"><a class="reference internal" href="../Atmosphere_Physics/Atmosphere_Physics.html">1.1. Atmosphere Physics</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="simple">
</ul>
</details></li>
<li class="toctree-l2 current active has-children"><a class="reference internal" href="Atmospheric_Composition.html">1.2. Atmospheric Composition</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="current">
<li class="toctree-l3 current active"><a class="current reference internal" href="#">1.2.1. Assessment of the resolution capability of SLSTR AOD (1°) to identify pollution hotspots (2018–2022).</a></li>
</ul>
</details></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../Cryosphere/Cryosphere.html">1.3. Cryosphere</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="simple">
</ul>
</details></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../Land_Biosphere/Land_Biosphere.html">1.4. Land Biosphere</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="simple">
</ul>
</details></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../Land_Hydrology/Land_Hydrology.html">1.5. Land Hydrology</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="simple">
</ul>
</details></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../Ocean/Ocean.html">1.6. Ocean</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="simple">
</ul>
</details></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">➡️ Insitu Observations</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../In_Situ/insitu.html">2. Quality assessments for Insitu Observations</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="simple">
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">➡️ Reanalysis</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../Reanalyses/reanalysis.html">3. Quality assessments for Reanalysis</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="simple">
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">➡️ Seasonal Forecasts</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../Seasonal_Forecasts/seasonal.html">4. Quality assessments for Seasonal Forecasts</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="simple">
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">➡️ Climate Projections</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../Climate_Projections/climate.html">5. Quality assessments for Climate Projections</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../Climate_Projections/CMIP6/CMIP6.html">5.1. CMIP6</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="simple">
</ul>
</details></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../Climate_Projections/CORDEX/CORDEX.html">5.2. CORDEX</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="simple">
</ul>
</details></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">➡️ Climate Indicators</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../Indicators/indicator.html">6. Quality assessments for Climate Indicators</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="simple">
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">➡️ Derived Datasets</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../Derived_Datasets/derived.html">7. Quality assessments for Derived Datasets</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="simple">
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">➡️ Applications</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../Applications/application.html">8. Quality assessments for C3S Applications</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="simple">
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Quality assessment template</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../templates/template_instructions.html">Template instructions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../templates/template.html">Template</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/ecmwf-projects/c3s2-eqc-quality-assessment" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/ecmwf-projects/c3s2-eqc-quality-assessment/issues/new?title=Issue%20on%20page%20%2FSatellite_ECVs/Atmospheric_Composition/satellite_satellite-aerosol-properties_consistency_q03.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/Satellite_ECVs/Atmospheric_Composition/satellite_satellite-aerosol-properties_consistency_q03.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Assessment of the resolution capability of SLSTR AOD (1°) to identify pollution hotspots (2018–2022).</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#use-case-identification-of-pollution-hotspots">🌍 Use case: Identification of Pollution Hotspots</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#quality-assessment-questions">❓ Quality assessment questions</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#quality-assessment-statement">📢 Quality assessment statement</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#methodology">📋 Methodology</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#analysis-and-results">📈 Analysis and results</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#choose-the-data-to-use-and-set-up-the-code">Choose the data to use and set up the code</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#import-all-required-libraries">Import all required libraries</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#spatial-and-temporal-definitions">Spatial and temporal definitions</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#data-retrieval-and-preparation">Data Retrieval and Preparation</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#download-aod-data">Download AOD data</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#prepare-the-dataframe">Prepare the dataframe</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#define-required-functions">Define required functions</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-calculation-and-describe-the-results">Plot, calculation and describe the results</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#pairwise-monthly-differences-city-nearby-town">Pairwise monthly differences (city − nearby town)</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#seasonal-means-climatological-per-pair">Seasonal means (climatological) per pair</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#cityrural-aod-and-fm-aod-time-series-plots">City–rural AOD and FM-AOD time-series plots</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#seasonal-aod-fm-aod-maps-with-city-rural-markers">Seasonal AOD &amp; FM-AOD maps (with city/rural markers)</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#focused-seasonal-map-plots-of-aod550-and-fm-aod550-for-megacitytown-pairs">Focused seasonal map plots of AOD550 and FM_AOD550 for megacity–town pairs</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#take-home-messages">Take-Home Messages</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#i-if-you-want-to-know-more">ℹ️ If you want to know more</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#key-resources">Key Resources</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#references">References</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <p><img alt="logo" src="../../_images/LogoLine_horizon_C3S1.png" /></p>
<div class="alert alert-block alert-warning">
Please note that this repository is used for development and review, so quality assessments should be considered work in progress until they are merged into the main branch
</div><section class="tex2jax_ignore mathjax_ignore" id="assessment-of-the-resolution-capability-of-slstr-aod-1-to-identify-pollution-hotspots-20182022">
<h1><span class="section-number">1.2.1. </span>Assessment of the resolution capability of SLSTR AOD (1°) to identify pollution hotspots (2018–2022).<a class="headerlink" href="#assessment-of-the-resolution-capability-of-slstr-aod-1-to-identify-pollution-hotspots-20182022" title="Link to this heading">#</a></h1>
<p> </p>
<p>Production date: 30-09-2024</p>
<p>Produced by: University of Salerno (UNISA)- (Fabio Madonna and Faezeh Karimian)</p>
<section id="use-case-identification-of-pollution-hotspots">
<h2>🌍 Use case: Identification of Pollution Hotspots<a class="headerlink" href="#use-case-identification-of-pollution-hotspots" title="Link to this heading">#</a></h2>
</section>
<section id="quality-assessment-questions">
<h2>❓ Quality assessment questions<a class="headerlink" href="#quality-assessment-questions" title="Link to this heading">#</a></h2>
<p><strong>• Is there a difference in the aerosol optical depth (AOD) between megacities and nearby towns?</strong></p>
<p><strong>• How satellite AOD can be used as a proxy for local air pollution when comparing scales of tens of kilometers?</strong></p>
<p>The satellite-aerosol-properties catalog provides global Aerosol Optical Depth (AOD) and fine-mode AOD (FMAOD) from 1995 to present. AOD is often used as a proxy for particulate pollution, but being representative of the entire atmospheric column and influenced by different sources at different atmospheric levels, may be not able to capture change in the local air pollution [1]. Moreover, several products are at horizonal resolutions coarser than what is required to capture local difference due to pollution sources. Europe, where most citizens are exposed to air pollution levels above WHO guidelines [2], provides a relevant and challenging case study for evaluating satellite-based aerosol observations.
In this analysis we use the SLSTR ensemble product to produce seasonal maps of AOD and FMAOD over the investigated period, with major cities such as Milan, Brussels, London, and Athens marked for context. These maps provide a regional overview of spatial patterns and seasonal variability. In addition, we retain line plots only for selected hotspots (e.g., Brussels, Milan, London) to illustrate how AOD and FMAOD values evolve over time at the city scale and also to show the difference in the AOD and FMAOD between megacities and nearby towns. This combination of maps and targeted time series balances spatial coverage with local detail, while keeping the focus on how satellite products can inform—but also constrain—urban air-quality assessments.</p>
</section>
<section id="quality-assessment-statement">
<h2>📢 Quality assessment statement<a class="headerlink" href="#quality-assessment-statement" title="Link to this heading">#</a></h2>
<div class="note admonition">
<p class="admonition-title">These are the key outcomes of this assessment</p>
<p>• The seasonal maps confirm broad regional patterns in AOD and FMAOD, with higher values in summer (JJA) and spring (MAM) and lower values in winter (DJF). This seasonal cycle is consistent with enhanced photochemical activity, transport of natural aerosols, and regional meteorology.</p>
<p>• Pairwise comparisons between megacities and their nearby towns reveal only modest differences. For Athens, mean AOD in the city is slightly higher than in Livadeia, but for Brussels, London, and Milan the rural sites often show equal or even slightly higher values.</p>
<p>• These small differences highlight that, at ~1° resolution, satellite AOD tends to represent regional-scale aerosol burdens rather than sharp urban hotspots. The fractional statistics support this: for example, Athens shows the city having higher AOD than the rural site in ~68% of months, while in Brussels and London the nearby towns often exceed the city.</p>
<p>• A small data gap is present for Northampton, which reduces the seasonal coverage. However, the available months are sufficient to capture the main seasonal cycle, so the results remain representative but should be interpreted with caution.</p>
<p>• Taken together, these findings emphasize the importance of scale and representativity. While satellite AOD products capture regional patterns and seasonality well, they cannot be expected to resolve contrasts between neighboring urban and rural sites at the scale of tens of kilometers.</p>
</div>
</section>
<section id="methodology">
<h2>📋 Methodology<a class="headerlink" href="#methodology" title="Link to this heading">#</a></h2>
<p>This assessment aims to assess the consistency and completeness of SLSTR-derived satellite data in capturing the seasonal variability of Aerosol Optical Depth (AOD) over different global regions from 2018 to 2023. We also quantifyed data completeness via monthly observation counts normalized by area, and  test urban–rural contrasts using grid-aware neighborhoods.</p>
<p>The methodology adopted for the analysis is split into the following steps:</p>
<p><a class="reference internal" href="#satellite-satellite-aerosol-properties-consistency-q03-section-1"><span class="std std-ref">Choose the data to use and set up the code</span></a></p>
<ul class="simple">
<li><p>Import all required libraries</p></li>
<li><p>Spatial and temporal definitions</p></li>
</ul>
<p><a class="reference internal" href="#satellite-satellite-aerosol-properties-consistency-q03-section-2"><span class="std std-ref">Data Retrieval and Preparation</span></a></p>
<ul class="simple">
<li><p>Download AOD data</p></li>
<li><p>Prepare the dataframe</p></li>
<li><p>Define required functions</p></li>
<li></li>
</ul>
<p><a class="reference internal" href="#satellite-satellite-aerosol-properties-consistency-q03-section-3"><span class="std std-ref">Plot, calculation and describe the results</span></a></p>
<ul class="simple">
<li><p>Pairwise monthly differences (city − nearby town)</p></li>
<li><p>Seasonal means (climatological) per pair</p></li>
<li><p>City–rural AOD and FM-AOD time-series plots</p></li>
<li><p>Seasonal AOD &amp; FM-AOD maps (with city/rural markers)</p></li>
<li><p>Focused seasonal map plots of AOD550 and FM_AOD550 for megacity–town pairs</p></li>
</ul>
<p><a class="reference internal" href="#satellite-satellite-aerosol-properties-consistency-q03-section-4"><span class="std std-ref">Take-Home Messages</span></a></p>
</section>
<section id="analysis-and-results">
<h2>📈 Analysis and results<a class="headerlink" href="#analysis-and-results" title="Link to this heading">#</a></h2>
<section id="choose-the-data-to-use-and-set-up-the-code">
<span id="satellite-satellite-aerosol-properties-consistency-q03-section-1"></span><h3>Choose the data to use and set up the code<a class="headerlink" href="#choose-the-data-to-use-and-set-up-the-code" title="Link to this heading">#</a></h3>
<section id="import-all-required-libraries">
<h4>Import all required libraries<a class="headerlink" href="#import-all-required-libraries" title="Link to this heading">#</a></h4>
<p>In this section, we import all the relevant packages needed for running the notebook.</p>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">xarray</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">xr</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.dates</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mdates</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.gridspec</span><span class="w"> </span><span class="kn">import</span> <span class="n">GridSpec</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">cartopy.crs</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">ccrs</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">cartopy.feature</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">cfeature</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.gridspec</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">gridspec</span>
</pre></div>
</div>
</div>
</details>
</div>
</section>
<section id="spatial-and-temporal-definitions">
<h4>Spatial and temporal definitions<a class="headerlink" href="#spatial-and-temporal-definitions" title="Link to this heading">#</a></h4>
<p>This assessment analyzes monthly SLSTR/Sentinel-3 AOD and FMAOD from July 2018 to December 2023, focusing on selected European megacities and their nearby towns. Four paired Areas of Interest (AOIs) are defined: Athens–Livadeia (Greece), London–Northampton (United Kingdom), Brussels–Arras (Belgium), and Milan–Sondrio (Italy). These AOIs are based on fixed latitude/longitude coordinates and represent typical urban–rural contrasts within ~100 km distance.</p>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">EUROPE_EXTENT</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">12</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span> 
<span class="n">YEAR_START</span><span class="p">,</span> <span class="n">YEAR_END</span> <span class="o">=</span> <span class="mi">2018</span><span class="p">,</span> <span class="mi">2022</span>
<span class="n">AOIS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1"># Greece</span>
    <span class="s2">&quot;Athens (megacity)&quot;</span><span class="p">:</span>       <span class="p">{</span><span class="s2">&quot;lat&quot;</span><span class="p">:</span> <span class="mf">37.9838</span><span class="p">,</span> <span class="s2">&quot;lon&quot;</span><span class="p">:</span> <span class="mf">23.7275</span><span class="p">,</span> <span class="s2">&quot;kind&quot;</span><span class="p">:</span> <span class="s2">&quot;city&quot;</span><span class="p">},</span>
    <span class="s2">&quot;Livadeia (nearby rural)&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;lat&quot;</span><span class="p">:</span> <span class="mf">38.4350</span><span class="p">,</span> <span class="s2">&quot;lon&quot;</span><span class="p">:</span> <span class="mf">22.8760</span><span class="p">,</span> <span class="s2">&quot;kind&quot;</span><span class="p">:</span> <span class="s2">&quot;rural&quot;</span><span class="p">},</span>  <span class="c1"># ~95 km</span>
     <span class="c1"># UK</span>
    <span class="s2">&quot;London (megacity)&quot;</span><span class="p">:</span>         <span class="p">{</span><span class="s2">&quot;lat&quot;</span><span class="p">:</span> <span class="mf">51.5074</span><span class="p">,</span> <span class="s2">&quot;lon&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.1278</span><span class="p">,</span> <span class="s2">&quot;kind&quot;</span><span class="p">:</span> <span class="s2">&quot;city&quot;</span><span class="p">},</span>
    <span class="s2">&quot;Northampton (nearby town)&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;lat&quot;</span><span class="p">:</span> <span class="mf">52.2405</span><span class="p">,</span> <span class="s2">&quot;lon&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.9027</span><span class="p">,</span> <span class="s2">&quot;kind&quot;</span><span class="p">:</span> <span class="s2">&quot;rural&quot;</span><span class="p">},</span>  <span class="c1"># ~97 km</span>

    <span class="c1"># Belgium</span>
    <span class="s2">&quot;Brussels (megacity)&quot;</span><span class="p">:</span>       <span class="p">{</span><span class="s2">&quot;lat&quot;</span><span class="p">:</span> <span class="mf">50.8466</span><span class="p">,</span> <span class="s2">&quot;lon&quot;</span><span class="p">:</span> <span class="mf">4.3528</span><span class="p">,</span>  <span class="s2">&quot;kind&quot;</span><span class="p">:</span> <span class="s2">&quot;city&quot;</span><span class="p">},</span>
    <span class="s2">&quot;Arras (nearby town)&quot;</span><span class="p">:</span>       <span class="p">{</span><span class="s2">&quot;lat&quot;</span><span class="p">:</span> <span class="mf">50.2910</span><span class="p">,</span> <span class="s2">&quot;lon&quot;</span><span class="p">:</span> <span class="mf">2.7770</span><span class="p">,</span>  <span class="s2">&quot;kind&quot;</span><span class="p">:</span> <span class="s2">&quot;rural&quot;</span><span class="p">},</span>  <span class="c1"># ~92 km WSW</span>

    <span class="c1"># Italy</span>
    <span class="s2">&quot;Milan (megacity)&quot;</span><span class="p">:</span>          <span class="p">{</span><span class="s2">&quot;lat&quot;</span><span class="p">:</span> <span class="mf">45.4642</span><span class="p">,</span> <span class="s2">&quot;lon&quot;</span><span class="p">:</span> <span class="mf">9.1900</span><span class="p">,</span>  <span class="s2">&quot;kind&quot;</span><span class="p">:</span> <span class="s2">&quot;city&quot;</span><span class="p">},</span>
    <span class="s2">&quot;Sondrio (nearby town)&quot;</span><span class="p">:</span>     <span class="p">{</span><span class="s2">&quot;lat&quot;</span><span class="p">:</span> <span class="mf">46.1690</span><span class="p">,</span> <span class="s2">&quot;lon&quot;</span><span class="p">:</span> <span class="mf">9.8710</span><span class="p">,</span>  <span class="s2">&quot;kind&quot;</span><span class="p">:</span> <span class="s2">&quot;rural&quot;</span><span class="p">},</span>  <span class="c1"># ~96 km N</span>
<span class="p">}</span>

<span class="n">PAIRS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="s2">&quot;Athens (megacity)&quot;</span><span class="p">,</span>      <span class="s2">&quot;Livadeia (nearby rural)&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;London (megacity)&quot;</span><span class="p">,</span>   <span class="s2">&quot;Northampton (nearby town)&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;Brussels (megacity)&quot;</span><span class="p">,</span> <span class="s2">&quot;Arras (nearby town)&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;Milan (megacity)&quot;</span><span class="p">,</span>    <span class="s2">&quot;Sondrio (nearby town)&quot;</span><span class="p">),</span>
<span class="p">]</span>
</pre></div>
</div>
</div>
</details>
</div>
</section>
</section>
<section id="data-retrieval-and-preparation">
<span id="satellite-satellite-aerosol-properties-consistency-q03-section-2"></span><h3>Data Retrieval and Preparation<a class="headerlink" href="#data-retrieval-and-preparation" title="Link to this heading">#</a></h3>
<p>Below are robust, grid-aware functions and the city/rural time-series computation.</p>
<section id="download-aod-data">
<h4>Download AOD data<a class="headerlink" href="#download-aod-data" title="Link to this heading">#</a></h4>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">folder_path</span> <span class="o">=</span> <span class="s2">&quot;./aod_data&quot;</span> 

<span class="n">file_list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span>
    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">folder_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.nc&#39;</span><span class="p">)</span>
<span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">file_list</span><span class="p">)</span><span class="si">}</span><span class="s2"> .nc files&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">file_list</span><span class="p">[:</span><span class="mi">5</span><span class="p">]:</span>  
    <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

<span class="n">df_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">file_list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">folder_path</span><span class="p">)</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.nc&#39;</span><span class="p">)])</span>
<span class="n">df_list</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">file_list</span><span class="p">:</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
    <span class="n">timestamp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">file</span><span class="p">)[:</span><span class="mi">6</span><span class="p">],</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;%Y%m&#39;</span><span class="p">)</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">({</span><span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">timestamp</span><span class="p">]})</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="n">df_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

<span class="n">final_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">df_list</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">final_df</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="o">-</span><span class="mf">999.0</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">NA</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">final_df</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">final_df</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">])</span>
<span class="n">final_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">final_df</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Found 66 .nc files
./aod_data/201801-C3S-L3_AEROSOL-AER_PRODUCTS-SLSTR-SENTINEL3A-ensemble-MONTHLY-v2.3.nc
./aod_data/201802-C3S-L3_AEROSOL-AER_PRODUCTS-SLSTR-SENTINEL3A-ensemble-MONTHLY-v2.3.nc
./aod_data/201803-C3S-L3_AEROSOL-AER_PRODUCTS-SLSTR-SENTINEL3A-ensemble-MONTHLY-v2.3.nc
./aod_data/201804-C3S-L3_AEROSOL-AER_PRODUCTS-SLSTR-SENTINEL3A-ensemble-MONTHLY-v2.3.nc
./aod_data/201805-C3S-L3_AEROSOL-AER_PRODUCTS-SLSTR-SENTINEL3A-ensemble-MONTHLY-v2.3.nc
              time  latitude  longitude    AOD550  FM_AOD550  \
0       2018-01-01     -89.5     -179.5       NaN        NaN   
43192   2018-01-01      29.5      172.5  0.123682   0.049830   
43193   2018-01-01      29.5      173.5  0.116795   0.043411   
43194   2018-01-01      29.5      174.5  0.188018   0.079148   
43195   2018-01-01      29.5      175.5  0.058454   0.015076   
...            ...       ...        ...       ...        ...   
4233604 2023-06-01     -29.5     -175.5  0.076325   0.047782   
4233605 2023-06-01     -29.5     -174.5  0.069183   0.040526   
4233606 2023-06-01     -29.5     -173.5  0.071204   0.041869   
4233593 2023-06-01     -30.5      173.5  0.093562   0.054036   
4276799 2023-06-01      89.5      179.5       NaN        NaN   

         AOD550_UNCERTAINTY_ENSEMBLE  NMEAS  
0                                NaN    0.0  
43192                       0.004982    6.0  
43193                       0.004510    4.0  
43194                       0.005259    3.0  
43195                       0.000400    1.0  
...                              ...    ...  
4233604                     0.017169   11.0  
4233605                     0.014429   12.0  
4233606                     0.013793   11.0  
4233593                     0.015986    6.0  
4276799                          NaN    0.0  

[4276800 rows x 7 columns]
</pre></div>
</div>
</div>
</div>
</section>
<section id="prepare-the-dataframe">
<h4>Prepare the dataframe<a class="headerlink" href="#prepare-the-dataframe" title="Link to this heading">#</a></h4>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_eu</span> <span class="o">=</span> <span class="n">subset_df</span><span class="p">(</span><span class="n">final_df</span><span class="p">,</span> <span class="n">year_start</span><span class="o">=</span><span class="n">YEAR_START</span><span class="p">,</span> <span class="n">year_end</span><span class="o">=</span><span class="n">YEAR_END</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="n">EUROPE_EXTENT</span><span class="p">)</span>
<span class="n">df_eu</span> <span class="o">=</span> <span class="n">add_season_cols</span><span class="p">(</span><span class="n">df_eu</span><span class="p">)</span>
<span class="n">seasonal</span> <span class="o">=</span> <span class="n">seasonal_means</span><span class="p">(</span><span class="n">df_eu</span><span class="p">,</span> <span class="n">value_cols</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;AOD550&quot;</span><span class="p">,</span><span class="s2">&quot;FM_AOD550&quot;</span><span class="p">))</span>
</pre></div>
</div>
</div>
</details>
</div>
</section>
<section id="define-required-functions">
<h4>Define required functions<a class="headerlink" href="#define-required-functions" title="Link to this heading">#</a></h4>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">month_to_season</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
    <span class="c1"># DJF, MAM, JJA, SON</span>
    <span class="k">if</span> <span class="n">m</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;DJF&quot;</span>
    <span class="k">elif</span> <span class="n">m</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;MAM&quot;</span>
    <span class="k">elif</span> <span class="n">m</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;JJA&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;SON&quot;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">add_season_cols</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;month&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;season&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;month&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">month_to_season</span><span class="p">)</span>
   
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;season_year&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">]</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;month&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">12</span><span class="p">,</span> <span class="s2">&quot;season_year&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">df</span>


<span class="k">def</span><span class="w"> </span><span class="nf">subset_df</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">year_start</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">year_end</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">sub</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">year_start</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sub</span> <span class="o">=</span> <span class="n">sub</span><span class="p">[</span><span class="n">sub</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span> <span class="o">&gt;=</span> <span class="n">year_start</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">year_end</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sub</span> <span class="o">=</span> <span class="n">sub</span><span class="p">[</span><span class="n">sub</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span> <span class="o">&lt;=</span> <span class="n">year_end</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">extent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">w</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="n">extent</span>
        <span class="n">sub</span> <span class="o">=</span> <span class="n">sub</span><span class="p">[(</span><span class="n">sub</span><span class="p">[</span><span class="s2">&quot;longitude&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">w</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">sub</span><span class="p">[</span><span class="s2">&quot;longitude&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">e</span><span class="p">)</span> <span class="o">&amp;</span>
                  <span class="p">(</span><span class="n">sub</span><span class="p">[</span><span class="s2">&quot;latitude&quot;</span><span class="p">]</span>  <span class="o">&gt;=</span> <span class="n">s</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">sub</span><span class="p">[</span><span class="s2">&quot;latitude&quot;</span><span class="p">]</span>  <span class="o">&lt;=</span> <span class="n">n</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">sub</span>


<span class="k">def</span><span class="w"> </span><span class="nf">seasonal_means</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">value_cols</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;AOD550&quot;</span><span class="p">,</span> <span class="s2">&quot;FM_AOD550&quot;</span><span class="p">)):</span>
    <span class="c1"># drop entirely NaN rows for both vars</span>
    <span class="n">keep</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="c1"># group per (season_year, season, lat, lon)</span>
    <span class="n">grp</span> <span class="o">=</span> <span class="n">keep</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;season_year&quot;</span><span class="p">,</span><span class="s2">&quot;season&quot;</span><span class="p">,</span><span class="s2">&quot;latitude&quot;</span><span class="p">,</span><span class="s2">&quot;longitude&quot;</span><span class="p">],</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="nb">list</span><span class="p">(</span><span class="n">value_cols</span><span class="p">)]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">grp</span>


<span class="k">def</span><span class="w"> </span><span class="nf">grid_for_plot</span><span class="p">(</span><span class="n">df_season</span><span class="p">,</span> <span class="n">var</span><span class="p">):</span>
    
    <span class="n">grid</span> <span class="o">=</span> <span class="n">df_season</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s2">&quot;latitude&quot;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s2">&quot;longitude&quot;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="n">var</span><span class="p">,</span> <span class="n">aggfunc</span><span class="o">=</span><span class="s2">&quot;mean&quot;</span><span class="p">)</span>
    <span class="n">lats</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span>
    <span class="n">lons</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span>

    <span class="n">dlat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">lats</span><span class="p">))</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lats</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="mf">1.0</span>
    <span class="n">dlon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">lons</span><span class="p">))</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lons</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="mf">1.0</span>
    <span class="n">lat_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(([</span><span class="n">lats</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">dlat</span><span class="o">/</span><span class="mi">2</span><span class="p">],</span> <span class="p">(</span><span class="n">lats</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">lats</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="p">[</span><span class="n">lats</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">dlat</span><span class="o">/</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">lon_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(([</span><span class="n">lons</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">dlon</span><span class="o">/</span><span class="mi">2</span><span class="p">],</span> <span class="p">(</span><span class="n">lons</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">lons</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="p">[</span><span class="n">lons</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">dlon</span><span class="o">/</span><span class="mi">2</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">lon_edges</span><span class="p">,</span> <span class="n">lat_edges</span><span class="p">,</span> <span class="n">grid</span><span class="o">.</span><span class="n">values</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.gridspec</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">gridspec</span>

<span class="k">def</span><span class="w"> </span><span class="nf">plot_seasonal_maps</span><span class="p">(</span><span class="n">seasonal_df</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">season_year</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;viridis&quot;</span><span class="p">,</span>
                       <span class="n">vmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="n">EUROPE_EXTENT</span><span class="p">,</span> <span class="n">title_suffix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">seasonal_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">season_year</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;season_year&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">season_year</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;season&quot;</span><span class="p">,</span><span class="s2">&quot;latitude&quot;</span><span class="p">,</span><span class="s2">&quot;longitude&quot;</span><span class="p">],</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

    <span class="n">seasons</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;DJF&quot;</span><span class="p">,</span><span class="s2">&quot;MAM&quot;</span><span class="p">,</span><span class="s2">&quot;JJA&quot;</span><span class="p">,</span><span class="s2">&quot;SON&quot;</span><span class="p">]</span>
    <span class="n">proj</span> <span class="o">=</span> <span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">()</span>


    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>
    <span class="n">gs</span> <span class="o">=</span> <span class="n">gridspec</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">width_ratios</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mf">0.05</span><span class="p">])</span>  

    <span class="n">axes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">],</span> <span class="n">projection</span><span class="o">=</span><span class="n">proj</span><span class="p">)</span>
            <span class="n">axes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">seasons</span><span class="p">):</span>
        <span class="n">sub</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;season&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">s</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">sub</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s2"> (no data)&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">coastlines</span><span class="p">();</span> <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">BORDERS</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_extent</span><span class="p">(</span><span class="n">extent</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="n">proj</span><span class="p">);</span> <span class="k">continue</span>

        <span class="n">lon_edges</span><span class="p">,</span> <span class="n">lat_edges</span><span class="p">,</span> <span class="n">Z</span> <span class="o">=</span> <span class="n">grid_for_plot</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span> <span class="n">var</span><span class="p">)</span>

        <span class="n">mesh</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">lon_edges</span><span class="p">,</span> <span class="n">lat_edges</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">proj</span><span class="p">,</span>
                             <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">shading</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">coastlines</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">BORDERS</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">LAND</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_extent</span><span class="p">(</span><span class="n">extent</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="n">proj</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">AOIS</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">extent</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;lon&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">extent</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="n">extent</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;lat&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">extent</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
                <span class="n">mk</span> <span class="o">=</span> <span class="s2">&quot;s&quot;</span> <span class="k">if</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;kind&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;city&quot;</span> <span class="k">else</span> <span class="s2">&quot;o&quot;</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;lon&quot;</span><span class="p">],</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;lat&quot;</span><span class="p">],</span> <span class="n">mk</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">proj</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">mec</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">mfc</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;lon&quot;</span><span class="p">]</span><span class="o">+</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;lat&quot;</span><span class="p">]</span><span class="o">+</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; (&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">transform</span><span class="o">=</span><span class="n">proj</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>

    <span class="n">cax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">])</span>
    <span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">)</span>
    <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>

    <span class="n">title_year</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">season_year</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">season_year</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;Climatology&quot;</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SLSTR seasonal mean </span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2"> — </span><span class="si">{</span><span class="n">title_year</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">title_suffix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">rect</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mf">0.93</span><span class="p">,</span><span class="mf">0.95</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">fig</span>






<span class="k">def</span><span class="w"> </span><span class="nf">global_color_limits</span><span class="p">(</span><span class="n">seasonal_df</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">lo</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">hi</span><span class="o">=</span><span class="mi">95</span><span class="p">):</span>
    <span class="n">vals</span> <span class="o">=</span> <span class="n">seasonal_df</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanpercentile</span><span class="p">(</span><span class="n">vals</span><span class="p">,</span> <span class="n">lo</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nanpercentile</span><span class="p">(</span><span class="n">vals</span><span class="p">,</span> <span class="n">hi</span><span class="p">))</span>

<span class="k">def</span><span class="w"> </span><span class="nf">subset_seasonal_box</span><span class="p">(</span><span class="n">seasonal_df</span><span class="p">,</span> <span class="n">extent</span><span class="p">):</span>
    <span class="n">w</span><span class="p">,</span><span class="n">e</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">n</span> <span class="o">=</span> <span class="n">extent</span>
    <span class="k">return</span> <span class="n">seasonal_df</span><span class="p">[</span>
        <span class="p">(</span><span class="n">seasonal_df</span><span class="p">[</span><span class="s2">&quot;longitude&quot;</span><span class="p">]</span><span class="o">&gt;=</span><span class="n">w</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">seasonal_df</span><span class="p">[</span><span class="s2">&quot;longitude&quot;</span><span class="p">]</span><span class="o">&lt;=</span><span class="n">e</span><span class="p">)</span> <span class="o">&amp;</span>
        <span class="p">(</span><span class="n">seasonal_df</span><span class="p">[</span><span class="s2">&quot;latitude&quot;</span><span class="p">]</span> <span class="o">&gt;=</span><span class="n">s</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">seasonal_df</span><span class="p">[</span><span class="s2">&quot;latitude&quot;</span><span class="p">]</span> <span class="o">&lt;=</span><span class="n">n</span><span class="p">)</span>
    <span class="p">]</span>

<span class="k">def</span><span class="w"> </span><span class="nf">grid_for_plot</span><span class="p">(</span><span class="n">df_season</span><span class="p">,</span> <span class="n">var</span><span class="p">):</span>
    <span class="n">grid</span> <span class="o">=</span> <span class="n">df_season</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s2">&quot;latitude&quot;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s2">&quot;longitude&quot;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="n">var</span><span class="p">,</span> <span class="n">aggfunc</span><span class="o">=</span><span class="s2">&quot;mean&quot;</span><span class="p">)</span>
    <span class="n">lats</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span>
    <span class="n">lons</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span>
    <span class="n">dlat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">lats</span><span class="p">))</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lats</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span> <span class="k">else</span> <span class="mf">1.0</span>
    <span class="n">dlon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">lons</span><span class="p">))</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lons</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span> <span class="k">else</span> <span class="mf">1.0</span>
    <span class="n">lat_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(([</span><span class="n">lats</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">dlat</span><span class="o">/</span><span class="mi">2</span><span class="p">],</span> <span class="p">(</span><span class="n">lats</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">lats</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="p">[</span><span class="n">lats</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">dlat</span><span class="o">/</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">lon_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(([</span><span class="n">lons</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">dlon</span><span class="o">/</span><span class="mi">2</span><span class="p">],</span> <span class="p">(</span><span class="n">lons</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">lons</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="p">[</span><span class="n">lons</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">dlon</span><span class="o">/</span><span class="mi">2</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">lon_edges</span><span class="p">,</span> <span class="n">lat_edges</span><span class="p">,</span> <span class="n">grid</span><span class="o">.</span><span class="n">values</span>


<span class="k">if</span> <span class="s1">&#39;df_eu&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span>
  
    <span class="n">EUROPE_EXTENT</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">12</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>
    <span class="n">df_eu</span> <span class="o">=</span> <span class="n">final_df</span><span class="p">[</span>
        <span class="p">(</span><span class="n">final_df</span><span class="p">[</span><span class="s1">&#39;longitude&#39;</span><span class="p">]</span><span class="o">&gt;=</span><span class="n">EUROPE_EXTENT</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">final_df</span><span class="p">[</span><span class="s1">&#39;longitude&#39;</span><span class="p">]</span><span class="o">&lt;=</span><span class="n">EUROPE_EXTENT</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&amp;</span>
        <span class="p">(</span><span class="n">final_df</span><span class="p">[</span><span class="s1">&#39;latitude&#39;</span><span class="p">]</span> <span class="o">&gt;=</span><span class="n">EUROPE_EXTENT</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">final_df</span><span class="p">[</span><span class="s1">&#39;latitude&#39;</span><span class="p">]</span> <span class="o">&lt;=</span><span class="n">EUROPE_EXTENT</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
    <span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">df_eu</span> <span class="o">=</span> <span class="n">df_eu</span><span class="p">[(</span><span class="n">df_eu</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="o">&gt;=</span><span class="mi">2018</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df_eu</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="o">&lt;=</span><span class="mi">2022</span><span class="p">)]</span>
    <span class="n">df_eu</span> <span class="o">=</span> <span class="n">df_eu</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">month</span><span class="o">=</span><span class="n">df_eu</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span><span class="p">,</span>
                         <span class="n">year</span><span class="o">=</span><span class="n">df_eu</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">m2s</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;DJF&quot;</span> <span class="k">if</span> <span class="n">m</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="k">else</span> <span class="p">(</span><span class="s2">&quot;MAM&quot;</span> <span class="k">if</span> <span class="n">m</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span> <span class="k">else</span> <span class="p">(</span><span class="s2">&quot;JJA&quot;</span> <span class="k">if</span> <span class="n">m</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;SON&quot;</span><span class="p">))</span>
    <span class="n">df_eu</span><span class="p">[</span><span class="s1">&#39;season&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_eu</span><span class="p">[</span><span class="s1">&#39;month&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">m2s</span><span class="p">)</span>
    <span class="n">df_eu</span><span class="p">[</span><span class="s1">&#39;season_year&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_eu</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span>
    <span class="n">df_eu</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_eu</span><span class="p">[</span><span class="s1">&#39;month&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">12</span><span class="p">,</span><span class="s1">&#39;season_year&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_eu</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span>

<span class="n">seasonal</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_eu</span>
            <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;season_year&quot;</span><span class="p">,</span><span class="s2">&quot;season&quot;</span><span class="p">,</span><span class="s2">&quot;latitude&quot;</span><span class="p">,</span><span class="s2">&quot;longitude&quot;</span><span class="p">],</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="p">[[</span><span class="s2">&quot;AOD550&quot;</span><span class="p">,</span><span class="s2">&quot;FM_AOD550&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>

<span class="n">aod_vmin</span><span class="p">,</span> <span class="n">aod_vmax</span> <span class="o">=</span> <span class="n">global_color_limits</span><span class="p">(</span><span class="n">seasonal</span><span class="p">,</span> <span class="s2">&quot;AOD550&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">95</span><span class="p">)</span>
<span class="n">fm_vmin</span><span class="p">,</span>  <span class="n">fm_vmax</span>  <span class="o">=</span> <span class="n">global_color_limits</span><span class="p">(</span><span class="n">seasonal</span><span class="p">,</span> <span class="s2">&quot;FM_AOD550&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">95</span><span class="p">)</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy.ma</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">ma</span>

<span class="k">def</span><span class="w"> </span><span class="nf">plot_pair_focus</span><span class="p">(</span>
    <span class="n">pair</span><span class="p">,</span>
    <span class="n">var</span><span class="o">=</span><span class="s2">&quot;AOD550&quot;</span><span class="p">,</span>
    <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;YlOrRd&quot;</span><span class="p">,</span>
    <span class="n">vmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">vmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">pad_deg</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span>  
    <span class="n">title_suffix</span><span class="o">=</span><span class="s2">&quot;Climatology (2018–2022)&quot;</span>
<span class="p">):</span>
    <span class="n">city</span><span class="p">,</span> <span class="n">town</span> <span class="o">=</span> <span class="n">pair</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">AOIS</span><span class="p">[</span><span class="n">city</span><span class="p">];</span> <span class="n">r</span> <span class="o">=</span> <span class="n">AOIS</span><span class="p">[</span><span class="n">town</span><span class="p">]</span>

 
    <span class="n">clim</span> <span class="o">=</span> <span class="n">seasonal</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;season&quot;</span><span class="p">,</span><span class="s2">&quot;latitude&quot;</span><span class="p">,</span><span class="s2">&quot;longitude&quot;</span><span class="p">],</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

 
    <span class="n">w</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="s2">&quot;lon&quot;</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="s2">&quot;lon&quot;</span><span class="p">])</span> <span class="o">-</span> <span class="n">pad_deg</span>
    <span class="n">e</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="s2">&quot;lon&quot;</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="s2">&quot;lon&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="n">pad_deg</span>
    <span class="n">s</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="s2">&quot;lat&quot;</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="s2">&quot;lat&quot;</span><span class="p">])</span> <span class="o">-</span> <span class="n">pad_deg</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="s2">&quot;lat&quot;</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="s2">&quot;lat&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="n">pad_deg</span>
    <span class="n">box</span> <span class="o">=</span> <span class="n">subset_seasonal_box</span><span class="p">(</span><span class="n">clim</span><span class="p">,</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>


    <span class="k">if</span> <span class="ow">not</span> <span class="n">box</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="n">w</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">box</span><span class="p">[</span><span class="s2">&quot;longitude&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">())</span> <span class="o">-</span> <span class="mf">0.25</span>
        <span class="n">e</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">box</span><span class="p">[</span><span class="s2">&quot;longitude&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span> <span class="o">+</span> <span class="mf">0.25</span>
        <span class="n">s</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">box</span><span class="p">[</span><span class="s2">&quot;latitude&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">())</span> <span class="o">-</span> <span class="mf">0.25</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">box</span><span class="p">[</span><span class="s2">&quot;latitude&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span> <span class="o">+</span> <span class="mf">0.25</span>
    <span class="n">extent</span> <span class="o">=</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>


    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
    <span class="n">gs</span> <span class="o">=</span> <span class="n">gridspec</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">width_ratios</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mf">0.05</span><span class="p">],</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.15</span><span class="p">)</span>
    <span class="n">axes</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">projection</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">()),</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">projection</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">()),</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">projection</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">()),</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">projection</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">()),</span>
    <span class="p">]</span>
    <span class="n">cax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[:,</span><span class="mi">2</span><span class="p">])</span>


    <span class="n">base_cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">cmap</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">low_col</span> <span class="o">=</span> <span class="n">base_cmap</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
    <span class="n">base_cmap</span><span class="o">.</span><span class="n">set_bad</span><span class="p">(</span><span class="n">low_col</span><span class="p">)</span>
    <span class="n">base_cmap</span><span class="o">.</span><span class="n">set_under</span><span class="p">(</span><span class="n">low_col</span><span class="p">)</span>

    <span class="n">last_mesh</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">season</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;DJF&quot;</span><span class="p">,</span><span class="s2">&quot;MAM&quot;</span><span class="p">,</span><span class="s2">&quot;JJA&quot;</span><span class="p">,</span><span class="s2">&quot;SON&quot;</span><span class="p">]):</span>
        <span class="n">sub</span> <span class="o">=</span> <span class="n">box</span><span class="p">[</span><span class="n">box</span><span class="p">[</span><span class="s2">&quot;season&quot;</span><span class="p">]</span><span class="o">==</span><span class="n">season</span><span class="p">]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">season</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_extent</span><span class="p">(</span><span class="n">extent</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">coastlines</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">BORDERS</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">(</span><span class="n">low_col</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">sub</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">loE</span><span class="p">,</span> <span class="n">laE</span><span class="p">,</span> <span class="n">Z</span> <span class="o">=</span> <span class="n">grid_for_plot</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span> <span class="n">var</span><span class="p">)</span>
            <span class="n">Z_masked</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked_invalid</span><span class="p">(</span><span class="n">Z</span><span class="p">)</span>
            <span class="n">last_mesh</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">loE</span><span class="p">,</span> <span class="n">laE</span><span class="p">,</span> <span class="n">Z_masked</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">base_cmap</span><span class="p">,</span>
                                      <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">(),</span>
                                      <span class="n">shading</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>

 
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="s2">&quot;lon&quot;</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="s2">&quot;lat&quot;</span><span class="p">],</span> <span class="s2">&quot;s&quot;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">mec</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">mfc</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">())</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s2">&quot;lon&quot;</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="s2">&quot;lat&quot;</span><span class="p">],</span> <span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">mec</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">mfc</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">())</span>

    <span class="k">if</span> <span class="n">last_mesh</span><span class="p">:</span>
        <span class="n">cb</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">last_mesh</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">)</span>
        <span class="n">cb</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2"> — </span><span class="si">{</span><span class="n">city</span><span class="si">}</span><span class="s2"> vs </span><span class="si">{</span><span class="n">town</span><span class="si">}</span><span class="s2"> — </span><span class="si">{</span><span class="n">title_suffix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.97</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">rect</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mf">0.95</span><span class="p">,</span><span class="mf">0.95</span><span class="p">])</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.lines</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mlines</span>


    <span class="n">city_marker</span> <span class="o">=</span> <span class="n">mlines</span><span class="o">.</span><span class="n">Line2D</span><span class="p">([],</span> <span class="p">[],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;s&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;None&quot;</span><span class="p">,</span>
                            <span class="n">markersize</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;City (megacity)&quot;</span><span class="p">)</span>
    <span class="n">rural_marker</span> <span class="o">=</span> <span class="n">mlines</span><span class="o">.</span><span class="n">Line2D</span><span class="p">([],</span> <span class="p">[],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;None&quot;</span><span class="p">,</span>
                             <span class="n">markersize</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Rural (nearby town)&quot;</span><span class="p">)</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="p">[</span><span class="n">city_marker</span><span class="p">,</span> <span class="n">rural_marker</span><span class="p">],</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;lower center&quot;</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">extent</span>



<span class="k">def</span><span class="w"> </span><span class="nf">ensure_monthly</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">to_period</span><span class="p">(</span><span class="s2">&quot;M&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">to_timestamp</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">df</span>

<span class="n">final_df</span> <span class="o">=</span> <span class="n">ensure_monthly</span><span class="p">(</span><span class="n">final_df</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">aoi_monthly_series</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">halfwin</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
    <span class="n">sub</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span>
        <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;latitude&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="n">lat</span> <span class="o">-</span> <span class="n">halfwin</span><span class="p">,</span> <span class="n">lat</span> <span class="o">+</span> <span class="n">halfwin</span><span class="p">))</span> <span class="o">&amp;</span>
        <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;longitude&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="n">lon</span> <span class="o">-</span> <span class="n">halfwin</span><span class="p">,</span> <span class="n">lon</span> <span class="o">+</span> <span class="n">halfwin</span><span class="p">))</span>
    <span class="p">]</span>
    <span class="n">ser</span> <span class="o">=</span> <span class="p">(</span><span class="n">sub</span>
           <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)[[</span><span class="s2">&quot;AOD550&quot;</span><span class="p">,</span><span class="s2">&quot;FM_AOD550&quot;</span><span class="p">,</span><span class="s2">&quot;NMEAS&quot;</span><span class="p">]]</span>
           <span class="o">.</span><span class="n">mean</span><span class="p">())</span> 
    <span class="n">ser</span> <span class="o">=</span> <span class="n">ser</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ser</span>

<span class="k">def</span><span class="w"> </span><span class="nf">build_pair_df</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">city_name</span><span class="p">,</span> <span class="n">town_name</span><span class="p">,</span> <span class="n">halfwin</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">AOIS</span><span class="p">[</span><span class="n">city_name</span><span class="p">];</span> <span class="n">t</span> <span class="o">=</span> <span class="n">AOIS</span><span class="p">[</span><span class="n">town_name</span><span class="p">]</span>
    <span class="n">city</span> <span class="o">=</span> <span class="n">aoi_monthly_series</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">c</span><span class="p">[</span><span class="s2">&quot;lat&quot;</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="s2">&quot;lon&quot;</span><span class="p">],</span> <span class="n">halfwin</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
        <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;AOD550&quot;</span><span class="p">:</span><span class="s2">&quot;AOD_city&quot;</span><span class="p">,</span> <span class="s2">&quot;FM_AOD550&quot;</span><span class="p">:</span><span class="s2">&quot;FM_city&quot;</span><span class="p">,</span> <span class="s2">&quot;NMEAS&quot;</span><span class="p">:</span><span class="s2">&quot;N_city&quot;</span><span class="p">})</span>
    <span class="n">town</span> <span class="o">=</span> <span class="n">aoi_monthly_series</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">t</span><span class="p">[</span><span class="s2">&quot;lat&quot;</span><span class="p">],</span> <span class="n">t</span><span class="p">[</span><span class="s2">&quot;lon&quot;</span><span class="p">],</span> <span class="n">halfwin</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
        <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;AOD550&quot;</span><span class="p">:</span><span class="s2">&quot;AOD_town&quot;</span><span class="p">,</span> <span class="s2">&quot;FM_AOD550&quot;</span><span class="p">:</span><span class="s2">&quot;FM_town&quot;</span><span class="p">,</span> <span class="s2">&quot;NMEAS&quot;</span><span class="p">:</span><span class="s2">&quot;N_town&quot;</span><span class="p">})</span>
    <span class="n">merged</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">city</span><span class="p">[[</span><span class="s2">&quot;time&quot;</span><span class="p">,</span><span class="s2">&quot;AOD_city&quot;</span><span class="p">,</span><span class="s2">&quot;FM_city&quot;</span><span class="p">]],</span>
                      <span class="n">town</span><span class="p">[[</span><span class="s2">&quot;time&quot;</span><span class="p">,</span><span class="s2">&quot;AOD_town&quot;</span><span class="p">,</span><span class="s2">&quot;FM_town&quot;</span><span class="p">]],</span>
                      <span class="n">on</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;outer&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;AOD_city&quot;</span><span class="p">,</span><span class="s2">&quot;AOD_town&quot;</span><span class="p">,</span><span class="s2">&quot;FM_city&quot;</span><span class="p">,</span><span class="s2">&quot;FM_town&quot;</span><span class="p">]:</span>
        <span class="n">merged</span><span class="p">[</span><span class="n">col</span><span class="o">+</span><span class="s2">&quot;_roll3&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">merged</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">min_periods</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
 
    <span class="n">merged</span><span class="p">[</span><span class="s2">&quot;AOD_diff&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">merged</span><span class="p">[</span><span class="s2">&quot;AOD_city&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">merged</span><span class="p">[</span><span class="s2">&quot;AOD_town&quot;</span><span class="p">]</span>
    <span class="n">merged</span><span class="p">[</span><span class="s2">&quot;FM_diff&quot;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">merged</span><span class="p">[</span><span class="s2">&quot;FM_city&quot;</span><span class="p">]</span>  <span class="o">-</span> <span class="n">merged</span><span class="p">[</span><span class="s2">&quot;FM_town&quot;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">merged</span>


<span class="k">def</span><span class="w"> </span><span class="nf">plot_pair_timeseries</span><span class="p">(</span><span class="n">pair_df</span><span class="p">,</span> <span class="n">city_name</span><span class="p">,</span> <span class="n">town_name</span><span class="p">,</span> <span class="n">year_start</span><span class="o">=</span><span class="mi">2018</span><span class="p">,</span> <span class="n">year_end</span><span class="o">=</span><span class="mi">2022</span><span class="p">):</span>
 
    <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">pair_df</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span> <span class="o">&gt;=</span> <span class="n">year_start</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">pair_df</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span> <span class="o">&lt;=</span> <span class="n">year_end</span><span class="p">)</span>
    <span class="n">dfp</span> <span class="o">=</span> <span class="n">pair_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">aod_pct</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">100</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">dfp</span><span class="p">[</span><span class="s2">&quot;AOD_diff&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">fm_pct</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">100</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">dfp</span><span class="p">[</span><span class="s2">&quot;FM_diff&quot;</span><span class="p">]</span>  <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">aod_md</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">dfp</span><span class="p">[</span><span class="s2">&quot;AOD_diff&quot;</span><span class="p">])</span>
    <span class="n">fm_md</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">dfp</span><span class="p">[</span><span class="s2">&quot;FM_diff&quot;</span><span class="p">])</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span> <span class="o">=</span> <span class="n">axes</span>

    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dfp</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">],</span> <span class="n">dfp</span><span class="p">[</span><span class="s2">&quot;AOD_city&quot;</span><span class="p">],</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">city_name</span><span class="si">}</span><span class="s2"> (monthly)&quot;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dfp</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">],</span> <span class="n">dfp</span><span class="p">[</span><span class="s2">&quot;AOD_town&quot;</span><span class="p">],</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">town_name</span><span class="si">}</span><span class="s2"> (monthly)&quot;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dfp</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">],</span> <span class="n">dfp</span><span class="p">[</span><span class="s2">&quot;AOD_city_roll3&quot;</span><span class="p">],</span> <span class="n">lw</span><span class="o">=</span><span class="mf">2.2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">city_name</span><span class="si">}</span><span class="s2"> (roll-3)&quot;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dfp</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">],</span> <span class="n">dfp</span><span class="p">[</span><span class="s2">&quot;AOD_town_roll3&quot;</span><span class="p">],</span> <span class="n">lw</span><span class="o">=</span><span class="mf">2.2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">town_name</span><span class="si">}</span><span class="s2"> (roll-3)&quot;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;AOD550&quot;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;AOD550 — city vs nearby town&quot;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">ncol</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Δ = city − town | mean Δ=</span><span class="si">{</span><span class="n">aod_md</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, city&gt;town=</span><span class="si">{</span><span class="n">aod_pct</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">,</span>
             <span class="n">transform</span><span class="o">=</span><span class="n">ax1</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s2">&quot;top&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span>
             <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">boxstyle</span><span class="o">=</span><span class="s2">&quot;round,pad=0.25&quot;</span><span class="p">,</span> <span class="n">fc</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span> <span class="n">ec</span><span class="o">=</span><span class="s2">&quot;0.7&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.9</span><span class="p">))</span>

    <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dfp</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">],</span> <span class="n">dfp</span><span class="p">[</span><span class="s2">&quot;FM_city&quot;</span><span class="p">],</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">city_name</span><span class="si">}</span><span class="s2"> (monthly)&quot;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dfp</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">],</span> <span class="n">dfp</span><span class="p">[</span><span class="s2">&quot;FM_town&quot;</span><span class="p">],</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">town_name</span><span class="si">}</span><span class="s2"> (monthly)&quot;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dfp</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">],</span> <span class="n">dfp</span><span class="p">[</span><span class="s2">&quot;FM_city_roll3&quot;</span><span class="p">],</span> <span class="n">lw</span><span class="o">=</span><span class="mf">2.2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">city_name</span><span class="si">}</span><span class="s2"> (roll-3)&quot;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dfp</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">],</span> <span class="n">dfp</span><span class="p">[</span><span class="s2">&quot;FM_town_roll3&quot;</span><span class="p">],</span> <span class="n">lw</span><span class="o">=</span><span class="mf">2.2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">town_name</span><span class="si">}</span><span class="s2"> (roll-3)&quot;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;FM_AOD550&quot;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Fine-mode AOD — city vs nearby town&quot;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">ncol</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Δ = city − town | mean Δ=</span><span class="si">{</span><span class="n">fm_md</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, city&gt;town=</span><span class="si">{</span><span class="n">fm_pct</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">,</span>
             <span class="n">transform</span><span class="o">=</span><span class="n">ax2</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s2">&quot;top&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span>
             <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">boxstyle</span><span class="o">=</span><span class="s2">&quot;round,pad=0.25&quot;</span><span class="p">,</span> <span class="n">fc</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span> <span class="n">ec</span><span class="o">=</span><span class="s2">&quot;0.7&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.9</span><span class="p">))</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">city_name</span><span class="si">}</span><span class="s2"> vs </span><span class="si">{</span><span class="n">town_name</span><span class="si">}</span><span class="s2"> — Monthly time series (2018–2022)&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.98</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time&quot;</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">rect</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mf">0.965</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">fig</span>   

<span class="k">def</span><span class="w"> </span><span class="nf">extract_monthly_aoi_means</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">AOIS</span><span class="p">,</span> <span class="n">varlist</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;AOD550&quot;</span><span class="p">,</span><span class="s2">&quot;FM_AOD550&quot;</span><span class="p">],</span> <span class="n">halfwin</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute monthly average AOD values for each AOI (city/rural).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">AOIS</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">sub</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span>
            <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;longitude&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;lon&quot;</span><span class="p">]</span><span class="o">-</span><span class="n">halfwin</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;longitude&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;lon&quot;</span><span class="p">]</span><span class="o">+</span><span class="n">halfwin</span><span class="p">)</span> <span class="o">&amp;</span>
            <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;latitude&quot;</span><span class="p">]</span>  <span class="o">&gt;=</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;lat&quot;</span><span class="p">]</span><span class="o">-</span><span class="n">halfwin</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;latitude&quot;</span><span class="p">]</span>  <span class="o">&lt;=</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;lat&quot;</span><span class="p">]</span><span class="o">+</span><span class="n">halfwin</span><span class="p">)</span>
        <span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">sub</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">sub</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span><span class="p">])[</span><span class="n">varlist</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">tmp</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">,</span><span class="s2">&quot;month&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">varlist</span>
        <span class="n">tmp</span><span class="p">[</span><span class="s2">&quot;AOI&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>
        <span class="n">tmp</span><span class="p">[</span><span class="s2">&quot;kind&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;kind&quot;</span><span class="p">]</span>
        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">extract_monthly_aoi_means</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">AOIS</span><span class="p">,</span> <span class="n">varlist</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;AOD550&quot;</span><span class="p">,</span><span class="s2">&quot;FM_AOD550&quot;</span><span class="p">),</span> <span class="n">halfwin</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a DataFrame with columns:</span>
<span class="sd">    [&#39;AOI&#39;,&#39;kind&#39;,&#39;year&#39;,&#39;month&#39;,&#39;AOD550&#39;,&#39;FM_AOD550&#39;]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
 
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">to_period</span><span class="p">(</span><span class="s2">&quot;M&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">to_timestamp</span><span class="p">()</span>

    <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">AOIS</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">sub</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span>
            <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;longitude&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;lon&quot;</span><span class="p">]</span><span class="o">-</span><span class="n">halfwin</span><span class="p">,</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;lon&quot;</span><span class="p">]</span><span class="o">+</span><span class="n">halfwin</span><span class="p">))</span> <span class="o">&amp;</span>
            <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;latitude&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;lat&quot;</span><span class="p">]</span><span class="o">-</span><span class="n">halfwin</span><span class="p">,</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;lat&quot;</span><span class="p">]</span><span class="o">+</span><span class="n">halfwin</span><span class="p">))</span>
        <span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">sub</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">continue</span>

 
        <span class="n">sub</span><span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sub</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span>
        <span class="n">sub</span><span class="p">[</span><span class="s2">&quot;month&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sub</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span>

        <span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">sub</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;year&quot;</span><span class="p">,</span><span class="s2">&quot;month&quot;</span><span class="p">],</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="nb">list</span><span class="p">(</span><span class="n">varlist</span><span class="p">)]</span>
                  <span class="o">.</span><span class="n">mean</span><span class="p">())</span>
        <span class="n">tmp</span><span class="p">[</span><span class="s2">&quot;AOI&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>
        <span class="n">tmp</span><span class="p">[</span><span class="s2">&quot;kind&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;kind&quot;</span><span class="p">]</span>
        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">if</span> <span class="n">out</span> <span class="k">else</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
        <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;AOI&quot;</span><span class="p">,</span><span class="s2">&quot;kind&quot;</span><span class="p">,</span><span class="s2">&quot;year&quot;</span><span class="p">,</span><span class="s2">&quot;month&quot;</span><span class="p">,</span><span class="o">*</span><span class="n">varlist</span><span class="p">]</span>
    <span class="p">)</span>

<span class="n">monthly_df</span> <span class="o">=</span> <span class="n">extract_monthly_aoi_means</span><span class="p">(</span><span class="n">final_df</span><span class="p">,</span> <span class="n">AOIS</span><span class="p">,</span> <span class="n">varlist</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;AOD550&quot;</span><span class="p">,</span><span class="s2">&quot;FM_AOD550&quot;</span><span class="p">),</span> <span class="n">halfwin</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">monthly_pairwise_diff</span><span class="p">(</span><span class="n">monthly_df</span><span class="p">,</span> <span class="n">pairs</span><span class="p">):</span>
    <span class="n">diffs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">city</span><span class="p">,</span> <span class="n">town</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">:</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">monthly_df</span><span class="p">[</span><span class="n">monthly_df</span><span class="p">[</span><span class="s2">&quot;AOI&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">city</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">monthly_df</span><span class="p">[</span><span class="n">monthly_df</span><span class="p">[</span><span class="s2">&quot;AOI&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">town</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">merged</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">,</span><span class="s2">&quot;month&quot;</span><span class="p">],</span> <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;_city&quot;</span><span class="p">,</span><span class="s2">&quot;_rural&quot;</span><span class="p">))</span>
        <span class="n">merged</span><span class="p">[</span><span class="s2">&quot;AOD550_diff&quot;</span><span class="p">]</span>    <span class="o">=</span> <span class="n">merged</span><span class="p">[</span><span class="s2">&quot;AOD550_city&quot;</span><span class="p">]</span>    <span class="o">-</span> <span class="n">merged</span><span class="p">[</span><span class="s2">&quot;AOD550_rural&quot;</span><span class="p">]</span>
        <span class="n">merged</span><span class="p">[</span><span class="s2">&quot;FM_AOD550_diff&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">merged</span><span class="p">[</span><span class="s2">&quot;FM_AOD550_city&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">merged</span><span class="p">[</span><span class="s2">&quot;FM_AOD550_rural&quot;</span><span class="p">]</span>
        <span class="n">merged</span><span class="p">[</span><span class="s2">&quot;pair&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">city</span><span class="si">}</span><span class="s2"> − </span><span class="si">{</span><span class="n">town</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">diffs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">merged</span><span class="p">[[</span><span class="s2">&quot;year&quot;</span><span class="p">,</span><span class="s2">&quot;month&quot;</span><span class="p">,</span><span class="s2">&quot;pair&quot;</span><span class="p">,</span><span class="s2">&quot;AOD550_diff&quot;</span><span class="p">,</span><span class="s2">&quot;FM_AOD550_diff&quot;</span><span class="p">]])</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">diffs</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">pairwise_monthly</span> <span class="o">=</span> <span class="n">monthly_pairwise_diff</span><span class="p">(</span><span class="n">monthly_df</span><span class="p">,</span> <span class="n">PAIRS</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">paired_summary</span><span class="p">(</span><span class="n">city_label</span><span class="p">,</span> <span class="n">rural_label</span><span class="p">,</span> <span class="n">var</span><span class="o">=</span><span class="s2">&quot;AOD550&quot;</span><span class="p">):</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">monthly_df</span><span class="p">[</span><span class="n">monthly_df</span><span class="p">[</span><span class="s2">&quot;AOI&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">city_label</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">monthly_df</span><span class="p">[</span><span class="n">monthly_df</span><span class="p">[</span><span class="s2">&quot;AOI&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">rural_label</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">merged</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">,</span><span class="s2">&quot;month&quot;</span><span class="p">],</span> <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;_city&quot;</span><span class="p">,</span><span class="s2">&quot;_rural&quot;</span><span class="p">))</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="n">merged</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2">_city&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">merged</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2">_rural&quot;</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;pair&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">city_label</span><span class="si">}</span><span class="s2"> − </span><span class="si">{</span><span class="n">rural_label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;variable&quot;</span><span class="p">:</span> <span class="n">var</span><span class="p">,</span>
        <span class="s2">&quot;mean_diff&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">diff</span><span class="o">.</span><span class="n">mean</span><span class="p">()),</span>
        <span class="s2">&quot;frac_city_gt (%)&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">((</span><span class="n">diff</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">*</span><span class="mi">100</span><span class="p">),</span>
        <span class="s2">&quot;n_months&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">diff</span><span class="p">))</span>
    <span class="p">}</span>

<span class="n">HALFWIN</span> <span class="o">=</span> <span class="mf">0.5</span>  <span class="c1"># degrees (±0.5° = the native 1° grid cell)</span>
<span class="n">YEAR_START</span><span class="p">,</span> <span class="n">YEAR_END</span> <span class="o">=</span> <span class="mi">2018</span><span class="p">,</span> <span class="mi">2022</span>

<span class="k">def</span><span class="w"> </span><span class="nf">month_to_season</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="s2">&quot;DJF&quot;</span> <span class="k">if</span> <span class="n">m</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">else</span> <span class="s2">&quot;MAM&quot;</span> <span class="k">if</span> <span class="n">m</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>
            <span class="k">else</span> <span class="s2">&quot;JJA&quot;</span> <span class="k">if</span> <span class="n">m</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span>
            <span class="k">else</span> <span class="s2">&quot;SON&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">aoi_monthly</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">halfwin</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Monthly mean for an AOI (AOD550 &amp; FM_AOD550) from the 1° grid cell around (lat,lon).&quot;&quot;&quot;</span>
    <span class="n">sub</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;latitude&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="n">lat</span><span class="o">-</span><span class="n">halfwin</span><span class="p">,</span> <span class="n">lat</span><span class="o">+</span><span class="n">halfwin</span><span class="p">)</span> <span class="o">&amp;</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;longitude&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="n">lon</span><span class="o">-</span><span class="n">halfwin</span><span class="p">,</span> <span class="n">lon</span><span class="o">+</span><span class="n">halfwin</span><span class="p">)</span>
    <span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">sub</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">,</span><span class="s2">&quot;AOD550&quot;</span><span class="p">,</span><span class="s2">&quot;FM_AOD550&quot;</span><span class="p">,</span><span class="s2">&quot;season&quot;</span><span class="p">])</span>

    <span class="n">sub</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">sub</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">to_period</span><span class="p">(</span><span class="s2">&quot;M&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">to_timestamp</span><span class="p">()</span>
    <span class="n">sub</span> <span class="o">=</span> <span class="n">sub</span><span class="p">[(</span><span class="n">sub</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span> <span class="o">&gt;=</span> <span class="n">YEAR_START</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">sub</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span> <span class="o">&lt;=</span> <span class="n">YEAR_END</span><span class="p">)]</span>

    <span class="n">out</span> <span class="o">=</span> <span class="p">(</span><span class="n">sub</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)[[</span><span class="s2">&quot;AOD550&quot;</span><span class="p">,</span><span class="s2">&quot;FM_AOD550&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
              <span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">))</span>
    <span class="n">out</span><span class="p">[</span><span class="s2">&quot;season&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">month_to_season</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="n">ts_by_place</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">AOIS</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">ts_by_place</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">aoi_monthly</span><span class="p">(</span><span class="n">final_df</span><span class="p">,</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;lat&quot;</span><span class="p">],</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;lon&quot;</span><span class="p">],</span> <span class="n">halfwin</span><span class="o">=</span><span class="n">HALFWIN</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Seasonal means (climatological) per pair:&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">print_pair_seasonals</span><span class="p">(</span><span class="n">city_label</span><span class="p">,</span> <span class="n">rural_label</span><span class="p">,</span> <span class="n">var</span><span class="p">):</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">ts_by_place</span><span class="p">[</span><span class="n">city_label</span><span class="p">]</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">ts_by_place</span><span class="p">[</span><span class="n">rural_label</span><span class="p">]</span>

    <span class="n">c_seas</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;season&quot;</span><span class="p">,</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">r_seas</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;season&quot;</span><span class="p">,</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

    <span class="n">order</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;DJF&quot;</span><span class="p">,</span><span class="s2">&quot;MAM&quot;</span><span class="p">,</span><span class="s2">&quot;JJA&quot;</span><span class="p">,</span><span class="s2">&quot;SON&quot;</span><span class="p">]</span>
    <span class="n">c_seas</span> <span class="o">=</span> <span class="n">c_seas</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
    <span class="n">r_seas</span> <span class="o">=</span> <span class="n">r_seas</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;city&quot;</span><span class="p">:</span> <span class="n">c_seas</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="s2">&quot;rural&quot;</span><span class="p">:</span> <span class="n">r_seas</span><span class="o">.</span><span class="n">values</span><span class="p">},</span> <span class="n">index</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2"> seasonal mean | </span><span class="si">{</span><span class="n">city_label</span><span class="si">}</span><span class="s2"> vs </span><span class="si">{</span><span class="n">rural_label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Seasonal means (climatological) per pair:
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="plot-calculation-and-describe-the-results">
<span id="satellite-satellite-aerosol-properties-consistency-q03-section-3"></span><h3>Plot, calculation and describe the results<a class="headerlink" href="#plot-calculation-and-describe-the-results" title="Link to this heading">#</a></h3>
<section id="pairwise-monthly-differences-city-nearby-town">
<h4>Pairwise monthly differences (city − nearby town)<a class="headerlink" href="#pairwise-monthly-differences-city-nearby-town" title="Link to this heading">#</a></h4>
<p>For each megacity–town pair, we computed monthly differences in AOD550 and FM_AOD550 by subtracting the nearby town value from the city value.</p>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">city_label</span><span class="p">,</span> <span class="n">rural_label</span> <span class="ow">in</span> <span class="n">PAIRS</span><span class="p">:</span>
    <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">paired_summary</span><span class="p">(</span><span class="n">city_label</span><span class="p">,</span> <span class="n">rural_label</span><span class="p">,</span> <span class="n">var</span><span class="o">=</span><span class="s2">&quot;AOD550&quot;</span><span class="p">))</span>
    <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">paired_summary</span><span class="p">(</span><span class="n">city_label</span><span class="p">,</span> <span class="n">rural_label</span><span class="p">,</span> <span class="n">var</span><span class="o">=</span><span class="s2">&quot;FM_AOD550&quot;</span><span class="p">))</span>
<span class="n">summary_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Pairwise monthly differences (city − nearby town):&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">summary_df</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Pairwise monthly differences (city − nearby town):
                                         pair  variable  mean_diff  frac_city_gt (%)  n_months
  Athens (megacity) − Livadeia (nearby rural)    AOD550      0.005            56.061        66
  Athens (megacity) − Livadeia (nearby rural) FM_AOD550      0.001            51.515        66
London (megacity) − Northampton (nearby town)    AOD550      0.037            65.152        66
London (megacity) − Northampton (nearby town) FM_AOD550      0.052            74.242        66
    Brussels (megacity) − Arras (nearby town)    AOD550     -0.021            24.242        66
    Brussels (megacity) − Arras (nearby town) FM_AOD550     -0.031            19.697        66
     Milan (megacity) − Sondrio (nearby town)    AOD550      0.010            57.576        66
     Milan (megacity) − Sondrio (nearby town) FM_AOD550      0.015            66.667        66
</pre></div>
</div>
</div>
</div>
<p>The results indicate that mean differences are generally small (within ±0.01–0.02), with Athens showing the most frequent positive city–rural contrast, while in Brussels, London, and Milan the rural sites often equal or exceed the city values.</p>
</section>
<section id="seasonal-means-climatological-per-pair">
<h4>Seasonal means (climatological) per pair<a class="headerlink" href="#seasonal-means-climatological-per-pair" title="Link to this heading">#</a></h4>
<p>For each megacity–town pair (Athens–Livadeia, London–Northampton, Brussels–Arras, Milan–Sondrio), seasonal climatological means of AOD550 and FM_AOD550 were computed.</p>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">city_label</span><span class="p">,</span> <span class="n">rural_label</span> <span class="ow">in</span> <span class="n">PAIRS</span><span class="p">:</span>
    <span class="n">print_pair_seasonals</span><span class="p">(</span><span class="n">city_label</span><span class="p">,</span> <span class="n">rural_label</span><span class="p">,</span> <span class="n">var</span><span class="o">=</span><span class="s2">&quot;AOD550&quot;</span><span class="p">)</span>
    <span class="n">print_pair_seasonals</span><span class="p">(</span><span class="n">city_label</span><span class="p">,</span> <span class="n">rural_label</span><span class="p">,</span> <span class="n">var</span><span class="o">=</span><span class="s2">&quot;FM_AOD550&quot;</span><span class="p">)</span>

<span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">city_label</span><span class="p">,</span> <span class="n">rural_label</span> <span class="ow">in</span> <span class="n">PAIRS</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;AOD550&quot;</span><span class="p">,</span><span class="s2">&quot;FM_AOD550&quot;</span><span class="p">]:</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">ts_by_place</span><span class="p">[</span><span class="n">city_label</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;season&quot;</span><span class="p">)[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">reindex</span><span class="p">([</span><span class="s2">&quot;DJF&quot;</span><span class="p">,</span><span class="s2">&quot;MAM&quot;</span><span class="p">,</span><span class="s2">&quot;JJA&quot;</span><span class="p">,</span><span class="s2">&quot;SON&quot;</span><span class="p">])</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">ts_by_place</span><span class="p">[</span><span class="n">rural_label</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;season&quot;</span><span class="p">)[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">reindex</span><span class="p">([</span><span class="s2">&quot;DJF&quot;</span><span class="p">,</span><span class="s2">&quot;MAM&quot;</span><span class="p">,</span><span class="s2">&quot;JJA&quot;</span><span class="p">,</span><span class="s2">&quot;SON&quot;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">season</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;DJF&quot;</span><span class="p">,</span><span class="s2">&quot;MAM&quot;</span><span class="p">,</span><span class="s2">&quot;JJA&quot;</span><span class="p">,</span><span class="s2">&quot;SON&quot;</span><span class="p">]:</span>
            <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s2">&quot;pair&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">city_label</span><span class="si">}</span><span class="s2"> vs </span><span class="si">{</span><span class="n">rural_label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="s2">&quot;variable&quot;</span><span class="p">:</span> <span class="n">var</span><span class="p">,</span>
                <span class="s2">&quot;season&quot;</span><span class="p">:</span> <span class="n">season</span><span class="p">,</span>
                <span class="s2">&quot;city&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">season</span><span class="p">])</span> <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">season</span><span class="p">])</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
                <span class="s2">&quot;rural&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">season</span><span class="p">])</span> <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">season</span><span class="p">])</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="p">})</span>
<span class="n">seasonal_pair_table</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>AOD550 seasonal mean | Athens (megacity) vs Livadeia (nearby rural)
      city  rural
DJF  0.120  0.126
MAM  0.187  0.161
JJA  0.194  0.200
SON  0.155  0.141

FM_AOD550 seasonal mean | Athens (megacity) vs Livadeia (nearby rural)
      city  rural
DJF  0.090  0.107
MAM  0.144  0.127
JJA  0.174  0.173
SON  0.126  0.116

AOD550 seasonal mean | London (megacity) vs Northampton (nearby town)
      city  rural
DJF  0.115  0.106
MAM  0.207  0.141
JJA  0.196  0.169
SON  0.138  0.112

FM_AOD550 seasonal mean | London (megacity) vs Northampton (nearby town)
      city  rural
DJF  0.100  0.085
MAM  0.182  0.112
JJA  0.168  0.101
SON  0.115  0.084

AOD550 seasonal mean | Brussels (megacity) vs Arras (nearby town)
      city  rural
DJF  0.147  0.141
MAM  0.145  0.184
JJA  0.200  0.219
SON  0.138  0.155

FM_AOD550 seasonal mean | Brussels (megacity) vs Arras (nearby town)
      city  rural
DJF  0.129  0.120
MAM  0.113  0.160
JJA  0.132  0.174
SON  0.113  0.135

AOD550 seasonal mean | Milan (megacity) vs Sondrio (nearby town)
      city  rural
DJF  0.162  0.129
MAM  0.188  0.176
JJA  0.178  0.192
SON  0.171  0.137

FM_AOD550 seasonal mean | Milan (megacity) vs Sondrio (nearby town)
      city  rural
DJF  0.147  0.113
MAM  0.152  0.120
JJA  0.121  0.139
SON  0.144  0.112
</pre></div>
</div>
</div>
</div>
<p>These values summarize average conditions in winter (DJF), spring (MAM), summer (JJA), and autumn (SON), allowing a compact comparison of seasonal cycles between cities and their nearby towns. The results show that while absolute levels vary seasonally, the city–rural differences remain small in magnitude relative to regional and seasonal variability.</p>
</section>
<section id="cityrural-aod-and-fm-aod-time-series-plots">
<h4>City–rural AOD and FM-AOD time-series plots<a class="headerlink" href="#cityrural-aod-and-fm-aod-time-series-plots" title="Link to this heading">#</a></h4>
<p>Values of timeseries are area-weighted neighborhood averages with valid-pixel masking.</p>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">HALFWIN</span> <span class="o">=</span> <span class="mf">0.5</span>   
<span class="k">for</span> <span class="n">city</span><span class="p">,</span> <span class="n">town</span> <span class="ow">in</span> <span class="n">PAIRS</span><span class="p">:</span>
    <span class="n">pair_df</span> <span class="o">=</span> <span class="n">build_pair_df</span><span class="p">(</span><span class="n">final_df</span><span class="p">,</span> <span class="n">city</span><span class="p">,</span> <span class="n">town</span><span class="p">,</span> <span class="n">halfwin</span><span class="o">=</span><span class="n">HALFWIN</span><span class="p">)</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plot_pair_timeseries</span><span class="p">(</span><span class="n">pair_df</span><span class="p">,</span> <span class="n">city</span><span class="p">,</span> <span class="n">town</span><span class="p">,</span> <span class="n">year_start</span><span class="o">=</span><span class="n">YEAR_START</span><span class="p">,</span> <span class="n">year_end</span><span class="o">=</span><span class="n">YEAR_END</span><span class="p">)</span>
    <span class="n">fname</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;timeseries_</span><span class="si">{</span><span class="n">city</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">town</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">YEAR_START</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">YEAR_END</span><span class="si">}</span><span class="s2">.png&quot;</span>
   
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../../_images/625c3b2fb82409abe58b340efa182ece283fc7319cbb0bc1ce190c01c02b6e0f.png" src="../../_images/625c3b2fb82409abe58b340efa182ece283fc7319cbb0bc1ce190c01c02b6e0f.png" />
<img alt="../../_images/931ad51e2335f15301ddace1a305b20b42662e4498f3b50a3d5738f15d7cbd69.png" src="../../_images/931ad51e2335f15301ddace1a305b20b42662e4498f3b50a3d5738f15d7cbd69.png" />
<img alt="../../_images/c8b2a54a9e40584c6be93e18d915c54047b6336ca97c5ee2c44772af1b75cafe.png" src="../../_images/c8b2a54a9e40584c6be93e18d915c54047b6336ca97c5ee2c44772af1b75cafe.png" />
<img alt="../../_images/8621bf6e0fcce9ae2d771d1b412f18675b9d8cca81c559a0bdbbf130af9b3d34.png" src="../../_images/8621bf6e0fcce9ae2d771d1b412f18675b9d8cca81c559a0bdbbf130af9b3d34.png" />
</div>
</div>
<p><em>Figure 1.</em> Monthly mean time series of AOD550 and FM_AOD550 for each megacity and its paired nearby town (Athens–Livadeia, London–Northampton, Brussels–Arras, Milan–Sondrio). Solid lines show the megacity, dashed lines the nearby town. These plots illustrate temporal variability.</p>
</section>
<section id="seasonal-aod-fm-aod-maps-with-city-rural-markers">
<h4>Seasonal AOD &amp; FM-AOD maps (with city/rural markers)<a class="headerlink" href="#seasonal-aod-fm-aod-maps-with-city-rural-markers" title="Link to this heading">#</a></h4>
<p>Each panel shows seasonal means (DJF, MAM, JJA, SON) for total AOD and fine-mode AOD. Triangles mark city AOIs their rural references. These maps provide the regional context for the urban–rural time-series and enhancement analyses.</p>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;AOD550&quot;</span><span class="p">,</span> <span class="s2">&quot;FM_AOD550&quot;</span><span class="p">):</span>

    <span class="n">vals</span> <span class="o">=</span> <span class="n">seasonal</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="n">vmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanpercentile</span><span class="p">(</span><span class="n">vals</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
    <span class="n">vmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanpercentile</span><span class="p">(</span><span class="n">vals</span><span class="p">,</span> <span class="mi">95</span><span class="p">)</span>

    <span class="n">fig</span> <span class="o">=</span> <span class="n">plot_seasonal_maps</span><span class="p">(</span>
    <span class="n">seasonal</span><span class="p">,</span>
    <span class="n">var</span><span class="o">=</span><span class="n">var</span><span class="p">,</span>
    <span class="n">season_year</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span>
    <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span>
    <span class="n">extent</span><span class="o">=</span><span class="n">EUROPE_EXTENT</span><span class="p">,</span>
    <span class="n">title_suffix</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">YEAR_START</span><span class="si">}</span><span class="s2">–</span><span class="si">{</span><span class="n">YEAR_END</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
    <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;YlOrRd&quot;</span>   
<span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../../_images/1a120505bca7a9914e4175fccd13e5d391c108df3faf58de51a3a534a16c207d.png" src="../../_images/1a120505bca7a9914e4175fccd13e5d391c108df3faf58de51a3a534a16c207d.png" />
<img alt="../../_images/19c05a79c3d4f6d377c0082fbc8085348feec1649cfb09b0f0e96aa7323b8b79.png" src="../../_images/19c05a79c3d4f6d377c0082fbc8085348feec1649cfb09b0f0e96aa7323b8b79.png" />
</div>
</div>
<p><em>Figure 2.</em> Seasonal AOD and Fine-Mode AOD (550 nm) over the Eastern Mediterranean, 2018–2023 (1°).</p>
</section>
<section id="focused-seasonal-map-plots-of-aod550-and-fm-aod550-for-megacitytown-pairs">
<h4>Focused seasonal map plots of AOD550 and FM_AOD550 for megacity–town pairs<a class="headerlink" href="#focused-seasonal-map-plots-of-aod550-and-fm-aod550-for-megacitytown-pairs" title="Link to this heading">#</a></h4>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">PAIRS</span><span class="p">:</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">extent</span> <span class="o">=</span> <span class="n">plot_pair_focus</span><span class="p">(</span><span class="n">pair</span><span class="p">,</span> <span class="n">var</span><span class="o">=</span><span class="s2">&quot;AOD550&quot;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;YlOrRd&quot;</span><span class="p">,</span>
                                  <span class="n">vmin</span><span class="o">=</span><span class="n">aod_vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">aod_vmax</span><span class="p">,</span> <span class="n">pad_deg</span><span class="o">=</span><span class="mf">6.0</span><span class="p">)</span>
   
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">extent</span> <span class="o">=</span> <span class="n">plot_pair_focus</span><span class="p">(</span><span class="n">pair</span><span class="p">,</span> <span class="n">var</span><span class="o">=</span><span class="s2">&quot;FM_AOD550&quot;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;PuBu&quot;</span><span class="p">,</span>
                                  <span class="n">vmin</span><span class="o">=</span><span class="n">fm_vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">fm_vmax</span><span class="p">,</span> <span class="n">pad_deg</span><span class="o">=</span><span class="mf">6.0</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../../_images/cc6070752e29ca274d78d69834bdf29bb8fbe93ad1c19cfedeece0d869ccbe41.png" src="../../_images/cc6070752e29ca274d78d69834bdf29bb8fbe93ad1c19cfedeece0d869ccbe41.png" />
<img alt="../../_images/41badea538f1aec74a36ad2a034b721c6ac9aab9bdaec5410c3cd1e8220bfd94.png" src="../../_images/41badea538f1aec74a36ad2a034b721c6ac9aab9bdaec5410c3cd1e8220bfd94.png" />
<img alt="../../_images/91c9d166b50ea49848aca7a5b56ae6e4a6839d6c52213d52a7ef914872e8b01d.png" src="../../_images/91c9d166b50ea49848aca7a5b56ae6e4a6839d6c52213d52a7ef914872e8b01d.png" />
<img alt="../../_images/91c5f17c4833ef4c441d2d84be436823bc0ce4524947d6a89d88f5f5f137f6c5.png" src="../../_images/91c5f17c4833ef4c441d2d84be436823bc0ce4524947d6a89d88f5f5f137f6c5.png" />
<img alt="../../_images/33304362ff871f17e11f2ea0fa45bb1704486a570e4301f40b33940ff2622a25.png" src="../../_images/33304362ff871f17e11f2ea0fa45bb1704486a570e4301f40b33940ff2622a25.png" />
<img alt="../../_images/4b5e597fe73ec0c57d9dda76bfc11ae4962c424d0533b110a99f8adb3370f3b3.png" src="../../_images/4b5e597fe73ec0c57d9dda76bfc11ae4962c424d0533b110a99f8adb3370f3b3.png" />
<img alt="../../_images/0061e8cb4b9c89ad0f08092ce29d2fc516e9df762e1d40c3fe702217bb22b996.png" src="../../_images/0061e8cb4b9c89ad0f08092ce29d2fc516e9df762e1d40c3fe702217bb22b996.png" />
<img alt="../../_images/9a9668d1bd19c01af5f724a8803dbf276b8ac7fa125851ec9c09d7ebc9728bfa.png" src="../../_images/9a9668d1bd19c01af5f724a8803dbf276b8ac7fa125851ec9c09d7ebc9728bfa.png" />
</div>
</div>
<p><em>Figure 3.</em> Focused seasonal map plots of AOD550 and FM_AOD550 for megacity–town pairs.</p>
</section>
</section>
<section id="take-home-messages">
<span id="satellite-satellite-aerosol-properties-consistency-q03-section-4"></span><h3>Take-Home Messages<a class="headerlink" href="#take-home-messages" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Seasonal cycles (e.g. summer peaks) dominate over city–rural differences.</p></li>
<li><p>Fine-mode AOD (fm_aod550) does not consistently show higher values over cities, highlighting the challenge of using satellite AOD as a direct proxy for local pollution.</p></li>
<li><p>Interpretation of urban–rural contrast in the AOD values requires caution, as meteorology, transport, and averaging effects can mask local signals.</p></li>
<li><p>A small data gap is present for Northampton due to SLSTR data unavailability; while this reduces seasonal coverage, the available records still capture the main seasonal cycle and trends.</p></li>
</ul>
</section>
</section>
<section id="i-if-you-want-to-know-more">
<h2>ℹ️ If you want to know more<a class="headerlink" href="#i-if-you-want-to-know-more" title="Link to this heading">#</a></h2>
<section id="key-resources">
<h3>Key Resources<a class="headerlink" href="#key-resources" title="Link to this heading">#</a></h3>
<p>• Aerosol properties gridded data from 1995 to present derived from satellite observations:</p>
<p><a class="reference external" href="https://cds.climate.copernicus.eu/datasets/satellite-aerosol-properties?tab=overview" rel="noreferrer" target="_blank">https://cds.climate.copernicus.eu/datasets/satellite-aerosol-properties?tab=overview</a></p>
<p>Code libraries used:</p>
<p>• C3S EQC custom function, c3s_eqc_automatic_quality_control, prepared by B-Open</p>
</section>
<section id="references">
<h3>References<a class="headerlink" href="#references" title="Link to this heading">#</a></h3>
<p><strong><a class="reference external" href="https://pubmed.ncbi.nlm.nih.gov/19603734/" rel="noreferrer" target="_blank">[1]</a></strong> Hoff, R. M., &amp; Christopher, S. A. (2009). <em>Remote sensing of particulate pollution from space: have we reached the promised land?</em> <em>Journal of the Air &amp; Waste Management Association</em>, 59(6), 645–675. <a class="reference external" href="https://pubmed.ncbi.nlm.nih.gov/19603734/" rel="noreferrer" target="_blank">https://pubmed.ncbi.nlm.nih.gov/19603734/</a></p>
<p><strong><a class="reference external" href="https://health.hub.copernicus.eu/air-pollution-nearly-everyone-europe-breathing-bad-air-deutsche-welle" rel="noreferrer" target="_blank">[2]</a></strong> <em>Air pollution: Nearly everyone in Europe is breathing bad air — Deutsche Welle (via Copernicus Health Hub)</em></p>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./Satellite_ECVs/Atmospheric_Composition"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="Atmospheric_Composition.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title"><span class="section-number">1.2. </span>Atmospheric Composition</p>
      </div>
    </a>
    <a class="right-next"
       href="../Cryosphere/Cryosphere.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title"><span class="section-number">1.3. </span>Cryosphere</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#use-case-identification-of-pollution-hotspots">🌍 Use case: Identification of Pollution Hotspots</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#quality-assessment-questions">❓ Quality assessment questions</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#quality-assessment-statement">📢 Quality assessment statement</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#methodology">📋 Methodology</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#analysis-and-results">📈 Analysis and results</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#choose-the-data-to-use-and-set-up-the-code">Choose the data to use and set up the code</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#import-all-required-libraries">Import all required libraries</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#spatial-and-temporal-definitions">Spatial and temporal definitions</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#data-retrieval-and-preparation">Data Retrieval and Preparation</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#download-aod-data">Download AOD data</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#prepare-the-dataframe">Prepare the dataframe</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#define-required-functions">Define required functions</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-calculation-and-describe-the-results">Plot, calculation and describe the results</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#pairwise-monthly-differences-city-nearby-town">Pairwise monthly differences (city − nearby town)</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#seasonal-means-climatological-per-pair">Seasonal means (climatological) per pair</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#cityrural-aod-and-fm-aod-time-series-plots">City–rural AOD and FM-AOD time-series plots</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#seasonal-aod-fm-aod-maps-with-city-rural-markers">Seasonal AOD &amp; FM-AOD maps (with city/rural markers)</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#focused-seasonal-map-plots-of-aod550-and-fm-aod550-for-megacitytown-pairs">Focused seasonal map plots of AOD550 and FM_AOD550 for megacity–town pairs</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#take-home-messages">Take-Home Messages</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#i-if-you-want-to-know-more">ℹ️ If you want to know more</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#key-resources">Key Resources</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#references">References</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By the Copernicus Climate Change Service (C3S), entrusted to ECMWF (European Centre for Medium-Range Weather Forecasts)
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2024.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>