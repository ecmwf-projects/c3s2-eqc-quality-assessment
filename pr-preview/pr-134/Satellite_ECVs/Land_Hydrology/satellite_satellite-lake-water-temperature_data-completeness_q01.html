
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>1.5.1. Satellite lake surface water temperature observations completeness for water resource management monitoring &#8212; eqcbook</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'Satellite_ECVs/Land_Hydrology/satellite_satellite-lake-water-temperature_data-completeness_q01';</script>
    <link rel="icon" href="../../_static/C3S_favicon.png"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="1.6. Ocean" href="../Ocean/Ocean.html" />
    <link rel="prev" title="1.5. Land Hydrology" href="Land_Hydrology.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>
<aside class="bd-header-announcement" aria-label="Announcement">
  <div class="bd-header-announcement__content">‚ö†Ô∏èThis is under development!‚ö†Ô∏è</div>
</aside>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/C3S‚ÄìPOS‚ÄìLINE.png" class="logo__image only-light" alt="eqcbook - Home"/>
    <script>document.write(`<img src="../../_static/C3S‚ÄìPOS‚ÄìLINE.png" class="logo__image only-dark" alt="eqcbook - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../intro.html">
                    C3S EQC quality assessments
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">‚û°Ô∏è Satellite Observations</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 current active has-children"><a class="reference internal" href="../satellite.html">1. Quality assessments for Satellite Observations</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="current">
<li class="toctree-l2 has-children"><a class="reference internal" href="../Atmosphere_Physics/Atmosphere_Physics.html">1.1. Atmosphere Physics</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="simple">
</ul>
</details></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../Atmospheric_Composition/Atmospheric_Composition.html">1.2. Atmospheric Composition</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="simple">
</ul>
</details></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../Cryosphere/Cryosphere.html">1.3. Cryosphere</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="simple">
</ul>
</details></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../Land_Biosphere/Land_Biosphere.html">1.4. Land Biosphere</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="simple">
</ul>
</details></li>
<li class="toctree-l2 current active has-children"><a class="reference internal" href="Land_Hydrology.html">1.5. Land Hydrology</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="current">
<li class="toctree-l3 current active"><a class="current reference internal" href="#">1.5.1. Satellite lake surface water temperature observations completeness for water resource management monitoring</a></li>
</ul>
</details></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../Ocean/Ocean.html">1.6. Ocean</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="simple">
</ul>
</details></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">‚û°Ô∏è Insitu Observations</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../In_Situ/insitu.html">2. Quality assessments for Insitu Observations</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="simple">
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">‚û°Ô∏è Reanalysis</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../Reanalyses/reanalysis.html">3. Quality assessments for Reanalysis</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="simple">
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">‚û°Ô∏è Seasonal Forecasts</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../Seasonal_Forecasts/seasonal.html">4. Quality assessments for Seasonal Forecasts</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="simple">
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">‚û°Ô∏è Climate Projections</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../Climate_Projections/climate.html">5. Quality assessments for Climate Projections</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../Climate_Projections/CMIP6/CMIP6.html">5.1. CMIP6</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="simple">
</ul>
</details></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../Climate_Projections/CORDEX/CORDEX.html">5.2. CORDEX</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="simple">
</ul>
</details></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">‚û°Ô∏è Climate Indicators</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../Indicators/indicator.html">6. Quality assessments for Climate Indicators</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="simple">
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">‚û°Ô∏è Derived Datasets</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../Derived_Datasets/derived.html">7. Quality assessments for Derived Datasets</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="simple">
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">‚û°Ô∏è Applications</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../Applications/application.html">8. Quality assessments for C3S Applications</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="simple">
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Quality assessment template</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../templates/template_instructions.html">Template instructions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../templates/template.html">Template</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/ecmwf-projects/c3s2-eqc-quality-assessment" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/ecmwf-projects/c3s2-eqc-quality-assessment/issues/new?title=Issue%20on%20page%20%2FSatellite_ECVs/Land_Hydrology/satellite_satellite-lake-water-temperature_data-completeness_q01.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/Satellite_ECVs/Land_Hydrology/satellite_satellite-lake-water-temperature_data-completeness_q01.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Satellite lake surface water temperature observations completeness for water resource management monitoring</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#use-case-utilize-satellite-derived-lake-water-temperature-data-to-water-resources-management-and-support-climate-adaptation-strategies">üåç Use case: Utilize satellite-derived lake water temperature data to water resources management and support climate adaptation strategies</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#quality-assessment-question">‚ùì Quality assessment question</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#quality-assessment-statement">üì¢ Quality assessment statement</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#methodology">üìã Methodology</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#analysis-and-results">üìà Analysis and results</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#data-request-and-download">1. Data request and download</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#import-packages">Import packages</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#set-variables">Set variables</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#set-the-data-request">Set the data request</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#download-data">Download data</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#data-preprocessing">2. Data preprocessing</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-lakeid">Plot lakeid</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#data-filtering">Data filtering</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#spatial-completeness-analysis">3. Spatial completeness analysis</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#temporal-completeness-analysis">4. Temporal completeness analysis</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#temporal-completeness">Temporal completeness</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#comparison-with-buoy-data">Comparison with buoy data</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#i-if-you-want-to-know-more">‚ÑπÔ∏è If you want to know more</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#key-resources">Key resources</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#references">References</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <p><img alt="logo" src="../../_images/LogoLine_horizon_C3S1.png" /></p>
<div class="alert alert-block alert-warning">
Please note that this repository is used for development and review, so quality assessments should be considered work in progress until they are merged into the main branch
</div><section class="tex2jax_ignore mathjax_ignore" id="satellite-lake-surface-water-temperature-observations-completeness-for-water-resource-management-monitoring">
<h1><span class="section-number">1.5.1. </span>Satellite lake surface water temperature observations completeness for water resource management monitoring<a class="headerlink" href="#satellite-lake-surface-water-temperature-observations-completeness-for-water-resource-management-monitoring" title="Link to this heading">#</a></h1>
<p>Production date: 22-12-2025</p>
<p>Produced by: Cristina Deidda (VUB) and Victor Couplet (VUB)</p>
<section id="use-case-utilize-satellite-derived-lake-water-temperature-data-to-water-resources-management-and-support-climate-adaptation-strategies">
<h2>üåç Use case: Utilize satellite-derived lake water temperature data to water resources management and support climate adaptation strategies<a class="headerlink" href="#use-case-utilize-satellite-derived-lake-water-temperature-data-to-water-resources-management-and-support-climate-adaptation-strategies" title="Link to this heading">#</a></h2>
</section>
<section id="quality-assessment-question">
<h2>‚ùì Quality assessment question<a class="headerlink" href="#quality-assessment-question" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p><strong>Are satellite measurements of surface water temperature adequately comprehensive in terms of temporal coverage and data completeness to monitor the temperature dynamics of Lake Superior (North America)?</strong></p></li>
</ul>
<p>The¬†<a class="reference external" href="https://cds.climate.copernicus.eu/datasets/satellite-lake-water-temperature?tab=overview" rel="noreferrer" target="_blank">satellite-lake-water-temperature</a> dataset, available from 1995 to the present, provides a consistent time series of lake surface water temperature observations for lakes worldwide. These data support a wide range of applications, including water resource management, climate change impact assessment, fisheries management, and ecosystem monitoring. In this case study, we focus on Lake Superior and restrict the analysis to summer conditions (July‚ÄìSeptember). The objective is to assess the spatiotemporal completeness of the dataset, identify potential outliers, and evaluate its suitability for monitoring lake temperature dynamics and supporting these applications.</p>
</section>
<section id="quality-assessment-statement">
<h2>üì¢ Quality assessment statement<a class="headerlink" href="#quality-assessment-statement" title="Link to this heading">#</a></h2>
<div class="note admonition">
<p class="admonition-title">These are the key outcomes of this assessment</p>
<ul class="simple">
<li><p>The completeness of satellite-derived lake surface water temperature (LSWT) data improves over time as satellite instrumentation evolves. For Lake Superior summer LSWT, data completeness (quality level ‚â• 4) increases from less than 20 % prior to 2000 to approximately 40 % in recent years.</p></li>
<li><p>At any given date, spatial data completeness over Lake Superior can range from 0 % to nearly 100 %, even with the most recent sensors. In contrast, when aggregated over the full 1995‚Äì2023 period, temporal data completeness is relatively spatially homogeneous across the lake.</p></li>
<li><p>At fixed locations, temporal gaps in satellite observations can substantially hinder the monitoring of temperature variability and bias aggregated metrics such as mean summer LSWT. In some applications, incorporating lower-quality observations may be warranted, provided that robust outlier detection is applied.</p></li>
</ul>
</div>
</section>
<section id="methodology">
<h2>üìã Methodology<a class="headerlink" href="#methodology" title="Link to this heading">#</a></h2>
<p>We structure the analysis in the following steps, which are detailed in the sections below:</p>
<p><strong><a class="reference internal" href="#satellite-satellite-lake-water-temperature-data-completeness-q01-section-1"><span class="std std-ref">1. Data request and download</span></a></strong></p>
<ul class="simple">
<li><p>We download satellite lake surface water temperature (LSWT) data for the summer months (July‚ÄìSeptember) over the period 1995‚Äì2023.</p></li>
</ul>
<p><strong><a class="reference internal" href="#satellite-satellite-lake-water-temperature-data-completeness-q01-section-2"><span class="std std-ref">2. Data preprocessing</span></a></strong></p>
<ul class="simple">
<li><p>We filter the dataset using lake identification masks and quality flags to retain both conservative (high-quality) and relaxed (low-to-high-quality) observations for Lake Superior.</p></li>
</ul>
<p><strong><a class="reference internal" href="#satellite-satellite-lake-water-temperature-data-completeness-q01-section-3"><span class="std std-ref">3. Spatial completeness analysis</span></a></strong></p>
<ul class="simple">
<li><p>To assess how spatial data completeness over Lake Superior evolves over time, we compute and plot the fraction of valid lake pixels for each summer season using both filtering strategies.</p></li>
<li><p>We relate changes in spatial completeness to the timeline of satellite instruments contributing to the dataset.</p></li>
</ul>
<p><strong><a class="reference internal" href="#satellite-satellite-lake-water-temperature-data-completeness-q01-section-4"><span class="std std-ref">4. Temporal completeness analysis</span></a></strong></p>
<ul class="simple">
<li><p>To examine how temporal data completeness varies across the lake, we compute the fraction of valid observations at each lake pixel over the full 1995‚Äì2023 period.</p></li>
<li><p>At locations corresponding to buoy sites, we compute annual mean summer LSWT from satellite data and compare these values with in situ buoy measurements to evaluate the impact of temporal gaps on aggregated metrics.</p></li>
<li><p>We compare results obtained with the conservative and relaxed filters and identify situations in which including lower-quality data may improve temporal coverage without substantially degrading data reliability.</p></li>
</ul>
</section>
<section id="analysis-and-results">
<h2>üìà Analysis and results<a class="headerlink" href="#analysis-and-results" title="Link to this heading">#</a></h2>
<section id="data-request-and-download">
<span id="satellite-satellite-lake-water-temperature-data-completeness-q01-section-1"></span><h3>1. Data request and download<a class="headerlink" href="#data-request-and-download" title="Link to this heading">#</a></h3>
<section id="import-packages">
<h4>Import packages<a class="headerlink" href="#import-packages" title="Link to this heading">#</a></h4>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">cartopy.crs</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">ccrs</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.cbook</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.colors</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mcolors</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.colors</span><span class="w"> </span><span class="kn">import</span> <span class="n">BoundaryNorm</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.patches</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mpatches</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.dates</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mdates</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">cartopy.mpl.ticker</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">cticker</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">xarray</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">xr</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">c3s_eqc_automatic_quality_control</span><span class="w"> </span><span class="kn">import</span> <span class="n">diagnostics</span><span class="p">,</span> <span class="n">download</span><span class="p">,</span> <span class="n">plot</span><span class="p">,</span> <span class="n">utils</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span><span class="o">,</span><span class="w"> </span><span class="nn">gzip</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tqdm</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">io</span><span class="w"> </span><span class="kn">import</span> <span class="n">StringIO</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">mean_squared_error</span>


<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s2">&quot;seaborn-v0_8-notebook&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
</div>
</section>
<section id="set-variables">
<h4>Set variables<a class="headerlink" href="#set-variables" title="Link to this heading">#</a></h4>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Time</span>
<span class="n">year_start</span> <span class="o">=</span> <span class="mi">1995</span>
<span class="n">year_stop</span> <span class="o">=</span> <span class="mi">2023</span>

<span class="c1"># Region</span>
<span class="n">lon_slice</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="o">-</span><span class="mf">92.10</span><span class="p">,</span> <span class="o">-</span><span class="mf">84.80</span><span class="p">)</span>
<span class="n">lat_slice</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="mf">46.30</span><span class="p">,</span> <span class="mf">49.00</span><span class="p">)</span>

<span class="c1"># Variable</span>
<span class="n">varname</span> <span class="o">=</span> <span class="s2">&quot;lake_surface_water_temperature&quot;</span>
</pre></div>
</div>
</div>
</details>
</div>
</section>
<section id="set-the-data-request">
<h4>Set the data request<a class="headerlink" href="#set-the-data-request" title="Link to this heading">#</a></h4>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">collection_id</span> <span class="o">=</span> <span class="s2">&quot;satellite-lake-water-temperature&quot;</span>
<span class="n">Requests</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">year_start</span><span class="p">,</span> <span class="n">year_stop</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
    <span class="n">Requests</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s2">&quot;variable&quot;</span><span class="p">:</span> <span class="s2">&quot;all&quot;</span><span class="p">,</span>
            <span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">)],</span>
            <span class="s2">&quot;month&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;07&quot;</span><span class="p">,</span> <span class="s2">&quot;08&quot;</span><span class="p">,</span> <span class="s2">&quot;09&quot;</span><span class="p">],</span>
            <span class="s2">&quot;day&quot;</span><span class="p">:</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">day</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">day</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">32</span><span class="p">)],</span>
            <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;4_5&quot;</span> <span class="k">if</span> <span class="n">year</span> <span class="o">&lt;</span> <span class="mi">2021</span> <span class="k">else</span> <span class="s2">&quot;4_5_2&quot;</span><span class="p">],</span>
        <span class="p">}</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
</details>
</div>
</section>
<section id="download-data">
<h4>Download data<a class="headerlink" href="#download-data" title="Link to this heading">#</a></h4>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ds</span> <span class="o">=</span> <span class="n">download</span><span class="o">.</span><span class="n">download_and_transform</span><span class="p">(</span>
    <span class="n">collection_id</span><span class="p">,</span>
    <span class="n">Requests</span><span class="p">,</span>
    <span class="n">transform_func</span><span class="o">=</span><span class="n">utils</span><span class="o">.</span><span class="n">regionalise</span><span class="p">,</span>
    <span class="n">transform_func_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;lon_slice&quot;</span><span class="p">:</span> <span class="n">lon_slice</span><span class="p">,</span> <span class="s2">&quot;lat_slice&quot;</span><span class="p">:</span> <span class="n">lat_slice</span><span class="p">},</span>
    <span class="n">chunks</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 29/29 [00:01&lt;00:00, 26.93it/s]
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="data-preprocessing">
<span id="satellite-satellite-lake-water-temperature-data-completeness-q01-section-2"></span><h3>2. Data preprocessing<a class="headerlink" href="#data-preprocessing" title="Link to this heading">#</a></h3>
<p>We download satellite lake surface temperature data and visualize the water masses over the region spanning 46.30‚Äì49.00¬∞N latitude and 92.10‚Äì84.80¬∞W longitude. In the dataset, Lake Superior is identified by ID number 2. The locations of the three NOAA buoys used for data comparison are also plotted.</p>
<section id="plot-lakeid">
<h4>Plot lakeid<a class="headerlink" href="#plot-lakeid" title="Link to this heading">#</a></h4>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lakeid_data</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;lakeid_CCI&#39;</span><span class="p">]</span>
<span class="n">lats</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;latitude&#39;</span><span class="p">]</span>
<span class="n">lons</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;longitude&#39;</span><span class="p">]</span>

<span class="n">unique_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">lakeid_data</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">lakeid_data</span><span class="o">.</span><span class="n">values</span><span class="p">)])</span>
<span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;tab10&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_ids</span><span class="p">))</span>

<span class="c1"># ------------------------------------------------------------------</span>
<span class="c1"># Buoy coordinates (lon, lat)</span>
<span class="n">buoy_coords</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;45006&quot;</span><span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mf">89.793</span><span class="p">,</span> <span class="mf">47.335</span><span class="p">),</span>
    <span class="s2">&quot;45004&quot;</span><span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mf">86.585</span><span class="p">,</span> <span class="mf">47.585</span><span class="p">),</span>
    <span class="s2">&quot;45001&quot;</span><span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mf">87.793</span><span class="p">,</span> <span class="mf">48.061</span><span class="p">),</span>
<span class="p">}</span>

<span class="c1"># ------------------------------------------------------------------</span>
<span class="c1"># Plot</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">(</span><span class="n">projection</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">())</span>

<span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span>
    <span class="n">lons</span><span class="p">,</span>
    <span class="n">lats</span><span class="p">,</span>
    <span class="n">lakeid_data</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
    <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
    <span class="n">shading</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
    <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">()</span>
<span class="p">)</span>

<span class="c1"># ------------------------------------------------------------------</span>
<span class="c1"># Plot buoys</span>
<span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">)</span> <span class="ow">in</span> <span class="n">buoy_coords</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
        <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span>
        <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="s1">&#39;C1&#39;</span><span class="p">,</span>
        <span class="n">markersize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
        <span class="n">markeredgewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">(),</span>
        <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span>
    <span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
        <span class="n">lon</span> <span class="o">+</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span>
        <span class="n">name</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="s1">&#39;C1&#39;</span><span class="p">,</span>
        <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
        <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">(),</span>
        <span class="n">zorder</span><span class="o">=</span><span class="mi">11</span>
    <span class="p">)</span>

<span class="c1"># ------------------------------------------------------------------</span>
<span class="c1"># Longitude / latitude ticks</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">92</span><span class="p">,</span> <span class="o">-</span><span class="mi">84</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">crs</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">())</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">46</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">crs</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">())</span>

<span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">cticker</span><span class="o">.</span><span class="n">LongitudeFormatter</span><span class="p">())</span>
<span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">cticker</span><span class="o">.</span><span class="n">LatitudeFormatter</span><span class="p">())</span>

<span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="c1"># ------------------------------------------------------------------</span>
<span class="c1"># Legend for lake IDs</span>
<span class="n">legend_handles</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">mpatches</span><span class="o">.</span><span class="n">Patch</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">cmap</span><span class="p">(</span><span class="n">i</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_ids</span><span class="p">)),</span> <span class="n">label</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">uid</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">uid</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">unique_ids</span><span class="p">)</span>
<span class="p">]</span>

<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span>
    <span class="n">handles</span><span class="o">=</span><span class="n">legend_handles</span><span class="p">,</span>
    <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper left&quot;</span><span class="p">,</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Lake ID CCI&quot;</span><span class="p">,</span>
    <span class="n">frameon</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;ID Identification for Lake Superior and Outliers&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../../_images/3bf6e7994177c0028ff772cef16a0aca5b2be3ec6d79dc126d9f1efcba90f421.png" src="../../_images/3bf6e7994177c0028ff772cef16a0aca5b2be3ec6d79dc126d9f1efcba90f421.png" />
</div>
</div>
<p><em>Figure 1 : Lake Superior identification in the dataset. Locations of the three NOAA-NBDC buoys used for data comparison are shown as orange crosses.</em></p>
<p>We construct a lake mask for the subsequent analyses, identifying a total of 4206 pixels associated with Lake Superior (Lake ID = 2).</p>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lake_mask</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;lakeid_CCI&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
<span class="n">lake_gridcell_count</span> <span class="o">=</span> <span class="n">lake_mask</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;latitude&quot;</span><span class="p">,</span> <span class="s2">&quot;longitude&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">values</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Number of pixels associated with Lake Superior:&#39;</span><span class="p">,</span><span class="n">lake_gridcell_count</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Number of pixels associated with Lake Superior: 4206
</pre></div>
</div>
</div>
</div>
</section>
<section id="data-filtering">
<h4>Data filtering<a class="headerlink" href="#data-filtering" title="Link to this heading">#</a></h4>
<p>The data are provided with ‚Äòquality flags‚Äô ranging from 0 to 5. Quality levels 4 and 5 reflect a higher degree of confidence in the validity of the satellite estimate. Users are advised to use the highest quality levels (4 and 5) in preference, unless they have specifically verified that lower quality levels are suitable for their application. Quality level 3 data, compared with in-situ data, may be acceptable to some users; however, they should be used with caution. Quality level 2 data is considered as the ‚Äòworst usable data‚Äô and should be thoroughly inspected if its use is strictly necessary (see section  4.2.4 of <a class="reference external" href="https://confluence.ecmwf.int/pages/viewpage.action?pageId=348800177" rel="noreferrer" target="_blank">PUGS</a> or section 3.4 of <a class="reference external" href="https://confluence.ecmwf.int/pages/viewpage.action?pageId=348800127#LSWTv4.5:AlgorithmTheoreticalBasisDocument(ATBD)-DeterminingQualityLevel" rel="noreferrer" target="_blank">ATBD</a>).</p>
<p>In the following analysis, we will use two quality filters:</p>
<ul class="simple">
<li><p>a <strong>conservative filter</strong> that retains data with quality levels 4 and 5 ;</p></li>
<li><p>a <strong>relaxed filter</strong> that retains data with quality levels 2, 3, 4, and 5.</p></li>
</ul>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Reindex using lakeids and min_quality_level</span>
<span class="n">lakeid</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;lakeid_CCI&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">),</span> <span class="n">dims</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;lakeid_CCI&quot;</span><span class="p">))</span>
    <span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="s2">&quot;lakeid_CCI&quot;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">min_quality_level</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="n">dims</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;min_quality_level&quot;</span><span class="p">))</span>
<span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s2">&quot;lakeid_CCI&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;lakeid_CCI&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">lakeid</span><span class="p">)</span>
<span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;lswt_quality_level&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">min_quality_level</span><span class="p">)</span>
<span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">lakeid_CCI</span><span class="o">=</span><span class="n">lakeid</span><span class="p">,</span> <span class="n">min_quality_level</span><span class="o">=</span><span class="n">min_quality_level</span><span class="p">)</span>

<span class="n">filtered_ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">lakeid_CCI</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">min_quality_level</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="n">unfiltered_ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">lakeid_CCI</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">min_quality_level</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
</div>
</section>
</section>
<section id="spatial-completeness-analysis">
<span id="satellite-satellite-lake-water-temperature-data-completeness-q01-section-3"></span><h3>3. Spatial completeness analysis<a class="headerlink" href="#spatial-completeness-analysis" title="Link to this heading">#</a></h3>
<p>To assess the temporal evolution of spatial data completeness over Lake Superior, we compute, for each time step, the fraction of lake pixels containing valid LSWT observations using both the conservative and relaxed quality filters. Results are plotted in <em>Figure 2</em>.</p>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">valid_percentage_time_series</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">lake_gridcell_count</span><span class="p">,</span> <span class="n">varname</span><span class="p">):</span>
    <span class="n">valid_percentage</span> <span class="o">=</span> <span class="p">(</span>
        <span class="mi">100</span>
        <span class="o">*</span> <span class="n">ds</span><span class="p">[</span><span class="n">varname</span><span class="p">]</span><span class="o">.</span><span class="n">notnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;latitude&quot;</span><span class="p">,</span> <span class="s2">&quot;longitude&quot;</span><span class="p">])</span>
        <span class="o">/</span> <span class="n">lake_gridcell_count</span>
    <span class="p">)</span>

    <span class="n">valid_percentage</span> <span class="o">=</span> <span class="n">valid_percentage</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span>
        <span class="n">month</span><span class="o">=</span><span class="n">valid_percentage</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span>
    <span class="p">)</span>

    <span class="n">valid_percentage</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;long_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Valid LSWT&quot;</span><span class="p">,</span>
        <span class="s2">&quot;units&quot;</span><span class="p">:</span> <span class="s2">&quot;%&quot;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">valid_percentage</span>

<span class="k">def</span><span class="w"> </span><span class="nf">valid_percentage_summer_by_year</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">lake_gridcell_count</span><span class="p">,</span> <span class="n">varname</span><span class="p">):</span>
    <span class="n">valid_percentage</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">ds</span><span class="p">[</span><span class="n">varname</span><span class="p">]</span><span class="o">.</span><span class="n">notnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;latitude&quot;</span><span class="p">,</span> <span class="s2">&quot;longitude&quot;</span><span class="p">])</span>
        <span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">ds</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">]))</span>
        <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;time.year&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="mi">100</span><span class="o">/</span> <span class="n">lake_gridcell_count</span>
    <span class="p">)</span>

    <span class="n">valid_percentage</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;long_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Mean valid LSWT percentage (JJA)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;units&quot;</span><span class="p">:</span> <span class="s2">&quot;%&quot;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">valid_percentage</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">vp_unfiltered_summer</span> <span class="o">=</span> <span class="n">valid_percentage_summer_by_year</span><span class="p">(</span>
    <span class="n">unfiltered_ds</span><span class="p">,</span> <span class="n">lake_gridcell_count</span><span class="p">,</span> <span class="n">varname</span>
<span class="p">)</span>

<span class="n">vp_filtered_summer</span> <span class="o">=</span> <span class="n">valid_percentage_summer_by_year</span><span class="p">(</span>
    <span class="n">filtered_ds</span><span class="p">,</span> <span class="n">lake_gridcell_count</span><span class="p">,</span> <span class="n">varname</span>
<span class="p">)</span>

<span class="n">valid_percentage_summer</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
    <span class="p">[</span><span class="n">vp_unfiltered_summer</span><span class="p">,</span> <span class="n">vp_filtered_summer</span><span class="p">],</span>
    <span class="n">dim</span><span class="o">=</span><span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">([</span><span class="s2">&quot;relaxed filter&quot;</span><span class="p">,</span> <span class="s2">&quot;conservative filter&quot;</span><span class="p">],</span> <span class="n">dims</span><span class="o">=</span><span class="s2">&quot;filter&quot;</span><span class="p">),</span>
<span class="p">)</span>

<span class="n">vp_unfiltered_ts</span> <span class="o">=</span> <span class="n">valid_percentage_time_series</span><span class="p">(</span>
    <span class="n">unfiltered_ds</span><span class="p">,</span> <span class="n">lake_gridcell_count</span><span class="p">,</span> <span class="n">varname</span>
<span class="p">)</span>

<span class="n">vp_filtered_ts</span> <span class="o">=</span> <span class="n">valid_percentage_time_series</span><span class="p">(</span>
    <span class="n">filtered_ds</span><span class="p">,</span> <span class="n">lake_gridcell_count</span><span class="p">,</span> <span class="n">varname</span>
<span class="p">)</span>

<span class="n">valid_percentage_ts</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
    <span class="p">[</span><span class="n">vp_unfiltered_ts</span><span class="p">,</span> <span class="n">vp_filtered_ts</span><span class="p">],</span>
    <span class="n">dim</span><span class="o">=</span><span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">([</span><span class="s2">&quot;realxed filter&quot;</span><span class="p">,</span> <span class="s2">&quot;conservative filter&quot;</span><span class="p">],</span> <span class="n">dims</span><span class="o">=</span><span class="s2">&quot;filter&quot;</span><span class="p">),</span>
<span class="p">)</span>

<span class="c1"># Convert year -&gt; datetime (e.g. July 1st of each year)</span>
<span class="n">summer_time</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span>
    <span class="n">valid_percentage_summer</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;-08-15&quot;</span>
<span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Summer (aggregated)</span>
<span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">valid_percentage_summer</span><span class="o">.</span><span class="n">filter</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
        <span class="n">summer_time</span><span class="p">,</span>
        <span class="n">valid_percentage_summer</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="nb">filter</span><span class="o">=</span><span class="n">f</span><span class="p">),</span>
        <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;s&quot;</span><span class="p">,</span>
        <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s2"> (summer mean)&quot;</span><span class="p">,</span>
    <span class="p">)</span>

<span class="c1"># Full time series</span>
<span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">valid_percentage_ts</span><span class="o">.</span><span class="n">filter</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
        <span class="n">valid_percentage_ts</span><span class="o">.</span><span class="n">time</span><span class="p">,</span>
        <span class="n">valid_percentage_ts</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="nb">filter</span><span class="o">=</span><span class="n">f</span><span class="p">),</span>
        <span class="n">s</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s2"> (daily)&quot;</span><span class="p">,</span>
    <span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Valid pixels (%)&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;LSWT data availability&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../../_images/67a9769850b68cf056d068b5d70dcd7306f4c6ec51be866d4632a56f696799c0.png" src="../../_images/67a9769850b68cf056d068b5d70dcd7306f4c6ec51be866d4632a56f696799c0.png" />
</div>
</div>
<p><em>Figure 2: Temporal evolution of spatial data completeness for Lake Superior. Dots indicate the fraction of valid LSWT pixels for each day, while squares show the average fraction over the summer months (July‚ÄìSeptember).</em></p>
<p>At any given date, spatial LSWT data completeness over Lake Superior can range from 0‚ÄØ% to nearly 100‚ÄØ%, even with the most recent satellite instruments (see <em>Figure 3</em>). When averaged over the summer months, however, data completeness generally improves over time as satellite instrumentation evolves. High-quality data (conservative filter, quality level ‚â•‚ÄØ4) completeness increases from less than 20‚ÄØ% before 2000 to approximately 40‚ÄØ% in recent years. Using a relaxed filter (quality level ‚â•‚ÄØ2) yields higher completeness, reaching around 60‚ÄØ% in recent summers, as fewer measurements are rejected. The marked increase in completeness around 2000 reflects the inclusion of MODIS observations from the Terra platform, whose wider swath allows more frequent observations of the same location. Similarly, the further increase around 2007 is associated with the incorporation of measurements from the AVHRR instruments (see <em>Figure 3</em>).</p>
<p><img alt="image.png" src="../../_images/e7a20759-c855-4da6-b79b-cec74596757f.png" /></p>
<p><em>Figure 3: Input data for the ESA CCI LAKES dataset (see Figure 1 from <a class="reference external" href="https://confluence.ecmwf.int/pages/viewpage.action?pageId=348800177" rel="noreferrer" target="_blank">PUGS</a>).</em></p>
</section>
<section id="temporal-completeness-analysis">
<span id="satellite-satellite-lake-water-temperature-data-completeness-q01-section-4"></span><h3>4. Temporal completeness analysis<a class="headerlink" href="#temporal-completeness-analysis" title="Link to this heading">#</a></h3>
<section id="temporal-completeness">
<h4>Temporal completeness<a class="headerlink" href="#temporal-completeness" title="Link to this heading">#</a></h4>
<p>To evaluate spatial variations in temporal data completeness over Lake Superior, we calculate, for each lake pixel, the fraction of valid observations across the full 1995‚Äì2023 period. The results for both conservative and relaxed filters are shown in Figure 4.</p>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># --------------------------------------------------</span>
<span class="c1"># Parameters</span>
<span class="c1"># --------------------------------------------------</span>
<span class="n">OUTSIDE_VALUE</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>  <span class="c1"># below colormap range for non-lake pixels</span>
<span class="n">bounds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">101</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>  <span class="c1"># 0‚Äì100 %</span>
<span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">viridis</span>
<span class="n">norm</span> <span class="o">=</span> <span class="n">BoundaryNorm</span><span class="p">(</span><span class="n">bounds</span><span class="p">,</span> <span class="n">cmap</span><span class="o">.</span><span class="n">N</span><span class="p">)</span>

<span class="n">cmap</span><span class="o">.</span><span class="n">set_under</span><span class="p">(</span><span class="s2">&quot;lightgray&quot;</span><span class="p">)</span>  <span class="c1"># outside lake</span>
<span class="n">cmap</span><span class="o">.</span><span class="n">set_bad</span><span class="p">(</span><span class="s2">&quot;white&quot;</span><span class="p">)</span>        <span class="c1"># lake but no valid data</span>

<span class="c1"># --------------------------------------------------</span>
<span class="c1"># Function to compute spatial valid percentage</span>
<span class="c1"># --------------------------------------------------</span>
<span class="k">def</span><span class="w"> </span><span class="nf">valid_percentage_spatial</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">varname</span><span class="p">,</span> <span class="n">lake_mask</span><span class="p">):</span>
    <span class="n">da</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="n">varname</span><span class="p">]</span>

    <span class="n">n_valid</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">notnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">)</span>
    <span class="n">n_total</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">sizes</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span>

    <span class="n">valid_pct</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">n_valid</span> <span class="o">/</span> <span class="n">n_total</span>
    <span class="n">valid_pct</span> <span class="o">=</span> <span class="n">valid_pct</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">lake_mask</span><span class="p">,</span> <span class="n">OUTSIDE_VALUE</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">valid_pct</span>

<span class="c1"># --------------------------------------------------</span>
<span class="c1"># Compute maps</span>
<span class="c1"># --------------------------------------------------</span>
<span class="n">valid_unfiltered</span> <span class="o">=</span> <span class="n">valid_percentage_spatial</span><span class="p">(</span><span class="n">unfiltered_ds</span><span class="p">,</span> <span class="n">varname</span><span class="p">,</span> <span class="n">lake_mask</span><span class="p">)</span>
<span class="n">valid_filtered</span>   <span class="o">=</span> <span class="n">valid_percentage_spatial</span><span class="p">(</span><span class="n">filtered_ds</span><span class="p">,</span> <span class="n">varname</span><span class="p">,</span> <span class="n">lake_mask</span><span class="p">)</span>

<span class="c1"># --------------------------------------------------</span>
<span class="c1"># Plot</span>
<span class="c1"># --------------------------------------------------</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
    <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
    <span class="n">subplot_kw</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;projection&quot;</span><span class="p">:</span> <span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">()},</span>
    <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span>
    <span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">titles</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Relaxed filter&quot;</span><span class="p">,</span> <span class="s2">&quot;Conservative filter&quot;</span><span class="p">]</span>
<span class="n">maps</span> <span class="o">=</span> <span class="p">[</span><span class="n">valid_unfiltered</span><span class="p">,</span> <span class="n">valid_filtered</span><span class="p">]</span>

<span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">da</span><span class="p">,</span> <span class="n">title</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">maps</span><span class="p">,</span> <span class="n">titles</span><span class="p">):</span>

    <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
        <span class="n">da</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
        <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">,</span>
        <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
        <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span>
        <span class="n">extent</span><span class="o">=</span><span class="p">[</span>
            <span class="nb">float</span><span class="p">(</span><span class="n">da</span><span class="o">.</span><span class="n">longitude</span><span class="o">.</span><span class="n">min</span><span class="p">()),</span>
            <span class="nb">float</span><span class="p">(</span><span class="n">da</span><span class="o">.</span><span class="n">longitude</span><span class="o">.</span><span class="n">max</span><span class="p">()),</span>
            <span class="nb">float</span><span class="p">(</span><span class="n">da</span><span class="o">.</span><span class="n">latitude</span><span class="o">.</span><span class="n">min</span><span class="p">()),</span>
            <span class="nb">float</span><span class="p">(</span><span class="n">da</span><span class="o">.</span><span class="n">latitude</span><span class="o">.</span><span class="n">max</span><span class="p">()),</span>
        <span class="p">],</span>
        <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">(),</span>
    <span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">coastlines</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>

    <span class="n">gl</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">gridlines</span><span class="p">(</span>
        <span class="n">draw_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
        <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">gl</span><span class="o">.</span><span class="n">top_labels</span> <span class="o">=</span> <span class="n">gl</span><span class="o">.</span><span class="n">right_labels</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1"># Remove left labels on right subplot</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">gridlines</span><span class="p">()</span><span class="o">.</span><span class="n">left_labels</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1"># Shared colorbar</span>
<span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span>
    <span class="n">im</span><span class="p">,</span>
    <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">,</span>
    <span class="n">shrink</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
    <span class="n">pad</span><span class="o">=</span><span class="mf">0.04</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s2">&quot;Valid observations (%)&quot;</span><span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span>
    <span class="s2">&quot;Lake Superior ‚Äî Percentage of Valid LSWT Observations (1995‚Äì2023)&quot;</span><span class="p">,</span>
    <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../../_images/0cc3c0a0dfa7b8bc40a2bbee2b9ff577fdeb388e8ff5a564712db16edc5e03df.png" src="../../_images/0cc3c0a0dfa7b8bc40a2bbee2b9ff577fdeb388e8ff5a564712db16edc5e03df.png" />
</div>
</div>
<p><em>Figure 4: Temporal completeness of LSWT data at each Lake Superior pixel over the full 1995‚Äì2023 satellite record.</em></p>
<p>When aggregated over the full 1995‚Äì2023 period, temporal data completeness is relatively homogeneous across Lake Superior. Areas of lower completeness are mainly found near land‚Äìwater boundaries, likely reflecting limitations of the water/no-water classification algorithm (see section 1.2 of <a class="reference external" href="https://confluence.ecmwf.int/pages/viewpage.action?pageId=348800177" rel="noreferrer" target="_blank">PUGS</a>).</p>
</section>
<section id="comparison-with-buoy-data">
<h4>Comparison with buoy data<a class="headerlink" href="#comparison-with-buoy-data" title="Link to this heading">#</a></h4>
<p>We compare the satellite data to in-situ buoy measurements to evaluate the impact of temporal gaps on aggregated metrics, such as the mean summer LSWT.</p>
<p>We download the buoy data from the NOAA National Data Buoy Center website <a class="reference external" href="https://www.ndbc.noaa.gov/" rel="noreferrer" target="_blank">[1]</a>, which provides data by station and year. We developed a Python script that automatically downloads the data for buoys 45001, 45004, and 45006 for the years 1995-2023, and combines them into a single, unified dataset.</p>
<p>We then avergae the buoy data over the summer months, and compare the results for each buoy to the summer mean temperature of the nearest satellite pixel corresponding to its location (see <em>Figure 5</em>).</p>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">parse_noaa_text</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parse NOAA stdmet text data.</span>

<span class="sd">    Args:</span>
<span class="sd">        text (str): Raw text from NOAA stdmet file.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: (columns_list, data_lines_str, header_line_index) or (None, None, None) if no header found.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>

    <span class="c1"># Find header: first non-empty line whose first token contains letters</span>
    <span class="n">header_idx</span><span class="p">,</span> <span class="n">header</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span>
        <span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="n">ln</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ln</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
         <span class="k">if</span> <span class="n">ln</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">ch</span><span class="o">.</span><span class="n">isalpha</span><span class="p">()</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">ln</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">])),</span>
        <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">header</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="n">cols</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="c1"># Extract data lines (non-empty, non-comment lines after header)</span>
    <span class="n">data_lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">ln</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span> <span class="k">for</span> <span class="n">ln</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">[</span><span class="n">header_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span> <span class="k">if</span> <span class="n">ln</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">ln</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">)]</span>

    <span class="k">return</span> <span class="n">cols</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_lines</span><span class="p">),</span> <span class="n">header_idx</span>


<span class="k">def</span><span class="w"> </span><span class="nf">load_noaa_year</span><span class="p">(</span><span class="n">station</span><span class="p">,</span> <span class="n">year</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">15</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load one year of NOAA stdmet data for a given station.</span>

<span class="sd">    Args:</span>
<span class="sd">        station (str): NOAA station ID.</span>
<span class="sd">        year (int): Year to load.</span>
<span class="sd">        timeout (int): Requests timeout in seconds.</span>

<span class="sd">    Returns:</span>
<span class="sd">        pd.DataFrame: Columns [&#39;datetime&#39;, &#39;WTMP&#39;], or None if no usable data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://www.ndbc.noaa.gov/data/historical/stdmet/</span><span class="si">{</span><span class="n">station</span><span class="si">}</span><span class="s2">h</span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2">.txt.gz&quot;</span>
    <span class="c1">#print(f&quot;Downloading {url} ...&quot;, end=&quot; &quot;)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="n">r</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
        <span class="n">raw</span> <span class="o">=</span> <span class="n">gzip</span><span class="o">.</span><span class="n">decompress</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">content</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;replace&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">tqdm</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> ‚Üí download error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">cols</span><span class="p">,</span> <span class="n">data_text</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">parse_noaa_text</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">cols</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">data_text</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; ‚Üí no usable header/data&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
            <span class="n">StringIO</span><span class="p">(</span><span class="n">data_text</span><span class="p">),</span>
            <span class="n">sep</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;\s+&quot;</span><span class="p">,</span>
            <span class="n">names</span><span class="o">=</span><span class="n">cols</span><span class="p">,</span>
            <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">na_values</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;MM&quot;</span><span class="p">,</span> <span class="s2">&quot;99.0&quot;</span><span class="p">,</span> <span class="s2">&quot;99&quot;</span><span class="p">,</span> <span class="s2">&quot;999&quot;</span><span class="p">,</span> <span class="s2">&quot;999.0&quot;</span><span class="p">,</span> <span class="s2">&quot;9999&quot;</span><span class="p">],</span>
            <span class="n">comment</span><span class="o">=</span><span class="s2">&quot;#&quot;</span><span class="p">,</span>
            <span class="n">engine</span><span class="o">=</span><span class="s2">&quot;python&quot;</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; ‚Üí pandas read error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>

    <span class="c1"># Ensure numeric columns for date/time</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;YY&quot;</span><span class="p">,</span> <span class="s2">&quot;YYYY&quot;</span><span class="p">,</span> <span class="s2">&quot;MM&quot;</span><span class="p">,</span> <span class="s2">&quot;DD&quot;</span><span class="p">,</span> <span class="s2">&quot;hh&quot;</span><span class="p">,</span> <span class="s2">&quot;mm&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">c</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;coerce&quot;</span><span class="p">)</span>

    <span class="c1"># Determine proper year</span>
    <span class="k">if</span> <span class="s2">&quot;YYYY&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;YEAR&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;YYYY&quot;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="s2">&quot;YY&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="ow">or</span> <span class="s2">&quot;#YY&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">yy_col</span> <span class="o">=</span> <span class="s2">&quot;YY&quot;</span> <span class="k">if</span> <span class="s2">&quot;YY&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">else</span> <span class="s2">&quot;#YY&quot;</span>
        <span class="c1"># If any 4-digit year present, treat as full year</span>
        <span class="k">if</span> <span class="n">df</span><span class="p">[</span><span class="n">yy_col</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">len</span><span class="p">()</span><span class="o">.</span><span class="n">gt</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;YEAR&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">yy_col</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># 2-digit year: &lt;50 -&gt; 2000s, &gt;=50 -&gt; 1900s</span>
            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;YEAR&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">yy_col</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">2000</span> <span class="o">+</span> <span class="n">x</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">50</span> <span class="k">else</span> <span class="mi">1900</span> <span class="o">+</span> <span class="n">x</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; ‚Üí no recognizable year column&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># Ensure minutes exist</span>
    <span class="k">if</span> <span class="s2">&quot;mm&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;mm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># Build datetime column</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span>
            <span class="nb">dict</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;YEAR&quot;</span><span class="p">],</span> <span class="n">month</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;MM&quot;</span><span class="p">],</span> <span class="n">day</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;DD&quot;</span><span class="p">],</span> <span class="n">hour</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;hh&quot;</span><span class="p">],</span> <span class="n">minute</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;mm&quot;</span><span class="p">]),</span>
            <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;coerce&quot;</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; ‚Üí datetime conversion error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># Process WTMP</span>
    <span class="k">if</span> <span class="s2">&quot;WTMP&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; ‚Üí WTMP column missing, skipping&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;WTMP&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;WTMP&quot;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;coerce&quot;</span><span class="p">)</span>

    <span class="c1"># Build output dataframe and filter invalid/extreme values</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;datetime&quot;</span><span class="p">:</span> <span class="n">dt</span><span class="p">,</span> <span class="s2">&quot;WTMP&quot;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;WTMP&quot;</span><span class="p">]})</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;datetime&quot;</span><span class="p">])</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="n">out</span><span class="p">[</span><span class="s2">&quot;WTMP&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">notna</span><span class="p">()]</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="p">[(</span><span class="n">out</span><span class="p">[</span><span class="s2">&quot;WTMP&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s2">&quot;WTMP&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">50</span><span class="p">)]</span>

    <span class="c1">#print(f&quot; ‚Üí loaded {len(out)} rows&quot;)</span>
    <span class="k">return</span> <span class="n">out</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">load_noaa_range</span><span class="p">(</span><span class="n">stations</span><span class="p">,</span> <span class="n">start_year</span><span class="o">=</span><span class="mi">1979</span><span class="p">,</span> <span class="n">end_year</span><span class="o">=</span><span class="mi">2024</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load NOAA data for multiple stations and years, with a progress bar.</span>
<span class="sd">    Returns a single DataFrame with a MultiIndex (station, datetime) and column &#39;WTMP&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">all_data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">total_steps</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">stations</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">end_year</span> <span class="o">-</span> <span class="n">start_year</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="n">total_steps</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Overall progress&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">pbar</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">station</span> <span class="ow">in</span> <span class="n">stations</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start_year</span><span class="p">,</span> <span class="n">end_year</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">pbar</span><span class="o">.</span><span class="n">set_postfix</span><span class="p">({</span><span class="s2">&quot;station&quot;</span><span class="p">:</span> <span class="n">station</span><span class="p">,</span> <span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="n">year</span><span class="p">})</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">load_noaa_year</span><span class="p">(</span><span class="n">station</span><span class="p">,</span> <span class="n">year</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;station&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">station</span>
                    <span class="n">all_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
                <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">all_data</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No data loaded for any station.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;WTMP&quot;</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_arrays</span><span class="p">([[],</span> <span class="p">[]],</span> <span class="n">names</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;station&quot;</span><span class="p">,</span> <span class="s2">&quot;datetime&quot;</span><span class="p">)))</span>

    <span class="c1"># Concatenate all data</span>
    <span class="n">full_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">all_data</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Set MultiIndex (station, datetime)</span>
    <span class="n">full_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s2">&quot;station&quot;</span><span class="p">,</span> <span class="s2">&quot;datetime&quot;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">full_df</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total rows loaded: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">full_df</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">full_df</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">stations</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;45001&quot;</span><span class="p">,</span><span class="s2">&quot;45004&quot;</span><span class="p">,</span><span class="s2">&quot;45006&quot;</span><span class="p">]</span>
<span class="n">buoy_data</span> <span class="o">=</span> <span class="n">load_noaa_range</span><span class="p">(</span><span class="n">stations</span><span class="p">,</span> <span class="mi">1995</span><span class="p">,</span> <span class="mi">2023</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Overall progress: 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 87/87 [01:09&lt;00:00,  1.25it/s, station=45006, year=2023]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Total rows loaded: 643188
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compare buoy, unfiltered, and filtered satellite summer mean temperatures</span>

<span class="n">summer_months</span> <span class="o">=</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">]</span>  <span class="c1"># JAS</span>

<span class="c1"># Prepare buoy summer mean</span>
<span class="n">buoy_df</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">buoy_data</span>
    <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
        <span class="n">year</span><span class="o">=</span><span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;datetime&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">,</span>
        <span class="n">month</span><span class="o">=</span><span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;datetime&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span><span class="p">,</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="n">summer_buoy</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">buoy_df</span>
    <span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">buoy_df</span><span class="p">[</span><span class="s2">&quot;month&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">summer_months</span><span class="p">)]</span>
    <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;station&quot;</span><span class="p">,</span> <span class="s2">&quot;year&quot;</span><span class="p">],</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="s2">&quot;WTMP&quot;</span><span class="p">]</span>
    <span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="p">)</span>

<span class="c1"># Extract nearest-neighbor satellite temperature at each buoy position</span>
<span class="n">sat_records_filtered</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">sat_records_unfiltered</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">station</span><span class="p">,</span> <span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">)</span> <span class="ow">in</span> <span class="n">buoy_coords</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

    <span class="c1"># --- Filtered ---</span>
    <span class="n">ts_filt</span> <span class="o">=</span> <span class="n">filtered_ds</span><span class="p">[</span><span class="n">varname</span><span class="p">]</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">longitude</span><span class="o">=</span><span class="n">lon</span><span class="p">,</span> <span class="n">latitude</span><span class="o">=</span><span class="n">lat</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="mf">273.15</span>
    <span class="n">ts_filt_summer</span> <span class="o">=</span> <span class="n">ts_filt</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">ts_filt</span><span class="p">[</span><span class="s2">&quot;time.month&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">summer_months</span><span class="p">))</span>
    <span class="n">ts_filt_mean</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">ts_filt_summer</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;time.year&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">to_dataframe</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;sat_filtered_WTMP&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="p">)</span>
    <span class="n">ts_filt_mean</span><span class="p">[</span><span class="s2">&quot;station&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">station</span>
    <span class="n">sat_records_filtered</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ts_filt_mean</span><span class="p">)</span>

    <span class="c1"># --- Unfiltered ---</span>
    <span class="n">ts_unfilt</span> <span class="o">=</span> <span class="n">unfiltered_ds</span><span class="p">[</span><span class="n">varname</span><span class="p">]</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">longitude</span><span class="o">=</span><span class="n">lon</span><span class="p">,</span> <span class="n">latitude</span><span class="o">=</span><span class="n">lat</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="mf">273.15</span>
    <span class="n">ts_unfilt_summer</span> <span class="o">=</span> <span class="n">ts_unfilt</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">ts_unfilt</span><span class="p">[</span><span class="s2">&quot;time.month&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">summer_months</span><span class="p">))</span>
    <span class="n">ts_unfilt_mean</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">ts_unfilt_summer</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;time.year&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">to_dataframe</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;sat_unfiltered_WTMP&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="p">)</span>
    <span class="n">ts_unfilt_mean</span><span class="p">[</span><span class="s2">&quot;station&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">station</span>
    <span class="n">sat_records_unfiltered</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ts_unfilt_mean</span><span class="p">)</span>

<span class="c1"># Concatenate all stations into reusable tables</span>
<span class="n">sat_summer_filtered</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">sat_records_filtered</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s2">&quot;station&quot;</span><span class="p">,</span> <span class="s2">&quot;year&quot;</span><span class="p">])</span>
<span class="n">sat_summer_unfiltered</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">sat_records_unfiltered</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s2">&quot;station&quot;</span><span class="p">,</span> <span class="s2">&quot;year&quot;</span><span class="p">])</span>

<span class="c1"># -------------------------</span>
<span class="c1"># Plot comparison</span>
<span class="c1"># -------------------------</span>
<span class="n">stations</span> <span class="o">=</span> <span class="n">summer_buoy</span><span class="p">[</span><span class="s2">&quot;station&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
    <span class="n">nrows</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">stations</span><span class="p">),</span>
    <span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">stations</span><span class="p">)),</span>
    <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>

<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">stations</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
    <span class="n">axes</span> <span class="o">=</span> <span class="p">[</span><span class="n">axes</span><span class="p">]</span>  <span class="c1"># Ensure axes is iterable</span>

<span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">st</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">stations</span><span class="p">):</span>

    <span class="n">s_buoy</span> <span class="o">=</span> <span class="n">summer_buoy</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">summer_buoy</span><span class="p">[</span><span class="s2">&quot;station&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">st</span><span class="p">]</span>
    <span class="n">s_sat_filt</span> <span class="o">=</span> <span class="n">sat_summer_filtered</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">sat_summer_filtered</span><span class="p">[</span><span class="s2">&quot;station&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">st</span><span class="p">]</span>
    <span class="n">s_sat_unfilt</span> <span class="o">=</span> <span class="n">sat_summer_unfiltered</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">sat_summer_unfiltered</span><span class="p">[</span><span class="s2">&quot;station&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">st</span><span class="p">]</span>

    <span class="c1"># Plot Buoy</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
        <span class="n">s_buoy</span><span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">],</span>
        <span class="n">s_buoy</span><span class="p">[</span><span class="s2">&quot;WTMP&quot;</span><span class="p">],</span>
        <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span>
        <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Buoy&quot;</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
        <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span>
    <span class="p">)</span>

    <span class="c1"># Plot Unfiltered Satellite</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
        <span class="n">s_sat_unfilt</span><span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">],</span>
        <span class="n">s_sat_unfilt</span><span class="p">[</span><span class="s2">&quot;sat_unfiltered_WTMP&quot;</span><span class="p">],</span>
        <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span>
        <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Satellite (relaxed filter)&quot;</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="s1">&#39;C0&#39;</span><span class="p">,</span>
        <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span>
    <span class="p">)</span>

    <span class="c1"># Plot Filtered Satellite</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
        <span class="n">s_sat_filt</span><span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">],</span>
        <span class="n">s_sat_filt</span><span class="p">[</span><span class="s2">&quot;sat_filtered_WTMP&quot;</span><span class="p">],</span>
        <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span>
        <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Satellite (conservative filter)&quot;</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="s1">&#39;C1&#39;</span><span class="p">,</span>
        <span class="n">zorder</span><span class="o">=</span><span class="mi">3</span>
    <span class="p">)</span>

    <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span> <span class="o">=</span> <span class="n">buoy_coords</span><span class="p">[</span><span class="n">st</span><span class="p">]</span>  <span class="c1"># get coordinates</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Buoy </span><span class="si">{</span><span class="n">st</span><span class="si">}</span><span class="s2"> (lat: </span><span class="si">{</span><span class="n">lat</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">¬∞, lon: </span><span class="si">{</span><span class="n">lon</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">¬∞)&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Mean summer LSWT ¬∞C&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">((</span><span class="mi">1995</span><span class="p">,</span><span class="mi">2023</span><span class="p">))</span>

<span class="n">axes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Year&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../../_images/bd6b9acc520a3b5b9892076ebe8f1b17e04571b210a607095ec6bfd12fbef96f.png" src="../../_images/bd6b9acc520a3b5b9892076ebe8f1b17e04571b210a607095ec6bfd12fbef96f.png" />
</div>
</div>
<p><em>Figure 5: Mean summer LSWT for three Lake Superior buoys, compared to the mean summer LSWT from satellite data at the nearest pixel locations.</em></p>
<p>We observe that mean summer LSWT values derived from the satellite data are generally close to the buoy measurements, regardless of the quality filter applied. In several cases, the mean LSWT computed using the relaxed filter aligns more closely with the buoy mean than the conservative filter, for instance in 2016 for all three buoys. To quantify differences in performance between the two quality filters, we calculate the mean bias, mean absolute error (MAE), and root mean square error (RMSE) relative to the buoy observations.</p>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">compute_sst_validation_metrics</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute satellite-vs-buoy SST validation metrics.</span>

<span class="sd">    Expects columns: [&#39;station&#39;, &#39;year&#39;, &#39;buoy&#39;, &#39;sat&#39;].</span>

<span class="sd">    Returns:</span>
<span class="sd">        pd.DataFrame with per-station metrics and a final &#39;ALL&#39; row</span>
<span class="sd">        containing overall metrics.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># ---- Helper to compute metrics for any subset ----</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">metrics</span><span class="p">(</span><span class="n">sub</span><span class="p">):</span>
        <span class="n">sat</span> <span class="o">=</span> <span class="n">sub</span><span class="p">[</span><span class="s2">&quot;sat&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">buoy</span> <span class="o">=</span> <span class="n">sub</span><span class="p">[</span><span class="s2">&quot;buoy&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="n">sat</span> <span class="o">-</span> <span class="n">buoy</span>

        <span class="n">bias</span> <span class="o">=</span> <span class="n">diff</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

        <span class="n">mae</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">diff</span><span class="p">))</span>
        <span class="n">rmse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">buoy</span><span class="p">,</span> <span class="n">sat</span><span class="p">))</span>



        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;n_samples&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">sub</span><span class="p">),</span>
            <span class="s2">&quot;bias&quot;</span><span class="p">:</span> <span class="n">bias</span><span class="p">,</span>
            <span class="s2">&quot;MAE&quot;</span><span class="p">:</span> <span class="n">mae</span><span class="p">,</span>
            <span class="s2">&quot;RMSE&quot;</span><span class="p">:</span> <span class="n">rmse</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="c1"># ---- Per-station metrics ----</span>
    <span class="k">for</span> <span class="n">st</span><span class="p">,</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;station&quot;</span><span class="p">):</span>
        <span class="n">row</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;station&quot;</span><span class="p">:</span> <span class="n">st</span><span class="p">}</span>
        <span class="n">row</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">metrics</span><span class="p">(</span><span class="n">sub</span><span class="p">))</span>
        <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

    <span class="c1"># ---- Overall metrics (all stations pooled) ----</span>
    <span class="n">overall</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;station&quot;</span><span class="p">:</span> <span class="s2">&quot;ALL&quot;</span><span class="p">}</span>
    <span class="n">overall</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">metrics</span><span class="p">(</span><span class="n">df</span><span class="p">))</span>
    <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">overall</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># -------------------------------</span>
<span class="c1"># Prepare merged dataframes for metrics</span>
<span class="c1"># -------------------------------</span>

<span class="c1"># 1. Filtered satellite</span>
<span class="n">df_diff_filtered</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">summer_buoy</span>
    <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;WTMP&quot;</span><span class="p">:</span> <span class="s2">&quot;buoy&quot;</span><span class="p">})</span>
    <span class="o">.</span><span class="n">merge</span><span class="p">(</span>
        <span class="n">sat_summer_filtered</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;sat_filtered_WTMP&quot;</span><span class="p">:</span> <span class="s2">&quot;sat&quot;</span><span class="p">}),</span>
        <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;station&quot;</span><span class="p">,</span> <span class="s2">&quot;year&quot;</span><span class="p">],</span>
        <span class="n">how</span><span class="o">=</span><span class="s2">&quot;inner&quot;</span><span class="p">,</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="n">metrics_filtered</span> <span class="o">=</span> <span class="n">compute_sst_validation_metrics</span><span class="p">(</span><span class="n">df_diff_filtered</span><span class="p">)</span>
<span class="n">metrics_filtered</span><span class="p">[</span><span class="s2">&quot;filter&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;conservative&quot;</span>

<span class="c1"># 2. Unfiltered satellite</span>
<span class="n">df_diff_unfiltered</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">summer_buoy</span>
    <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;WTMP&quot;</span><span class="p">:</span> <span class="s2">&quot;buoy&quot;</span><span class="p">})</span>
    <span class="o">.</span><span class="n">merge</span><span class="p">(</span>
        <span class="n">sat_summer_unfiltered</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;sat_unfiltered_WTMP&quot;</span><span class="p">:</span> <span class="s2">&quot;sat&quot;</span><span class="p">}),</span>
        <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;station&quot;</span><span class="p">,</span> <span class="s2">&quot;year&quot;</span><span class="p">],</span>
        <span class="n">how</span><span class="o">=</span><span class="s2">&quot;inner&quot;</span><span class="p">,</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="n">metrics_unfiltered</span> <span class="o">=</span> <span class="n">compute_sst_validation_metrics</span><span class="p">(</span><span class="n">df_diff_unfiltered</span><span class="p">)</span>
<span class="n">metrics_unfiltered</span><span class="p">[</span><span class="s2">&quot;filter&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;relaxed&quot;</span>

<span class="c1"># 3. Combine metrics into single table</span>
<span class="n">metrics_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">metrics_filtered</span><span class="p">,</span> <span class="n">metrics_unfiltered</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">float_format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span>

<span class="n">display</span><span class="p">(</span><span class="n">metrics_df</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>station</th>
      <th>n_samples</th>
      <th>bias</th>
      <th>MAE</th>
      <th>RMSE</th>
      <th>filter</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>45001</td>
      <td>29</td>
      <td>0.32</td>
      <td>1.23</td>
      <td>1.88</td>
      <td>conservative</td>
    </tr>
    <tr>
      <th>1</th>
      <td>45004</td>
      <td>28</td>
      <td>-0.12</td>
      <td>1.20</td>
      <td>1.58</td>
      <td>conservative</td>
    </tr>
    <tr>
      <th>2</th>
      <td>45006</td>
      <td>28</td>
      <td>0.21</td>
      <td>0.95</td>
      <td>1.18</td>
      <td>conservative</td>
    </tr>
    <tr>
      <th>3</th>
      <td>ALL</td>
      <td>85</td>
      <td>0.14</td>
      <td>1.13</td>
      <td>1.58</td>
      <td>conservative</td>
    </tr>
    <tr>
      <th>4</th>
      <td>45001</td>
      <td>29</td>
      <td>0.13</td>
      <td>0.95</td>
      <td>1.67</td>
      <td>relaxed</td>
    </tr>
    <tr>
      <th>5</th>
      <td>45004</td>
      <td>28</td>
      <td>-0.26</td>
      <td>0.86</td>
      <td>1.10</td>
      <td>relaxed</td>
    </tr>
    <tr>
      <th>6</th>
      <td>45006</td>
      <td>28</td>
      <td>-0.03</td>
      <td>0.58</td>
      <td>0.72</td>
      <td>relaxed</td>
    </tr>
    <tr>
      <th>7</th>
      <td>ALL</td>
      <td>85</td>
      <td>-0.05</td>
      <td>0.80</td>
      <td>1.23</td>
      <td>relaxed</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Overall,the conservative high-quality satellite data show a small warm bias of 0.14‚ÄØ¬∞C relative to the mean summer LSWT from buoy measurements. The corresponding MAE and RMSE are relatively large, at 1.13‚ÄØ¬∞C and 1.58‚ÄØ¬∞C, respectively. In contrast, the relaxed lower-quality data perform better across all metrics, with a slight cool bias of ‚àí0.05‚ÄØ¬∞C, an MAE of 0.80‚ÄØ¬∞C, and an RMSE of 1.23‚ÄØ¬∞C.</p>
<p>To explore this further, we examine summer 2016 for buoy 45001 (see <em>Figure 6</em>). Only two high-quality satellite observations are available between late July and mid-August, a particularly warm period, whereas more than a dozen lower-quality observations are present throughout this interval. Despite their lower quality flag, these data closely match the buoy record and explain why the mean summer LSWT computed using the relaxed filter is higher than that from the conservative filter and more representative of the ‚Äútrue‚Äù mean indicated by the buoy measurements.</p>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># --------------------------------------------------</span>
<span class="c1"># User inputs</span>
<span class="c1"># --------------------------------------------------</span>
<span class="n">year</span> <span class="o">=</span> <span class="mi">2016</span>
<span class="n">station</span> <span class="o">=</span> <span class="s2">&quot;45001&quot;</span>
<span class="n">summer_months</span> <span class="o">=</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">]</span>

<span class="c1"># Station coordinates</span>
<span class="n">lon_gridcell</span><span class="p">,</span> <span class="n">lat_gridcell</span> <span class="o">=</span> <span class="n">buoy_coords</span><span class="p">[</span><span class="n">station</span><span class="p">]</span>

<span class="c1"># --------------------------------------------------</span>
<span class="c1"># 1. All summer points for the station/year</span>
<span class="c1"># --------------------------------------------------</span>
<span class="c1"># Buoy: all summer points</span>
<span class="n">df_buoy_all</span> <span class="o">=</span> <span class="n">buoy_data</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">df_buoy_all</span> <span class="o">=</span> <span class="n">df_buoy_all</span><span class="p">[</span>
    <span class="p">(</span><span class="n">df_buoy_all</span><span class="p">[</span><span class="s1">&#39;station&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">station</span><span class="p">)</span> <span class="o">&amp;</span>
    <span class="p">(</span><span class="n">df_buoy_all</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">year</span><span class="p">)</span> <span class="o">&amp;</span>
    <span class="p">(</span><span class="n">df_buoy_all</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">summer_months</span><span class="p">))</span>
<span class="p">]</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;datetime&#39;</span><span class="p">)</span>

<span class="c1"># Satellite: unfiltered</span>
<span class="n">ts_sat_unfiltered</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">unfiltered_ds</span><span class="p">[</span><span class="n">varname</span><span class="p">]</span>
    <span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">latitude</span><span class="o">=</span><span class="n">lat_gridcell</span><span class="p">,</span> <span class="n">longitude</span><span class="o">=</span><span class="n">lon_gridcell</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">unfiltered_ds</span><span class="p">[</span><span class="s1">&#39;time.year&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">year</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">ts_sat_unfiltered</span> <span class="o">=</span> <span class="n">ts_sat_unfiltered</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">ts_sat_unfiltered</span><span class="p">[</span><span class="s1">&#39;time.month&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">summer_months</span><span class="p">))</span> <span class="o">-</span> <span class="mf">273.15</span>

<span class="c1"># Satellite: filtered</span>
<span class="n">ts_sat_filtered</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">filtered_ds</span><span class="p">[</span><span class="n">varname</span><span class="p">]</span>
    <span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">latitude</span><span class="o">=</span><span class="n">lat_gridcell</span><span class="p">,</span> <span class="n">longitude</span><span class="o">=</span><span class="n">lon_gridcell</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">filtered_ds</span><span class="p">[</span><span class="s1">&#39;time.year&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">year</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">ts_sat_filtered</span> <span class="o">=</span> <span class="n">ts_sat_filtered</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">ts_sat_filtered</span><span class="p">[</span><span class="s1">&#39;time.month&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">summer_months</span><span class="p">))</span> <span class="o">-</span> <span class="mf">273.15</span>

<span class="c1"># Means</span>
<span class="n">mean_buoy</span> <span class="o">=</span> <span class="n">df_buoy_all</span><span class="p">[</span><span class="s1">&#39;WTMP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">mean_sat_unfiltered</span> <span class="o">=</span> <span class="n">ts_sat_unfiltered</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>
<span class="n">mean_sat_filtered</span> <span class="o">=</span> <span class="n">ts_sat_filtered</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>

<span class="c1"># --------------------------------------------------</span>
<span class="c1"># Shared y-axis limits</span>
<span class="c1"># --------------------------------------------------</span>
<span class="n">ymin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">df_buoy_all</span><span class="p">[</span><span class="s1">&#39;WTMP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">ts_sat_unfiltered</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">compute</span><span class="p">(),</span> <span class="n">ts_sat_filtered</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">compute</span><span class="p">())</span>
<span class="n">ymax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">df_buoy_all</span><span class="p">[</span><span class="s1">&#39;WTMP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">ts_sat_unfiltered</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">compute</span><span class="p">(),</span> <span class="n">ts_sat_filtered</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">compute</span><span class="p">())</span>
<span class="n">pad</span> <span class="o">=</span> <span class="mf">0.5</span>
<span class="n">ylim</span> <span class="o">=</span> <span class="p">(</span><span class="n">ymin</span> <span class="o">-</span> <span class="n">pad</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">+</span> <span class="n">pad</span><span class="p">)</span>

<span class="c1"># --------------------------------------------------</span>
<span class="c1"># Plot</span>
<span class="c1"># --------------------------------------------------</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

<span class="c1"># ---- Date formatting ----</span>
<span class="n">locator</span> <span class="o">=</span> <span class="n">mdates</span><span class="o">.</span><span class="n">MonthLocator</span><span class="p">()</span>
<span class="n">formatter</span> <span class="o">=</span> <span class="n">mdates</span><span class="o">.</span><span class="n">DateFormatter</span><span class="p">(</span><span class="s2">&quot;%b </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">locator</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2">-07-01&quot;</span><span class="p">),</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2">-09-30&quot;</span><span class="p">))</span>

<span class="c1"># ---- Scatter plots ----</span>
<span class="c1"># 1. Buoy points (background)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">df_buoy_all</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df_buoy_all</span><span class="p">[</span><span class="s1">&#39;WTMP&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Buoy&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="c1"># 2. Unfiltered satellite points</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">ts_sat_unfiltered</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">ts_sat_unfiltered</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;C0&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Satellite (relaxed filter)&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="c1"># 3. Filtered satellite points (on top)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">ts_sat_filtered</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">ts_sat_filtered</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;C1&#39;</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Satellite (conservative filter)&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

<span class="c1"># ---- Mean lines ----</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">mean_buoy</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Buoy Mean (</span><span class="si">{</span><span class="n">mean_buoy</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> ¬∞C)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">mean_sat_unfiltered</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;C0&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Satellite relaxed filter Mean (</span><span class="si">{</span><span class="n">mean_sat_unfiltered</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> ¬∞C)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">mean_sat_filtered</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;C1&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Satellite conservative filter Mean (</span><span class="si">{</span><span class="n">mean_sat_filtered</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> ¬∞C)&#39;</span><span class="p">)</span>

<span class="c1"># ---- Labels, grid, legend ----</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">station</span><span class="si">}</span><span class="s2"> ‚Äî Summer </span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2"> (All points)&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Temperature (¬∞C)&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Date&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower right&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../../_images/9ba336e160e1a070e638f32a4d86f3fea5336f5cda5ec9c8e2c73370e9554104.png" src="../../_images/9ba336e160e1a070e638f32a4d86f3fea5336f5cda5ec9c8e2c73370e9554104.png" />
</div>
</div>
<p><em>Figure 6: Comparison of buoy and satellite LSWT measurements for summer 2016 at the location of buoy 45001.</em></p>
<p>In general, including lower-quality observations increases temporal coverage, which can improve the estimation of aggregated quantities such as the mean summer LSWT. However, this comes with a trade-off: lower-quality data are more likely to include measurements that do not accurately represent true surface temperatures. In particular, cloud contamination can introduce spurious cold outliers that bias aggregated metrics. As a result, using relaxed quality filters can be advantageous during periods of sparse high-quality coverage, but it requires careful outlier screening to preserve the reliability of derived statistics.</p>
<p>To quantify the occurrence of spurious satellite measurements for both high- and low-quality data at buoy locations, we perform a direct comparison with the in-situ observations. Specifically, each satellite observation is paired with the nearest buoy measurement in time, provided the time difference is less than a specified tolerance (1 hour). If the absolute temperature difference exceeds 2 ¬∞C, the satellite observation is classified as an outlier. <em>Figure 7</em> shows, for each summer, the fraction of outliers relative to the total number of satellite observations obtained using the conservative and relaxed quality filters.</p>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">get_matched_buoy_sat</span><span class="p">(</span><span class="n">buoy_data</span><span class="p">,</span> <span class="n">filtered_ds</span><span class="p">,</span> <span class="n">varname</span><span class="p">,</span> <span class="n">buoy_coords</span><span class="p">,</span>
                          <span class="n">summer_months</span><span class="o">=</span><span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">],</span> <span class="n">tolerance</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="s1">&#39;12h&#39;</span><span class="p">)):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Match buoy and satellite time series by timestamp within a tolerance for multiple stations.</span>

<span class="sd">    Args:</span>
<span class="sd">        buoy_data (pd.DataFrame): Buoy data with MultiIndex (station, datetime)</span>
<span class="sd">        filtered_ds (xarray.DataArray): Satellite data (Kelvin)</span>
<span class="sd">        varname (str): Name of variable in filtered_ds</span>
<span class="sd">        buoy_coords (dict): station -&gt; (lat, lon)</span>
<span class="sd">        summer_months (list): List of summer months to consider</span>
<span class="sd">        tolerance (pd.Timedelta): Maximum allowed time difference for matching</span>

<span class="sd">    Returns:</span>
<span class="sd">        pd.DataFrame: Long-form DataFrame with columns</span>
<span class="sd">                      [&#39;station&#39;, &#39;time&#39;, &#39;buoy&#39;, &#39;sat&#39;]</span>
<span class="sd">                      containing matched values for each station/time.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">records</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Flatten buoy data and add year/month</span>
    <span class="n">df_buoy</span> <span class="o">=</span> <span class="n">buoy_data</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="n">df_buoy</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_buoy</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span>
    <span class="n">df_buoy</span><span class="p">[</span><span class="s1">&#39;month&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_buoy</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span>

    <span class="n">years</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">df_buoy</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>

    <span class="k">for</span> <span class="n">st</span><span class="p">,</span> <span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">)</span> <span class="ow">in</span> <span class="n">buoy_coords</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="c1"># Satellite at buoy location</span>
        <span class="n">ts_sat</span> <span class="o">=</span> <span class="n">filtered_ds</span><span class="p">[</span><span class="n">varname</span><span class="p">]</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">latitude</span><span class="o">=</span><span class="n">lat</span><span class="p">,</span> <span class="n">longitude</span><span class="o">=</span><span class="n">lon</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="mf">273.15</span>
        <span class="n">df_sat</span> <span class="o">=</span> <span class="n">ts_sat</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;sat&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">df_sat</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_sat</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span>
        <span class="n">df_sat</span><span class="p">[</span><span class="s1">&#39;month&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_sat</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span>
        <span class="n">df_sat_summer</span> <span class="o">=</span> <span class="n">df_sat</span><span class="p">[</span><span class="n">df_sat</span><span class="p">[</span><span class="s1">&#39;month&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">summer_months</span><span class="p">)]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>

        <span class="c1"># Buoy summer series</span>
        <span class="n">df_buoy_st</span> <span class="o">=</span> <span class="n">df_buoy</span><span class="p">[(</span><span class="n">df_buoy</span><span class="p">[</span><span class="s1">&#39;station&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">st</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df_buoy</span><span class="p">[</span><span class="s1">&#39;month&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">summer_months</span><span class="p">))]</span>
        <span class="n">df_buoy_st</span> <span class="o">=</span> <span class="n">df_buoy_st</span><span class="p">[[</span><span class="s1">&#39;datetime&#39;</span><span class="p">,</span> <span class="s1">&#39;WTMP&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;datetime&#39;</span><span class="p">)</span>

        <span class="c1"># Match satellite and buoy points year by year</span>
        <span class="k">for</span> <span class="n">yr</span> <span class="ow">in</span> <span class="n">years</span><span class="p">:</span>
            <span class="n">df_sat_year</span> <span class="o">=</span> <span class="n">df_sat_summer</span><span class="p">[</span><span class="n">df_sat_summer</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">yr</span><span class="p">]</span>
            <span class="n">df_buoy_year</span> <span class="o">=</span> <span class="n">df_buoy_st</span><span class="p">[</span><span class="n">df_buoy_st</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">yr</span><span class="p">]</span>
           
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_sat_year</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_buoy_year</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">matched</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge_asof</span><span class="p">(</span>
                    <span class="n">df_sat_year</span><span class="p">,</span>
                    <span class="n">df_buoy_year</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;datetime&#39;</span><span class="p">:</span> <span class="s1">&#39;time&#39;</span><span class="p">}),</span>
                    <span class="n">on</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">,</span>
                    <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">,</span>
                    <span class="n">tolerance</span><span class="o">=</span><span class="n">tolerance</span>
                <span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

                <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">matched</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                    <span class="n">records</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s1">&#39;station&#39;</span><span class="p">:</span> <span class="n">st</span><span class="p">,</span>
                        <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">],</span>
                        <span class="s1">&#39;buoy&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;WTMP&#39;</span><span class="p">],</span>
                        <span class="s1">&#39;sat&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;sat&#39;</span><span class="p">]</span>
                    <span class="p">})</span>
        
    <span class="n">df_matched</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">records</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df_matched</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_matched</span> <span class="o">=</span> <span class="n">get_matched_buoy_sat</span><span class="p">(</span>
    <span class="n">buoy_data</span><span class="o">=</span><span class="n">buoy_data</span><span class="p">,</span>
    <span class="n">filtered_ds</span><span class="o">=</span><span class="n">filtered_ds</span><span class="p">,</span>
    <span class="n">varname</span><span class="o">=</span><span class="n">varname</span><span class="p">,</span>
    <span class="n">buoy_coords</span><span class="o">=</span><span class="n">buoy_coords</span><span class="p">,</span>
    <span class="n">summer_months</span><span class="o">=</span><span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">],</span>
    <span class="n">tolerance</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="s1">&#39;1h&#39;</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">df_matched_unfiltered</span> <span class="o">=</span> <span class="n">get_matched_buoy_sat</span><span class="p">(</span>
    <span class="n">buoy_data</span><span class="o">=</span><span class="n">buoy_data</span><span class="p">,</span>
    <span class="n">filtered_ds</span><span class="o">=</span><span class="n">unfiltered_ds</span><span class="p">,</span>
    <span class="n">varname</span><span class="o">=</span><span class="n">varname</span><span class="p">,</span>
    <span class="n">buoy_coords</span><span class="o">=</span><span class="n">buoy_coords</span><span class="p">,</span>
    <span class="n">summer_months</span><span class="o">=</span><span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">],</span>
    <span class="n">tolerance</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="s1">&#39;1h&#39;</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># -------------------------------</span>
<span class="c1"># Parameters</span>
<span class="c1"># -------------------------------</span>
<span class="n">deltaT</span> <span class="o">=</span> <span class="mf">2.0</span>  <span class="c1"># ¬∞C difference to define an outlier</span>
<span class="n">stations</span> <span class="o">=</span> <span class="n">df_matched</span><span class="p">[</span><span class="s1">&#39;station&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

<span class="c1"># -------------------------------</span>
<span class="c1"># Function to compute fraction of outliers per year</span>
<span class="c1"># -------------------------------</span>
<span class="k">def</span><span class="w"> </span><span class="nf">compute_outlier_fraction</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">deltaT</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;outlier&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;sat&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;buoy&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">deltaT</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span>
    <span class="n">summary</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;station&#39;</span><span class="p">,</span> <span class="s1">&#39;year&#39;</span><span class="p">])</span>
        <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">n_outliers</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;outlier&#39;</span><span class="p">,</span> <span class="s1">&#39;sum&#39;</span><span class="p">),</span>
             <span class="n">n_total</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;outlier&#39;</span><span class="p">,</span> <span class="s1">&#39;count&#39;</span><span class="p">))</span>
        <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="p">)</span>
    <span class="n">summary</span><span class="p">[</span><span class="s1">&#39;fraction_outliers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">summary</span><span class="p">[</span><span class="s1">&#39;n_outliers&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">summary</span><span class="p">[</span><span class="s1">&#39;n_total&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">summary</span>

<span class="n">frac_outliers_filtered</span> <span class="o">=</span> <span class="n">compute_outlier_fraction</span><span class="p">(</span><span class="n">df_matched</span><span class="p">,</span> <span class="n">deltaT</span><span class="o">=</span><span class="n">deltaT</span><span class="p">)</span>
<span class="n">frac_outliers_unfiltered</span> <span class="o">=</span> <span class="n">compute_outlier_fraction</span><span class="p">(</span><span class="n">df_matched_unfiltered</span><span class="p">,</span> <span class="n">deltaT</span><span class="o">=</span><span class="n">deltaT</span><span class="p">)</span>

<span class="c1"># -------------------------------</span>
<span class="c1"># Plot fraction of outliers per station</span>
<span class="c1"># -------------------------------</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">stations</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">stations</span><span class="p">)),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">stations</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
    <span class="n">axes</span> <span class="o">=</span> <span class="p">[</span><span class="n">axes</span><span class="p">]</span>  <span class="c1"># ensure iterable</span>

<span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">st</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">stations</span><span class="p">):</span>
    <span class="n">df_f</span> <span class="o">=</span> <span class="n">frac_outliers_filtered</span><span class="p">[</span><span class="n">frac_outliers_filtered</span><span class="p">[</span><span class="s1">&#39;station&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">st</span><span class="p">]</span>
    <span class="n">df_u</span> <span class="o">=</span> <span class="n">frac_outliers_unfiltered</span><span class="p">[</span><span class="n">frac_outliers_unfiltered</span><span class="p">[</span><span class="s1">&#39;station&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">st</span><span class="p">]</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_u</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">],</span> <span class="n">df_u</span><span class="p">[</span><span class="s1">&#39;fraction_outliers&#39;</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;C1&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Relaxed filter&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_f</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">],</span> <span class="n">df_f</span><span class="p">[</span><span class="s1">&#39;fraction_outliers&#39;</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;C0&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Conservative filter&#39;</span><span class="p">)</span>

    <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span> <span class="o">=</span> <span class="n">buoy_coords</span><span class="p">[</span><span class="n">st</span><span class="p">]</span>  <span class="c1"># get coordinates</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Buoy </span><span class="si">{</span><span class="n">st</span><span class="si">}</span><span class="s2"> (lat: </span><span class="si">{</span><span class="n">lat</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">¬∞, lon: </span><span class="si">{</span><span class="n">lon</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">¬∞)&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Fraction of outliers&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">axes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Year&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../../_images/6504f064e727f4cfec000a8f6aabe78bf46ed68fb9c25f6de45cde8e587dd4f6.png" src="../../_images/6504f064e727f4cfec000a8f6aabe78bf46ed68fb9c25f6de45cde8e587dd4f6.png" />
</div>
</div>
<p><em>Figure 7: Fraction of satellite LSWT observations classified as outliers at buoy locations for each summer, shown separately for the conservative (quality level ‚â• 4) and relaxed (quality level ‚â• 2) filters. Outliers are defined as satellite observations differing by more than 2 ¬∞C from the nearest-in-time buoy measurement (within a 1-hour tolerance)</em></p>
<p>We find that, for most years, the fraction of outliers associated with the relaxed filter is not substantially higher than that of the conservative filter. This explains why, in this specific case, using a relaxed quality filter yields more accurate estimates of the mean summer LSWT for Lake Superior than a conservative filter. However, this result may not generalize to other lakes, and users should evaluate whether including lower-quality data is appropriate for their application. In practice, outliers can be identified using statistical methods applied directly to the satellite time series, without relying on in-situ observations.</p>
</section>
</section>
</section>
<section id="i-if-you-want-to-know-more">
<h2>‚ÑπÔ∏è If you want to know more<a class="headerlink" href="#i-if-you-want-to-know-more" title="Link to this heading">#</a></h2>
<section id="key-resources">
<h3>Key resources<a class="headerlink" href="#key-resources" title="Link to this heading">#</a></h3>
<p>Dataset documentation:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://confluence.ecmwf.int/pages/viewpage.action?pageId=348800127#LSWTv4.5:AlgorithmTheoreticalBasisDocument(ATBD)-DeterminingQualityLevel" rel="noreferrer" target="_blank">ATBD</a>: Algorithm Theoretical Basis Document (ATBD)</p></li>
<li><p><a class="reference external" href="https://confluence.ecmwf.int/pages/viewpage.action?pageId=348800177" rel="noreferrer" target="_blank">PUGS</a>: Product User Guide and Specification (PUGS)</p></li>
</ul>
<p>Code libraries used:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/bopen/c3s-eqc-automatic-quality-control/tree/main/c3s_eqc_automatic_quality_control" rel="noreferrer" target="_blank">C3S EQC custom functions</a>, <code class="docutils literal notranslate"><span class="pre">c3s_eqc_automatic_quality_control</span></code>,  prepared by <a class="reference external" href="https://www.bopen.eu/" rel="noreferrer" target="_blank">B-Open</a></p></li>
</ul>
</section>
<section id="references">
<h3>References<a class="headerlink" href="#references" title="Link to this heading">#</a></h3>
<p><a class="reference external" href="https://www.ndbc.noaa.gov/" rel="noreferrer" target="_blank">[1]</a> NOAA National Buoy Data Centre.</p>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./Satellite_ECVs/Land_Hydrology"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="Land_Hydrology.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title"><span class="section-number">1.5. </span>Land Hydrology</p>
      </div>
    </a>
    <a class="right-next"
       href="../Ocean/Ocean.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title"><span class="section-number">1.6. </span>Ocean</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#use-case-utilize-satellite-derived-lake-water-temperature-data-to-water-resources-management-and-support-climate-adaptation-strategies">üåç Use case: Utilize satellite-derived lake water temperature data to water resources management and support climate adaptation strategies</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#quality-assessment-question">‚ùì Quality assessment question</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#quality-assessment-statement">üì¢ Quality assessment statement</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#methodology">üìã Methodology</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#analysis-and-results">üìà Analysis and results</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#data-request-and-download">1. Data request and download</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#import-packages">Import packages</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#set-variables">Set variables</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#set-the-data-request">Set the data request</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#download-data">Download data</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#data-preprocessing">2. Data preprocessing</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-lakeid">Plot lakeid</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#data-filtering">Data filtering</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#spatial-completeness-analysis">3. Spatial completeness analysis</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#temporal-completeness-analysis">4. Temporal completeness analysis</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#temporal-completeness">Temporal completeness</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#comparison-with-buoy-data">Comparison with buoy data</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#i-if-you-want-to-know-more">‚ÑπÔ∏è If you want to know more</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#key-resources">Key resources</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#references">References</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By the Copernicus Climate Change Service (C3S), entrusted to ECMWF (European Centre for Medium-Range Weather Forecasts)
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      ¬© Copyright 2024.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>