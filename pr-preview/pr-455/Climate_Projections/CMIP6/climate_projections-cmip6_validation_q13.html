
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>5.1.1. CMIP6 biases in SPEI6 drought simulations over the Mediterranean region &#8212; eqcbook</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'Climate_Projections/CMIP6/climate_projections-cmip6_validation_q13';</script>
    <link rel="icon" href="../../_static/C3S_favicon.png"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="5.2. CORDEX" href="../CORDEX/CORDEX.html" />
    <link rel="prev" title="5.1. CMIP6" href="CMIP6.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>
<aside class="bd-header-announcement" aria-label="Announcement">
  <div class="bd-header-announcement__content">⚠️This is under development!⚠️</div>
</aside>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/C3S–POS–LINE.png" class="logo__image only-light" alt="eqcbook - Home"/>
    <script>document.write(`<img src="../../_static/C3S–POS–LINE.png" class="logo__image only-dark" alt="eqcbook - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../intro.html">
                    C3S EQC quality assessments
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">➡️ Satellite Observations</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../Satellite_ECVs/satellite.html">1. Quality assessments for Satellite Observations</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../Satellite_ECVs/Atmosphere_Physics/Atmosphere_Physics.html">1.1. Atmosphere Physics</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="simple">
</ul>
</details></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../Satellite_ECVs/Atmospheric_Composition/Atmospheric_Composition.html">1.2. Atmospheric Composition</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="simple">
</ul>
</details></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../Satellite_ECVs/Cryosphere/Cryosphere.html">1.3. Cryosphere</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="simple">
</ul>
</details></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../Satellite_ECVs/Land_Biosphere/Land_Biosphere.html">1.4. Land Biosphere</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="simple">
</ul>
</details></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../Satellite_ECVs/Land_Hydrology/Land_Hydrology.html">1.5. Land Hydrology</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="simple">
</ul>
</details></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../Satellite_ECVs/Ocean/Ocean.html">1.6. Ocean</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="simple">
</ul>
</details></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">➡️ Insitu Observations</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../In_Situ/insitu.html">2. Quality assessments for Insitu Observations</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="simple">
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">➡️ Reanalysis</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../Reanalyses/reanalysis.html">3. Quality assessments for Reanalysis</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="simple">
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">➡️ Seasonal Forecasts</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../Seasonal_Forecasts/seasonal.html">4. Quality assessments for Seasonal Forecasts</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="simple">
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">➡️ Climate Projections</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 current active has-children"><a class="reference internal" href="../climate.html">5. Quality assessments for Climate Projections</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="current">
<li class="toctree-l2 current active has-children"><a class="reference internal" href="CMIP6.html">5.1. CMIP6</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="current">
<li class="toctree-l3 current active"><a class="current reference internal" href="#">5.1.1. CMIP6 biases in SPEI6 drought simulations over the Mediterranean region</a></li>
</ul>
</details></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../CORDEX/CORDEX.html">5.2. CORDEX</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="simple">
</ul>
</details></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">➡️ Climate Indicators</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../Indicators/indicator.html">6. Quality assessments for Climate Indicators</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="simple">
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">➡️ Derived Datasets</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../Derived_Datasets/derived.html">7. Quality assessments for Derived Datasets</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="simple">
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">➡️ Applications</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../Applications/application.html">8. Quality assessments for C3S Applications</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="simple">
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Quality assessment template</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../templates/template_instructions.html">Template instructions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../templates/template.html">Template</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/ecmwf-projects/c3s2-eqc-quality-assessment" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/ecmwf-projects/c3s2-eqc-quality-assessment/issues/new?title=Issue%20on%20page%20%2FClimate_Projections/CMIP6/climate_projections-cmip6_validation_q13.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/Climate_Projections/CMIP6/climate_projections-cmip6_validation_q13.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>CMIP6 biases in SPEI6 drought simulations over the Mediterranean region</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#use-case-investigating-drought-biases-to-inform-water-management">🌍 Use case: Investigating drought biases to inform water management</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#quality-assessment-question">❓ Quality assessment question</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#quality-assessment-statement">📢 Quality assessment statement</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#methodology">📋 Methodology</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#analysis-and-results">📈 Analysis and results</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#parameters-requests-and-functions-definition">1. Parameters, requests and functions definition</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#import-packages">1.1. Import packages</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#define-parameters">1.2. Define Parameters</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#define-models">1.3. Define models</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#define-era5-request">1.4. Define ERA5 request</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#define-model-requests">1.5. Define model requests</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#functions-to-cache">1.6. Functions to cache</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#downloading-and-processing">2. Downloading and processing</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#download-and-transform-era5">2.1. Download and transform ERA5</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#download-and-transform-models">2.2. Download and transform models</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#apply-land-sea-mask-and-change-some-attributes">2.3. Apply land-sea mask and change some attributes</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-and-describe-results">3. Plot and describe results</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#define-plotting-functions">3.1. Define plotting functions</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-ensemble-maps">3.2. Plot ensemble maps</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-model-maps">3.3. Plot model maps</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-bias-maps">3.4. Plot bias maps</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#timeseries">3.5. Timeseries</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#results-summary">3.6. Results summary</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#implications-for-the-users">3.7. Implications for the users</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#i-if-you-want-to-know-more">ℹ️ If you want to know more</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#key-resources">Key resources</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#references">References</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <p><img alt="logo" src="../../_images/LogoLine_horizon_C3S1.png" /></p>
<div class="alert alert-block alert-warning">
Please note that this repository is used for development and review, so quality assessments should be considered work in progress until they are merged into the main branch
</div><section class="tex2jax_ignore mathjax_ignore" id="cmip6-biases-in-spei6-drought-simulations-over-the-mediterranean-region">
<h1><span class="section-number">5.1.1. </span>CMIP6 biases in SPEI6 drought simulations over the Mediterranean region<a class="headerlink" href="#cmip6-biases-in-spei6-drought-simulations-over-the-mediterranean-region" title="Link to this heading">#</a></h1>
<p>Production date: 20-09-2025</p>
<p>Produced by: CMCC foundation - Euro-Mediterranean Center on Climate Change. Albert Martinez Boti and Lorenzo Sangelantoni.</p>
<section id="use-case-investigating-drought-biases-to-inform-water-management">
<h2>🌍 Use case: Investigating drought biases to inform water management<a class="headerlink" href="#use-case-investigating-drought-biases-to-inform-water-management" title="Link to this heading">#</a></h2>
</section>
<section id="quality-assessment-question">
<h2>❓ Quality assessment question<a class="headerlink" href="#quality-assessment-question" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p><strong>How well do CMIP6 models simulate drought compared to signals derived from ERA5?</strong></p></li>
</ul>
<p>The Standardized Precipitation-Evapotranspiration Index (SPEI) <a class="reference external" href="https://doi.org/10.1175/2009JCLI2909.1" rel="noreferrer" target="_blank">[1]</a> is a widely used drought indicator that integrates precipitation and potential evapotranspiration, providing a more complete measure of water deficits than precipitation alone. Its multiscalar formulation allows the evaluation of different types of drought <a class="reference external" href="https://digitalcommons.unl.edu/droughtfacpub/69/" rel="noreferrer" target="_blank">[2]</a>, from short-term agricultural or soil moisture deficits to long-term hydrological or ecological events. Being standardized, SPEI is dimensionless, facilitating comparisons across regions and climates. By capturing variations in frequency, duration, and severity, it effectively reflects the complex nature of drought, making it a robust and physically meaningful proxy for drought assessment in the context of climate change <a class="reference external" href="https://doi.org/10.1175/2012EI000434.1" rel="noreferrer" target="_blank">[3]</a>.</p>
<p>Understanding SPEI is particularly relevant for the water management sector. By capturing multiple types of drought SPEI serves as a versatile indicator for various users. Climate projections using SPEI enable planners to anticipate future water deficits, guide allocation, and design effective strategies for reservoir management, irrigation, and drought preparedness, helping to reduce socio-economic and ecological impacts <a class="reference external" href="https://doi.org/10.1016/j.scitotenv.2019.135245" rel="noreferrer" target="_blank">[4]</a><a class="reference external" href="https://doi.org/10.3390/w17101507" rel="noreferrer" target="_blank">[5]</a>.</p>
<p>This assessment evaluates SPEI6 (six-month accumulation) across the full ensemble of <a class="reference external" href="https://cds.climate.copernicus.eu/datasets/projections-cmip6?tab=overview" rel="noreferrer" target="_blank">CMIP6</a> models available through the Copernicus Climate Data Store (CDS). Model outputs are compared against SPEI6 derived from <a class="reference external" href="https://cds.climate.copernicus.eu/datasets/reanalysis-era5-complete?tab=doc" rel="noreferrer" target="_blank">ERA5</a> reanalysis, which serves as the reference product. The standard reference period is 1971–2010. We specifically evaluate whether changes in the 1991–2020 period relative to the 1961–1990 baseline are accurately represented by CMIP6 models and the trend acroos the whole 1961-2020 period for the Mediterranean domain.</p>
</section>
<section id="quality-assessment-statement">
<h2>📢 Quality assessment statement<a class="headerlink" href="#quality-assessment-statement" title="Link to this heading">#</a></h2>
<div class="note admonition">
<p class="admonition-title">These are the key outcomes of this assessment</p>
<ul class="simple">
<li><p>CMIP6 ensemble median captures the general intensification of drought over the Mediterranean seen in ERA5, though the magnitude of the change is underestimated, particularly over eastern Spain, southern France, and much of Turkey.</p></li>
<li><p>Individual models do not reproduce the same spatial pattern, highlighting the importance of using large ensembles rather than relying on a single model for planning purposes.</p></li>
<li><p>Despite inherent biases, the considered subset of CMIP6 models provides a foundation for understanding the evolution of past drought conditions. These results support the use of SPEI to anticipate water deficits and guide drought preparedness, increasing confidence (though not ensuring accuracy) when assessing future trends.</p></li>
<li><p>Regions with high inter-model spread, such as North Africa, Turkey, and the eastern Mediterranean, may be associated with future higher uncertainty, suggesting that adaptation strategies in these areas should consider a wider range of possible futures.</p></li>
</ul>
</div>
<figure class="align-default" id="id1">
<a class="reference internal image-reference" href="../../_images/7b5c6a55-25e9-4938-99e9-a977bad344e6.png"><img alt="Visual abstract" src="../../_images/7b5c6a55-25e9-4938-99e9-a977bad344e6.png" style="width: 1500px;" />
</a>
<figcaption>
<p><span class="caption-number">Fig. 5.1.1.1 </span><span class="caption-text">Spatial patterns of SPEI6 change over the Mediterranean region. Panels show (a) ERA5 reference, (b) CMIP6 ensemble median (median of the selected subset of models at each grid cell), (c) ensemble median bias relative to ERA5, and (d) ensemble spread (standard deviation across the selected models). SPEI6 is standardised over the reference period 1971–2010. SPEI6 change is calculated at each grid point as the difference between the monthly climatologies of the target period (1991–2020) and the baseline period (1961–1990), and then averaged to obtain the annual mean.</span><a class="headerlink" href="#id1" title="Link to this image">#</a></p>
</figcaption>
</figure>
</section>
<section id="methodology">
<h2>📋 Methodology<a class="headerlink" href="#methodology" title="Link to this heading">#</a></h2>
<p>The Standardized Precipitation-Evapotranspiration Index accumulated to six months (SPEI6) has been calculated for this assessment — through the use of <a class="reference external" href="https://xclim.readthedocs.io/en/stable/" rel="noreferrer" target="_blank">xclim</a> — as a proxy to evaluate drought conditions for a subset of <a class="reference external" href="https://cds.climate.copernicus.eu/datasets/projections-cmip6?tab=overview" rel="noreferrer" target="_blank">CMIP6</a> models, which are evaluated against SPEI6 derived from  <a class="reference external" href="https://cds.climate.copernicus.eu/datasets/reanalysis-era5-complete?tab=doc" rel="noreferrer" target="_blank">ERA5</a> reanalysis. The study covers the Mediterranean domain, following IPCC-AR6 regional definitions <a class="reference external" href="https://doi.org/10.5194/essd-12-2959-2020" rel="noreferrer" target="_blank">[6]</a>, and results include spatial maps of SPEI6 changes for ERA5, CMIP6, and the biases of these changes. Additionally, time series showing the temporal evolution of drought across the domain are calculated, comparing trends from the models with ERA5 over the historical period considered within this assessment (1961–2020).</p>
<p>Potential evapotranspiration (PET) is calculated with the Hargreaves method <a class="reference external" href="https://doi.org/10.13031/2013.26773" rel="noreferrer" target="_blank">[7]</a>, which requires only maximum and minimum temperatures (and optionally mean temperature), providing a computationally efficient yet robust estimate (e.g., <a class="reference external" href="https://doi.org/10.1002/joc.3887" rel="noreferrer" target="_blank">[8]</a>,). The accumulated series of precipitation minus PET is standardized for the reference period defined by the <a class="reference external" href="https://confluence.ecmwf.int/display/CKB/Gridded+data+underpinning+the+Copernicus+Interactive+Climate+Atlas%3A+Description+of+the+datasets+and+variables#GriddeddataunderpinningtheCopernicusInteractiveClimateAtlas:Descriptionofthedatasetsandvariables" rel="noreferrer" target="_blank">C3S Atlas</a> (1971–2010).</p>
<p>Five key concepts are defined:</p>
<ul class="simple">
<li><p><strong>Reference period:</strong> The period used to standardize SPEI values, here 1971–2010, following the <a class="reference external" href="https://confluence.ecmwf.int/display/CKB/Gridded+data+underpinning+the+Copernicus+Interactive+Climate+Atlas%3A+Description+of+the+datasets+and+variables#GriddeddataunderpinningtheCopernicusInteractiveClimateAtlas:Descriptionofthedatasetsandvariables" rel="noreferrer" target="_blank">C3S Atlas</a>.</p></li>
<li><p><strong>Baseline period:</strong> The period against which changes are calculated, here 1961–1990.</p></li>
<li><p><strong>Target period:</strong> The period for which changes are evaluated, here 1991–2020.</p></li>
<li><p><strong>Historical period:</strong> The entire period considered in this assessment, here 1961–2020.</p></li>
<li><p><strong>Change assessment:</strong> Differences in SPEI6 between the target period and the baseline, representing anomalies in drought conditions.</p></li>
</ul>
<p>The analysis and results follow the next outline:</p>
<p><strong><a class="reference internal" href="#climate-projections-cmip6-validation-q13-climate-projections-cmip6-validation-q13-section-1"><span class="std std-ref">1. Parameters, requests and functions definition</span></a></strong></p>
<ul class="simple">
<li><p><a class="reference internal" href="#climate-projections-cmip6-validation-q13-climate-projections-cmip6-validation-q13-section-1-1"><span class="std std-ref">1.1. Import packages</span></a></p></li>
<li><p><a class="reference internal" href="#climate-projections-cmip6-validation-q13-climate-projections-cmip6-validation-q13-section-1-2"><span class="std std-ref">1.2. Define Parameters</span></a></p></li>
<li><p><a class="reference internal" href="#climate-projections-cmip6-validation-q13-climate-projections-cmip6-validation-q13-section-1-3"><span class="std std-ref">1.3. Define models</span></a></p></li>
<li><p><a class="reference internal" href="#climate-projections-cmip6-validation-q13-climate-projections-cmip6-validation-q13-section-1-4"><span class="std std-ref">1.4. Define ERA5 request</span></a></p></li>
<li><p><a class="reference internal" href="#climate-projections-cmip6-validation-q13-climate-projections-cmip6-validation-q13-section-1-5"><span class="std std-ref">1.5. Define model requests</span></a></p></li>
<li><p><a class="reference internal" href="#climate-projections-cmip6-validation-q13-climate-projections-cmip6-validation-q13-section-1-6"><span class="std std-ref">1.6. Functions to cache</span></a></p></li>
</ul>
<p><strong><a class="reference internal" href="#climate-projections-cmip6-validation-q13-climate-projections-cmip6-validation-q13-section-2"><span class="std std-ref">2. Downloading and processing</span></a></strong></p>
<ul class="simple">
<li><p><a class="reference internal" href="#climate-projections-cmip6-validation-q13-climate-projections-cmip6-validation-q13-section-2-1"><span class="std std-ref">2.1. Download and transform ERA5</span></a></p></li>
<li><p><a class="reference internal" href="#climate-projections-cmip6-validation-q13-climate-projections-cmip6-validation-q13-section-2-2"><span class="std std-ref">2.2. Download and transform models</span></a></p></li>
<li><p><a class="reference internal" href="#climate-projections-cmip6-validation-q13-climate-projections-cmip6-validation-q13-section-2-3"><span class="std std-ref">2.3. Apply land-sea mask and change some attributes</span></a></p></li>
</ul>
<p><strong><a class="reference internal" href="#climate-projections-cmip6-validation-q13-climate-projections-cmip6-validation-q13-section-3"><span class="std std-ref">3. Plot and describe results</span></a></strong></p>
<ul class="simple">
<li><p><a class="reference internal" href="#climate-projections-cmip6-validation-q13-climate-projections-cmip6-validation-q13-section-3-1"><span class="std std-ref">3.1. Define plotting functions</span></a></p></li>
<li><p><a class="reference internal" href="#climate-projections-cmip6-validation-q13-climate-projections-cmip6-validation-q13-section-3-2"><span class="std std-ref">3.2. Plot ensemble maps</span></a></p></li>
<li><p><a class="reference internal" href="#climate-projections-cmip6-validation-q13-climate-projections-cmip6-validation-q13-section-3-3"><span class="std std-ref">3.3. Plot model maps</span></a></p></li>
<li><p><a class="reference internal" href="#climate-projections-cmip6-validation-q13-climate-projections-cmip6-validation-q13-section-3-4"><span class="std std-ref">3.4. Plot bias maps</span></a></p></li>
<li><p><a class="reference internal" href="#climate-projections-cmip6-validation-q13-climate-projections-cmip6-validation-q13-section-3-5"><span class="std std-ref">3.5. Timeseries</span></a></p></li>
<li><p><a class="reference internal" href="#climate-projections-cmip6-validation-q13-climate-projections-cmip6-validation-q13-section-3-6"><span class="std std-ref">3.6. Results summary</span></a></p></li>
<li><p><a class="reference internal" href="#climate-projections-cmip6-validation-q13-climate-projections-cmip6-validation-q13-section-3-7"><span class="std std-ref">3.7. Implications for the users</span></a></p></li>
</ul>
</section>
<section id="analysis-and-results">
<h2>📈 Analysis and results<a class="headerlink" href="#analysis-and-results" title="Link to this heading">#</a></h2>
<section id="parameters-requests-and-functions-definition">
<span id="climate-projections-cmip6-validation-q13-climate-projections-cmip6-validation-q13-section-1"></span><h3>1. Parameters, requests and functions definition<a class="headerlink" href="#parameters-requests-and-functions-definition" title="Link to this heading">#</a></h3>
<section id="import-packages">
<span id="climate-projections-cmip6-validation-q13-climate-projections-cmip6-validation-q13-section-1-1"></span><h4>1.1. Import packages<a class="headerlink" href="#import-packages" title="Link to this heading">#</a></h4>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">math</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">tempfile</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">textwrap</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">cartopy.crs</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">ccrs</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">xclim</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">xarray</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">xr</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">c3s_eqc_automatic_quality_control</span><span class="w"> </span><span class="kn">import</span> <span class="n">diagnostics</span><span class="p">,</span> <span class="n">download</span><span class="p">,</span> <span class="n">plot</span><span class="p">,</span> <span class="n">utils</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">linregress</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">cartopy.mpl.gridliner</span><span class="w"> </span><span class="kn">import</span> <span class="n">Gridliner</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">OrderedDict</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.ticker</span><span class="w"> </span><span class="kn">import</span> <span class="n">FixedLocator</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">scipy.signal</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">signal</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.dates</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mdates</span>

<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s2">&quot;seaborn-v0_8-notebook&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;hatch.linewidth&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span>
</pre></div>
</div>
</div>
</details>
</div>
</section>
<section id="define-parameters">
<span id="climate-projections-cmip6-validation-q13-climate-projections-cmip6-validation-q13-section-1-2"></span><h4>1.2. Define Parameters<a class="headerlink" href="#define-parameters" title="Link to this heading">#</a></h4>
<p>In the “Define Parameters” section, various customisable options for the notebook are specified:</p>
<ul class="simple">
<li><p>The historical period can be adjusted by modifying <code class="docutils literal notranslate"><span class="pre">historical_slice</span></code>; the default range is 1961-2020.</p></li>
<li><p>The reference period can be adjusted by modifying <code class="docutils literal notranslate"><span class="pre">reference_slice</span></code>; the default range is 1971–2010, following the <a class="reference external" href="https://confluence.ecmwf.int/display/CKB/Gridded+data+underpinning+the+Copernicus+Interactive+Climate+Atlas%3A+Description+of+the+datasets+and+variables#GriddeddataunderpinningtheCopernicusInteractiveClimateAtlas:Descriptionofthedatasetsandvariables" rel="noreferrer" target="_blank">C3S Atlas</a>.</p></li>
<li><p>The baseline period can be adjusted by modifying <code class="docutils literal notranslate"><span class="pre">baseline_slice</span></code>; the default range is 1961-1990.</p></li>
<li><p>The target period can be adjusted by modifying <code class="docutils literal notranslate"><span class="pre">target_slice</span></code>; the default range is 1991-2020.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">interpolation_method</span></code> parameter allows selecting the interpolation method when regridding is performed.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">collection_id</span></code> is not customisable for this assessment and is set to ‘CMIP6’. Expert users can use this notebook as a guide to create similar analyses for other model sets (such as CORDEX).</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">area</span></code> parameter specifies the geographical domain of interest. By default, the Mediterranean domain is used, following IPCC-AR6 regional definitions <a class="reference external" href="https://doi.org/10.5194/essd-12-2959-2020" rel="noreferrer" target="_blank">[6]</a></p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">time_agg</span></code> allows selecting the time aggregation for the analysis. Options include: annual, DJF, MAM, JJA, SON, Jan, Feb, Mar, Apr, May, Jun, Jul, Aug, Sep, Oct, Nov, Dec.</p></li>
<li><p>SPEI accumulation window (<code class="docutils literal notranslate"><span class="pre">window</span></code>): Defines the accumulation period in months for the SPEI calculation. Common options include 3, 6, or 12 months, depending on whether short-term or long-term droughts are of interest. In this assessment, a six-month accumulation is used.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">chunks</span></code> selection allows the user to define if dividing into chunks when downloading the data on their local machine. Although it does not significantly affect the analysis, it is recommended to keep the default value for optimal performance.</p></li>
</ul>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Periods definition</span>
<span class="n">historical_slice</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">1961</span><span class="p">,</span><span class="mi">2020</span><span class="p">)</span>
<span class="n">reference_slice</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">1971</span><span class="p">,</span><span class="mi">2010</span><span class="p">)</span>
<span class="n">baseline_slice</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">1961</span><span class="p">,</span><span class="mi">1990</span><span class="p">)</span>
<span class="n">target_slice</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">1991</span><span class="p">,</span><span class="mi">2020</span><span class="p">)</span>

<span class="c1"># Interpolation method</span>
<span class="n">interpolation_method</span> <span class="o">=</span> <span class="s2">&quot;conservative&quot;</span>

<span class="c1">#Collection id</span>
<span class="n">collection_id</span> <span class="o">=</span> <span class="s2">&quot;CMIP6&quot;</span>
<span class="k">assert</span> <span class="n">collection_id</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;CMIP6&quot;</span><span class="p">)</span>

<span class="c1"># Define region for analysis</span>
<span class="n">area</span> <span class="o">=</span> <span class="p">[</span><span class="mi">45</span><span class="p">,</span> <span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">40</span><span class="p">]</span>
<span class="c1">#time aggregation</span>
<span class="n">time_agg</span> <span class="o">=</span> <span class="s2">&quot;annual&quot;</span> 

<span class="k">assert</span> <span class="n">time_agg</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;annual&quot;</span><span class="p">,</span><span class="s2">&quot;DJF&quot;</span><span class="p">,</span><span class="s2">&quot;MAM&quot;</span><span class="p">,</span><span class="s2">&quot;JJA&quot;</span><span class="p">,</span><span class="s2">&quot;SON&quot;</span><span class="p">,</span>
           <span class="s2">&quot;Jan&quot;</span><span class="p">,</span> <span class="s2">&quot;Feb&quot;</span><span class="p">,</span> <span class="s2">&quot;Mar&quot;</span><span class="p">,</span> <span class="s2">&quot;Apr&quot;</span><span class="p">,</span> <span class="s2">&quot;May&quot;</span><span class="p">,</span>
           <span class="s2">&quot;Jun&quot;</span><span class="p">,</span> <span class="s2">&quot;Jul&quot;</span><span class="p">,</span> <span class="s2">&quot;Aug&quot;</span><span class="p">,</span> <span class="s2">&quot;Sep&quot;</span><span class="p">,</span> <span class="s2">&quot;Oct&quot;</span><span class="p">,</span>
           <span class="s2">&quot;Nov&quot;</span><span class="p">,</span> <span class="s2">&quot;Dec&quot;</span><span class="p">)</span>

<span class="c1">#SPEI accumulation</span>
<span class="n">window</span><span class="o">=</span><span class="mi">6</span>

<span class="c1"># Chunks for download</span>
<span class="n">chunks</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
</pre></div>
</div>
</div>
</details>
</div>
</section>
<section id="define-models">
<span id="climate-projections-cmip6-validation-q13-climate-projections-cmip6-validation-q13-section-1-3"></span><h4>1.3. Define models<a class="headerlink" href="#define-models" title="Link to this heading">#</a></h4>
<p>The following climate analyses are performed using CMIP6 models that provide both the historical and SSP5-8.5 experiments, as well as maximum, minimum and mean temperatures and precipitation, within the Climate Data Store (<a class="reference external" href="https://cds.climate.copernicus.eu/datasets/projections-cmip6?tab=overview" rel="noreferrer" target="_blank">CDS</a>).</p>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">models_cmip6</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s2">&quot;access_cm2&quot;</span><span class="p">,</span>  <span class="s2">&quot;canesm5&quot;</span><span class="p">,</span> <span class="s2">&quot;cmcc_esm2&quot;</span><span class="p">,</span> <span class="s2">&quot;cnrm_cm6_1&quot;</span><span class="p">,</span>
    <span class="s2">&quot;cnrm_cm6_1_hr&quot;</span><span class="p">,</span> <span class="s2">&quot;cnrm_esm2_1&quot;</span><span class="p">,</span> <span class="s2">&quot;ec_earth3_cc&quot;</span><span class="p">,</span>
    <span class="s2">&quot;gfdl_esm4&quot;</span><span class="p">,</span> <span class="s2">&quot;inm_cm4_8&quot;</span><span class="p">,</span> <span class="s2">&quot;inm_cm5_0&quot;</span><span class="p">,</span> <span class="s2">&quot;kace_1_0_g&quot;</span><span class="p">,</span>
    <span class="s2">&quot;miroc6&quot;</span><span class="p">,</span> <span class="s2">&quot;miroc_es2l&quot;</span><span class="p">,</span> <span class="s2">&quot;mpi_esm1_2_lr&quot;</span><span class="p">,</span> <span class="s2">&quot;mri_esm2_0&quot;</span><span class="p">,</span>
    <span class="s2">&quot;nesm3&quot;</span><span class="p">,</span><span class="s2">&quot;noresm2_mm&quot;</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</details>
</div>
</section>
<section id="define-era5-request">
<span id="climate-projections-cmip6-validation-q13-climate-projections-cmip6-validation-q13-section-1-4"></span><h4>1.4. Define ERA5 request<a class="headerlink" href="#define-era5-request" title="Link to this heading">#</a></h4>
<p>Within this notebook, ERA5 serves as the reference product. In this section, we set the required parameters for the cds-api data-request of ERA5.</p>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">request_era</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s2">&quot;reanalysis-era5-single-levels&quot;</span><span class="p">,</span>
    <span class="p">{</span>
        <span class="s2">&quot;product_type&quot;</span><span class="p">:</span> <span class="s2">&quot;reanalysis&quot;</span><span class="p">,</span>
        <span class="s2">&quot;format&quot;</span><span class="p">:</span> <span class="s2">&quot;netcdf&quot;</span><span class="p">,</span>
        <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">hour</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">:00&quot;</span> <span class="k">for</span> <span class="n">hour</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">24</span><span class="p">)],</span>
        <span class="s2">&quot;variable&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;2m_temperature&quot;</span><span class="p">,</span> <span class="s2">&quot;total_precipitation&quot;</span><span class="p">],</span>
        <span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">historical_slice</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">historical_slice</span><span class="o">.</span><span class="n">stop</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">],</span>  <span class="c1"># Include D(year-1)</span>
        <span class="s2">&quot;month&quot;</span><span class="p">:</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">month</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">month</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">13</span><span class="p">)],</span>
        <span class="s2">&quot;day&quot;</span><span class="p">:</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">day</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">day</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">32</span><span class="p">)],</span>
        <span class="s2">&quot;area&quot;</span><span class="p">:</span> <span class="n">area</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">)</span>

<span class="n">request_lsm</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">request_era</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
    <span class="n">request_era</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="o">|</span> <span class="p">{</span>
        <span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="s2">&quot;1940&quot;</span><span class="p">,</span>
        <span class="s2">&quot;month&quot;</span><span class="p">:</span> <span class="s2">&quot;01&quot;</span><span class="p">,</span>
        <span class="s2">&quot;day&quot;</span><span class="p">:</span> <span class="s2">&quot;01&quot;</span><span class="p">,</span>
        <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="s2">&quot;00:00&quot;</span><span class="p">,</span>
        <span class="s2">&quot;variable&quot;</span><span class="p">:</span> <span class="s2">&quot;land_sea_mask&quot;</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</details>
</div>
</section>
<section id="define-model-requests">
<span id="climate-projections-cmip6-validation-q13-climate-projections-cmip6-validation-q13-section-1-5"></span><h4>1.5. Define model requests<a class="headerlink" href="#define-model-requests" title="Link to this heading">#</a></h4>
<p>In this section we set the required parameters for the cds-api data-request.</p>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">request_cmip6</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;format&quot;</span><span class="p">:</span> <span class="s2">&quot;zip&quot;</span><span class="p">,</span>
    <span class="s2">&quot;temporal_resolution&quot;</span><span class="p">:</span> <span class="s2">&quot;daily&quot;</span><span class="p">,</span>
    <span class="s2">&quot;month&quot;</span><span class="p">:</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">month</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">month</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">13</span><span class="p">)],</span>
    <span class="s2">&quot;day&quot;</span><span class="p">:</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">day</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">day</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">32</span><span class="p">)],</span>
    <span class="s2">&quot;area&quot;</span><span class="p">:</span> <span class="n">area</span><span class="p">,</span>
<span class="p">}</span>


<span class="k">def</span><span class="w"> </span><span class="nf">get_cmip6_years</span><span class="p">(</span><span class="n">year_slice</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span>
        <span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span>
            <span class="n">year_slice</span><span class="o">.</span><span class="n">start</span><span class="p">,</span>  
            <span class="n">year_slice</span><span class="o">.</span><span class="n">stop</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">]</span>

<span class="n">model_requests_var</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">if</span> <span class="n">collection_id</span> <span class="o">==</span> <span class="s2">&quot;CMIP6&quot;</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;near_surface_air_temperature&quot;</span><span class="p">,</span> <span class="s2">&quot;daily_maximum_near_surface_air_temperature&quot;</span><span class="p">,</span> 
                <span class="s2">&quot;daily_minimum_near_surface_air_temperature&quot;</span><span class="p">,</span> <span class="s2">&quot;precipitation&quot;</span><span class="p">]:</span>
        <span class="n">model_requests</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">historical_slice</span><span class="o">.</span><span class="n">stop</span> <span class="o">&lt;=</span> <span class="mi">2014</span><span class="p">:</span>
            <span class="c1"># Only historical data</span>
            <span class="n">requests</span> <span class="o">=</span> <span class="n">download</span><span class="o">.</span><span class="n">split_request</span><span class="p">(</span>
                <span class="n">request_cmip6</span>
                <span class="o">|</span> <span class="p">{</span><span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="n">get_cmip6_years</span><span class="p">(</span><span class="n">historical_slice</span><span class="p">),</span> <span class="s2">&quot;experiment&quot;</span><span class="p">:</span> <span class="s2">&quot;historical&quot;</span><span class="p">,</span><span class="s2">&quot;variable&quot;</span><span class="p">:[</span><span class="n">var</span><span class="p">]},</span>
                <span class="n">chunks</span><span class="o">=</span><span class="n">chunks</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">historical_slice</span><span class="o">.</span><span class="n">stop</span> <span class="o">&gt;</span> <span class="mi">2014</span><span class="p">:</span>
            <span class="c1"># Historical until 2014</span>
            <span class="n">requests</span> <span class="o">=</span> <span class="n">download</span><span class="o">.</span><span class="n">split_request</span><span class="p">(</span>
                <span class="n">request_cmip6</span>
                <span class="o">|</span> <span class="p">{</span><span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="n">get_cmip6_years</span><span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="n">historical_slice</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="mi">2014</span><span class="p">)),</span>
                   <span class="s2">&quot;experiment&quot;</span><span class="p">:</span> <span class="s2">&quot;historical&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;variable&quot;</span><span class="p">:[</span><span class="n">var</span><span class="p">]},</span>
                <span class="n">chunks</span><span class="o">=</span><span class="n">chunks</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="c1"># Future from 2015 to historical_slice.stop</span>
            <span class="n">requests</span> <span class="o">+=</span> <span class="n">download</span><span class="o">.</span><span class="n">split_request</span><span class="p">(</span>
                <span class="n">request_cmip6</span>
                <span class="o">|</span> <span class="p">{</span><span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="n">get_cmip6_years</span><span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="mi">2015</span><span class="p">,</span> <span class="n">historical_slice</span><span class="o">.</span><span class="n">stop</span><span class="p">)),</span>
                   <span class="s2">&quot;experiment&quot;</span><span class="p">:</span> <span class="s2">&quot;ssp5_8_5&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;variable&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="n">var</span><span class="p">]},</span>
                <span class="n">chunks</span><span class="o">=</span><span class="n">chunks</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">models_cmip6</span><span class="p">:</span>
            <span class="n">model_requests</span><span class="p">[</span><span class="n">model</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;projections-cmip6&quot;</span><span class="p">,</span>
                <span class="p">[</span><span class="n">request</span> <span class="o">|</span> <span class="p">{</span><span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="n">model</span><span class="p">}</span> <span class="k">for</span> <span class="n">request</span> <span class="ow">in</span> <span class="n">requests</span><span class="p">],</span>
            <span class="p">)</span>
        <span class="n">model_requests_var</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">=</span> <span class="n">model_requests</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</pre></div>
</div>
</div>
</details>
</div>
</section>
<section id="functions-to-cache">
<span id="climate-projections-cmip6-validation-q13-climate-projections-cmip6-validation-q13-section-1-6"></span><h4>1.6. Functions to cache<a class="headerlink" href="#functions-to-cache" title="Link to this heading">#</a></h4>
<p>In this section, functions that will be executed in the caching phase are defined. Caching is the process of storing copies of files in a temporary storage location, so that they can be accessed more quickly. This process also checks if the user has already downloaded a file, avoiding redundant downloads.</p>
<p>Description of the main functions:</p>
<ul class="simple">
<li><p><strong><code class="docutils literal notranslate"><span class="pre">compute_spei</span></code></strong>: Uses the xclim package to calculate the Standardized Precipitation-Evapotranspiration Index (SPEI). The <code class="docutils literal notranslate"><span class="pre">reference_slice</span></code> argument specifies the reference period used for standardization, while the <code class="docutils literal notranslate"><span class="pre">window</span></code> argument defines the number of months over which precipitation and evapotranspiration are accumulated (6 months in this assessment).</p></li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">get_mask_below_03</span></code></strong>: Generates a mask identifying grid points where precipitation is below 0.3 mm/day, allowing filtering of extremely dry regions.</p></li>
</ul>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">add_bounds</span><span class="p">(</span><span class="n">ds</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;latitude&quot;</span><span class="p">,</span> <span class="s2">&quot;longitude&quot;</span><span class="p">}</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">cf</span><span class="o">.</span><span class="n">bounds</span><span class="p">):</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">cf</span><span class="o">.</span><span class="n">add_bounds</span><span class="p">(</span><span class="n">coord</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ds</span>


<span class="k">def</span><span class="w"> </span><span class="nf">get_grid_out</span><span class="p">(</span><span class="n">request_grid_out</span><span class="p">,</span> <span class="n">method</span><span class="p">):</span>
    <span class="n">ds_regrid</span> <span class="o">=</span> <span class="n">download</span><span class="o">.</span><span class="n">download_and_transform</span><span class="p">(</span><span class="o">*</span><span class="n">request_grid_out</span><span class="p">)</span>
    <span class="n">coords</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;latitude&quot;</span><span class="p">,</span> <span class="s2">&quot;longitude&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;conservative&quot;</span><span class="p">:</span>
        <span class="n">ds_regrid</span> <span class="o">=</span> <span class="n">add_bounds</span><span class="p">(</span><span class="n">ds_regrid</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">coords</span><span class="p">):</span>
            <span class="n">coords</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">ds_regrid</span><span class="o">.</span><span class="n">cf</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="n">coord</span><span class="p">])</span>
    <span class="n">grid_out</span> <span class="o">=</span> <span class="n">ds_regrid</span><span class="p">[</span><span class="n">coords</span><span class="p">]</span>
    <span class="n">coords_to_drop</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">grid_out</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">grid_out</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span>
    <span class="n">grid_out</span> <span class="o">=</span> <span class="n">ds_regrid</span><span class="p">[</span><span class="n">coords</span><span class="p">]</span><span class="o">.</span><span class="n">reset_coords</span><span class="p">(</span><span class="n">coords_to_drop</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">grid_out</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">return</span> <span class="n">grid_out</span>


<span class="k">def</span><span class="w"> </span><span class="nf">compute_spei</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span>
                 <span class="n">reference_slice</span><span class="p">,</span>
                 <span class="n">window</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
                 <span class="n">resample_reduction</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">request_vars</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">model</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
                 <span class="n">request_grid_out</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">request_all_vars</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">regrid_kwargs</span>
                <span class="p">):</span>
    <span class="c1"># Download the other vars if we are dealing with CMIP6 </span>
    <span class="k">if</span> <span class="n">request_vars</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">var_map</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;tasmax&quot;</span><span class="p">:</span> <span class="s2">&quot;daily_maximum_near_surface_air_temperature&quot;</span><span class="p">,</span>
            <span class="s2">&quot;tasmin&quot;</span><span class="p">:</span> <span class="s2">&quot;daily_minimum_near_surface_air_temperature&quot;</span><span class="p">,</span>
            <span class="s2">&quot;pr&quot;</span><span class="p">:</span> <span class="s2">&quot;precipitation&quot;</span>
        <span class="p">}</span>
        <span class="n">datasets</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;tas&quot;</span><span class="p">:</span> <span class="n">ds</span><span class="p">}</span>  
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">var_name</span> <span class="ow">in</span> <span class="n">var_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">datasets</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">download</span><span class="o">.</span><span class="n">download_and_transform</span><span class="p">(</span>
                <span class="o">*</span><span class="n">request_vars</span><span class="p">[</span><span class="n">var_name</span><span class="p">][</span><span class="n">model</span><span class="p">],</span><span class="n">chunks</span><span class="o">=</span><span class="n">chunks</span><span class="p">)</span>
            <span class="n">datasets</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">datasets</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">([</span><span class="n">var</span> <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">da</span> <span class="ow">in</span> <span class="n">datasets</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">data_vars</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">da</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">])</span>
            <span class="n">datasets</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">datasets</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="nb">list</span><span class="p">(</span><span class="n">datasets</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">data_vars</span><span class="p">)]</span>
       
    <span class="c1"># Original bounds for conservative interpolation</span>
    <span class="k">if</span> <span class="n">regrid_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;method&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;conservative&quot;</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">ds_var</span> <span class="ow">in</span> <span class="n">datasets</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">datasets</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">add_bounds</span><span class="p">(</span><span class="n">datasets</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
            <span class="n">bounds</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">datasets</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">cf</span><span class="o">.</span><span class="n">get_bounds</span><span class="p">(</span><span class="n">coord</span><span class="p">)</span><span class="o">.</span><span class="n">reset_coords</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;latitude&quot;</span><span class="p">,</span> <span class="s2">&quot;longitude&quot;</span><span class="p">)</span>
            <span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">bounds</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">if</span> <span class="n">request_grid_out</span> <span class="ow">and</span> <span class="n">request_vars</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">ds_obj</span> <span class="ow">in</span> <span class="n">datasets</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;longitude attrs:&quot;</span><span class="p">,</span> <span class="n">ds_obj</span><span class="p">[</span><span class="s2">&quot;longitude&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">)</span>
            <span class="n">datasets</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">diagnostics</span><span class="o">.</span><span class="n">regrid</span><span class="p">(</span>
                <span class="n">ds_obj</span><span class="o">.</span><span class="n">merge</span><span class="p">({</span><span class="n">da</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">da</span> <span class="k">for</span> <span class="n">da</span> <span class="ow">in</span> <span class="n">bounds</span><span class="p">}),</span>
                <span class="n">grid_out</span><span class="o">=</span><span class="n">get_grid_out</span><span class="p">(</span><span class="n">request_grid_out</span><span class="p">,</span> <span class="n">regrid_kwargs</span><span class="p">[</span><span class="s2">&quot;method&quot;</span><span class="p">]),</span>
                <span class="o">**</span><span class="n">regrid_kwargs</span><span class="p">,</span>
            <span class="p">)</span>
            
    <span class="k">if</span> <span class="n">resample_reduction</span><span class="p">:</span>
        <span class="c1"># Apply correct daily reductions</span>
        <span class="n">pr</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;tp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="s2">&quot;1D&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">keep_attrs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">*</span> <span class="mi">1000</span>   
        <span class="n">tas</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;t2m&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="s2">&quot;1D&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">keep_attrs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">tasmax</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;t2m&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="s2">&quot;1D&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">keep_attrs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> 
        <span class="n">tasmin</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;t2m&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="s2">&quot;1D&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">keep_attrs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> 
        <span class="n">pr</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;mm/day&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pr</span> <span class="o">=</span> <span class="n">datasets</span><span class="p">[</span><span class="s2">&quot;pr&quot;</span><span class="p">][</span><span class="s2">&quot;pr&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">86400</span>
        <span class="n">pr</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;mm/day&quot;</span>

    <span class="n">da_pet</span><span class="o">=</span><span class="n">xclim</span><span class="o">.</span><span class="n">indices</span><span class="o">.</span><span class="n">potential_evapotranspiration</span><span class="p">(</span><span class="n">tas</span> <span class="o">=</span> <span class="n">tas</span> <span class="k">if</span> <span class="n">resample_reduction</span> <span class="k">else</span> <span class="n">datasets</span><span class="p">[</span><span class="s2">&quot;tas&quot;</span><span class="p">][</span><span class="s2">&quot;tas&quot;</span><span class="p">],</span>
                                                      <span class="n">tasmin</span> <span class="o">=</span> <span class="n">tasmin</span> <span class="k">if</span> <span class="n">resample_reduction</span> <span class="k">else</span> <span class="n">datasets</span><span class="p">[</span><span class="s2">&quot;tasmin&quot;</span><span class="p">][</span><span class="s2">&quot;tasmin&quot;</span><span class="p">],</span>
                                                      <span class="n">tasmax</span> <span class="o">=</span> <span class="n">tasmax</span> <span class="k">if</span> <span class="n">resample_reduction</span> <span class="k">else</span> <span class="n">datasets</span><span class="p">[</span><span class="s2">&quot;tasmax&quot;</span><span class="p">][</span><span class="s2">&quot;tasmax&quot;</span><span class="p">],</span>
                                                      <span class="n">method</span><span class="o">=</span><span class="s1">&#39;HG85&#39;</span><span class="p">)</span><span class="o">*</span><span class="mi">86400</span>
    <span class="n">da_pet</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;mm/day&quot;</span>

    <span class="n">wb</span> <span class="o">=</span> <span class="n">pr</span> <span class="o">-</span> <span class="n">da_pet</span>
    <span class="n">wb</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;mm/day&quot;</span>
    <span class="n">wb</span> <span class="o">=</span> <span class="n">wb</span><span class="o">.</span><span class="n">convert_calendar</span><span class="p">(</span><span class="s2">&quot;proleptic_gregorian&quot;</span><span class="p">,</span> <span class="n">align_on</span><span class="o">=</span><span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="n">use_cftime</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    
    <span class="n">da_spei</span> <span class="o">=</span> <span class="n">xclim</span><span class="o">.</span><span class="n">indices</span><span class="o">.</span><span class="n">standardized_precipitation_evapotranspiration_index</span><span class="p">(</span><span class="n">wb</span><span class="p">,</span>
                                                                                <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;MS&#39;</span><span class="p">,</span>
                                                                                <span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">,</span>
                                                                                <span class="n">cal_start</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">reference_slice</span><span class="o">.</span><span class="n">start</span><span class="si">}</span><span class="s2">-01-01&quot;</span><span class="p">,</span>
                                                                                <span class="n">cal_end</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">reference_slice</span><span class="o">.</span><span class="n">stop</span><span class="si">}</span><span class="s2">-12-31&quot;</span><span class="p">)</span>
    <span class="c1"># Wrap into dataset</span>
    <span class="n">ds_out</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">({</span><span class="s2">&quot;spei&quot;</span><span class="p">:</span> <span class="n">da_spei</span><span class="p">})</span>
    <span class="n">ds_out</span><span class="p">[</span><span class="s2">&quot;spei&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">da_spei</span><span class="o">.</span><span class="n">attrs</span> 
    
    <span class="k">return</span> <span class="n">ds_out</span>

<span class="k">def</span><span class="w"> </span><span class="nf">get_mask_below_03</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="n">threshold</span><span class="p">,</span><span class="n">resample_reduction</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="c1"># Select pr and         </span>
    <span class="k">if</span> <span class="n">resample_reduction</span><span class="p">:</span>
        <span class="c1"># Apply correct daily reductions</span>
        <span class="n">pr</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;tp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="s2">&quot;1D&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">keep_attrs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">*</span> <span class="mi">1000</span>   
        <span class="n">pr</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;mm/day&quot;</span>
        <span class="n">pr_mean</span> <span class="o">=</span><span class="n">pr</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span> <span class="o">=</span> <span class="s1">&#39;time&#39;</span><span class="p">)</span>
        <span class="n">pr_mask</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pr_mean</span><span class="o">&lt;</span><span class="n">threshold</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">ds_out</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">({</span><span class="s2">&quot;pr_mask&quot;</span><span class="p">:</span> <span class="n">pr_mask</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">ds_out</span>
</pre></div>
</div>
</div>
</details>
</div>
</section>
</section>
<section id="downloading-and-processing">
<span id="climate-projections-cmip6-validation-q13-climate-projections-cmip6-validation-q13-section-2"></span><h3>2. Downloading and processing<a class="headerlink" href="#downloading-and-processing" title="Link to this heading">#</a></h3>
<section id="download-and-transform-era5">
<span id="climate-projections-cmip6-validation-q13-climate-projections-cmip6-validation-q13-section-2-1"></span><h4>2.1. Download and transform ERA5<a class="headerlink" href="#download-and-transform-era5" title="Link to this heading">#</a></h4>
<p>In this section, the <code class="docutils literal notranslate"><span class="pre">download.download_and_transform</span></code> function from the ‘c3s_eqc_automatic_quality_control’ package is used to retrieve ERA5 hourly reference data, resample it to daily frequency, compute daily potential evapotranspiration, calculate the daily water balance, and derive the SPEI (SPEI6 for this assessment). Results are cached to avoid redundant downloads and repeated processing.</p>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">transform_func_kwargs</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;reference_slice&quot;</span><span class="p">:</span> <span class="n">reference_slice</span><span class="p">,</span>
    <span class="s2">&quot;window&quot;</span><span class="p">:</span><span class="n">window</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">ds_era5</span> <span class="o">=</span> <span class="n">download</span><span class="o">.</span><span class="n">download_and_transform</span><span class="p">(</span>
    <span class="o">*</span><span class="n">request_era</span><span class="p">,</span>
    <span class="n">chunks</span><span class="o">=</span><span class="n">chunks</span><span class="p">,</span>
    <span class="n">transform_chunks</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">transform_func</span><span class="o">=</span><span class="n">compute_spei</span><span class="p">,</span>
    <span class="n">transform_func_kwargs</span><span class="o">=</span><span class="n">transform_func_kwargs</span><span class="o">|</span> 
    <span class="p">{</span><span class="s2">&quot;resample_reduction&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</details>
</div>
</section>
<section id="download-and-transform-models">
<span id="climate-projections-cmip6-validation-q13-climate-projections-cmip6-validation-q13-section-2-2"></span><h4>2.2. Download and transform models<a class="headerlink" href="#download-and-transform-models" title="Link to this heading">#</a></h4>
<p>In this section, the <code class="docutils literal notranslate"><span class="pre">download.download_and_transform</span></code> function from the ‘c3s_eqc_automatic_quality_control’ package is used to download daily data from CMIP6 models, compute daily potential evapotranspiration, calculate the daily water balance, and derive the SPEI (SPEI6 for this assessment). SPEI6 is computed on each model’s native grid and also on the ERA5 grid to enable bias assessment. When regridding is required, it is performed for each essential climate variable before the index calculation to preserve standardisation. Results are cached to avoid redundant downloads and repeated processing.</p>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">interpolated_datasets</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">model_datasets</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">model</span><span class="p">,</span> <span class="n">requests</span> <span class="ow">in</span> <span class="n">model_requests_var</span><span class="p">[</span><span class="s1">&#39;near_surface_air_temperature&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">model_kwargs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;chunks&quot;</span><span class="p">:</span> <span class="n">chunks</span><span class="p">,</span>
        <span class="s2">&quot;transform_chunks&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;transform_func&quot;</span><span class="p">:</span> <span class="n">compute_spei</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="c1"># Original model</span>
    <span class="n">model_datasets</span><span class="p">[</span><span class="n">model</span><span class="p">]</span> <span class="o">=</span> <span class="n">download</span><span class="o">.</span><span class="n">download_and_transform</span><span class="p">(</span>
        <span class="o">*</span><span class="n">requests</span><span class="p">,</span>
        <span class="o">**</span><span class="n">model_kwargs</span><span class="p">,</span>
        <span class="n">transform_func_kwargs</span><span class="o">=</span><span class="n">transform_func_kwargs</span>
        <span class="o">|</span> <span class="p">{</span>
            <span class="s2">&quot;request_vars&quot;</span><span class="p">:</span> <span class="n">model_requests_var</span><span class="p">,</span>
            <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="n">model</span><span class="p">,</span>
        <span class="p">},</span>                                                 
    <span class="p">)</span>

    <span class="c1"># Interpolated model</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">download</span><span class="o">.</span><span class="n">download_and_transform</span><span class="p">(</span>
        <span class="o">*</span><span class="n">requests</span><span class="p">,</span>
        <span class="o">**</span><span class="n">model_kwargs</span><span class="p">,</span>
        <span class="n">transform_func_kwargs</span><span class="o">=</span><span class="n">transform_func_kwargs</span>
        <span class="o">|</span> <span class="p">{</span>
            <span class="s2">&quot;request_vars&quot;</span><span class="p">:</span> <span class="n">model_requests_var</span><span class="p">,</span>
            <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="n">model</span><span class="p">,</span>
            <span class="s2">&quot;request_grid_out&quot;</span><span class="p">:</span> <span class="n">request_lsm</span><span class="p">,</span>
            <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="n">interpolation_method</span><span class="p">,</span>
            <span class="s2">&quot;skipna&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">)</span>
    <span class="n">interpolated_datasets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="p">[</span><span class="n">model</span><span class="p">]))</span>

<span class="n">ds_interpolated</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">interpolated_datasets</span><span class="p">,</span> <span class="s2">&quot;model&quot;</span><span class="p">,</span><span class="n">coords</span><span class="o">=</span><span class="s1">&#39;minimal&#39;</span><span class="p">,</span> <span class="n">compat</span><span class="o">=</span><span class="s1">&#39;override&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>model=&#39;access_cm2&#39;
model=&#39;canesm5&#39;
model=&#39;cmcc_esm2&#39;
model=&#39;cnrm_cm6_1&#39;
model=&#39;cnrm_cm6_1_hr&#39;
model=&#39;cnrm_esm2_1&#39;
model=&#39;ec_earth3_cc&#39;
model=&#39;gfdl_esm4&#39;
model=&#39;inm_cm4_8&#39;
model=&#39;inm_cm5_0&#39;
model=&#39;kace_1_0_g&#39;
model=&#39;miroc6&#39;
model=&#39;miroc_es2l&#39;
model=&#39;mpi_esm1_2_lr&#39;
model=&#39;mri_esm2_0&#39;
model=&#39;nesm3&#39;
model=&#39;noresm2_mm&#39;
</pre></div>
</div>
</div>
</div>
</section>
<section id="apply-land-sea-mask-and-change-some-attributes">
<span id="climate-projections-cmip6-validation-q13-climate-projections-cmip6-validation-q13-section-2-3"></span><h4>2.3. Apply land-sea mask and change some attributes<a class="headerlink" href="#apply-land-sea-mask-and-change-some-attributes" title="Link to this heading">#</a></h4>
<p>This section changes some attributes and applies a land–sea mask to all models, as well as to ERA5. A bare-earth (barrean) mask is also applied to ensure meaningful results in arid regions, as in the <a class="reference external" href="https://atlas.climate.copernicus.eu/atlas" rel="noreferrer" target="_blank">C3S atlas</a>. In particular, we follow the methodology available in their <a class="reference external" href="https://github.com/ecmwf-projects/c3s-atlas/blob/main/auxiliar/barrean_mask.ipynb" rel="noreferrer" target="_blank">Github repository</a>. While their implementation of the mask also considers factors such as snow depth and vegetation cover, here we only apply the filter based on annual mean precipitation for 1991–2020 being less than 0.3 mm day⁻¹. This simplification is justified because, in the region under consideration, the bare-earth mask obtained with the full set of filters closely matches the one derived from the precipitation threshold alone.</p>
<p><strong>Note:</strong> <code class="docutils literal notranslate"><span class="pre">ds_interpolated</span></code> contains data from the models regridded to the ERA5 grid. <code class="docutils literal notranslate"><span class="pre">model_datasets</span></code> contain the same data on the original grid of each model. Regridding is performed for every essential climate variable prior to the index calculation in order to avoid compromising standardisation.</p>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Download and prepare lsm</span>
<span class="n">lsm</span> <span class="o">=</span> <span class="n">download</span><span class="o">.</span><span class="n">download_and_transform</span><span class="p">(</span><span class="o">*</span><span class="n">request_lsm</span><span class="p">)[</span><span class="s2">&quot;lsm&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">lsm</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">lsm</span><span class="o">&lt;</span><span class="mf">0.7</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

<span class="c1"># Mask</span>
<span class="n">ds_era5</span> <span class="o">=</span> <span class="n">ds_era5</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">lsm</span><span class="p">)</span>
<span class="n">ds_interpolated</span> <span class="o">=</span> <span class="n">ds_interpolated</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">lsm</span><span class="p">)</span>

<span class="c1"># Ensure CF-compliant attributes for model datasets</span>
<span class="k">def</span><span class="w"> </span><span class="nf">ensure_cf_attrs</span><span class="p">(</span><span class="n">ds</span><span class="p">):</span>
    <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;longitude&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
        <span class="s2">&quot;standard_name&quot;</span><span class="p">:</span> <span class="s2">&quot;longitude&quot;</span><span class="p">,</span>
        <span class="s2">&quot;units&quot;</span><span class="p">:</span> <span class="s2">&quot;degrees_east&quot;</span>
    <span class="p">})</span>
    <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;latitude&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
        <span class="s2">&quot;standard_name&quot;</span><span class="p">:</span> <span class="s2">&quot;latitude&quot;</span><span class="p">,</span>
        <span class="s2">&quot;units&quot;</span><span class="p">:</span> <span class="s2">&quot;degrees_north&quot;</span>
    <span class="p">})</span>
    <span class="k">return</span> <span class="n">ds</span>

<span class="n">ds_era5</span> <span class="o">=</span> <span class="n">ensure_cf_attrs</span><span class="p">(</span><span class="n">ds_era5</span><span class="p">)</span>
<span class="n">ds_interpolated</span> <span class="o">=</span> <span class="n">ensure_cf_attrs</span><span class="p">(</span><span class="n">ds_interpolated</span><span class="p">)</span>

<span class="c1"># Regrid each model dataset</span>
<span class="n">model_datasets</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">ds</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="n">diagnostics</span><span class="o">.</span><span class="n">regrid</span><span class="p">(</span><span class="n">lsm</span><span class="p">,</span> <span class="n">ensure_cf_attrs</span><span class="p">(</span><span class="n">ds</span><span class="p">),</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;bilinear&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">for</span> <span class="n">model</span><span class="p">,</span> <span class="n">ds</span> <span class="ow">in</span> <span class="n">model_datasets</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
<span class="p">}</span>

<span class="k">for</span> <span class="n">ds</span> <span class="ow">in</span> <span class="p">(</span><span class="n">ds_era5</span><span class="p">,</span> <span class="n">ds_interpolated</span><span class="p">,</span> <span class="o">*</span><span class="n">model_datasets</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
    <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;spei&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;long_name&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;units&quot;</span><span class="p">:</span> <span class="s2">&quot;fraction of unity&quot;</span><span class="p">}</span>

<span class="n">ds_pr_mask</span> <span class="o">=</span> <span class="n">download</span><span class="o">.</span><span class="n">download_and_transform</span><span class="p">(</span>
    <span class="o">*</span><span class="n">request_era</span><span class="p">,</span>
    <span class="n">chunks</span><span class="o">=</span><span class="n">chunks</span><span class="p">,</span>
    <span class="n">transform_chunks</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">transform_func</span><span class="o">=</span><span class="n">get_mask_below_03</span><span class="p">,</span>
    <span class="n">transform_func_kwargs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;resample_reduction&quot;</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span>
        <span class="s2">&quot;threshold&quot;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">)</span>
    
<span class="c1"># Apply precipitation mask to ERA5 and interpolated</span>
<span class="n">ds_era5</span> <span class="o">=</span> <span class="n">ds_era5</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ds_pr_mask</span><span class="p">[</span><span class="s2">&quot;pr_mask&quot;</span><span class="p">])</span>
<span class="n">ds_interpolated</span> <span class="o">=</span> <span class="n">ds_interpolated</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ds_pr_mask</span><span class="p">[</span><span class="s2">&quot;pr_mask&quot;</span><span class="p">])</span>

<span class="c1"># Apply PR mask to each model</span>
<span class="n">model_datasets</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">ds</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">diagnostics</span><span class="o">.</span><span class="n">regrid</span><span class="p">(</span><span class="n">ds_pr_mask</span><span class="p">[</span><span class="s2">&quot;pr_mask&quot;</span><span class="p">],</span> <span class="n">ds</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;bilinear&quot;</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">model</span><span class="p">,</span> <span class="n">ds</span> <span class="ow">in</span> <span class="n">model_datasets</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
<span class="p">}</span>      
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|██████████| 1/1 [00:00&lt;00:00, 44.33it/s]
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="plot-and-describe-results">
<span id="climate-projections-cmip6-validation-q13-climate-projections-cmip6-validation-q13-section-3"></span><h3>3. Plot and describe results<a class="headerlink" href="#plot-and-describe-results" title="Link to this heading">#</a></h3>
<p>This section will display the following results:</p>
<ul class="simple">
<li><p>SPEI6 change maps comparing ERA5 and the ensemble median (defined as the median of the change values for the selected subset of models at each grid cell). The layout includes ERA5, the ensemble median, the ensemble median bias, and the ensemble spread (calculated as the standard deviation of the change across the selected subset of models).</p></li>
<li><p>SPEI6 change maps for each individual model.</p></li>
<li><p>Bias maps of the SPEI6 change for each model.</p></li>
<li><p>Time series of SPEI6 change (averaged over the Mediterranean region).</p></li>
</ul>
<p><strong>Note:</strong> SPEI6 change is calculated at each grid point as the arithmetic difference between climatologies in the target period (1991–2020) and the baseline period (1961–1990).</p>
<section id="define-plotting-functions">
<span id="climate-projections-cmip6-validation-q13-climate-projections-cmip6-validation-q13-section-3-1"></span><h4>3.1. Define plotting functions<a class="headerlink" href="#define-plotting-functions" title="Link to this heading">#</a></h4>
<p>The functions presented here are used to calculate SPEI6 changes and generate corresponding layout plots. Three types of layout can be displayed, depending on the plotting function:</p>
<ol class="arabic simple">
<li><p>Reference and ensemble summary: Includes the ERA5 reference product, the ensemble median, the bias of the ensemble median, and the ensemble spread. This is generated using <code class="docutils literal notranslate"><span class="pre">plot_ensemble()</span></code>.</p></li>
<li><p>Individual models: Displays all models individually using <code class="docutils literal notranslate"><span class="pre">plot_models()</span></code>.</p></li>
<li><p>Model biases: Displays the bias of each model relative to the reference, also using <code class="docutils literal notranslate"><span class="pre">plot_models()</span></code>.</p></li>
</ol>
<p><strong>Calculation of SPEI6 change:</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">compute_spei_change()</span></code> calculates SPEI6 change at each grid point as the arithmetic difference between monthly climatologies of the target period (1991–2020) and the baseline period (1961–1990). It then aggregates the change according to the user-specified <code class="docutils literal notranslate"><span class="pre">time_agg</span></code> (annual, seasonal, or monthly).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">compute_change_4timeseries()</span></code> computes SPEI6 anomalies relative to the baseline climatology for each month of the timeseries and aggregates them according to the <code class="docutils literal notranslate"><span class="pre">time_agg</span></code> parameter. This provides monthly, seasonal, or annual-level information depending on the user’s selection.</p></li>
</ul>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">compute_spei_change</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">baseline_slice</span><span class="p">,</span> <span class="n">target_slice</span><span class="p">,</span> <span class="n">time_agg</span><span class="o">=</span><span class="s2">&quot;annual&quot;</span><span class="p">):</span>
    <span class="c1"># Mapping months to names</span>
    <span class="n">month_map</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;Jan&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;Feb&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="s2">&quot;Mar&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="s2">&quot;Apr&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="s2">&quot;May&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="s2">&quot;Jun&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">6</span><span class="p">],</span>
        <span class="s2">&quot;Jul&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">7</span><span class="p">],</span> <span class="s2">&quot;Aug&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">8</span><span class="p">],</span><span class="s2">&quot;Sep&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">9</span><span class="p">],</span> <span class="s2">&quot;Oct&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">10</span><span class="p">],</span> <span class="s2">&quot;Nov&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">11</span><span class="p">],</span> <span class="s2">&quot;Dec&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">12</span><span class="p">]}</span>

    <span class="c1"># Mapping seasons to months</span>
    <span class="n">season_map</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;DJF&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">12</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span><span class="s2">&quot;MAM&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span>
                  <span class="s2">&quot;JJA&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">],</span><span class="s2">&quot;SON&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">]}</span>
    
    <span class="n">valid_opts</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;annual&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">season_map</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">month_map</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="k">assert</span> <span class="n">time_agg</span> <span class="ow">in</span> <span class="n">valid_opts</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Invalid option: </span><span class="si">{</span><span class="n">time_agg</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="c1"># Select baseline and target periods</span>
    <span class="n">baseline</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">baseline_slice</span><span class="o">.</span><span class="n">start</span><span class="si">}</span><span class="s2">-01&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">baseline_slice</span><span class="o">.</span><span class="n">stop</span><span class="si">}</span><span class="s2">-12&quot;</span><span class="p">))[</span><span class="s2">&quot;spei&quot;</span><span class="p">]</span>
    <span class="n">target</span>   <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">target_slice</span><span class="o">.</span><span class="n">start</span><span class="si">}</span><span class="s2">-01&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">target_slice</span><span class="o">.</span><span class="n">stop</span><span class="si">}</span><span class="s2">-12&quot;</span><span class="p">))[</span><span class="s2">&quot;spei&quot;</span><span class="p">]</span>
    <span class="c1"># Monthly climatologies </span>
    <span class="n">clim_baseline</span> <span class="o">=</span> <span class="n">baseline</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;time.month&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="n">keep_attrs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">clim_target</span>   <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;time.month&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="n">keep_attrs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1">#get delta</span>
    <span class="n">delta_time</span> <span class="o">=</span> <span class="n">clim_target</span> <span class="o">-</span> <span class="n">clim_baseline</span>
    <span class="n">delta_time</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;spei&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span>  
    <span class="c1"># Aggregate according to user choice</span>
    <span class="k">if</span> <span class="n">time_agg</span> <span class="o">==</span> <span class="s2">&quot;annual&quot;</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">delta_time</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s2">&quot;month&quot;</span><span class="p">,</span> <span class="n">keep_attrs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">time_agg</span> <span class="ow">in</span> <span class="n">season_map</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">delta_time</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">month</span><span class="o">=</span><span class="n">season_map</span><span class="p">[</span><span class="n">time_agg</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s2">&quot;month&quot;</span><span class="p">,</span> <span class="n">keep_attrs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">time_agg</span> <span class="ow">in</span> <span class="n">month_map</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">delta_time</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">month</span><span class="o">=</span><span class="n">month_map</span><span class="p">[</span><span class="n">time_agg</span><span class="p">])</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="s2">&quot;month&quot;</span><span class="p">)</span>
        <span class="n">result</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;spei&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span>  

    <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span><span class="w"> </span><span class="nf">compute_change_4timeseries</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">baseline_slice</span><span class="p">,</span> <span class="n">time_agg</span><span class="o">=</span><span class="s2">&quot;annual&quot;</span><span class="p">):</span>
    <span class="c1"># Mapping months to names</span>
    <span class="n">month_map</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;Jan&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;Feb&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="s2">&quot;Mar&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="s2">&quot;Apr&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="s2">&quot;May&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="s2">&quot;Jun&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">6</span><span class="p">],</span>
        <span class="s2">&quot;Jul&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">7</span><span class="p">],</span> <span class="s2">&quot;Aug&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">8</span><span class="p">],</span><span class="s2">&quot;Sep&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">9</span><span class="p">],</span> <span class="s2">&quot;Oct&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">10</span><span class="p">],</span> <span class="s2">&quot;Nov&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">11</span><span class="p">],</span> <span class="s2">&quot;Dec&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">12</span><span class="p">]}</span>

    <span class="c1"># Mapping seasons to months</span>
    <span class="n">season_map</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;DJF&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">12</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span><span class="s2">&quot;MAM&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span>
                  <span class="s2">&quot;JJA&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">],</span><span class="s2">&quot;SON&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">]}</span>
    <span class="n">valid_opts</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;annual&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">season_map</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">month_map</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="k">assert</span> <span class="n">time_agg</span> <span class="ow">in</span> <span class="n">valid_opts</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Invalid option: </span><span class="si">{</span><span class="n">time_agg</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="c1"># Select baseline period</span>
    <span class="n">baseline</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">baseline_slice</span><span class="o">.</span><span class="n">start</span><span class="si">}</span><span class="s2">-01&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">baseline_slice</span><span class="o">.</span><span class="n">stop</span><span class="si">}</span><span class="s2">-12&quot;</span><span class="p">))[</span><span class="s2">&quot;spei&quot;</span><span class="p">]</span>

    <span class="c1"># Monthly climatology for the baseline</span>
    <span class="n">clim_baseline</span> <span class="o">=</span> <span class="n">baseline</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;time.month&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="n">keep_attrs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Compute monthly anomalies relative to baseline climatology</span>
    <span class="n">anomalies</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;spei&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;time.month&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">clim_baseline</span>

    <span class="c1"># Preserve attributes</span>
    <span class="n">anomalies</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;spei&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span>

    <span class="c1"># Aggregate anomalies</span>
    <span class="k">if</span> <span class="n">time_agg</span> <span class="o">==</span> <span class="s2">&quot;annual&quot;</span><span class="p">:</span>
        <span class="c1"># Group by year</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">anomalies</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;time.year&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="n">keep_attrs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">time_agg</span> <span class="ow">in</span> <span class="n">season_map</span><span class="p">:</span>
        <span class="c1"># Select months for the season, then group by year</span>
        <span class="n">sel_months</span> <span class="o">=</span> <span class="n">season_map</span><span class="p">[</span><span class="n">time_agg</span><span class="p">]</span>
        <span class="n">season_anom</span> <span class="o">=</span> <span class="n">anomalies</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">anomalies</span><span class="p">[</span><span class="s2">&quot;time.month&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">sel_months</span><span class="p">))</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">season_anom</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;time.year&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="n">keep_attrs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">time_agg</span> <span class="ow">in</span> <span class="n">month_map</span><span class="p">:</span>
        <span class="c1"># Select the month, keep time as is</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">anomalies</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">anomalies</span><span class="p">[</span><span class="s2">&quot;time.month&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">month_map</span><span class="p">[</span><span class="n">time_agg</span><span class="p">]))</span>

    <span class="k">return</span> <span class="n">result</span>
    
<span class="k">def</span><span class="w"> </span><span class="nf">plot_trend</span><span class="p">(</span><span class="n">time_series</span><span class="p">,</span> <span class="n">var_values</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">color</span><span class="p">):</span>
    <span class="n">time_numeric</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">time_series</span><span class="o">.</span><span class="n">to_series</span><span class="p">())</span>
    <span class="n">slope</span><span class="p">,</span> <span class="n">intercept</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">p_value</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">linregress</span><span class="p">(</span><span class="n">time_numeric</span><span class="p">,</span> <span class="n">var_values</span><span class="p">)</span>
    <span class="n">trend</span> <span class="o">=</span> <span class="n">intercept</span> <span class="o">+</span> <span class="n">slope</span> <span class="o">*</span> <span class="n">time_numeric</span>
    <span class="n">slope_per_decade</span> <span class="o">=</span> <span class="n">slope</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">*</span> <span class="p">(</span><span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mf">365.25</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="mi">9</span><span class="p">)</span>  <span class="c1"># nanoseconds to decade</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_series</span><span class="p">,</span> <span class="n">trend</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">slope_per_decade</span><span class="p">,</span> <span class="n">p_value</span>

<span class="k">def</span><span class="w"> </span><span class="nf">set_extent</span><span class="p">(</span><span class="n">da</span><span class="p">,</span> <span class="n">axs</span><span class="p">,</span> <span class="n">area</span><span class="p">):</span>
    <span class="n">extent</span> <span class="o">=</span> <span class="p">[</span><span class="n">area</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span>
    <span class="n">extent</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+=</span> <span class="o">-</span><span class="mi">3</span> 
    <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axs</span><span class="p">:</span>
        <span class="c1"># Grid</span>
        <span class="n">subplotspec</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_subplotspec</span><span class="p">()</span>
        <span class="n">gridliners</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">artists</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">Gridliner</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">gl</span> <span class="ow">in</span> <span class="n">gridliners</span><span class="p">:</span>
            <span class="n">gl</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
            <span class="n">gl</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">gridlines</span><span class="p">(</span><span class="n">draw_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.15</span><span class="p">)</span>
            <span class="n">gl</span><span class="o">.</span><span class="n">top_labels</span> <span class="o">=</span> <span class="n">gl</span><span class="o">.</span><span class="n">right_labels</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">gl</span><span class="o">.</span><span class="n">left_labels</span> <span class="o">=</span> <span class="n">subplotspec</span><span class="o">.</span><span class="n">is_first_col</span><span class="p">()</span>
            <span class="n">gl</span><span class="o">.</span><span class="n">bottom_labels</span> <span class="o">=</span> <span class="n">subplotspec</span><span class="o">.</span><span class="n">is_last_row</span><span class="p">()</span>
        <span class="c1"># Extent</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_extent</span><span class="p">(</span><span class="n">extent</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">plot_models</span><span class="p">(</span>
    <span class="n">data</span><span class="p">,</span>
    <span class="n">da_for_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">col_wrap</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
    <span class="n">subplot_kw</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;projection&quot;</span><span class="p">:</span> <span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">()},</span>
    <span class="n">figsize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">layout</span><span class="o">=</span><span class="s2">&quot;constrained&quot;</span><span class="p">,</span>
    <span class="n">area</span><span class="o">=</span><span class="n">area</span><span class="p">,</span>
    <span class="n">flip_cmaps</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">da_for_kwargs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">model_dataarrays</span> <span class="o">=</span> <span class="n">data</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">da_for_kwargs</span> <span class="o">=</span> <span class="n">da_for_kwargs</span> <span class="ow">or</span> <span class="n">data</span>
        <span class="n">model_dataarrays</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">))</span>

    <span class="c1"># Get kwargs</span>
    <span class="n">default_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;robust&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;extend&quot;</span><span class="p">:</span> <span class="s2">&quot;both&quot;</span><span class="p">}</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="n">default_kwargs</span> <span class="o">|</span> <span class="n">kwargs</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">_determine_cmap_params</span><span class="p">(</span><span class="n">da_for_kwargs</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    
    <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
        <span class="o">*</span><span class="p">(</span><span class="n">col_wrap</span><span class="p">,</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">model_dataarrays</span><span class="p">)</span> <span class="o">/</span> <span class="n">col_wrap</span><span class="p">)),</span>
        <span class="n">subplot_kw</span><span class="o">=</span><span class="n">subplot_kw</span><span class="p">,</span>
        <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span>
        <span class="n">layout</span><span class="o">=</span><span class="n">layout</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">axs</span> <span class="o">=</span> <span class="n">axs</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    
    <span class="c1"># Plot only available models</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">da</span><span class="p">),</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">model_dataarrays</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">axs</span><span class="p">):</span>
        <span class="n">pcm</span> <span class="o">=</span> <span class="n">plot</span><span class="o">.</span><span class="n">projected_map</span><span class="p">(</span>
            <span class="n">da</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">show_stats</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">add_colorbar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        
    <span class="c1"># Hide any remaining empty axes</span>
    <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axs</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">model_dataarrays</span><span class="p">):]:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">set_extent</span><span class="p">(</span><span class="n">da_for_kwargs</span><span class="p">,</span> <span class="n">axs</span><span class="p">,</span> <span class="n">area</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span>
        <span class="n">pcm</span><span class="p">,</span>
        <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
        <span class="n">extend</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;extend&quot;</span><span class="p">],</span>
        <span class="n">location</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">da_for_kwargs</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;long_name&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">da_for_kwargs</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;units&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">fig</span>

<span class="k">def</span><span class="w"> </span><span class="nf">plot_ensemble</span><span class="p">(</span>
    <span class="n">da_models</span><span class="p">,</span>
    <span class="n">da_era5</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">subplot_kw</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;projection&quot;</span><span class="p">:</span> <span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">()},</span>
    <span class="n">figsize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">layout</span><span class="o">=</span><span class="s2">&quot;constrained&quot;</span><span class="p">,</span>
    <span class="n">cbar_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">area</span><span class="o">=</span><span class="n">area</span><span class="p">,</span>
    <span class="n">flip_cmaps</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">cmap_params_era5</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">cmap_params_median</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">cmap_params_bias</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">cmap_params_std</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">):</span>
    <span class="c1"># Default behaviour</span>
    <span class="n">default_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;robust&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;extend&quot;</span><span class="p">:</span> <span class="s2">&quot;both&quot;</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">da_era5</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">cbar_kwargs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cbar_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;orientation&quot;</span><span class="p">:</span> <span class="s2">&quot;horizontal&quot;</span><span class="p">}</span>

    <span class="c1"># Create figure and axes</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
        <span class="o">*</span><span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="n">da_era5</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
        <span class="n">subplot_kw</span><span class="o">=</span><span class="n">subplot_kw</span><span class="p">,</span>
        <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span>
        <span class="n">layout</span><span class="o">=</span><span class="n">layout</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">axs</span> <span class="o">=</span> <span class="n">axs</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">axs_iter</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">axs</span><span class="p">)</span>

    <span class="c1"># --- ERA5 plot ---</span>
    <span class="k">if</span> <span class="n">da_era5</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">axs_iter</span><span class="p">)</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">cmap_params_era5</span> <span class="ow">or</span> <span class="n">xr</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">_determine_cmap_params</span><span class="p">(</span>
            <span class="n">da_era5</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="o">**</span><span class="n">default_kwargs</span>
        <span class="p">)</span>
        <span class="n">plot</span><span class="o">.</span><span class="n">projected_map</span><span class="p">(</span>
            <span class="n">da_era5</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">show_stats</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cbar_kwargs</span><span class="o">=</span><span class="n">cbar_kwargs</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span>
        <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;(a) ERA5&quot;</span><span class="p">)</span>

    <span class="c1"># --- Ensemble Median ---</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">axs_iter</span><span class="p">)</span>
    <span class="n">median</span> <span class="o">=</span> <span class="n">da_models</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="n">keep_attrs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">cmap_params_median</span> <span class="ow">or</span> <span class="n">xr</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">_determine_cmap_params</span><span class="p">(</span>
        <span class="n">da_era5</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="o">**</span><span class="n">default_kwargs</span>
    <span class="p">)</span>
    <span class="n">plot</span><span class="o">.</span><span class="n">projected_map</span><span class="p">(</span>
        <span class="n">median</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">show_stats</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cbar_kwargs</span><span class="o">=</span><span class="n">cbar_kwargs</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span>
    <span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;(b) Ensemble Median&quot;</span> <span class="k">if</span> <span class="n">da_era5</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;(a) Ensemble Median&quot;</span><span class="p">)</span>

    <span class="c1"># --- Ensemble Bias (Median - ERA5) ---</span>
    <span class="k">if</span> <span class="n">da_era5</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">axs_iter</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">xr</span><span class="o">.</span><span class="n">set_options</span><span class="p">(</span><span class="n">keep_attrs</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="n">bias</span> <span class="o">=</span> <span class="n">median</span> <span class="o">-</span> <span class="n">da_era5</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">cmap_params_bias</span> <span class="ow">or</span> <span class="n">xr</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">_determine_cmap_params</span><span class="p">(</span>
            <span class="n">bias</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">default_kwargs</span>
        <span class="p">)</span>
        <span class="n">plot</span><span class="o">.</span><span class="n">projected_map</span><span class="p">(</span>
            <span class="n">bias</span><span class="p">,</span>
            <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
            <span class="n">show_stats</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">cbar_kwargs</span><span class="o">=</span><span class="n">cbar_kwargs</span><span class="p">,</span>
            <span class="o">**</span><span class="n">params</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;(c) Ensemble Median Bias&quot;</span><span class="p">)</span>

    <span class="c1"># --- Ensemble Standard Deviation ---</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">axs_iter</span><span class="p">)</span>
    <span class="n">std</span> <span class="o">=</span> <span class="n">da_models</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="n">keep_attrs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">cmap_params_std</span> <span class="ow">or</span> <span class="n">xr</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">_determine_cmap_params</span><span class="p">(</span>
        <span class="n">std</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="o">**</span><span class="n">default_kwargs</span>
    <span class="p">)</span>
    <span class="n">plot</span><span class="o">.</span><span class="n">projected_map</span><span class="p">(</span>
        <span class="n">std</span><span class="p">,</span>
        <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
        <span class="n">show_stats</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">cbar_kwargs</span><span class="o">=</span><span class="n">cbar_kwargs</span><span class="p">,</span>
        <span class="o">**</span><span class="n">params</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;(d) Ensemble Standard Deviation&quot;</span> <span class="k">if</span> <span class="n">da_era5</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;(b) Ensemble Standard Deviation&quot;</span><span class="p">)</span>

    <span class="c1"># Set extent</span>
    <span class="n">set_extent</span><span class="p">(</span><span class="n">da_models</span><span class="p">,</span> <span class="n">axs</span><span class="p">,</span> <span class="n">area</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">fig</span>
</pre></div>
</div>
</div>
</details>
</div>
</section>
<section id="plot-ensemble-maps">
<span id="climate-projections-cmip6-validation-q13-climate-projections-cmip6-validation-q13-section-3-2"></span><h4>3.2. Plot ensemble maps<a class="headerlink" href="#plot-ensemble-maps" title="Link to this heading">#</a></h4>
<p>In this section, we invoke the <code class="docutils literal notranslate"><span class="pre">plot_ensemble()</span></code> function to visualise the SPEI6 change for the following: (a) the reference ERA5 product, (b) the ensemble median (defined as the median of the change values for the selected subset of models at each grid cell), (c) the bias of the ensemble median, and (d) the ensemble spread (calculated as the standard deviation of the change across the selected subset of models).</p>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Change default colorbars</span>
<span class="n">cbars</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;cmap_divergent&quot;</span><span class="p">:</span> <span class="s2">&quot;BrBG&quot;</span><span class="p">,</span> <span class="s2">&quot;cmap_sequential&quot;</span><span class="p">:</span> <span class="s2">&quot;viridis&quot;</span><span class="p">,}</span>
<span class="n">xr</span><span class="o">.</span><span class="n">set_options</span><span class="p">(</span><span class="o">**</span><span class="n">cbars</span><span class="p">)</span>
<span class="c1"># Shared colorbar for ERA5 and ensemble median</span>
<span class="n">shared_cmap_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;BrBG&quot;</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">robust</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">extend</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">)</span>

<span class="c1"># Title</span>
<span class="n">common_title</span> <span class="o">=</span> <span class="p">(</span>
    <span class="sa">f</span><span class="s2">&quot;SPEI</span><span class="si">{</span><span class="n">window</span><span class="si">}</span><span class="s2"> (ref. period </span><span class="si">{</span><span class="n">reference_slice</span><span class="o">.</span><span class="n">start</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">reference_slice</span><span class="o">.</span><span class="n">stop</span><span class="si">}</span><span class="s2">) | &quot;</span>
    <span class="sa">f</span><span class="s2">&quot;Change in climatology: target (</span><span class="si">{</span><span class="n">target_slice</span><span class="o">.</span><span class="n">start</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">target_slice</span><span class="o">.</span><span class="n">stop</span><span class="si">}</span><span class="s2">) &quot;</span>
    <span class="sa">f</span><span class="s2">&quot;minus baseline (</span><span class="si">{</span><span class="n">baseline_slice</span><span class="o">.</span><span class="n">start</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">baseline_slice</span><span class="o">.</span><span class="n">stop</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    
<span class="c1">#Get spei change</span>
<span class="n">da_era5</span> <span class="o">=</span> <span class="n">compute_spei_change</span><span class="p">(</span><span class="n">ds_era5</span><span class="p">,</span> <span class="n">baseline_slice</span><span class="p">,</span> <span class="n">target_slice</span><span class="p">,</span><span class="n">time_agg</span><span class="o">=</span><span class="n">time_agg</span><span class="p">)</span>
<span class="n">da_interpolated</span> <span class="o">=</span> <span class="n">compute_spei_change</span><span class="p">(</span><span class="n">ds_interpolated</span><span class="p">,</span> <span class="n">baseline_slice</span><span class="p">,</span> <span class="n">target_slice</span><span class="p">,</span><span class="n">time_agg</span><span class="o">=</span><span class="n">time_agg</span><span class="p">)</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plot_ensemble</span><span class="p">(</span>
    <span class="n">da_models</span><span class="o">=</span><span class="n">da_interpolated</span><span class="p">,</span>
    <span class="n">da_era5</span><span class="o">=</span><span class="n">da_era5</span><span class="p">,</span>
    <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
    <span class="n">cmap_params_era5</span><span class="o">=</span><span class="n">shared_cmap_params</span><span class="p">,</span>
    <span class="n">cmap_params_median</span><span class="o">=</span><span class="n">shared_cmap_params</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">common_title</span><span class="si">}</span><span class="se">\n</span><span class="s2">ERA5 vs </span><span class="si">{</span><span class="n">collection_id</span><span class="si">}</span><span class="s2"> ensemble | </span><span class="si">{</span><span class="n">time_agg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>    
<span class="c1"># Show the plot</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">common_title</span><span class="si">}</span><span class="se">\n</span><span class="s2">ERA5 vs </span><span class="si">{</span><span class="n">collection_id</span><span class="si">}</span><span class="s2"> ensemble | </span><span class="si">{</span><span class="n">time_agg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../../_images/51ad30ec921c8e83f987c838af2c62cc4bef72714b5eb26072c775f43f46b94e.png" src="../../_images/51ad30ec921c8e83f987c838af2c62cc4bef72714b5eb26072c775f43f46b94e.png" />
</div>
</div>
<div>
    <div style="max-width">
    <p><strong>Fig 1.</strong> 
        Spatial patterns of SPEI6 change over the Mediterranean region. Panels show (a) ERA5 reference, (b) CMIP6 ensemble median (median of the selected subset of models at each grid cell), (c) ensemble median bias relative to ERA5, and (d) ensemble spread (standard deviation across the selected models). SPEI6 is standardised over the reference period 1971–2010. SPEI6 change is calculated at each grid point as the difference between the monthly climatologies of the target period (1991–2020) and the baseline period (1961–1990), and then averaged to obtain the annual mean.
</div></section>
<section id="plot-model-maps">
<span id="climate-projections-cmip6-validation-q13-climate-projections-cmip6-validation-q13-section-3-3"></span><h4>3.3. Plot model maps<a class="headerlink" href="#plot-model-maps" title="Link to this heading">#</a></h4>
<p>In this section, we invoke the <code class="docutils literal notranslate"><span class="pre">plot_models()</span></code> function to visualise the SPEI6 change of every model individually. Note that the model data used in this section maintains its original grid.</p>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">title</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">common_title</span><span class="si">}</span><span class="s2"> </span><span class="se">\n</span><span class="si">{</span><span class="n">collection_id</span><span class="si">}</span><span class="s2"> individual members | </span><span class="si">{</span><span class="n">time_agg</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="n">da_for_kwargs</span> <span class="o">=</span> <span class="n">ds_era5</span><span class="p">[</span><span class="s2">&quot;spei&quot;</span><span class="p">]</span>

<span class="n">data_to_plot</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">compute_spei_change</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">baseline_slice</span><span class="p">,</span> <span class="n">target_slice</span><span class="p">,</span><span class="n">time_agg</span><span class="o">=</span><span class="n">time_agg</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">model</span><span class="p">,</span> <span class="n">ds</span> <span class="ow">in</span> <span class="n">model_datasets</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
<span class="p">}</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plot_models</span><span class="p">(</span>
    <span class="n">data_to_plot</span><span class="p">,</span>
    <span class="n">da_for_kwargs</span><span class="o">=</span><span class="n">da_for_kwargs</span><span class="p">,</span>
    <span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">16</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span>
<span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../../_images/707e13e8de5e293edf24ec1a2225b6cb634a658b639fa61647a2aaa9c8198ac1.png" src="../../_images/707e13e8de5e293edf24ec1a2225b6cb634a658b639fa61647a2aaa9c8198ac1.png" />
</div>
</div>
<div>
    <div style="max-width">
    <p><strong>Fig 2.</strong>
        Spatial patterns of SPEI6 change for each individual CMIP6 model over the Mediterranean region. SPEI6 is standardised over the reference period 1971–2010. For each model, SPEI6 change is calculated at each grid point as the difference between the monthly climatologies of the target period (1991–2020) and the baseline period (1961–1990), and then averaged to obtain the annual mean. 
</div></section>
<section id="plot-bias-maps">
<span id="climate-projections-cmip6-validation-q13-climate-projections-cmip6-validation-q13-section-3-4"></span><h4>3.4. Plot bias maps<a class="headerlink" href="#plot-bias-maps" title="Link to this heading">#</a></h4>
<p>In this section, we invoke the <code class="docutils literal notranslate"><span class="pre">plot_models()</span></code> function to visualise the bias of the vSPEI6 change for every model individually. Note that the model data used in this section has previously been interpolated to the ERA5 grid. Regridding is performed for each essential climate variable before the index calculation to preserve standardisation.</p>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">title</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">common_title</span><span class="si">}</span><span class="s2"> </span><span class="se">\n</span><span class="si">{</span><span class="n">collection_id</span><span class="si">}</span><span class="s2"> Individual members’ biases | </span><span class="si">{</span><span class="n">time_agg</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="k">with</span> <span class="n">xr</span><span class="o">.</span><span class="n">set_options</span><span class="p">(</span><span class="n">keep_attrs</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">dataset</span><span class="p">,</span> <span class="n">dataset_era</span> <span class="o">=</span> <span class="n">ds_interpolated</span><span class="p">,</span> <span class="n">ds_era5</span>
    <span class="n">bias</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">compute_spei_change</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">baseline_slice</span><span class="p">,</span> <span class="n">target_slice</span><span class="p">,</span><span class="n">time_agg</span><span class="o">=</span><span class="n">time_agg</span><span class="p">)</span>
        <span class="o">-</span> <span class="n">compute_spei_change</span><span class="p">(</span><span class="n">dataset_era</span><span class="p">,</span> <span class="n">baseline_slice</span><span class="p">,</span> <span class="n">target_slice</span><span class="p">,</span><span class="n">time_agg</span><span class="o">=</span><span class="n">time_agg</span><span class="p">)</span>
    <span class="p">)</span>       
<span class="n">fig</span> <span class="o">=</span> <span class="n">plot_models</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">bias</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">16</span><span class="p">,</span><span class="mi">5</span><span class="p">])</span>
<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../../_images/b4a60afa83cd4a1eb36346c86520245fdd5c0641b9e1f6e8fb0107ff4e6590fc.png" src="../../_images/b4a60afa83cd4a1eb36346c86520245fdd5c0641b9e1f6e8fb0107ff4e6590fc.png" />
</div>
</div>
<div>
    <div style="max-width">
    <p><strong>Fig 3.</strong>
        Bias of SPEI6 change for each individual CMIP6 model relative to ERA5 over the Mediterranean region. SPEI6 is standardised over the reference period 1971–2010. For each model and ERA5, SPEI6 change is calculated at each grid point as the difference between the monthly climatologies of the target period (1991–2020) and the baseline period (1961–1990), and then averaged to obtain the annual mean. 
</div></section>
<section id="timeseries">
<span id="climate-projections-cmip6-validation-q13-climate-projections-cmip6-validation-q13-section-3-5"></span><h4>3.5. Timeseries<a class="headerlink" href="#timeseries" title="Link to this heading">#</a></h4>
<p>This section examines the time series of SPEI6 anomalies relative to the baseline climatology. We first use <code class="docutils literal notranslate"><span class="pre">compute_change_4timeseries()</span></code>, which calculates SPEI6 anomalies for each month of the timeseries (relative to the baseline climatology of each month) and aggregates them according to the <code class="docutils literal notranslate"><span class="pre">time_agg</span> <span class="pre">parameter</span></code>. Spatially averaged values are then obtained. Light grey shading highlights the baseline period, while darker grey shading marks the target period. The analysis compares the CMIP6 ensemble median, ERA5, and individual models, displaying trends for both ERA5 and the ensemble median. Additionally, it shows the ensemble spread and the slope values of the trends for ERA5 and the CMIP6 ensemble median.</p>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define colors</span>
<span class="n">colors</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;CMIP6&quot;</span><span class="p">:</span> <span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="s2">&quot;ERA5&quot;</span><span class="p">:</span> <span class="s2">&quot;black&quot;</span><span class="p">}</span>

<span class="c1"># Cutout region</span>
<span class="n">regionalise_kwargs</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;lon_slice&quot;</span><span class="p">:</span> <span class="nb">slice</span><span class="p">(</span><span class="n">area</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">area</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span>
    <span class="s2">&quot;lat_slice&quot;</span><span class="p">:</span> <span class="nb">slice</span><span class="p">(</span><span class="n">area</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">area</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
<span class="p">}</span>

<span class="c1"># Compute the change/anomaly for ERA5</span>
<span class="n">ds_era5_change</span> <span class="o">=</span> <span class="n">compute_change_4timeseries</span><span class="p">(</span><span class="n">ds_era5</span><span class="p">,</span> <span class="n">baseline_slice</span><span class="p">,</span> <span class="n">time_agg</span><span class="p">)</span>

<span class="c1"># Regionalise and compute spatially weighted mean</span>
<span class="n">era5_mean</span> <span class="o">=</span> <span class="n">diagnostics</span><span class="o">.</span><span class="n">spatial_weighted_mean</span><span class="p">(</span>
    <span class="n">utils</span><span class="o">.</span><span class="n">regionalise</span><span class="p">(</span><span class="n">ds_era5_change</span><span class="p">,</span> <span class="o">**</span><span class="n">regionalise_kwargs</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">era5_mean</span><span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">]</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">era5_mean</span><span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;%Y&#39;</span><span class="p">)</span>


<span class="c1"># Compute change/anomaly for each model and spatially aggregate</span>
<span class="n">cmip6_means</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">model</span><span class="p">,</span> <span class="n">ds</span> <span class="ow">in</span> <span class="n">model_datasets</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">ds_model_change</span> <span class="o">=</span> <span class="n">compute_change_4timeseries</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">baseline_slice</span><span class="p">,</span> <span class="n">time_agg</span><span class="p">)</span>
    <span class="n">ds_model_change</span><span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">]</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">ds_model_change</span><span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;%Y&#39;</span><span class="p">)</span>
    <span class="n">ds_model_regional</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">regionalise</span><span class="p">(</span><span class="n">ds_model_change</span><span class="p">,</span> <span class="o">**</span><span class="n">regionalise_kwargs</span><span class="p">)</span>
    <span class="n">cmip6_mean</span> <span class="o">=</span> <span class="n">diagnostics</span><span class="o">.</span><span class="n">spatial_weighted_mean</span><span class="p">(</span><span class="n">ds_model_regional</span><span class="p">)</span>
    <span class="n">cmip6_means</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cmip6_mean</span><span class="p">)</span>

<span class="c1"># Ensemble statistics</span>
<span class="n">cmip6_stack</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">cmip6_means</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="s2">&quot;model&quot;</span><span class="p">)</span>
<span class="n">cmip6_var</span> <span class="o">=</span> <span class="n">cmip6_stack</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="n">keep_attrs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">cmip6_std</span> <span class="o">=</span> <span class="n">cmip6_stack</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="n">keep_attrs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Initialize plot</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

<span class="c1"># Plot individual model time series</span>
<span class="k">for</span> <span class="n">model_data</span> <span class="ow">in</span> <span class="n">cmip6_means</span><span class="p">:</span>
    <span class="n">model_values</span> <span class="o">=</span> <span class="n">model_data</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="k">if</span> <span class="n">model_data</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">model_data</span><span class="o">.</span><span class="n">values</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">model_data</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">],</span> <span class="n">model_values</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;grey&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>

<span class="c1"># Add legend entry for individual models</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([],</span> <span class="p">[],</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Individual Models&#39;</span><span class="p">)</span>

<span class="c1"># Plot ERA5</span>
<span class="n">era5_mean</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;ERA5&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="s2">&quot;ERA5&quot;</span><span class="p">])</span>

<span class="c1"># Plot CMIP6 median</span>
<span class="n">cmip6_var</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;CMIP6 Median&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="s2">&quot;CMIP6&quot;</span><span class="p">])</span>

<span class="c1"># Fill ±1 std (spread)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span>
    <span class="n">cmip6_var</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">],</span>
    <span class="n">cmip6_var</span><span class="o">.</span><span class="n">values</span> <span class="o">-</span> <span class="n">cmip6_std</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">cmip6_var</span><span class="o">.</span><span class="n">values</span> <span class="o">+</span> <span class="n">cmip6_std</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">color</span> <span class="o">=</span> <span class="n">colors</span><span class="p">[</span><span class="s2">&quot;CMIP6&quot;</span><span class="p">],</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
    <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;CMIP6 Spread&quot;</span>
<span class="p">)</span>

<span class="c1"># Compute trends</span>
<span class="n">slope_era5</span><span class="p">,</span> <span class="n">p_value_era5</span> <span class="o">=</span> <span class="n">plot_trend</span><span class="p">(</span>
    <span class="n">era5_mean</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">][</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">era5_mean</span><span class="o">.</span><span class="n">values</span><span class="p">)],</span>
    <span class="n">era5_mean</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">era5_mean</span><span class="o">.</span><span class="n">values</span><span class="p">)],</span>
    <span class="s2">&quot;ERA5 Trend&quot;</span><span class="p">,</span>
    <span class="n">colors</span><span class="p">[</span><span class="s2">&quot;ERA5&quot;</span><span class="p">]</span>
<span class="p">)</span>

<span class="n">slope_cmip6</span><span class="p">,</span> <span class="n">p_value_cmip6</span> <span class="o">=</span> <span class="n">plot_trend</span><span class="p">(</span>
    <span class="n">cmip6_var</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">][</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">cmip6_var</span><span class="o">.</span><span class="n">values</span><span class="p">)],</span>
    <span class="n">cmip6_var</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">cmip6_var</span><span class="o">.</span><span class="n">values</span><span class="p">)],</span>
    <span class="s2">&quot;CMIP6 Median Trend&quot;</span><span class="p">,</span>
    <span class="n">colors</span><span class="p">[</span><span class="s2">&quot;CMIP6&quot;</span><span class="p">]</span>
<span class="p">)</span>

<span class="n">trend_info</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="s2">&quot;ERA5&quot;</span><span class="p">,</span> <span class="n">slope_era5</span><span class="p">,</span> <span class="n">p_value_era5</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;CMIP6 Median&quot;</span><span class="p">,</span> <span class="n">slope_cmip6</span><span class="p">,</span> <span class="n">p_value_cmip6</span><span class="p">)</span>
<span class="p">]</span>

<span class="c1"># Labels and grid</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Year&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Fraction of unity&quot;</span><span class="p">)</span>
<span class="n">title</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SPEI</span><span class="si">{</span><span class="n">window</span><span class="si">}</span><span class="s2"> (ref. period </span><span class="si">{</span><span class="n">reference_slice</span><span class="o">.</span><span class="n">start</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">reference_slice</span><span class="o">.</span><span class="n">stop</span><span class="si">}</span><span class="s2">) | Change rel. to </span><span class="si">{</span><span class="n">baseline_slice</span><span class="o">.</span><span class="n">start</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">baseline_slice</span><span class="o">.</span><span class="n">stop</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;Target period: (</span><span class="si">{</span><span class="n">target_slice</span><span class="o">.</span><span class="n">start</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">target_slice</span><span class="o">.</span><span class="n">stop</span><span class="si">}</span><span class="s2">) | </span><span class="si">{</span><span class="n">time_agg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>

    
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Format x-axis as years</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">mdates</span><span class="o">.</span><span class="n">DateFormatter</span><span class="p">(</span><span class="s1">&#39;%Y&#39;</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">autofmt_xdate</span><span class="p">()</span>

<span class="c1"># Annotate trends</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
    <span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.015</span><span class="p">,</span>
    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> Trend: </span><span class="si">{</span><span class="n">trend</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> (fraction of unity/decade), p-value: </span><span class="si">{</span><span class="n">p</span><span class="si">:</span><span class="s2">.3e</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">trend</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">trend_info</span>
    <span class="p">]),</span>
    <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
    <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
    <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
    <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">boxstyle</span><span class="o">=</span><span class="s2">&quot;square,pad=0.5&quot;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;lightgray&quot;</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">((</span><span class="o">-</span><span class="mf">1.7</span><span class="p">,</span> <span class="mf">1.7</span><span class="p">))</span>
<span class="c1"># Shade baseline period (light gray)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">baseline_slice</span><span class="o">.</span><span class="n">start</span><span class="p">)),</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">baseline_slice</span><span class="o">.</span><span class="n">stop</span><span class="p">)),</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;lightgray&quot;</span><span class="p">,</span>
    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Baseline period&quot;</span>
<span class="p">)</span>

<span class="c1"># Shade target period (grey)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">target_slice</span><span class="o">.</span><span class="n">start</span><span class="p">)),</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">target_slice</span><span class="o">.</span><span class="n">stop</span><span class="p">)),</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;grey&quot;</span><span class="p">,</span>
    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Target period&quot;</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../../_images/f749e4e64faf42d112ee8fa50e091a31a85f8d2b0df1443dc5486715826a0e13.png" src="../../_images/f749e4e64faf42d112ee8fa50e091a31a85f8d2b0df1443dc5486715826a0e13.png" />
</div>
</div>
<div>
    <div style="max-width">
    <p><strong>Fig 4.</strong>
        Time series of SPEI6 anomalies over the Mediterranean region, calculated relative to the baseline climatology. Monthly anomalies are aggregated according to the specified timescale and then spatially averaged over the region. Light grey shading indicates the baseline period, and dark grey shading indicates the target period. The figure compares ERA5, the CMIP6 ensemble median, and individual models, showing trends for ERA5 and the ensemble median, as well as the ensemble spread and slope values of the trends.
</div></section>
<section id="results-summary">
<span id="climate-projections-cmip6-validation-q13-climate-projections-cmip6-validation-q13-section-3-6"></span><h4>3.6. Results summary<a class="headerlink" href="#results-summary" title="Link to this heading">#</a></h4>
<ul class="simple">
<li><p>ERA5 indicates a general intensification of drought conditions over the Mediterranean region when comparing the baseline (1961–1990) and target (1991–2020) periods.</p></li>
<li><p>The CMIP6 ensemble median captures this SPEI6 change signal, but the magnitude of the increase in drought conditions is underestimated, particularly over eastern Spain, southern France, and much of Turkey.</p></li>
<li><p>With respect to inter-model spread, models do not reproduce the same spatial pattern. The largest spread appears over North African countries bordering the Mediterranean, Turkey, Lebanon, and Syria, and to a lesser extent over the Balkans, Portugal, and central and western Spain.</p></li>
<li><p>Time series of spatial means over the Mediterranean confirm this increase in drought conditions and the underestimation by CMIP6 models, with trends of –0.15 for ERA5 and –0.08 (about half) for the CMIP6 median.</p></li>
</ul>
</section>
<section id="implications-for-the-users">
<span id="climate-projections-cmip6-validation-q13-climate-projections-cmip6-validation-q13-section-3-7"></span><h4>3.7. Implications for the users<a class="headerlink" href="#implications-for-the-users" title="Link to this heading">#</a></h4>
<ul class="simple">
<li><p>Models do not reproduce the same exact spatial pattern, but the ensemble median captures the SPEI6 change. This underlines the importance of considering large ensembles rather than relying on a single or a few models.</p></li>
<li><p>Although the CMIP6 ensemble median captures the intensification of drought conditions, caution is needed when looking into the future. Precipitation projections generally involve more uncertainty than temperature, and model biases may evolve under changing climate conditions <a class="reference external" href="https://doi.org/10.5194/hess-25-273-2021" rel="noreferrer" target="_blank">[9]</a>.</p></li>
<li><p>This assessment shows consistent results with those obtained in the <a class="reference external" href="https://confluence.ecmwf.int/display/CKB/Gridded+data+underpinning+the+Copernicus+Interactive+Climate+Atlas%3A+Description+of+the+datasets+and+variables#GriddeddataunderpinningtheCopernicusInteractiveClimateAtlas:Descriptionofthedatasetsandvariables" rel="noreferrer" target="_blank">C3S Atlas</a>. In addition, it provides users with insight into the rationale behind SPEI and how models reproduce historical conditions over the Mediterranean, reinforcing its value as a tool for water management and drought preparedness.</p></li>
<li><p>The pronounced inter-model spread over North Africa, Turkey, and the eastern Mediterranean implies that users in these regions may face higher future uncertainty. This highlights the need to stress-test adaptation strategies against a wide range of plausible futures rather than relying on a single scenario.</p></li>
</ul>
</section>
</section>
</section>
<section id="i-if-you-want-to-know-more">
<h2>ℹ️ If you want to know more<a class="headerlink" href="#i-if-you-want-to-know-more" title="Link to this heading">#</a></h2>
<section id="key-resources">
<h3>Key resources<a class="headerlink" href="#key-resources" title="Link to this heading">#</a></h3>
<p>Some key resources and further reading were linked throughout this assessment.</p>
<p>The CDS catalogue entries for the data used were:</p>
<ul class="simple">
<li><p>CMIP6 climate projections (daily - daily maximum near-surface air temperature, daily minimum near-surface air temperature and precipitation): <a class="reference external" href="https://cds.climate.copernicus.eu/datasets/projections-cmip6?tab=overview" rel="noreferrer" target="_blank">https://cds.climate.copernicus.eu/datasets/projections-cmip6?tab=overview</a></p></li>
<li><p>ERA5 hourly data on single levels from 1940 to present (2m temperature and total precipitation): <a class="reference external" href="https://cds.climate.copernicus.eu/datasets/reanalysis-era5-pressure-levels-monthly-means?tab=overview" rel="noreferrer" target="_blank">https://cds.climate.copernicus.eu/datasets/reanalysis-era5-pressure-levels-monthly-means?tab=overview</a></p></li>
</ul>
<p>Code libraries used:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/bopen/c3s-eqc-automatic-quality-control/tree/main/c3s_eqc_automatic_quality_control" rel="noreferrer" target="_blank">C3S EQC custom functions</a>, <code class="docutils literal notranslate"><span class="pre">c3s_eqc_automatic_quality_control</span></code>,  prepared by <a class="reference external" href="https://www.bopen.eu/" rel="noreferrer" target="_blank">B-Open</a></p></li>
</ul>
</section>
<section id="references">
<h3>References<a class="headerlink" href="#references" title="Link to this heading">#</a></h3>
<p><a class="reference external" href="https://doi.org/10.1175/2009JCLI2909.1" rel="noreferrer" target="_blank">[1]</a> Vicente-Serrano, S. M., Beguerı́a, S., and López-Moreno, J. I., 2010.  A multiscalar drought index sensitive to global warming: The standardized precipitation evapotranspiration index, Journal of Climate, 23, 1696–1718. <a class="reference external" href="https://doi.org/10.1175/2009JCLI2909.1" rel="noreferrer" target="_blank">https://doi.org/10.1175/2009JCLI2909.1</a></p>
<p><a class="reference external" href="https://digitalcommons.unl.edu/droughtfacpub/69/" rel="noreferrer" target="_blank">[2]</a> Wilhite, D. A., 2000. Droughts as a natural hazard: concepts and definitions. In: DROUGHT, A Global Assessment, vol. I and II, Routledge Hazards and Disasters Series, Routledge.</p>
<p><a class="reference external" href="https://doi.org/10.1175/2012EI000434.1" rel="noreferrer" target="_blank">[3]</a> Vicente-Serrano, S. M., Beguerı́a, S., Lorenzo-Lacruz, J., Camarero, J. J., López-Moreno, J. I., Azorin-Molina, C., Revuelto, J., Morán-Tejeda, E., and Sanchez-Lorenzo, A., 2012. Performance of drought indices for ecological, agricultural, and hydrological applications, Earth Interactions, 16, <a class="reference external" href="https://doi.org/10.1175/2012EI000434.1" rel="noreferrer" target="_blank">https://doi.org/10.1175/2012EI000434.1</a></p>
<p><a class="reference external" href="https://doi.org/10.1016/j.scitotenv.2019.135245" rel="noreferrer" target="_blank">[4]</a> Yao, N., Li, L., Feng, P., Feng, H., Liu, D. L., Liu, Y., Jiang, K., Hu, X., and Li, Y., 2020. Projections of drought characteristics in China based on a standardized precipitation and evapotranspiration index and multiple GCMs. Science of The Total Environment, 704, 135245. <a class="reference external" href="https://doi.org/10.1016/j.scitotenv.2019.135245" rel="noreferrer" target="_blank">https://doi.org/10.1016/j.scitotenv.2019.135245</a></p>
<p><a class="reference external" href="https://doi.org/10.3390/w17101507" rel="noreferrer" target="_blank">[5]</a> Tuong, V. Q., Kiet, B. A., and Pham, T. T., 2025. Assessment of Future Drought Characteristics Using Various Temporal Scales and Multiple Drought Indices over Mekong Basin Under Climate Changes. Water, 17(10), 1507. <a class="reference external" href="https://doi.org/10.3390/w17101507" rel="noreferrer" target="_blank">https://doi.org/10.3390/w17101507</a></p>
<p><a class="reference external" href="https://doi.org/10.5194/essd-12-2959-2020" rel="noreferrer" target="_blank">[6]</a> Iturbide, M., Gutiérrez, J. M., Alves, L. M., Bedia, J., Cerezo-Mota, R., Cimadevilla, E., Cofiño, A. S., Di Luca, A., Faria, S. H., Gorodetskaya, I. V., Hauser, M., Herrera, S., Hennessy, K., Hewitt, H. T., Jones, R. G., Krakovska, S., Manzanas, R., Martínez-Castro, D., Narisma, G. T., Nurhati, I. S., Pinto, I., Seneviratne, S. I., van den Hurk, B., and Vera, C. S., 2020. An update of IPCC climate reference regions for subcontinental analysis of climate model data: definition and aggregated datasets, Earth Syst. Sci. Data, 12, 2959–2970, <a class="reference external" href="https://doi.org/10.5194/essd-12-2959-2020" rel="noreferrer" target="_blank">https://doi.org/10.5194/essd-12-2959-2020</a></p>
<p><a class="reference external" href="https://doi.org/10.13031/2013.26773" rel="noreferrer" target="_blank">[7]</a> Hargreaves, G. H., and Samani, Z. A., 1985. Reference crop evapotranspiration from temperature, Applied engineering in agriculture, pp. 96–99.  <a class="reference external" href="https://doi.org/10.13031/2013.26773" rel="noreferrer" target="_blank">https://doi.org/10.13031/2013.26773</a></p>
<p><a class="reference external" href="https://doi.org/10.1002/joc.3887" rel="noreferrer" target="_blank">[8]</a> Beguerı́a, S., Vicente-Serrano, S. M., Reig, F., and Latorre, B., 2014. Standardized precipitation evapotranspiration index (spei) revisited: Parameter fitting, evapotranspiration models, tools, datasets and drought monitoring, International Journal of Climatology, 34, 3001–3023. <a class="reference external" href="https://doi.org/10.1002/joc.3887" rel="noreferrer" target="_blank">https://doi.org/10.1002/joc.3887</a></p>
<p><a class="reference external" href="https://doi.org/10.5194/hess-25-273-2021" rel="noreferrer" target="_blank">[9]</a> Schmith, T., Thejll, P., Berg, P., Boberg, F., Christensen, O. B., Christiansen, B., Christensen, J. H., Madsen, M. S., and Steger, C., 2021. Identifying robust bias adjustment methods for European extreme precipitation in a multi-model pseudo-reality setting, Hydrol. Earth Syst. Sci., 25, 273–290, <a class="reference external" href="https://doi.org/10.5194/hess-25-273-2021" rel="noreferrer" target="_blank">https://doi.org/10.5194/hess-25-273-2021</a></p>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./Climate_Projections/CMIP6"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="CMIP6.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title"><span class="section-number">5.1. </span>CMIP6</p>
      </div>
    </a>
    <a class="right-next"
       href="../CORDEX/CORDEX.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title"><span class="section-number">5.2. </span>CORDEX</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#use-case-investigating-drought-biases-to-inform-water-management">🌍 Use case: Investigating drought biases to inform water management</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#quality-assessment-question">❓ Quality assessment question</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#quality-assessment-statement">📢 Quality assessment statement</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#methodology">📋 Methodology</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#analysis-and-results">📈 Analysis and results</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#parameters-requests-and-functions-definition">1. Parameters, requests and functions definition</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#import-packages">1.1. Import packages</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#define-parameters">1.2. Define Parameters</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#define-models">1.3. Define models</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#define-era5-request">1.4. Define ERA5 request</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#define-model-requests">1.5. Define model requests</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#functions-to-cache">1.6. Functions to cache</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#downloading-and-processing">2. Downloading and processing</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#download-and-transform-era5">2.1. Download and transform ERA5</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#download-and-transform-models">2.2. Download and transform models</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#apply-land-sea-mask-and-change-some-attributes">2.3. Apply land-sea mask and change some attributes</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-and-describe-results">3. Plot and describe results</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#define-plotting-functions">3.1. Define plotting functions</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-ensemble-maps">3.2. Plot ensemble maps</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-model-maps">3.3. Plot model maps</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-bias-maps">3.4. Plot bias maps</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#timeseries">3.5. Timeseries</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#results-summary">3.6. Results summary</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#implications-for-the-users">3.7. Implications for the users</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#i-if-you-want-to-know-more">ℹ️ If you want to know more</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#key-resources">Key resources</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#references">References</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By the Copernicus Climate Change Service (C3S), entrusted to ECMWF (European Centre for Medium-Range Weather Forecasts)
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2024.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>