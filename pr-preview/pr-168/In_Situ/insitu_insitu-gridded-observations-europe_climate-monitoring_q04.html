
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>2.1. In-situ precipitation assessment for drought monitoring &#8212; eqcbook</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'In_Situ/insitu_insitu-gridded-observations-europe_climate-monitoring_q04';</script>
    <link rel="icon" href="../_static/C3S_favicon.png"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="3. Reanalysis" href="../Reanalyses/reanalysis.html" />
    <link rel="prev" title="2. Insitu Observations" href="insitu.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>
<aside class="bd-header-announcement" aria-label="Announcement">
  <div class="bd-header-announcement__content">‚ö†Ô∏èThis is under development!‚ö†Ô∏è</div>
</aside>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/C3S‚ÄìPOS‚ÄìLINE.png" class="logo__image only-light" alt="eqcbook - Home"/>
    <script>document.write(`<img src="../_static/C3S‚ÄìPOS‚ÄìLINE.png" class="logo__image only-dark" alt="eqcbook - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../intro.html">
                    C3S EQC quality assessments
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">‚û°Ô∏è Satellite Observations</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../Satellite_ECVs/satellite.html">1. Quality assessments for Satellite Observations</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../Satellite_ECVs/Atmosphere_Physics/Atmosphere_Physics.html">1.1. Atmosphere Physics</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="simple">
</ul>
</details></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../Satellite_ECVs/Atmospheric_Composition/Atmospheric_Composition.html">1.2. Atmospheric Composition</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="simple">
</ul>
</details></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../Satellite_ECVs/Cryosphere/Cryosphere.html">1.3. Cryosphere</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="simple">
</ul>
</details></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../Satellite_ECVs/Land_Biosphere/Land_Biosphere.html">1.4. Land Biosphere</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="simple">
</ul>
</details></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../Satellite_ECVs/Land_Hydrology/Land_Hydrology.html">1.5. Land Hydrology</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="simple">
</ul>
</details></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../Satellite_ECVs/Ocean/Ocean.html">1.6. Ocean</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="simple">
</ul>
</details></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">‚û°Ô∏è Insitu Observations</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 current active has-children"><a class="reference internal" href="insitu.html">2. Quality assessments for Insitu Observations</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="current">
<li class="toctree-l2 current active"><a class="current reference internal" href="#">2.1. In-situ precipitation assessment for drought monitoring</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">‚û°Ô∏è Reanalysis</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../Reanalyses/reanalysis.html">3. Quality assessments for Reanalysis</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="simple">
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">‚û°Ô∏è Seasonal Forecasts</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../Seasonal_Forecasts/seasonal.html">4. Quality assessments for Seasonal Forecasts</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="simple">
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">‚û°Ô∏è Climate Projections</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../Climate_Projections/climate.html">5. Quality assessments for Climate Projections</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../Climate_Projections/CMIP6/CMIP6.html">5.1. CMIP6</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="simple">
</ul>
</details></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../Climate_Projections/CORDEX/CORDEX.html">5.2. CORDEX</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="simple">
</ul>
</details></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">‚û°Ô∏è Climate Indicators</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../Indicators/indicator.html">6. Quality assessments for Climate Indicators</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="simple">
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">‚û°Ô∏è Derived Datasets</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../Derived_Datasets/derived.html">7. Quality assessments for Derived Datasets</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="simple">
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">‚û°Ô∏è Applications</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../Applications/application.html">8. Quality assessments for C3S Applications</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="simple">
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Quality assessment template</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../templates/template_instructions.html">Template instructions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../templates/template.html">Template</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/ecmwf-projects/c3s2-eqc-quality-assessment" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/ecmwf-projects/c3s2-eqc-quality-assessment/issues/new?title=Issue%20on%20page%20%2FIn_Situ/insitu_insitu-gridded-observations-europe_climate-monitoring_q04.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/In_Situ/insitu_insitu-gridded-observations-europe_climate-monitoring_q04.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>In-situ precipitation assessment for drought monitoring</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#use-case-adaptation-to-climate-extremes">üåç Use case: Adaptation to Climate Extremes.</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#quality-assessment-question">‚ùì Quality assessment question</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#quality-assessment-statement">üì¢ Quality assessment statement</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#methodology">üìã Methodology</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#analysis-and-results">üìà Analysis and results</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#define-the-aoi-search-and-download-e-obs">1. Define the AoI, search and download E-OBS</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#import-all-the-libraries-packages">Import all the libraries/packages</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#data-overview">Data Overview</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#download-and-prepare-e-obs-data">1.1. Download and prepare E-OBS data</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#inspect-and-view-data">1.2. Inspect and view data</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#calculate-standardized-precipitation-index-spi">2. Calculate Standardized Precipitation Index (SPI)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#calculate-standardized-precipitation-evapotranspiration-index-spei">3. Calculate Standardized Precipitation Evapotranspiration Index (SPEI)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#comparing-spi-and-spei-climatologies">4. Comparing SPI and SPEI Climatologies</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#calculate-linear-trends">5. Calculate Linear Trends</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#discussion">Discussion</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#main-takeaways">6. Main Takeaways</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#i-if-you-want-to-know-more">‚ÑπÔ∏è If you want to know more</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#key-resources">Key resources</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#references">References:</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <p><img alt="logo" src="../_images/LogoLine_horizon_C3S1.png" /></p>
<div class="alert alert-block alert-warning">
Please note that this repository is used for development and review, so quality assessments should be considered work in progress until they are merged into the main branch
</div><section class="tex2jax_ignore mathjax_ignore" id="in-situ-precipitation-assessment-for-drought-monitoring">
<h1><span class="section-number">2.1. </span>In-situ precipitation assessment for drought monitoring<a class="headerlink" href="#in-situ-precipitation-assessment-for-drought-monitoring" title="Link to this heading">#</a></h1>
<p>Production date: 21/10/2024</p>
<p>Produced by: Ana Oliveira and Jo√£o Paix√£o (CoLAB +ATLANTIC)</p>
<section id="use-case-adaptation-to-climate-extremes">
<h2>üåç Use case: Adaptation to Climate Extremes.<a class="headerlink" href="#use-case-adaptation-to-climate-extremes" title="Link to this heading">#</a></h2>
</section>
<section id="quality-assessment-question">
<h2>‚ùì Quality assessment question<a class="headerlink" href="#quality-assessment-question" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p><strong>User Question: How well can we disclose which regions are the most exposed to droughts? What are the observed changes?</strong></p></li>
</ul>
<p>In this Use Case, we will access the E-OBS daily gridded meteorological data for Europe from 1950 to present derived from in-situ observations (henceforth, E-OBS) data from the Climate Data Store (CDS) of the Copernicus Climate Change Service (C3S) and analyse the E-OBS precipitation (RR) drought extremes, over a given Area of Interest (AoI), as a regional example of using E-OBS in the scope of the European State of Climate <a class="reference external" href="https://climate.copernicus.eu/esotc/2023" rel="noreferrer" target="_blank">[1]</a>. The analysis includes drought indicators as defined by the World Meteorological Organization‚Äôs Expert Team on Sector-Specific Climate Indices (ET-SCI) in conjunction with sector experts <a class="reference external" href="https://climpact-sci.org/" rel="noreferrer" target="_blank">[2]</a> <a class="reference external" href="https://library.wmo.int/index.php?lvl=notice_display&amp;amp;id=20130" rel="noreferrer" target="_blank">[3]</a>:</p>
<ul class="simple">
<li><p>(i) Standardized Precipitation Index (SPI);</p></li>
<li><p>(ii) Standardized Precipitation Evapotranspiration Index (SPEI);</p></li>
<li><p>(iii) the corresponding maps, to disclose where drought extremes are changing the most.</p></li>
</ul>
</section>
<section id="quality-assessment-statement">
<h2>üì¢ Quality assessment statement<a class="headerlink" href="#quality-assessment-statement" title="Link to this heading">#</a></h2>
<div class="note admonition">
<p class="admonition-title">These are the key outcomes of this assessment</p>
<ul class="simple">
<li><p>The E-OBS dataset offers a consistent and complete set of gridded meteorological observations over Europe suitable for analysing climate change and extremes, including for precipitation monitoring. <a class="reference external" href="https://doi.org/full/10.1029/2017JD028200" rel="noreferrer" target="_blank">[4]</a></p></li>
<li><p>Its reliance on observation data indicates a more sensitive depiction of extreme values, being fit for drought monitoring. For example, according to <a class="reference external" href="https://doi.org/10.1002/joc.7269" rel="noreferrer" target="_blank">[5]</a> both E-OBS and ERA5 demonstrate accuracy in capturing precipitation patterns, with E-OBS showing good agreement in regions with dense station networks. The authors also concluded that E-OBS can capture extreme values of precipitation in areas with high data density but may smooth out extreme events in data-sparse regions.</p></li>
<li><p>E-OBS has also been prove as useful in monitoring drought conditions over the Iberian Peninsula, showing similar results to those reported in the literature over this region, using other observational gridded data <a class="reference external" href="https://doi.org/10.1016/j.wace.2021.100320" rel="noreferrer" target="_blank">[7]</a>. Indeed, SPEI showcases more significant and pronounced trends over the region, and increased sensitivity in drought detection. Furthermore, results agree with the notion that the Iberian Peninsula is a hotspot for climate change impacts related to drought.</p></li>
<li><p>In an another example, <a class="reference external" href="https://doi.org/10.1002/joc.6950" rel="noreferrer" target="_blank">[6]</a> evaluated the effectiveness of the E-OBS dataset for drought monitoring in Greek wine production areas from 1981 to 2012. E-OBS excelled in reproducing annual decreasing precipitation trends across spring, summer, and autumn, and accurately captured monthly variability, especially in the spring and summer. It demonstrated lower error rates compared to other datasets and performed well in various statistical evaluations, including better simulation of wet and dry day probabilities and extreme precipitation indices. For drought monitoring specifically, E-OBS proved superior when using the Standardized Precipitation Index (SPI).</p></li>
</ul>
</div>
<p><img alt="SPI_SPEI_trendAnalysis_EOBS.png" src="../_images/SPI_SPEI_trendAnalysis_EOBS.png" /></p>
</section>
<section id="methodology">
<h2>üìã Methodology<a class="headerlink" href="#methodology" title="Link to this heading">#</a></h2>
<p><strong><a class="reference internal" href="#insitu-insitu-gridded-observations-europe-climate-monitoring-q04-code-section-1"><span class="std std-ref">1. Define the AoI, search and download E-OBS</span></a></strong><br />
<strong><a class="reference internal" href="#insitu-insitu-gridded-observations-europe-climate-monitoring-q04-code-section-2"><span class="std std-ref">2. Calculate Standardized Precipitation Index (SPI)</span></a></strong><br />
<strong><a class="reference internal" href="#insitu-insitu-gridded-observations-europe-climate-monitoring-q04-code-section-3"><span class="std std-ref">3. Calculate Standardized Precipitation Evapotranspiration Index (SPEI)</span></a></strong><br />
<strong><a class="reference internal" href="#insitu-insitu-gridded-observations-europe-climate-monitoring-q04-code-section-4"><span class="std std-ref">4. Comparing SPI and SPEI Climatologies</span></a></strong><br />
<strong><a class="reference internal" href="#insitu-insitu-gridded-observations-europe-climate-monitoring-q04-code-section-5"><span class="std std-ref">5. Calculate Linear Trends</span></a></strong><br />
<strong><a class="reference internal" href="#insitu-insitu-gridded-observations-europe-climate-monitoring-q04-code-section-6"><span class="std std-ref">6. Main Takeaways</span></a></strong></p>
</section>
<section id="analysis-and-results">
<h2>üìà Analysis and results<a class="headerlink" href="#analysis-and-results" title="Link to this heading">#</a></h2>
<section id="define-the-aoi-search-and-download-e-obs">
<span id="insitu-insitu-gridded-observations-europe-climate-monitoring-q04-code-section-1"></span><h3>1. Define the AoI, search and download E-OBS<a class="headerlink" href="#define-the-aoi-search-and-download-e-obs" title="Link to this heading">#</a></h3>
<section id="import-all-the-libraries-packages">
<h4>Import all the libraries/packages<a class="headerlink" href="#import-all-the-libraries-packages" title="Link to this heading">#</a></h4>
<p>We will be working with data in NetCDF format. To best handle this data we will use libraries for working with multidimensional arrays, in particular Xarray. We will also need libraries for plotting and viewing data, in this case we will use Matplotlib and Cartopy.</p>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">cartopy.crs</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">ccrs</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">xarray</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">xr</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pymannkendall</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mk</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">math</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">calendar</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">norm</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">c3s_eqc_automatic_quality_control</span><span class="w"> </span><span class="kn">import</span> <span class="n">download</span>

<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;figure.figsize&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>
<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s2">&quot;seaborn-v0_8-notebook&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
</div>
</section>
<section id="data-overview">
<h4>Data Overview<a class="headerlink" href="#data-overview" title="Link to this heading">#</a></h4>
<p>To search for data, visit the CDS website: <a class="reference external" href="http://cds.climate.copernicus.eu" rel="noreferrer" target="_blank">http://cds.climate.copernicus.eu</a> Here you can search for ‚Äòin-situ observations‚Äô using the search bar. The data we need for this tutorial is the E-OBS daily gridded meteorological data for Europe from 1950 to present derived from in-situ observations. This catalogue entry provides a daily gridded dataset of historical meteorological observations, covering Europe (land-only), from 1950 to the present. This data is derived from in-situ meteorological stations, made available through the European Climate Assessment &amp; Dataset (ECA&amp;D) project, as provided by National Meteorological and Hydrological Services (NMHSs) and other data-holding institutes.</p>
<p>E-OBS comprises a set of spatially continuous Essential Climate Variables (ECVs) from the Surface Atmosphere, following the Global Climate Observing System (GCOS) convention, provided as the mean and spread of the spatial prediction ensemble algorithm, at regular latitude-longitude grid intervals (at a 0.1¬∞ and 0.25¬∞ spatial resolution), and covering a long time-period, from 1 January 1950 to present-day. In addition to the land surface elevation, E-OBS includes daily air temperature (mean, maximum and minimum), precipitation amount, wind speed, sea-level pressure and shortwave downwelling radiation.</p>
<p>The E-OBS version used for this Use Case, E-OBSv28.0e, was released in October 2023 and its main difference from the previous E-OBSv27.0e is the inclusion of new series and some corrections for precipitation stations.</p>
<p>Having selected the correct dataset, we now need to specify what product type, variables, temporal and geographic coverage we are interested in. In this Use Case, the ensemble mean of precipitation (RR) will be used, considering the last version available (v28.0e). These can all be selected in the ‚ÄúDownload data‚Äù tab from the CDS. In this tab a form appears in which we will select the following parameters to download, for example:</p>
<ul class="simple">
<li><p>Product Type: Ensemble mean</p></li>
<li><p>Variable: daily precipitation sum, and mean temperature</p></li>
<li><p>Grid resolution: 0.25</p></li>
<li><p>Period: Full period</p></li>
<li><p>Version: 28.0e</p></li>
<li><p>Format: Zip file (.zip)</p></li>
</ul>
<p>At the end of the download form, select <code class="docutils literal notranslate"><span class="pre">Show</span> <span class="pre">API</span> <span class="pre">request</span></code>. This will reveal a block of code, which you can simply copy and paste into a cell of your Jupyter Notebook ‚Ä¶</p>
<p>Download data
‚Ä¶ having copied the API request to a Jupyter Notebook cell, running it will retrieve and download the data you requested into your local directory. However, before you run it, the <code class="docutils literal notranslate"><span class="pre">terms</span> <span class="pre">and</span> <span class="pre">conditions</span></code> of this particular dataset need to have been accepted directly at the CDS website. The option to view and accept these conditions is given at the end of the download form, just above the <code class="docutils literal notranslate"><span class="pre">Show</span> <span class="pre">API</span> <span class="pre">request</span></code> option. In addition, it is also useful to define the time period and AoI parameters and edit the request accordingly, as exemplified in the cells below.</p>
</section>
<section id="download-and-prepare-e-obs-data">
<h4>1.1. Download and prepare E-OBS data<a class="headerlink" href="#download-and-prepare-e-obs-data" title="Link to this heading">#</a></h4>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define region of interest - AoI</span>
<span class="n">iberian_peninsula</span><span class="o">=</span><span class="p">[</span><span class="mi">44</span><span class="p">,</span> <span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define request</span>
<span class="n">request</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s2">&quot;insitu-gridded-observations-europe&quot;</span><span class="p">,</span>
    <span class="p">{</span>
        <span class="s2">&quot;format&quot;</span><span class="p">:</span> <span class="s2">&quot;zip&quot;</span><span class="p">,</span>
        <span class="s2">&quot;product_type&quot;</span><span class="p">:</span> <span class="s2">&quot;ensemble_mean&quot;</span><span class="p">,</span>
        <span class="s2">&quot;variable&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;mean_temperature&quot;</span><span class="p">,</span><span class="s2">&quot;precipitation_amount&quot;</span><span class="p">],</span>
        <span class="s2">&quot;grid_resolution&quot;</span><span class="p">:</span> <span class="s2">&quot;0_25deg&quot;</span><span class="p">,</span>
        <span class="s2">&quot;period&quot;</span><span class="p">:</span> <span class="s2">&quot;full_period&quot;</span><span class="p">,</span>
        <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;30_0e&quot;</span><span class="p">,</span>
        <span class="s2">&quot;area&quot;</span><span class="p">:</span> <span class="n">iberian_peninsula</span><span class="p">,</span> <span class="c1">#adjust for other regions</span>
    <span class="p">},</span>
<span class="p">)</span>

<span class="c1"># Process the request</span>
<span class="n">data_EOBS</span> <span class="o">=</span> <span class="n">download</span><span class="o">.</span><span class="n">download_and_transform</span><span class="p">(</span><span class="o">*</span><span class="n">request</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  0%|          | 0/1 [00:00&lt;?, ?it/s]2025-03-12 12:20:48,030 INFO [2024-09-26T00:00:00] Watch our [Forum](https://forum.ecmwf.int/) for Announcements, news and other discussed topics.
2025-03-12 12:20:48,031 WARNING [2024-06-16T00:00:00] CDS API syntax is changed and some keys or parameter names may have also changed. To avoid requests failing, please use the &quot;Show API request code&quot; tool on the dataset Download Form to check you are using the correct syntax for your API request.
2025-03-12 12:20:48,247 INFO [2024-09-26T00:00:00] Watch our [Forum](https://forum.ecmwf.int/) for Announcements, news and other discussed topics.
2025-03-12 12:20:48,248 WARNING [2024-06-16T00:00:00] CDS API syntax is changed and some keys or parameter names may have also changed. To avoid requests failing, please use the &quot;Show API request code&quot; tool on the dataset Download Form to check you are using the correct syntax for your API request.
2025-03-12 12:20:48,632 INFO Request ID is f75f154f-8545-4a20-ba13-a68f5dbe86d2
2025-03-12 12:20:48,726 INFO status has been updated to accepted
2025-03-12 12:20:55,939 INFO status has been updated to running
2025-03-12 12:27:10,129 INFO status has been updated to successful
100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 1/1 [06:41&lt;00:00, 401.42s/it]
</pre></div>
</div>
</div>
</div>
</section>
<section id="inspect-and-view-data">
<h4>1.2. Inspect and view data<a class="headerlink" href="#inspect-and-view-data" title="Link to this heading">#</a></h4>
<p>Now that we have downloaded the data, we can inspect it. We have requested the data in NetCDF format. This is a commonly used format for array-oriented scientific data. To read and process this data we will make use of the Xarray library. Xarray is an open source project and Python package that makes working with labelled multi-dimensional arrays simple and efficient. We will read the data from our NetCDF file into an xarray.Dataset.</p>
<p>To better understand the E-OBS data structure and check the aggregated Daily Mean Precipitation (RR) and the Daily Mean Temperature (TG), we will first need to retrieve the RR variable from the 2 multidimensional netCDF data structures and calculate the descriptive statistics.</p>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Subset data for the year range 1950 to 2020</span>
<span class="n">start_date</span> <span class="o">=</span> <span class="s1">&#39;1950-01-01&#39;</span><span class="p">;</span> <span class="n">end_date</span> <span class="o">=</span> <span class="s1">&#39;2020-12-31&#39;</span>
<span class="n">data_EOBS</span> <span class="o">=</span> <span class="n">data_EOBS</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">))</span>

<span class="c1"># Specify the new variable name, long name and units</span>
<span class="n">new_long_name</span> <span class="o">=</span> <span class="s1">&#39;Daily Precipitation&#39;</span>
<span class="n">new_units</span> <span class="o">=</span> <span class="s1">&#39;mm&#39;</span>

<span class="c1"># Change the variable long name</span>
<span class="n">data_EOBS</span><span class="p">[</span><span class="s1">&#39;rr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_long_name</span>

<span class="c1"># Specify the new variable units</span>
<span class="n">data_EOBS</span><span class="p">[</span><span class="s1">&#39;rr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_units</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Print the xarray data structure</span>
<span class="n">data_EOBS</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output text_html"><div><svg style="position: absolute; width: 0; height: 0; overflow: hidden">
<defs>
<symbol id="icon-database" viewBox="0 0 32 32">
<path d="M16 0c-8.837 0-16 2.239-16 5v4c0 2.761 7.163 5 16 5s16-2.239 16-5v-4c0-2.761-7.163-5-16-5z"></path>
<path d="M16 17c-8.837 0-16-2.239-16-5v6c0 2.761 7.163 5 16 5s16-2.239 16-5v-6c0 2.761-7.163 5-16 5z"></path>
<path d="M16 26c-8.837 0-16-2.239-16-5v6c0 2.761 7.163 5 16 5s16-2.239 16-5v-6c0 2.761-7.163 5-16 5z"></path>
</symbol>
<symbol id="icon-file-text2" viewBox="0 0 32 32">
<path d="M28.681 7.159c-0.694-0.947-1.662-2.053-2.724-3.116s-2.169-2.030-3.116-2.724c-1.612-1.182-2.393-1.319-2.841-1.319h-15.5c-1.378 0-2.5 1.121-2.5 2.5v27c0 1.378 1.122 2.5 2.5 2.5h23c1.378 0 2.5-1.122 2.5-2.5v-19.5c0-0.448-0.137-1.23-1.319-2.841zM24.543 5.457c0.959 0.959 1.712 1.825 2.268 2.543h-4.811v-4.811c0.718 0.556 1.584 1.309 2.543 2.268zM28 29.5c0 0.271-0.229 0.5-0.5 0.5h-23c-0.271 0-0.5-0.229-0.5-0.5v-27c0-0.271 0.229-0.5 0.5-0.5 0 0 15.499-0 15.5 0v7c0 0.552 0.448 1 1 1h7v19.5z"></path>
<path d="M23 26h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
<path d="M23 22h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
<path d="M23 18h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
</symbol>
</defs>
</svg>
<style>/* CSS stylesheet for displaying xarray objects in jupyterlab.
 *
 */

:root {
  --xr-font-color0: var(--jp-content-font-color0, rgba(0, 0, 0, 1));
  --xr-font-color2: var(--jp-content-font-color2, rgba(0, 0, 0, 0.54));
  --xr-font-color3: var(--jp-content-font-color3, rgba(0, 0, 0, 0.38));
  --xr-border-color: var(--jp-border-color2, #e0e0e0);
  --xr-disabled-color: var(--jp-layout-color3, #bdbdbd);
  --xr-background-color: var(--jp-layout-color0, white);
  --xr-background-color-row-even: var(--jp-layout-color1, white);
  --xr-background-color-row-odd: var(--jp-layout-color2, #eeeeee);
}

html[theme=dark],
html[data-theme=dark],
body[data-theme=dark],
body.vscode-dark {
  --xr-font-color0: rgba(255, 255, 255, 1);
  --xr-font-color2: rgba(255, 255, 255, 0.54);
  --xr-font-color3: rgba(255, 255, 255, 0.38);
  --xr-border-color: #1F1F1F;
  --xr-disabled-color: #515151;
  --xr-background-color: #111111;
  --xr-background-color-row-even: #111111;
  --xr-background-color-row-odd: #313131;
}

.xr-wrap {
  display: block !important;
  min-width: 300px;
  max-width: 700px;
}

.xr-text-repr-fallback {
  /* fallback to plain text repr when CSS is not injected (untrusted notebook) */
  display: none;
}

.xr-header {
  padding-top: 6px;
  padding-bottom: 6px;
  margin-bottom: 4px;
  border-bottom: solid 1px var(--xr-border-color);
}

.xr-header > div,
.xr-header > ul {
  display: inline;
  margin-top: 0;
  margin-bottom: 0;
}

.xr-obj-type,
.xr-array-name {
  margin-left: 2px;
  margin-right: 10px;
}

.xr-obj-type {
  color: var(--xr-font-color2);
}

.xr-sections {
  padding-left: 0 !important;
  display: grid;
  grid-template-columns: 150px auto auto 1fr 0 20px 0 20px;
}

.xr-section-item {
  display: contents;
}

.xr-section-item input {
  display: inline-block;
  opacity: 0;
}

.xr-section-item input + label {
  color: var(--xr-disabled-color);
}

.xr-section-item input:enabled + label {
  cursor: pointer;
  color: var(--xr-font-color2);
}

.xr-section-item input:focus + label {
  border: 2px solid var(--xr-font-color0);
}

.xr-section-item input:enabled + label:hover {
  color: var(--xr-font-color0);
}

.xr-section-summary {
  grid-column: 1;
  color: var(--xr-font-color2);
  font-weight: 500;
}

.xr-section-summary > span {
  display: inline-block;
  padding-left: 0.5em;
}

.xr-section-summary-in:disabled + label {
  color: var(--xr-font-color2);
}

.xr-section-summary-in + label:before {
  display: inline-block;
  content: '‚ñ∫';
  font-size: 11px;
  width: 15px;
  text-align: center;
}

.xr-section-summary-in:disabled + label:before {
  color: var(--xr-disabled-color);
}

.xr-section-summary-in:checked + label:before {
  content: '‚ñº';
}

.xr-section-summary-in:checked + label > span {
  display: none;
}

.xr-section-summary,
.xr-section-inline-details {
  padding-top: 4px;
  padding-bottom: 4px;
}

.xr-section-inline-details {
  grid-column: 2 / -1;
}

.xr-section-details {
  display: none;
  grid-column: 1 / -1;
  margin-bottom: 5px;
}

.xr-section-summary-in:checked ~ .xr-section-details {
  display: contents;
}

.xr-array-wrap {
  grid-column: 1 / -1;
  display: grid;
  grid-template-columns: 20px auto;
}

.xr-array-wrap > label {
  grid-column: 1;
  vertical-align: top;
}

.xr-preview {
  color: var(--xr-font-color3);
}

.xr-array-preview,
.xr-array-data {
  padding: 0 5px !important;
  grid-column: 2;
}

.xr-array-data,
.xr-array-in:checked ~ .xr-array-preview {
  display: none;
}

.xr-array-in:checked ~ .xr-array-data,
.xr-array-preview {
  display: inline-block;
}

.xr-dim-list {
  display: inline-block !important;
  list-style: none;
  padding: 0 !important;
  margin: 0;
}

.xr-dim-list li {
  display: inline-block;
  padding: 0;
  margin: 0;
}

.xr-dim-list:before {
  content: '(';
}

.xr-dim-list:after {
  content: ')';
}

.xr-dim-list li:not(:last-child):after {
  content: ',';
  padding-right: 5px;
}

.xr-has-index {
  font-weight: bold;
}

.xr-var-list,
.xr-var-item {
  display: contents;
}

.xr-var-item > div,
.xr-var-item label,
.xr-var-item > .xr-var-name span {
  background-color: var(--xr-background-color-row-even);
  margin-bottom: 0;
}

.xr-var-item > .xr-var-name:hover span {
  padding-right: 5px;
}

.xr-var-list > li:nth-child(odd) > div,
.xr-var-list > li:nth-child(odd) > label,
.xr-var-list > li:nth-child(odd) > .xr-var-name span {
  background-color: var(--xr-background-color-row-odd);
}

.xr-var-name {
  grid-column: 1;
}

.xr-var-dims {
  grid-column: 2;
}

.xr-var-dtype {
  grid-column: 3;
  text-align: right;
  color: var(--xr-font-color2);
}

.xr-var-preview {
  grid-column: 4;
}

.xr-index-preview {
  grid-column: 2 / 5;
  color: var(--xr-font-color2);
}

.xr-var-name,
.xr-var-dims,
.xr-var-dtype,
.xr-preview,
.xr-attrs dt {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  padding-right: 10px;
}

.xr-var-name:hover,
.xr-var-dims:hover,
.xr-var-dtype:hover,
.xr-attrs dt:hover {
  overflow: visible;
  width: auto;
  z-index: 1;
}

.xr-var-attrs,
.xr-var-data,
.xr-index-data {
  display: none;
  background-color: var(--xr-background-color) !important;
  padding-bottom: 5px !important;
}

.xr-var-attrs-in:checked ~ .xr-var-attrs,
.xr-var-data-in:checked ~ .xr-var-data,
.xr-index-data-in:checked ~ .xr-index-data {
  display: block;
}

.xr-var-data > table {
  float: right;
}

.xr-var-name span,
.xr-var-data,
.xr-index-name div,
.xr-index-data,
.xr-attrs {
  padding-left: 25px !important;
}

.xr-attrs,
.xr-var-attrs,
.xr-var-data,
.xr-index-data {
  grid-column: 1 / -1;
}

dl.xr-attrs {
  padding: 0;
  margin: 0;
  display: grid;
  grid-template-columns: 125px auto;
}

.xr-attrs dt,
.xr-attrs dd {
  padding: 0;
  margin: 0;
  float: left;
  padding-right: 10px;
  width: auto;
}

.xr-attrs dt {
  font-weight: normal;
  grid-column: 1;
}

.xr-attrs dt:hover span {
  display: inline-block;
  background: var(--xr-background-color);
  padding-right: 10px;
}

.xr-attrs dd {
  grid-column: 2;
  white-space: pre-wrap;
  word-break: break-all;
}

.xr-icon-database,
.xr-icon-file-text2,
.xr-no-icon {
  display: inline-block;
  vertical-align: middle;
  width: 1em;
  height: 1.5em !important;
  stroke-width: 0;
  stroke: currentColor;
  fill: currentColor;
}
</style><pre class='xr-text-repr-fallback'>&lt;xarray.Dataset&gt; Size: 292MB
Dimensions:    (time: 25933, latitude: 32, longitude: 44)
Coordinates:
  * latitude   (latitude) float64 256B 36.12 36.38 36.62 ... 43.38 43.62 43.88
  * longitude  (longitude) float64 352B -9.875 -9.625 -9.375 ... 0.625 0.875
  * time       (time) datetime64[ns] 207kB 1950-01-01 1950-01-02 ... 2020-12-31
Data variables:
    rr         (time, latitude, longitude) float32 146MB dask.array&lt;chunksize=(13605, 16, 22), meta=np.ndarray&gt;
    tg         (time, latitude, longitude) float32 146MB dask.array&lt;chunksize=(13605, 16, 22), meta=np.ndarray&gt;
Attributes:
    E-OBS_version:  30.0e
    Conventions:    CF-1.4
    References:     http://surfobs.climate.copernicus.eu/dataaccess/access_eo...
    history:        Fri Aug 30 12:51:50 2024: ncks --no-abc -d time,0,27209 /...
    NCO:            netCDF Operators version 5.1.8 (Homepage = http://nco.sf....</pre><div class='xr-wrap' style='display:none'><div class='xr-header'><div class='xr-obj-type'>xarray.Dataset</div></div><ul class='xr-sections'><li class='xr-section-item'><input id='section-7fddb3a3-7a77-4abb-a5fd-edd9a9f4c897' class='xr-section-summary-in' type='checkbox' disabled ><label for='section-7fddb3a3-7a77-4abb-a5fd-edd9a9f4c897' class='xr-section-summary'  title='Expand/collapse section'>Dimensions:</label><div class='xr-section-inline-details'><ul class='xr-dim-list'><li><span class='xr-has-index'>time</span>: 25933</li><li><span class='xr-has-index'>latitude</span>: 32</li><li><span class='xr-has-index'>longitude</span>: 44</li></ul></div><div class='xr-section-details'></div></li><li class='xr-section-item'><input id='section-f29cfc84-b5d5-46e0-ae43-33b05072a750' class='xr-section-summary-in' type='checkbox'  checked><label for='section-f29cfc84-b5d5-46e0-ae43-33b05072a750' class='xr-section-summary' >Coordinates: <span>(3)</span></label><div class='xr-section-inline-details'></div><div class='xr-section-details'><ul class='xr-var-list'><li class='xr-var-item'><div class='xr-var-name'><span class='xr-has-index'>latitude</span></div><div class='xr-var-dims'>(latitude)</div><div class='xr-var-dtype'>float64</div><div class='xr-var-preview xr-preview'>36.12 36.38 36.62 ... 43.62 43.88</div><input id='attrs-1403fe23-9659-48e8-9c45-d085b1eebfff' class='xr-var-attrs-in' type='checkbox' ><label for='attrs-1403fe23-9659-48e8-9c45-d085b1eebfff' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-516b13ec-d6a7-4526-a2f9-acb9186fdcb7' class='xr-var-data-in' type='checkbox'><label for='data-516b13ec-d6a7-4526-a2f9-acb9186fdcb7' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'><dt><span>units :</span></dt><dd>degrees_north</dd><dt><span>long_name :</span></dt><dd>Latitude values</dd><dt><span>axis :</span></dt><dd>Y</dd><dt><span>standard_name :</span></dt><dd>latitude</dd><dt><span>positive :</span></dt><dd>North</dd><dt><span>type :</span></dt><dd>double</dd><dt><span>valid_max :</span></dt><dd>90.0</dd><dt><span>valid_min :</span></dt><dd>-90.0</dd><dt><span>out_name :</span></dt><dd>latitude</dd></dl></div><div class='xr-var-data'><pre>array([36.125, 36.375, 36.625, 36.875, 37.125, 37.375, 37.625, 37.875, 38.125,
       38.375, 38.625, 38.875, 39.125, 39.375, 39.625, 39.875, 40.125, 40.375,
       40.625, 40.875, 41.125, 41.375, 41.625, 41.875, 42.125, 42.375, 42.625,
       42.875, 43.125, 43.375, 43.625, 43.875])</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span class='xr-has-index'>longitude</span></div><div class='xr-var-dims'>(longitude)</div><div class='xr-var-dtype'>float64</div><div class='xr-var-preview xr-preview'>-9.875 -9.625 ... 0.625 0.875</div><input id='attrs-b4fb9c71-6bc8-4198-bdca-562cd784616d' class='xr-var-attrs-in' type='checkbox' ><label for='attrs-b4fb9c71-6bc8-4198-bdca-562cd784616d' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-a6c14bcf-a33f-4d38-b3e8-5c56118c8dd3' class='xr-var-data-in' type='checkbox'><label for='data-a6c14bcf-a33f-4d38-b3e8-5c56118c8dd3' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'><dt><span>units :</span></dt><dd>degrees_east</dd><dt><span>long_name :</span></dt><dd>Longitude values</dd><dt><span>axis :</span></dt><dd>X</dd><dt><span>standard_name :</span></dt><dd>longitude</dd><dt><span>positive :</span></dt><dd>East</dd><dt><span>type :</span></dt><dd>double</dd><dt><span>valid_max :</span></dt><dd>360.0</dd><dt><span>valid_min :</span></dt><dd>-180.0</dd><dt><span>out_name :</span></dt><dd>longitude</dd></dl></div><div class='xr-var-data'><pre>array([-9.875, -9.625, -9.375, -9.125, -8.875, -8.625, -8.375, -8.125, -7.875,
       -7.625, -7.375, -7.125, -6.875, -6.625, -6.375, -6.125, -5.875, -5.625,
       -5.375, -5.125, -4.875, -4.625, -4.375, -4.125, -3.875, -3.625, -3.375,
       -3.125, -2.875, -2.625, -2.375, -2.125, -1.875, -1.625, -1.375, -1.125,
       -0.875, -0.625, -0.375, -0.125,  0.125,  0.375,  0.625,  0.875])</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span class='xr-has-index'>time</span></div><div class='xr-var-dims'>(time)</div><div class='xr-var-dtype'>datetime64[ns]</div><div class='xr-var-preview xr-preview'>1950-01-01 ... 2020-12-31</div><input id='attrs-749173e8-3b1d-41d6-a388-32aade96d7a5' class='xr-var-attrs-in' type='checkbox' ><label for='attrs-749173e8-3b1d-41d6-a388-32aade96d7a5' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-4e643231-bc1e-49c7-baea-191fac44a928' class='xr-var-data-in' type='checkbox'><label for='data-4e643231-bc1e-49c7-baea-191fac44a928' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'><dt><span>long_name :</span></dt><dd>Time in days</dd><dt><span>standard_name :</span></dt><dd>time</dd><dt><span>axis :</span></dt><dd>T</dd><dt><span>positive :</span></dt><dd>up</dd><dt><span>stored_direction :</span></dt><dd>increasing</dd><dt><span>type :</span></dt><dd>double</dd><dt><span>valid_max :</span></dt><dd></dd><dt><span>valid_min :</span></dt><dd></dd><dt><span>value :</span></dt><dd></dd><dt><span>z_bounds_factors :</span></dt><dd></dd><dt><span>z_factors :</span></dt><dd></dd><dt><span>bounds_values :</span></dt><dd></dd><dt><span>out_name :</span></dt><dd>time</dd></dl></div><div class='xr-var-data'><pre>array([&#x27;1950-01-01T00:00:00.000000000&#x27;, &#x27;1950-01-02T00:00:00.000000000&#x27;,
       &#x27;1950-01-03T00:00:00.000000000&#x27;, ..., &#x27;2020-12-29T00:00:00.000000000&#x27;,
       &#x27;2020-12-30T00:00:00.000000000&#x27;, &#x27;2020-12-31T00:00:00.000000000&#x27;],
      dtype=&#x27;datetime64[ns]&#x27;)</pre></div></li></ul></div></li><li class='xr-section-item'><input id='section-688f73ec-cd34-44ba-b22b-1b7096dcdc9f' class='xr-section-summary-in' type='checkbox'  checked><label for='section-688f73ec-cd34-44ba-b22b-1b7096dcdc9f' class='xr-section-summary' >Data variables: <span>(2)</span></label><div class='xr-section-inline-details'></div><div class='xr-section-details'><ul class='xr-var-list'><li class='xr-var-item'><div class='xr-var-name'><span>rr</span></div><div class='xr-var-dims'>(time, latitude, longitude)</div><div class='xr-var-dtype'>float32</div><div class='xr-var-preview xr-preview'>dask.array&lt;chunksize=(13605, 16, 22), meta=np.ndarray&gt;</div><input id='attrs-0046347e-dc57-4e98-88e4-98ac142028af' class='xr-var-attrs-in' type='checkbox' ><label for='attrs-0046347e-dc57-4e98-88e4-98ac142028af' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-4a2f848f-073a-448a-884c-c672f620acca' class='xr-var-data-in' type='checkbox'><label for='data-4a2f848f-073a-448a-884c-c672f620acca' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'><dt><span>units :</span></dt><dd>mm</dd><dt><span>long_name :</span></dt><dd>Daily Precipitation</dd><dt><span>standard_name :</span></dt><dd>thickness_of_rainfall_amount</dd></dl></div><div class='xr-var-data'><table>
    <tr>
        <td>
            <table style="border-collapse: collapse;">
                <thead>
                    <tr>
                        <td> </td>
                        <th> Array </th>
                        <th> Chunk </th>
                    </tr>
                </thead>
                <tbody>
                    
                    <tr>
                        <th> Bytes </th>
                        <td> 139.29 MiB </td>
                        <td> 18.27 MiB </td>
                    </tr>
                    
                    <tr>
                        <th> Shape </th>
                        <td> (25933, 32, 44) </td>
                        <td> (13605, 16, 22) </td>
                    </tr>
                    <tr>
                        <th> Dask graph </th>
                        <td colspan="2"> 8 chunks in 3 graph layers </td>
                    </tr>
                    <tr>
                        <th> Data type </th>
                        <td colspan="2"> float32 numpy.ndarray </td>
                    </tr>
                </tbody>
            </table>
        </td>
        <td>
        <svg width="156" height="146" style="stroke:rgb(0,0,0);stroke-width:1" >

  <!-- Horizontal lines -->
  <line x1="10" y1="0" x2="80" y2="70" style="stroke-width:2" />
  <line x1="10" y1="12" x2="80" y2="83" />
  <line x1="10" y1="25" x2="80" y2="96" style="stroke-width:2" />

  <!-- Vertical lines -->
  <line x1="10" y1="0" x2="10" y2="25" style="stroke-width:2" />
  <line x1="47" y1="37" x2="47" y2="62" />
  <line x1="80" y1="70" x2="80" y2="96" style="stroke-width:2" />

  <!-- Colored Rectangle -->
  <polygon points="10.0,0.0 80.58823529411765,70.58823529411765 80.58823529411765,96.00085180870013 10.0,25.412616514582485" style="fill:#ECB172A0;stroke-width:0"/>

  <!-- Horizontal lines -->
  <line x1="10" y1="0" x2="35" y2="0" style="stroke-width:2" />
  <line x1="47" y1="37" x2="72" y2="37" />
  <line x1="80" y1="70" x2="106" y2="70" style="stroke-width:2" />

  <!-- Vertical lines -->
  <line x1="10" y1="0" x2="80" y2="70" style="stroke-width:2" />
  <line x1="22" y1="0" x2="93" y2="70" />
  <line x1="35" y1="0" x2="106" y2="70" style="stroke-width:2" />

  <!-- Colored Rectangle -->
  <polygon points="10.0,0.0 35.41261651458248,0.0 106.00085180870013,70.58823529411765 80.58823529411765,70.58823529411765" style="fill:#ECB172A0;stroke-width:0"/>

  <!-- Horizontal lines -->
  <line x1="80" y1="70" x2="106" y2="70" style="stroke-width:2" />
  <line x1="80" y1="83" x2="106" y2="83" />
  <line x1="80" y1="96" x2="106" y2="96" style="stroke-width:2" />

  <!-- Vertical lines -->
  <line x1="80" y1="70" x2="80" y2="96" style="stroke-width:2" />
  <line x1="93" y1="70" x2="93" y2="96" />
  <line x1="106" y1="70" x2="106" y2="96" style="stroke-width:2" />

  <!-- Colored Rectangle -->
  <polygon points="80.58823529411765,70.58823529411765 106.00085180870013,70.58823529411765 106.00085180870013,96.00085180870013 80.58823529411765,96.00085180870013" style="fill:#ECB172A0;stroke-width:0"/>

  <!-- Text -->
  <text x="93.294544" y="116.000852" font-size="1.0rem" font-weight="100" text-anchor="middle" >44</text>
  <text x="126.000852" y="83.294544" font-size="1.0rem" font-weight="100" text-anchor="middle" transform="rotate(0,126.000852,83.294544)">32</text>
  <text x="35.294118" y="80.706734" font-size="1.0rem" font-weight="100" text-anchor="middle" transform="rotate(45,35.294118,80.706734)">25933</text>
</svg>
        </td>
    </tr>
</table></div></li><li class='xr-var-item'><div class='xr-var-name'><span>tg</span></div><div class='xr-var-dims'>(time, latitude, longitude)</div><div class='xr-var-dtype'>float32</div><div class='xr-var-preview xr-preview'>dask.array&lt;chunksize=(13605, 16, 22), meta=np.ndarray&gt;</div><input id='attrs-09895289-d52a-4794-918f-23903eb7ffc7' class='xr-var-attrs-in' type='checkbox' ><label for='attrs-09895289-d52a-4794-918f-23903eb7ffc7' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-b8f72f48-11c6-47b2-bc7c-3d418c858c88' class='xr-var-data-in' type='checkbox'><label for='data-b8f72f48-11c6-47b2-bc7c-3d418c858c88' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'><dt><span>units :</span></dt><dd>Celsius</dd><dt><span>long_name :</span></dt><dd>mean temperature</dd><dt><span>standard_name :</span></dt><dd>air_temperature</dd></dl></div><div class='xr-var-data'><table>
    <tr>
        <td>
            <table style="border-collapse: collapse;">
                <thead>
                    <tr>
                        <td> </td>
                        <th> Array </th>
                        <th> Chunk </th>
                    </tr>
                </thead>
                <tbody>
                    
                    <tr>
                        <th> Bytes </th>
                        <td> 139.29 MiB </td>
                        <td> 18.27 MiB </td>
                    </tr>
                    
                    <tr>
                        <th> Shape </th>
                        <td> (25933, 32, 44) </td>
                        <td> (13605, 16, 22) </td>
                    </tr>
                    <tr>
                        <th> Dask graph </th>
                        <td colspan="2"> 8 chunks in 3 graph layers </td>
                    </tr>
                    <tr>
                        <th> Data type </th>
                        <td colspan="2"> float32 numpy.ndarray </td>
                    </tr>
                </tbody>
            </table>
        </td>
        <td>
        <svg width="156" height="146" style="stroke:rgb(0,0,0);stroke-width:1" >

  <!-- Horizontal lines -->
  <line x1="10" y1="0" x2="80" y2="70" style="stroke-width:2" />
  <line x1="10" y1="12" x2="80" y2="83" />
  <line x1="10" y1="25" x2="80" y2="96" style="stroke-width:2" />

  <!-- Vertical lines -->
  <line x1="10" y1="0" x2="10" y2="25" style="stroke-width:2" />
  <line x1="47" y1="37" x2="47" y2="62" />
  <line x1="80" y1="70" x2="80" y2="96" style="stroke-width:2" />

  <!-- Colored Rectangle -->
  <polygon points="10.0,0.0 80.58823529411765,70.58823529411765 80.58823529411765,96.00085180870013 10.0,25.412616514582485" style="fill:#ECB172A0;stroke-width:0"/>

  <!-- Horizontal lines -->
  <line x1="10" y1="0" x2="35" y2="0" style="stroke-width:2" />
  <line x1="47" y1="37" x2="72" y2="37" />
  <line x1="80" y1="70" x2="106" y2="70" style="stroke-width:2" />

  <!-- Vertical lines -->
  <line x1="10" y1="0" x2="80" y2="70" style="stroke-width:2" />
  <line x1="22" y1="0" x2="93" y2="70" />
  <line x1="35" y1="0" x2="106" y2="70" style="stroke-width:2" />

  <!-- Colored Rectangle -->
  <polygon points="10.0,0.0 35.41261651458248,0.0 106.00085180870013,70.58823529411765 80.58823529411765,70.58823529411765" style="fill:#ECB172A0;stroke-width:0"/>

  <!-- Horizontal lines -->
  <line x1="80" y1="70" x2="106" y2="70" style="stroke-width:2" />
  <line x1="80" y1="83" x2="106" y2="83" />
  <line x1="80" y1="96" x2="106" y2="96" style="stroke-width:2" />

  <!-- Vertical lines -->
  <line x1="80" y1="70" x2="80" y2="96" style="stroke-width:2" />
  <line x1="93" y1="70" x2="93" y2="96" />
  <line x1="106" y1="70" x2="106" y2="96" style="stroke-width:2" />

  <!-- Colored Rectangle -->
  <polygon points="80.58823529411765,70.58823529411765 106.00085180870013,70.58823529411765 106.00085180870013,96.00085180870013 80.58823529411765,96.00085180870013" style="fill:#ECB172A0;stroke-width:0"/>

  <!-- Text -->
  <text x="93.294544" y="116.000852" font-size="1.0rem" font-weight="100" text-anchor="middle" >44</text>
  <text x="126.000852" y="83.294544" font-size="1.0rem" font-weight="100" text-anchor="middle" transform="rotate(0,126.000852,83.294544)">32</text>
  <text x="35.294118" y="80.706734" font-size="1.0rem" font-weight="100" text-anchor="middle" transform="rotate(45,35.294118,80.706734)">25933</text>
</svg>
        </td>
    </tr>
</table></div></li></ul></div></li><li class='xr-section-item'><input id='section-faa3264c-1174-467b-bfad-8091d7a2d719' class='xr-section-summary-in' type='checkbox'  ><label for='section-faa3264c-1174-467b-bfad-8091d7a2d719' class='xr-section-summary' >Indexes: <span>(3)</span></label><div class='xr-section-inline-details'></div><div class='xr-section-details'><ul class='xr-var-list'><li class='xr-var-item'><div class='xr-index-name'><div>latitude</div></div><div class='xr-index-preview'>PandasIndex</div><div></div><input id='index-4c1daa14-55f4-43b0-ad0d-2afefa6c36de' class='xr-index-data-in' type='checkbox'/><label for='index-4c1daa14-55f4-43b0-ad0d-2afefa6c36de' title='Show/Hide index repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-index-data'><pre>PandasIndex(Index([36.125, 36.375, 36.625, 36.875, 37.125, 37.375, 37.625, 37.875, 38.125,
       38.375, 38.625, 38.875, 39.125, 39.375, 39.625, 39.875, 40.125, 40.375,
       40.625, 40.875, 41.125, 41.375, 41.625, 41.875, 42.125, 42.375, 42.625,
       42.875, 43.125, 43.375, 43.625, 43.875],
      dtype=&#x27;float64&#x27;, name=&#x27;latitude&#x27;))</pre></div></li><li class='xr-var-item'><div class='xr-index-name'><div>longitude</div></div><div class='xr-index-preview'>PandasIndex</div><div></div><input id='index-22ecae88-5ceb-4aeb-bf08-a8c4f6936830' class='xr-index-data-in' type='checkbox'/><label for='index-22ecae88-5ceb-4aeb-bf08-a8c4f6936830' title='Show/Hide index repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-index-data'><pre>PandasIndex(Index([-9.875, -9.625, -9.375, -9.125, -8.875, -8.625, -8.375, -8.125, -7.875,
       -7.625, -7.375, -7.125, -6.875, -6.625, -6.375, -6.125, -5.875, -5.625,
       -5.375, -5.125, -4.875, -4.625, -4.375, -4.125, -3.875, -3.625, -3.375,
       -3.125, -2.875, -2.625, -2.375, -2.125, -1.875, -1.625, -1.375, -1.125,
       -0.875, -0.625, -0.375, -0.125,  0.125,  0.375,  0.625,  0.875],
      dtype=&#x27;float64&#x27;, name=&#x27;longitude&#x27;))</pre></div></li><li class='xr-var-item'><div class='xr-index-name'><div>time</div></div><div class='xr-index-preview'>PandasIndex</div><div></div><input id='index-6d74cc83-264b-43e7-8c7b-3e24288195b3' class='xr-index-data-in' type='checkbox'/><label for='index-6d74cc83-264b-43e7-8c7b-3e24288195b3' title='Show/Hide index repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-index-data'><pre>PandasIndex(DatetimeIndex([&#x27;1950-01-01&#x27;, &#x27;1950-01-02&#x27;, &#x27;1950-01-03&#x27;, &#x27;1950-01-04&#x27;,
               &#x27;1950-01-05&#x27;, &#x27;1950-01-06&#x27;, &#x27;1950-01-07&#x27;, &#x27;1950-01-08&#x27;,
               &#x27;1950-01-09&#x27;, &#x27;1950-01-10&#x27;,
               ...
               &#x27;2020-12-22&#x27;, &#x27;2020-12-23&#x27;, &#x27;2020-12-24&#x27;, &#x27;2020-12-25&#x27;,
               &#x27;2020-12-26&#x27;, &#x27;2020-12-27&#x27;, &#x27;2020-12-28&#x27;, &#x27;2020-12-29&#x27;,
               &#x27;2020-12-30&#x27;, &#x27;2020-12-31&#x27;],
              dtype=&#x27;datetime64[ns]&#x27;, name=&#x27;time&#x27;, length=25933, freq=None))</pre></div></li></ul></div></li><li class='xr-section-item'><input id='section-ecfadadf-b525-460d-8328-d56e32791445' class='xr-section-summary-in' type='checkbox'  checked><label for='section-ecfadadf-b525-460d-8328-d56e32791445' class='xr-section-summary' >Attributes: <span>(5)</span></label><div class='xr-section-inline-details'></div><div class='xr-section-details'><dl class='xr-attrs'><dt><span>E-OBS_version :</span></dt><dd>30.0e</dd><dt><span>Conventions :</span></dt><dd>CF-1.4</dd><dt><span>References :</span></dt><dd>http://surfobs.climate.copernicus.eu/dataaccess/access_eobs.php</dd><dt><span>history :</span></dt><dd>Fri Aug 30 12:51:50 2024: ncks --no-abc -d time,0,27209 /nobackup_1/users/besselaa/Data/Gridding/EOBSv30.0e/Grid_0.25deg/rr//rr_ensmean_master_rectime.nc /nobackup_1/users/besselaa/Data/Gridding/EOBSv30.0e/Grid_0.25deg/rr//rr_ens_mean_0.25deg_reg_v30.0e.nc
Fri Aug 30 12:50:32 2024: ncks --no-abc --mk_rec_dmn time /nobackup_1/users/besselaa/Data/Gridding/EOBSv30.0e/Grid_0.25deg/rr//rr_ensmean_master.nc /nobackup_1/users/besselaa/Data/Gridding/EOBSv30.0e/Grid_0.25deg/rr//rr_ensmean_master_rectime.nc
Fri Aug 30 10:04:23 2024: ncks -O -d time,0,27209 /nobackup_1/users/besselaa/Data/Gridding/EOBSv30.0e/Grid_0.25deg/rr/rr_ensmean_master_untilJul2024.nc /nobackup_1/users/besselaa/Data/Gridding/EOBSv30.0e/Grid_0.25deg/rr/rr_ensmean_master.nc</dd><dt><span>NCO :</span></dt><dd>netCDF Operators version 5.1.8 (Homepage = http://nco.sf.net, Code = http://github.com/nco/nco, Citation = 10.1016/j.envsoft.2008.03.004)</dd></dl></div></li></ul></div></div></div></div>
</div>
<p>We can see from the data structure that our information is already stored in a four-dimensional array with two data variables, corresponding to the RR ‚Äòmean‚Äô and TG ‚Äòmean‚Äô, with dimensions: 25933 days in ‚Äòtime‚Äô, 32 steps in ‚Äòlatitude‚Äô, and 44 steps in ‚Äòlongitude‚Äô. In this case, we are not using the toolbox‚Äôs transformer function to calculate the maximum/minimum statistics directly from the daily data. The following 30-year climatological periods are considered, as per the guidelines from the World Meteorological Organization (WMO):</p>
<ul class="simple">
<li><p>1951 to 1980</p></li>
<li><p>1961 to 1990</p></li>
<li><p>1971 to 2000</p></li>
<li><p>1981 to 2010</p></li>
<li><p>1991 to 2020</p></li>
</ul>
<p>Let‚Äôs inspect the data and compute these descriptive statistics of each period and print them in tabular form.</p>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ds</span> <span class="o">=</span> <span class="n">data_EOBS</span>

<span class="n">years_start</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1951</span><span class="p">,</span> <span class="mi">1961</span><span class="p">,</span> <span class="mi">1971</span><span class="p">,</span> <span class="mi">1981</span><span class="p">,</span> <span class="mi">1991</span><span class="p">]</span>
<span class="n">years_stop</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1980</span><span class="p">,</span> <span class="mi">1990</span><span class="p">,</span> <span class="mi">2000</span><span class="p">,</span> <span class="mi">2010</span><span class="p">,</span> <span class="mi">2020</span><span class="p">]</span>
<span class="n">periods</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">years_start</span><span class="p">,</span> <span class="n">years_stop</span><span class="p">))</span>

<span class="c1"># List to store the results as dictionaries for each row</span>
<span class="n">table_data</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># Loop through each period for the &#39;rr&#39; variable</span>
<span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span> <span class="ow">in</span> <span class="n">periods</span><span class="p">:</span>
    <span class="c1"># Select the data for each period</span>
    <span class="n">period_data</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;rr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">start</span><span class="si">}</span><span class="s2">-01-01&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">stop</span><span class="si">}</span><span class="s2">-12-31&quot;</span><span class="p">))</span>

    <span class="c1"># Summary statistics: maximum and minimum</span>
    <span class="n">mean</span> <span class="o">=</span> <span class="p">(</span><span class="n">period_data</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;latitude&#39;</span><span class="p">,</span> <span class="s1">&#39;longitude&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
    <span class="n">max_value</span> <span class="o">=</span> <span class="p">(</span><span class="n">period_data</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;latitude&#39;</span><span class="p">,</span> <span class="s1">&#39;longitude&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
    <span class="n">min_value</span> <span class="o">=</span> <span class="p">(</span><span class="n">period_data</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;latitude&#39;</span><span class="p">,</span> <span class="s1">&#39;longitude&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
    <span class="n">std</span> <span class="o">=</span> <span class="p">(</span><span class="n">period_data</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;latitude&#39;</span><span class="p">,</span> <span class="s1">&#39;longitude&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
    <span class="n">n_observations</span> <span class="o">=</span> <span class="p">(</span><span class="n">period_data</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;latitude&#39;</span><span class="p">,</span> <span class="s1">&#39;longitude&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>

    <span class="c1"># Append row data to the list</span>
    <span class="n">table_data</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
        <span class="s1">&#39;period&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">start</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">stop</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s1">&#39;number&#39;</span><span class="p">:</span> <span class="n">n_observations</span><span class="p">,</span>
        <span class="s1">&#39;mean&#39;</span><span class="p">:</span> <span class="n">mean</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span>
        <span class="s1">&#39;maximum&#39;</span><span class="p">:</span> <span class="n">max_value</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span>
        <span class="s1">&#39;minimum&#39;</span><span class="p">:</span> <span class="n">min_value</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span>
        <span class="s1">&#39;st.deviation&#39;</span><span class="p">:</span> <span class="n">std</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
    <span class="p">})</span>

<span class="c1"># Convert list of dictionaries to DataFrame for tabular display</span>
<span class="n">summary_table</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">table_data</span><span class="p">)</span>

<span class="n">summary_table</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>period</th>
      <th>number</th>
      <th>mean</th>
      <th>maximum</th>
      <th>minimum</th>
      <th>st.deviation</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1951-1980</td>
      <td>10892252</td>
      <td>1.750003</td>
      <td>135.500000</td>
      <td>0.0</td>
      <td>4.383260</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1961-1990</td>
      <td>10891258</td>
      <td>1.710895</td>
      <td>147.699997</td>
      <td>0.0</td>
      <td>4.355820</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1971-2000</td>
      <td>10892252</td>
      <td>1.649149</td>
      <td>147.699997</td>
      <td>0.0</td>
      <td>4.281535</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1981-2010</td>
      <td>10891258</td>
      <td>1.610303</td>
      <td>147.699997</td>
      <td>0.0</td>
      <td>4.284586</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1991-2020</td>
      <td>10892252</td>
      <td>1.619957</td>
      <td>174.600006</td>
      <td>0.0</td>
      <td>4.376774</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>As we can see from the descriptive statistics, the two most recent climatological periods are characterized by mean lower precipitation - in the Iberian Peninsula, the annual daily mean RR between 1991 and 2020 is almost 0.15mm above the equivalent in 1951 to 1980. Nevertheless, when we check the annual daily maximum RR in each period, the most recent period shows a positive deviation of circa 40.0mm. To further explore these findings, let‚Äôs compare also TG.</p>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ds</span> <span class="o">=</span> <span class="n">data_EOBS</span>

<span class="n">years_start</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1951</span><span class="p">,</span> <span class="mi">1961</span><span class="p">,</span> <span class="mi">1971</span><span class="p">,</span> <span class="mi">1981</span><span class="p">,</span> <span class="mi">1991</span><span class="p">]</span>
<span class="n">years_stop</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1980</span><span class="p">,</span> <span class="mi">1990</span><span class="p">,</span> <span class="mi">2000</span><span class="p">,</span> <span class="mi">2010</span><span class="p">,</span> <span class="mi">2020</span><span class="p">]</span>
<span class="n">periods</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">years_start</span><span class="p">,</span> <span class="n">years_stop</span><span class="p">))</span>

<span class="c1"># List to store the results as dictionaries for each row</span>
<span class="n">table_data</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># Loop through each period for the &#39;rr&#39; variable</span>
<span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span> <span class="ow">in</span> <span class="n">periods</span><span class="p">:</span>
    <span class="c1"># Select the data for each period</span>
    <span class="n">period_data</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;tg&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">start</span><span class="si">}</span><span class="s2">-01-01&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">stop</span><span class="si">}</span><span class="s2">-12-31&quot;</span><span class="p">))</span>

    <span class="c1"># Summary statistics: maximum and minimum</span>
    <span class="n">mean</span> <span class="o">=</span> <span class="p">(</span><span class="n">period_data</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;latitude&#39;</span><span class="p">,</span> <span class="s1">&#39;longitude&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
    <span class="n">max_value</span> <span class="o">=</span> <span class="p">(</span><span class="n">period_data</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;latitude&#39;</span><span class="p">,</span> <span class="s1">&#39;longitude&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
    <span class="n">min_value</span> <span class="o">=</span> <span class="p">(</span><span class="n">period_data</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;latitude&#39;</span><span class="p">,</span> <span class="s1">&#39;longitude&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
    <span class="n">std</span> <span class="o">=</span> <span class="p">(</span><span class="n">period_data</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;latitude&#39;</span><span class="p">,</span> <span class="s1">&#39;longitude&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
    <span class="n">n_observations</span> <span class="o">=</span> <span class="p">(</span><span class="n">period_data</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;latitude&#39;</span><span class="p">,</span> <span class="s1">&#39;longitude&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>

    <span class="c1"># Append row data to the list</span>
    <span class="n">table_data</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
        <span class="s1">&#39;period&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">start</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">stop</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s1">&#39;number&#39;</span><span class="p">:</span> <span class="n">n_observations</span><span class="p">,</span>
        <span class="s1">&#39;mean&#39;</span><span class="p">:</span> <span class="n">mean</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span>
        <span class="s1">&#39;maximum&#39;</span><span class="p">:</span> <span class="n">max_value</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span>
        <span class="s1">&#39;minimum&#39;</span><span class="p">:</span> <span class="n">min_value</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span>
        <span class="s1">&#39;st.deviation&#39;</span><span class="p">:</span> <span class="n">std</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
    <span class="p">})</span>

<span class="c1"># Convert list of dictionaries to DataFrame for tabular display</span>
<span class="n">summary_table</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">table_data</span><span class="p">)</span>

<span class="n">summary_table</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>period</th>
      <th>number</th>
      <th>mean</th>
      <th>maximum</th>
      <th>minimum</th>
      <th>st.deviation</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1951-1980</td>
      <td>10892252</td>
      <td>13.030372</td>
      <td>34.860001</td>
      <td>-21.350000</td>
      <td>6.920749</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1961-1990</td>
      <td>10891258</td>
      <td>13.167892</td>
      <td>35.380001</td>
      <td>-19.090000</td>
      <td>6.949373</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1971-2000</td>
      <td>10892252</td>
      <td>13.348657</td>
      <td>35.459999</td>
      <td>-19.090000</td>
      <td>6.910661</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1981-2010</td>
      <td>10891258</td>
      <td>13.785862</td>
      <td>36.259998</td>
      <td>-19.090000</td>
      <td>7.055634</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1991-2020</td>
      <td>10892252</td>
      <td>14.076628</td>
      <td>36.259998</td>
      <td>-17.389999</td>
      <td>7.108184</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>In the case of daily mean air temperature, the two most recent climatological periods are characterized by higher mean and maximum TG values - in the Iberian Peninsula, the annual daily mean TG between 1991 and 2020 is 1.0¬∞C above the equivalent in 1951 to 1980, while the annual daily maximum increased circa 1.5¬∞C. To further explore these findings, let‚Äôs inspect the maps and time series of the data.</p>
<p>To do this, we need to create a set of weights based on latitude values. The weighted method is used to create a weighted dataset. Any subsequent aggregation operations (such as mean, sum, etc.) will take these weights into account. These weights can be used to account for the varying area of grid cells in latitude-longitude grids to ensure that calculations properly account for varying areas represented by grid cells at different latitudes.</p>
<p>Now we will proceed with plotting an example from the last time step of the time series to visualise the spatial level of detail of the data.</p>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Compute last years&#39; mean</span>
<span class="n">p_last_year</span> <span class="o">=</span> <span class="n">data_EOBS</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="o">-</span><span class="mi">365</span><span class="p">,</span><span class="kc">None</span><span class="p">))</span>
<span class="n">p_last_year_mean</span> <span class="o">=</span> <span class="n">p_last_year</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="s1">&#39;time&#39;</span><span class="p">])</span>

<span class="k">def</span><span class="w"> </span><span class="nf">plot_maps</span><span class="p">(</span><span class="n">da1</span><span class="p">,</span> <span class="n">da2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="c1"># Set up the number of subplots depending on whether one or two datasets are passed</span>
    <span class="k">if</span> <span class="n">da2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">subplot_kw</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;projection&#39;</span><span class="p">:</span> <span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">()})</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="p">[</span><span class="n">ax</span><span class="p">]</span>
        <span class="n">datasets</span> <span class="o">=</span> <span class="p">[</span><span class="n">da1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">subplot_kw</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;projection&#39;</span><span class="p">:</span> <span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">()})</span>
        <span class="n">datasets</span> <span class="o">=</span> <span class="p">[</span><span class="n">da1</span><span class="p">,</span> <span class="n">da2</span><span class="p">]</span>
    
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">da</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">datasets</span><span class="p">):</span>
        <span class="c1"># Get longitude and latitude extents</span>
        <span class="n">lon_min</span><span class="p">,</span> <span class="n">lon_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">da</span><span class="o">.</span><span class="n">longitude</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">da</span><span class="o">.</span><span class="n">longitude</span><span class="p">)</span>
        <span class="n">lat_min</span><span class="p">,</span> <span class="n">lat_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">da</span><span class="o">.</span><span class="n">latitude</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">da</span><span class="o">.</span><span class="n">latitude</span><span class="p">)</span>

        <span class="c1"># Plot using PlateCarree projection on the given axis</span>
        <span class="n">facet</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span>
            <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>  <span class="c1"># Use the current axis</span>
            <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">(),</span>  <span class="c1"># Coordinate transform for plotting</span>
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>

        <span class="c1"># Set extent, add coastlines, and gridlines</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_extent</span><span class="p">([</span><span class="n">lon_min</span><span class="p">,</span> <span class="n">lon_max</span><span class="p">,</span> <span class="n">lat_min</span><span class="p">,</span> <span class="n">lat_max</span><span class="p">],</span> <span class="n">crs</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">())</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">coastlines</span><span class="p">(</span><span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">gl</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">gridlines</span><span class="p">(</span><span class="n">draw_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">gl</span><span class="o">.</span><span class="n">top_labels</span> <span class="o">=</span> <span class="n">gl</span><span class="o">.</span><span class="n">right_labels</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1"># Plot the selected time step</span>
<span class="n">plot_maps</span><span class="p">(</span><span class="n">p_last_year_mean</span><span class="p">[</span><span class="s1">&#39;rr&#39;</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;coolwarm&#39;</span><span class="p">,</span>
           <span class="n">cbar_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="s1">&#39;Precipitation (mm)&#39;</span><span class="p">,</span> <span class="s1">&#39;fraction&#39;</span><span class="p">:</span><span class="mf">0.03</span><span class="p">})</span>

<span class="n">start_plot</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">p_last_year</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">end_plot</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">p_last_year</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Mean Precipitation from </span><span class="si">{</span><span class="n">start_plot</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">end_plot</span><span class="si">}</span><span class="s1"> (E-OBS)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/dd30387ab2538c35d31e46a1944b72c1a39a5da66fc27996876296b00dd186e6.png" src="../_images/dd30387ab2538c35d31e46a1944b72c1a39a5da66fc27996876296b00dd186e6.png" />
</div>
</div>
<p>We will also plot the spatial weighted average of RR to check for its temporal variability in this area.</p>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Calculate the weighted mean of the time series</span>
<span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">data_EOBS</span><span class="o">.</span><span class="n">latitude</span><span class="p">))</span>
<span class="n">weights</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;weights&quot;</span>

<span class="n">merged_p_weighted</span> <span class="o">=</span> <span class="n">data_EOBS</span><span class="p">[</span><span class="s1">&#39;rr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">weighted</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
<span class="n">mean_p</span> <span class="o">=</span> <span class="n">merged_p_weighted</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="s2">&quot;longitude&quot;</span><span class="p">,</span> <span class="s2">&quot;latitude&quot;</span><span class="p">))</span>

<span class="c1"># Plot the data</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;E-OBS Daily Amount of Precipitation - Weighted Average Spatial Mean&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Total Precipitation (mm)&#39;</span><span class="p">)</span>

<span class="c1"># Plot prec data</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">mean_p</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="n">mean_p</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;E-OBS (Precipitation)&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>

<span class="c1"># Add a legend</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="c1"># Show the plot</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/08e79b7f50a8e5b307a3d0b9258097585a258d41a572b6bbfe0965530ddd3419.png" src="../_images/08e79b7f50a8e5b307a3d0b9258097585a258d41a572b6bbfe0965530ddd3419.png" />
</div>
</div>
<p>These time series plots show that the E-OBS data product has very significative inter-annual variability in the RR values, with very few cases of RR surpassing 20mm. Some years with RR &lt; 5mm are also apparent in the last decades. To move forward with the drought analysis, we will now calculate the two above-mentioned sector-specific drought indicators.</p>
</section>
</section>
<section id="calculate-standardized-precipitation-index-spi">
<span id="insitu-insitu-gridded-observations-europe-climate-monitoring-q04-code-section-2"></span><h3>2. Calculate Standardized Precipitation Index (SPI)<a class="headerlink" href="#calculate-standardized-precipitation-index-spi" title="Link to this heading">#</a></h3>
<p>The Standardized Precipitation Index (SPI) is commonly used to describe meteorological drought across various timescales. It correlates closely with soil moisture on shorter scales and with groundwater and reservoir levels on longer scales. The SPI allows for comparisons between different climatic regions by measuring observed precipitation as a standardized variation from a chosen probability distribution function that best fits the precipitation data. Typically, this data is adjusted to fit either a gamma or a Pearson Type III distribution before being converted into a normal distribution. The SPI values represent the number of standard deviations that the observed precipitation anomaly is from the long-term average. It can be calculated for periods ranging from 1 to 36 months using monthly data. Within the operational community, the SPI is recognized globally as the standard metric for assessing and reporting meteorological drought. An SPI below -2 corresponds to a precipitation deficit found in only 2.3% of cases (severe drought), while an SPI above 2 means excess rainfall in the top 2.3% of cases (extremely wet). Values between -1 and 1 occur around 68% of the time, reflecting near-normal conditions.</p>
<p>We will proceed to calculate SPI for 6-month periods.</p>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define function to caluclate SPI</span>
<span class="k">def</span><span class="w"> </span><span class="nf">calc_spi</span><span class="p">(</span><span class="n">precip</span><span class="p">):</span>
    <span class="n">precip</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">precip</span><span class="p">)</span>
    <span class="n">valid_data</span> <span class="o">=</span> <span class="n">precip</span><span class="p">[</span><span class="n">precip</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>  <span class="c1"># Ensure there are enough points to fit the distribution</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">precip</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    
    <span class="n">shape</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">scale</span> <span class="o">=</span> <span class="n">gamma</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">valid_data</span><span class="p">,</span> <span class="n">floc</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">gamma_dist</span> <span class="o">=</span> <span class="n">gamma</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">)</span>
    <span class="n">cdf</span> <span class="o">=</span> <span class="n">gamma_dist</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">precip</span><span class="p">)</span>
    
    <span class="n">spi</span> <span class="o">=</span> <span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">cdf</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">spi</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute sum and resample the dataset to seasonal totals (e.g. 3 months, 6 months, 1 year), keeping spatial dimensions</span>
<span class="n">time_scale</span> <span class="o">=</span> <span class="s1">&#39;6M&#39;</span>
<span class="n">annual_precip_EOBS</span> <span class="o">=</span> <span class="n">data_EOBS</span><span class="p">[</span><span class="s1">&#39;rr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">time_scale</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>


<span class="c1"># Apply the SPI function using apply_ufunc, preserving spatial dimensions</span>
<span class="n">spi_values_EOBS</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">apply_ufunc</span><span class="p">(</span>
    <span class="n">calc_spi</span><span class="p">,</span>
    <span class="n">annual_precip_EOBS</span><span class="p">,</span>

    <span class="n">input_core_dims</span><span class="o">=</span><span class="p">[[</span><span class="s1">&#39;time&#39;</span><span class="p">]],</span>
    <span class="n">output_core_dims</span><span class="o">=</span><span class="p">[[</span><span class="s1">&#39;time&#39;</span><span class="p">]],</span>
    <span class="n">vectorize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">dask</span><span class="o">=</span><span class="s1">&#39;parallelized&#39;</span><span class="p">,</span>
    <span class="n">dask_gufunc_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;allow_rechunk&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
    <span class="n">output_dtypes</span><span class="o">=</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
    <span class="n">keep_attrs</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>

<span class="c1"># Compute the results</span>
<span class="n">spi_values_EOBS_compute</span> <span class="o">=</span> <span class="n">spi_values_EOBS</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
</div>
<p>To inspect the SPI calculation results, we will first have a look at the time series over the Iberian Peninsula, highlighting the Moderate and Severe events detected.</p>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Select the time period</span>
<span class="n">start_date_plot_spi</span> <span class="o">=</span> <span class="s1">&#39;1950-01-01&#39;</span>
<span class="n">end_date_plot_spi</span> <span class="o">=</span> <span class="s1">&#39;2020-12-31&#39;</span>

<span class="c1"># Reduce to mean SPI over spatial dimensions</span>
<span class="n">spi_values_EOBS_weighted</span> <span class="o">=</span> <span class="n">spi_values_EOBS_compute</span><span class="o">.</span><span class="n">weighted</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
<span class="n">spi_mean_EOBS</span> <span class="o">=</span> <span class="n">spi_values_EOBS_weighted</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;latitude&#39;</span><span class="p">,</span> <span class="s1">&#39;longitude&#39;</span><span class="p">])</span>

<span class="c1">#select dates</span>
<span class="n">spi_mean_EOBS</span> <span class="o">=</span> <span class="n">spi_mean_EOBS</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">start_date_plot_spi</span><span class="p">,</span> <span class="n">end_date_plot_spi</span><span class="p">))</span>

<span class="c1">#interpolate to daily data for visualization</span>
<span class="n">time</span> <span class="o">=</span> <span class="n">spi_mean_EOBS</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span>
<span class="n">time</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
<span class="n">spi_mean_EOBS</span> <span class="o">=</span> <span class="n">spi_mean_EOBS</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">time</span><span class="p">)</span>

<span class="c1"># Find and print times where SPI indicates moderate drought (SPI &lt; -1)</span>
<span class="n">drought_periods</span> <span class="o">=</span> <span class="n">spi_mean_EOBS</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">spi_mean_EOBS</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Convert the time coordinates to a pandas datetime index for better plotting</span>
<span class="n">time</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

<span class="c1"># Create the plot</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">spi_mean_EOBS</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;SPI&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>

<span class="c1"># Highlight the drought periods using fill_between with appropriate mask</span>
<span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span> <span class="c1">#transparency</span>
<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">spi_mean_EOBS</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="p">((</span><span class="n">spi_mean_EOBS</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">spi_mean_EOBS</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">1.5</span><span class="p">)),</span>
                  <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Moderate Drought (SPI [-1.5, -1[)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">spi_mean_EOBS</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="p">(</span><span class="n">spi_mean_EOBS</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">1.5</span><span class="p">),</span>
                  <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Severe Drought (SPI [-2, -1.5[)&#39;</span><span class="p">)</span>

<span class="c1"># Add labels and title</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Time&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;SPI&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Time Series of E-OBS SPI with Moderate Drought Periods Highlighted&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=-</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Show the plot</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/d23f73c08f3b189aad4ff6502837f480e50111cb3d13fd307325761ced980179.png" src="../_images/d23f73c08f3b189aad4ff6502837f480e50111cb3d13fd307325761ced980179.png" />
</div>
</div>
<p>As we can see from this plot, SPI shows a tendency towards lower values in the last two decades. In particular, we observe 5 instances of Moderate drought since 1985, and 1 Severe Drought event after 2005, agreeing with the overall notion that drought events are already becoming more frequent, and severe, recently. These findings agree with those reported in the literature <a class="reference external" href="https://doi.org/10.1016/j.wace.2021.100320" rel="noreferrer" target="_blank">[7]</a>.</p>
</section>
<section id="calculate-standardized-precipitation-evapotranspiration-index-spei">
<span id="insitu-insitu-gridded-observations-europe-climate-monitoring-q04-code-section-3"></span><h3>3. Calculate Standardized Precipitation Evapotranspiration Index (SPEI)<a class="headerlink" href="#calculate-standardized-precipitation-evapotranspiration-index-spei" title="Link to this heading">#</a></h3>
<p>Extending the above-calculated SPI, the Standardized Precipitation Evapotranspiration Index (SPEI) adds additional information by incorporating temperature data to account for both precipitation and evapotranspiration (ET), making it sensitive to climate-driven changes in water demand. This allows SPEI to better reflect drought conditions under warming scenarios, as it considers not only rainfall deficits but also increased evaporation due to higher temperatures. While several ET estimation algorithms exist, here we use the Thornthwaite method, which is based on temperature and solar radiation, by latitude and season. The interpretation of SPEI values is similar to SPI in terms of probabilistic distribution, where values follow a standard normal distribution. The functions for Evapotranspiration computation were based on the <em>‚Äúclimate_indices‚Äù</em> Python library, from James Adams <a class="reference external" href="https://github.com/monocongo/climate_indices" rel="noreferrer" target="_blank">[8]</a>.</p>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># To define the month-days, we simplify by only using non leap year&#39;s month-days</span>
<span class="n">_MONTH_DAYS_NONLEAP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">31</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">31</span><span class="p">])</span>

<span class="c1"># Angle values used within the _sunset_hour_angle() function defined below</span>
<span class="c1"># Valid range for latitude, in radians</span>
<span class="n">_LATITUDE_RADIANS_MIN</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="o">-</span><span class="mf">90.0</span><span class="p">)</span>
<span class="n">_LATITUDE_RADIANS_MAX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="mf">90.0</span><span class="p">)</span>

<span class="c1"># Valid range for solar declination angle, in radians</span>
<span class="n">_SOLAR_DECLINATION_RADIANS_MIN</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="o">-</span><span class="mf">23.45</span><span class="p">)</span>
<span class="n">_SOLAR_DECLINATION_RADIANS_MAX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="mf">23.45</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define usefull functions to compute the evapotranspiration</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_sunset_hour_angle</span><span class="p">(</span><span class="n">latitude_radians</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">solar_declination_radians</span><span class="p">:</span> <span class="nb">float</span><span class="p">,)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>

    <span class="c1"># validate the latitude argument</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">_LATITUDE_RADIANS_MIN</span> <span class="o">&lt;=</span> <span class="n">latitude_radians</span> <span class="o">&lt;=</span> <span class="n">_LATITUDE_RADIANS_MAX</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;latitude outside valid range [</span><span class="si">{0!r}</span><span class="s2"> to </span><span class="si">{1!r}</span><span class="s2">]: </span><span class="si">{2!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">_LATITUDE_RADIANS_MIN</span><span class="p">,</span> <span class="n">_LATITUDE_RADIANS_MAX</span><span class="p">,</span> <span class="n">latitude_radians</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="c1"># validate the solar declination angle argument</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">_SOLAR_DECLINATION_RADIANS_MIN</span> <span class="o">&lt;=</span> <span class="n">solar_declination_radians</span> <span class="o">&lt;=</span> <span class="n">_SOLAR_DECLINATION_RADIANS_MAX</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;solar declination angle outside the valid range [</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">_SOLAR_DECLINATION_RADIANS_MIN</span><span class="p">)</span><span class="si">}</span><span class="se">\</span>
<span class="s2">                  to </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">_SOLAR_DECLINATION_RADIANS_MAX</span><span class="p">)</span><span class="si">}</span><span class="s2">]: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">solar_declination_radians</span><span class="p">)</span><span class="si">}</span><span class="s2"> (actual value)&quot;</span>
        <span class="p">)</span>

    <span class="c1"># calculate the cosine of the sunset hour angle (*Ws* in FAO 25)</span>
    <span class="c1"># from latitude and solar declination</span>
    <span class="n">cos_sunset_hour_angle</span> <span class="o">=</span> <span class="o">-</span><span class="n">math</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">latitude_radians</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">solar_declination_radians</span><span class="p">)</span>

    <span class="c1"># If the sunset hour angle is &gt;= 1 there is no sunset, i.e. 24 hours of daylight</span>
    <span class="c1"># If the sunset hour angle is &lt;= 1 there is no sunrise, i.e. 24 hours of darkness</span>
    <span class="k">return</span> <span class="n">math</span><span class="o">.</span><span class="n">acos</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">cos_sunset_hour_angle</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">),</span> <span class="mf">1.0</span><span class="p">))</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_solar_declination</span><span class="p">(</span>
    <span class="n">day_of_year</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">day_of_year</span> <span class="o">&lt;=</span> <span class="mi">366</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Day of the year must be in the range [1-366]: &quot;</span> <span class="s2">&quot;</span><span class="si">{0!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">day_of_year</span><span class="p">))</span>

    <span class="k">return</span> <span class="mf">0.409</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(((</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">365.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">day_of_year</span> <span class="o">-</span> <span class="mf">1.39</span><span class="p">))</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_daylight_hours</span><span class="p">(</span><span class="n">sunset_hour_angle_radians</span><span class="p">:</span> <span class="nb">float</span><span class="p">,)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="mf">0.0</span> <span class="o">&lt;=</span> <span class="n">sunset_hour_angle_radians</span> <span class="o">&lt;=</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;sunset hour angle outside valid range [0.0 to </span><span class="se">\</span>
<span class="s2">                         </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="si">}</span><span class="s2">] : </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">sunset_hour_angle_radians</span><span class="p">)</span><span class="si">}</span><span class="s2"> (actual value)&quot;</span>
        <span class="p">)</span>

    <span class="c1"># calculate daylight hours from the sunset hour angle</span>
    <span class="k">return</span> <span class="p">(</span><span class="mf">24.0</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">sunset_hour_angle_radians</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_monthly_mean_daylight_hours</span><span class="p">(</span><span class="n">latitude_radians</span><span class="p">:</span> <span class="nb">float</span><span class="p">,)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>

    <span class="c1"># allocate an array of daylight hours for each of the 12 months of the year</span>
    <span class="n">monthly_mean_dlh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">12</span><span class="p">,))</span>

    <span class="c1"># keep a count of the day of the year</span>
    <span class="n">day_of_year</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="c1"># loop over each calendar month to calculate the daylight hours for the month</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">days_in_month</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">_MONTH_DAYS_NONLEAP</span><span class="p">):</span>
        <span class="n">cumulative_daylight_hours</span> <span class="o">=</span> <span class="mf">0.0</span>  <span class="c1"># cumulative daylight hours for the month</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">days_in_month</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">daily_solar_declination</span> <span class="o">=</span> <span class="n">_solar_declination</span><span class="p">(</span><span class="n">day_of_year</span><span class="p">)</span>
            <span class="n">daily_sunset_hour_angle</span> <span class="o">=</span> <span class="n">_sunset_hour_angle</span><span class="p">(</span><span class="n">latitude_radians</span><span class="p">,</span> <span class="n">daily_solar_declination</span><span class="p">)</span>
            <span class="n">cumulative_daylight_hours</span> <span class="o">+=</span> <span class="n">_daylight_hours</span><span class="p">(</span><span class="n">daily_sunset_hour_angle</span><span class="p">)</span>
            <span class="n">day_of_year</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># calculate the mean daylight hours of the month</span>
        <span class="n">monthly_mean_dlh</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cumulative_daylight_hours</span> <span class="o">/</span> <span class="n">days_in_month</span>

    <span class="k">return</span> <span class="n">monthly_mean_dlh</span>

<span class="k">def</span><span class="w"> </span><span class="nf">pet_thornthwaite</span><span class="p">(</span><span class="n">mean_monthly_temps</span><span class="p">,</span> <span class="n">latitude_map_degrees</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">mean_monthly_temps</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>

    <span class="c1">#print(mean_monthly_temps[0], latitude_degrees[0])</span>
    <span class="c1"># Ensure the array is writable by creating a copy</span>
    <span class="n">mean_monthly_temps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">mean_monthly_temps</span><span class="p">)</span>

    <span class="n">mean_monthly_temps</span><span class="p">[</span><span class="n">mean_monthly_temps</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="n">heat_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">mean_monthly_temps</span> <span class="o">/</span> <span class="mf">5.0</span><span class="p">,</span> <span class="mf">1.514</span><span class="p">))</span>
    <span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="mf">6.75e-07</span> <span class="o">*</span> <span class="n">heat_index</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="mf">7.71e-05</span> <span class="o">*</span> <span class="n">heat_index</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.792e-02</span> <span class="o">*</span> <span class="n">heat_index</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.49239</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">latitude_map_degrees</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">latitude_radians</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">latitude_map_degrees</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Latitudes must be all the same in this mapping structure&#39;</span><span class="p">)</span>

    <span class="n">mean_daylight_hours</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">_monthly_mean_daylight_hours</span><span class="p">(</span><span class="n">latitude_radians</span><span class="p">))</span>
    <span class="n">adjust</span> <span class="o">=</span> <span class="p">(</span><span class="n">mean_daylight_hours</span> <span class="o">/</span> <span class="mf">12.0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">_MONTH_DAYS_NONLEAP</span> <span class="o">/</span> <span class="mf">30.0</span><span class="p">)</span>

    <span class="c1"># calculate the Thornthwaite equation</span>
    <span class="n">pet</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">mean_monthly_temps</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="n">pet</span> <span class="o">=</span> <span class="mi">16</span><span class="o">*</span><span class="n">adjust</span><span class="o">*</span><span class="p">((</span><span class="mi">10</span><span class="o">*</span><span class="n">mean_monthly_temps</span><span class="o">/</span><span class="n">heat_index</span><span class="p">)</span><span class="o">**</span><span class="n">a</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pet</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># t_EOBS_mean = data_EOBS.drop_vars(&#39;rr&#39;).resample(time=&#39;M&#39;).mean()</span>
<span class="c1"># Resample daily temperature to montly mean for evapotranspiration computation</span>
<span class="n">t_EOBS_mean</span> <span class="o">=</span> <span class="n">data_EOBS</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s1">&#39;rr&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="s1">&#39;M&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
</div>
<p>Considering the amount of data, for faster computation, we must parallelise the pixel-wise calculation of PET. For this, we create a latitude mapping - i.e., we save latitude in a xr.DataArray with the same structure as ‚Äút_EOBS_mean‚Äù for a later use.</p>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Make a copy of the original dataset</span>
<span class="n">latitude_matrix</span> <span class="o">=</span> <span class="n">t_EOBS_mean</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="c1"># Helper function to replace temperature values with the corresponding latitude</span>
<span class="k">def</span><span class="w"> </span><span class="nf">replace_with_latitude</span><span class="p">(</span><span class="n">temp_array</span><span class="p">,</span> <span class="n">latitudes</span><span class="p">):</span>
    <span class="c1"># This function will broadcast latitude values across the temperature data</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">broadcast_to</span><span class="p">(</span><span class="n">latitudes</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span> <span class="n">temp_array</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="c1"># Apply the function across the dataset using apply_ufunc</span>
<span class="n">latitude_matrix</span><span class="p">[</span><span class="s1">&#39;tg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">apply_ufunc</span><span class="p">(</span>
    <span class="n">replace_with_latitude</span><span class="p">,</span>                   <span class="c1"># Function to apply</span>
    <span class="n">t_EOBS_mean</span><span class="p">[</span><span class="s1">&#39;tg&#39;</span><span class="p">],</span>                       <span class="c1"># Temperature values</span>
    <span class="n">t_EOBS_mean</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;latitude&#39;</span><span class="p">],</span>          <span class="c1"># Latitude values</span>
    <span class="n">input_core_dims</span><span class="o">=</span><span class="p">[[</span><span class="s1">&#39;latitude&#39;</span><span class="p">,</span> <span class="s1">&#39;longitude&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;latitude&#39;</span><span class="p">]],</span>  <span class="c1"># Dimensions in function</span>
    <span class="n">output_core_dims</span><span class="o">=</span><span class="p">[[</span><span class="s1">&#39;latitude&#39;</span><span class="p">,</span> <span class="s1">&#39;longitude&#39;</span><span class="p">]],</span>  <span class="c1"># Output dimensions</span>
    <span class="n">vectorize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>                          <span class="c1"># Vectorization for efficiency</span>
    <span class="n">dask</span><span class="o">=</span><span class="s1">&#39;parallelized&#39;</span><span class="p">,</span>                     <span class="c1"># Parallelize if using Dask</span>
    <span class="n">output_dtypes</span><span class="o">=</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>                    <span class="c1"># Specify output dtype</span>
    <span class="n">dask_gufunc_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;allow_rechunk&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>  <span class="c1"># Allow rechunking</span>
<span class="p">)</span>

<span class="c1"># Compute the result if using Dask for parallelism</span>
<span class="n">latitude_matrix</span><span class="p">[</span><span class="s1">&#39;tg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">latitude_matrix</span><span class="p">[</span><span class="s1">&#39;tg&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Rename variables to merge E-OBS precipitation and temperature again</span>
<span class="n">latitude_matrix</span><span class="o">=</span><span class="n">latitude_matrix</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;tg&#39;</span><span class="p">:</span><span class="s1">&#39;lats&#39;</span><span class="p">})</span>
<span class="n">ds_monthly</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">merge</span><span class="p">([</span><span class="n">t_EOBS_mean</span><span class="p">,</span> <span class="n">latitude_matrix</span><span class="p">],</span> <span class="n">join</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Helper function to apply Thornthwaite method by grouping by year and month</span>
<span class="k">def</span><span class="w"> </span><span class="nf">apply_thornthwaite</span><span class="p">(</span><span class="n">group</span><span class="p">):</span>
    <span class="c1"># Group data by year and month, then apply the Thornthwaite method</span>
    <span class="n">temp</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="s1">&#39;tg&#39;</span><span class="p">]</span>
    <span class="n">lats</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="s1">&#39;lats&#39;</span><span class="p">]</span>
    
    <span class="c1"># Call the Thornthwaite function</span>
    <span class="n">et_func</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">apply_ufunc</span><span class="p">(</span>
        <span class="n">pet_thornthwaite</span><span class="p">,</span>
        <span class="n">temp</span><span class="p">,</span>
        <span class="n">lats</span><span class="p">,</span>
        <span class="n">input_core_dims</span><span class="o">=</span><span class="p">[[</span><span class="s1">&#39;time&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]],</span>
        <span class="n">output_core_dims</span><span class="o">=</span><span class="p">[[</span><span class="s1">&#39;time&#39;</span><span class="p">]],</span>
        <span class="n">vectorize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">dask</span><span class="o">=</span><span class="s1">&#39;parallelized&#39;</span><span class="p">,</span>
        <span class="n">dask_gufunc_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;allow_rechunk&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
        <span class="n">output_dtypes</span><span class="o">=</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
        <span class="n">keep_attrs</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>

    <span class="c1"># Compute the results</span>
    <span class="n">et</span> <span class="o">=</span> <span class="n">et_func</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">et</span>

<span class="c1"># Apply Thornthwaite grouped by year and month</span>
<span class="n">et_monthly</span> <span class="o">=</span> <span class="n">ds_monthly</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;time.year&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">apply_thornthwaite</span><span class="p">)</span>
<span class="n">et_monthly</span> <span class="o">=</span> <span class="n">et_monthly</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;et&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
</div>
<p>Having calculated ET, we can now plot the last time step of the data to visualise the spatial structure of SPEI.</p>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Selecting the last year of the series as an example</span>
<span class="n">et_last_year</span> <span class="o">=</span> <span class="n">et_monthly</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="o">-</span><span class="mi">12</span><span class="p">,</span><span class="kc">None</span><span class="p">))</span>
<span class="n">et_last_year_mean</span> <span class="o">=</span> <span class="n">et_last_year</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="s1">&#39;time&#39;</span><span class="p">])</span>

<span class="c1"># Plot the selected time step</span>
<span class="n">plot_maps</span><span class="p">(</span><span class="n">et_last_year_mean</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;coolwarm&#39;</span><span class="p">,</span>
           <span class="n">cbar_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="s1">&#39;Evapotranspiration (mm)&#39;</span><span class="p">,</span> <span class="s1">&#39;fraction&#39;</span><span class="p">:</span><span class="mf">0.03</span><span class="p">})</span>

<span class="n">start_plot</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">p_last_year</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">end_plot</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">p_last_year</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Mean Monthly Precipitation from </span><span class="si">{</span><span class="n">start_plot</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">end_plot</span><span class="si">}</span><span class="s1"> (E-OBS)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/4f5d19356095141d723fa0dbc962ea2c3c52731d9909ec73f9bf9b582ca68806.png" src="../_images/4f5d19356095141d723fa0dbc962ea2c3c52731d9909ec73f9bf9b582ca68806.png" />
</div>
</div>
<p>As with SPI, the SPEI index also requires the definition of the time scale for aggregating the variables and calculate its values as seasonal or annual summaries (e.g., 3 months, 6 months, 1 year). Here, we selected 6 months as the target time scale, and proceed to calculate the precipitation and evapotranspiration sums over this period. We will inspect the resulting time series.</p>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute sum and resample the dataset to seasonal totals (e.g. 3 months, 6 months, 1 year), keeping spatial dimensions</span>
<span class="n">time_scale</span> <span class="o">=</span> <span class="s1">&#39;6M&#39;</span>

<span class="n">precip_EOBS</span> <span class="o">=</span> <span class="n">data_EOBS</span><span class="p">[</span><span class="s1">&#39;rr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">time_scale</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="n">et_EOBS</span> <span class="o">=</span> <span class="n">et_monthly</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">time_scale</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Helper functions to calculate SPEI</span>
<span class="k">def</span><span class="w"> </span><span class="nf">calc_spei</span><span class="p">(</span><span class="n">precip</span><span class="p">):</span>

    <span class="n">count_nonzero_non_nan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">precip</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">precip</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">count_nonzero_non_nan</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">precip</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

    <span class="n">precip</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">precip</span><span class="p">)</span>

    <span class="n">shape</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">scale</span> <span class="o">=</span> <span class="n">gamma</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">precip</span><span class="p">)</span>
    <span class="n">gamma_dist</span> <span class="o">=</span> <span class="n">gamma</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">loc</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">)</span>
    <span class="n">cdf</span> <span class="o">=</span> <span class="n">gamma_dist</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">precip</span><span class="p">)</span>
    
    <span class="n">spi</span> <span class="o">=</span> <span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">cdf</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">spi</span>

<span class="c1"># Apply the SPI function using apply_ufunc, preserving spatial dimensions</span>
<span class="n">spi_values_EOBS</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">apply_ufunc</span><span class="p">(</span>
    <span class="n">calc_spei</span><span class="p">,</span>
    <span class="n">precip_EOBS</span><span class="o">-</span><span class="n">et_EOBS</span><span class="p">,</span>
    <span class="n">input_core_dims</span><span class="o">=</span><span class="p">[[</span><span class="s1">&#39;time&#39;</span><span class="p">]],</span>
    <span class="n">output_core_dims</span><span class="o">=</span><span class="p">[[</span><span class="s1">&#39;time&#39;</span><span class="p">]],</span>
    <span class="n">vectorize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">dask</span><span class="o">=</span><span class="s1">&#39;parallelized&#39;</span><span class="p">,</span>
    <span class="n">dask_gufunc_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;allow_rechunk&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
    <span class="n">output_dtypes</span><span class="o">=</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
    <span class="n">keep_attrs</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>

<span class="c1"># Compute the results</span>
<span class="n">spei_values_EOBS_compute</span> <span class="o">=</span> <span class="n">spi_values_EOBS</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
</div>
<p>As with SPI, we will also plot the SPEI time series over the Iberian Peninsula, highlighting the Moderate and Severe events detected.</p>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">start_date_plot_spei</span> <span class="o">=</span> <span class="s1">&#39;1950-01-01&#39;</span>
<span class="n">end_date_plot_spei</span> <span class="o">=</span> <span class="s1">&#39;2020-12-31&#39;</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Reduce to mean SPI over spatial dimensions (weighted latitude)</span>
<span class="n">spei_EOBS_weighted</span> <span class="o">=</span> <span class="n">spei_values_EOBS_compute</span><span class="o">.</span><span class="n">weighted</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
<span class="n">spei_mean_EOBS</span> <span class="o">=</span> <span class="n">spei_EOBS_weighted</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;latitude&#39;</span><span class="p">,</span> <span class="s1">&#39;longitude&#39;</span><span class="p">])</span>

<span class="c1">#select dates</span>
<span class="n">spei_mean_EOBS</span> <span class="o">=</span> <span class="n">spei_mean_EOBS</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">start_date_plot_spei</span><span class="p">,</span> <span class="n">end_date_plot_spei</span><span class="p">))</span>

<span class="c1">#interpolate to daily data for visualization</span>
<span class="n">time</span> <span class="o">=</span> <span class="n">spei_mean_EOBS</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span>
<span class="n">time</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
<span class="n">spei_mean_EOBS</span> <span class="o">=</span> <span class="n">spei_mean_EOBS</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">time</span><span class="p">)</span>

<span class="c1"># Find and print times where SPI indicates moderate droughst (SPI &lt; -1)</span>
<span class="n">drought_periods</span> <span class="o">=</span> <span class="n">spei_mean_EOBS</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">spei_mean_EOBS</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Convert the time coordinates to a pandas datetime index for better plotting</span>
<span class="n">time</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

<span class="c1"># Create the plot</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">spei_mean_EOBS</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;SPEI&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>

<span class="c1"># Highlight the drought periods using fill_between with appropriate mask</span>
<span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span> <span class="c1">#transparency</span>
<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">spei_mean_EOBS</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="p">((</span><span class="n">spei_mean_EOBS</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">spei_mean_EOBS</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">1.5</span><span class="p">)),</span>
                  <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Moderate Drought (SPEI [-1.5, -1[)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">spei_mean_EOBS</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="p">(</span><span class="n">spei_mean_EOBS</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">1.5</span><span class="p">),</span>
                  <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Severe Drought (SPEI [-2, -1.5[)&#39;</span><span class="p">)</span>

<span class="c1"># Add labels and title</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Time&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;SPEI&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Time Series of E-OBS SPEI with Moderate Drought Periods Highlighted&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=-</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Show the plot</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/7533b19319879339c7a0b87903fd4a376ade4d98249e00407be5a077eec8f41f.png" src="../_images/7533b19319879339c7a0b87903fd4a376ade4d98249e00407be5a077eec8f41f.png" />
</div>
</div>
<p>As we can see from this plot, SPEI also shows a tendency towards lower values in the last two decades. However, this index shows a higher frequency of severe drought periods. This is due to the evapotranspiration factor, providing a more sensitive assessment of the severity and impact of low precipitation periods. In particular, we observe 17 instances of Moderate drought since 1980, and 7 Severe Drought events after 1990. These findings  also agree with findings reported in the literature <a class="reference external" href="https://doi.org/10.1016/j.wace.2021.100320" rel="noreferrer" target="_blank">[7]</a>.</p>
</section>
<section id="comparing-spi-and-spei-climatologies">
<span id="insitu-insitu-gridded-observations-europe-climate-monitoring-q04-code-section-4"></span><h3>4. Comparing SPI and SPEI Climatologies<a class="headerlink" href="#comparing-spi-and-spei-climatologies" title="Link to this heading">#</a></h3>
<p>To further compare the E-OBS SPI and SPEI calculated results, let‚Äôs analyse the spatial patterns of their climatologies. With the subsets per period already selected, now it is time to calculate the climatological mean over each Time of Interest (ToI). Here, we calculate the pixel-wise annual mean SPI and SPEI values.</p>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define the periods</span>
<span class="n">periods</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;1951-01-01&#39;</span><span class="p">,</span> <span class="s1">&#39;1980-12-31&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;1961-01-01&#39;</span><span class="p">,</span> <span class="s1">&#39;1990-12-31&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;1971-01-01&#39;</span><span class="p">,</span> <span class="s1">&#39;2000-12-31&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;1981-01-01&#39;</span><span class="p">,</span> <span class="s1">&#39;2010-12-31&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;1991-01-01&#39;</span><span class="p">,</span> <span class="s1">&#39;2020-12-31&#39;</span><span class="p">)</span>
<span class="p">]</span>

<span class="c1"># Helper function to plot the climatology maps</span>
<span class="k">def</span><span class="w"> </span><span class="nf">compute_climatology</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="c1"># Calculate the mean data for each period</span>
    <span class="n">mean_data_clim</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="ow">in</span> <span class="n">periods</span><span class="p">:</span>
        <span class="n">mean_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">))</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>
        <span class="n">mean_data_clim</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mean_data</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mean_data_clim</span>

<span class="k">def</span><span class="w"> </span><span class="nf">plot_climatology</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">subtitle</span><span class="o">=</span><span class="s1">&#39;Mean Precipitation&#39;</span><span class="p">,</span> <span class="n">cb_label</span><span class="o">=</span><span class="s1">&#39;Precipitation (mm)&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="c1"># Create subplots</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">periods</span><span class="p">),</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">24</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">subplot_kw</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;projection&quot;</span><span class="p">:</span> <span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">()})</span>

    <span class="c1"># Plot each clim</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">subdata</span><span class="p">,</span> <span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">))</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">periods</span><span class="p">)):</span>
        <span class="n">lon_min</span><span class="p">,</span> <span class="n">lon_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">subdata</span><span class="o">.</span><span class="n">longitude</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">subdata</span><span class="o">.</span><span class="n">longitude</span><span class="p">)</span>
        <span class="n">lat_min</span><span class="p">,</span> <span class="n">lat_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">subdata</span><span class="o">.</span><span class="n">latitude</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">subdata</span><span class="o">.</span><span class="n">latitude</span><span class="p">)</span>

        <span class="n">facet</span> <span class="o">=</span> <span class="n">subdata</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span>
            <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
            <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">(),</span>
            <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span>  <span class="c1"># You can change the colormap</span>
            <span class="n">add_colorbar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="c1"># Disable the colorbar for now, we will add it later</span>
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>

        <span class="c1"># Set extent, add coastlines, and gridlines</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_extent</span><span class="p">([</span><span class="n">lon_min</span><span class="p">,</span> <span class="n">lon_max</span><span class="p">,</span> <span class="n">lat_min</span><span class="p">,</span> <span class="n">lat_max</span><span class="p">],</span> <span class="n">crs</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">())</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">coastlines</span><span class="p">(</span><span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">gl</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">gridlines</span><span class="p">(</span><span class="n">draw_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="n">gl</span><span class="o">.</span><span class="n">left_labels</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">gl</span><span class="o">.</span><span class="n">left_labels</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">gl</span><span class="o">.</span><span class="n">top_labels</span> <span class="o">=</span> <span class="n">gl</span><span class="o">.</span><span class="n">right_labels</span> <span class="o">=</span> <span class="kc">False</span>
        
        <span class="c1"># Title for each subplot</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">subtitle</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">start</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">end</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span><span class="c1">#, right=0.85) </span>

    <span class="n">cbar_ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mf">0.91</span><span class="p">,</span> <span class="mf">0.23</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.53</span><span class="p">])</span>  <span class="c1"># Adjust the position as needed</span>
    <span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">facet</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cbar_ax</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;vertical&#39;</span><span class="p">)</span>
    <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="n">cb_label</span><span class="p">)</span>

    <span class="c1"># Show the plot</span>
    <span class="c1">#plt.tight_layout()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plotting SPI</span>
<span class="n">mean_spi</span> <span class="o">=</span> <span class="n">compute_climatology</span><span class="p">(</span><span class="n">spi_values_EOBS_compute</span><span class="p">)</span>
<span class="n">plot_climatology</span><span class="p">(</span><span class="n">mean_spi</span><span class="p">,</span> <span class="n">subtitle</span><span class="o">=</span><span class="s1">&#39;Mean SPI&#39;</span><span class="p">,</span> <span class="n">cb_label</span><span class="o">=</span><span class="s1">&#39;SPI&#39;</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="mf">0.5</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/f30080086abdccac48174b9d8ceca5f3f3d6e8886c29ba6c616620da387f09bc.png" src="../_images/f30080086abdccac48174b9d8ceca5f3f3d6e8886c29ba6c616620da387f09bc.png" />
</div>
</div>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plotting SPEI</span>
<span class="n">mean_spei</span> <span class="o">=</span> <span class="n">compute_climatology</span><span class="p">(</span><span class="n">spei_values_EOBS_compute</span><span class="p">)</span>
<span class="n">plot_climatology</span><span class="p">(</span><span class="n">mean_spei</span><span class="p">,</span> <span class="n">subtitle</span><span class="o">=</span><span class="s1">&#39;Mean SPEI&#39;</span><span class="p">,</span> <span class="n">cb_label</span><span class="o">=</span><span class="s1">&#39;SPEI&#39;</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="mf">0.5</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/0c3ad10c9d5ca8483f0c766aa2bfe8a97e1f9d9edb2dac9c5614bc90fef4974e.png" src="../_images/0c3ad10c9d5ca8483f0c766aa2bfe8a97e1f9d9edb2dac9c5614bc90fef4974e.png" />
</div>
</div>
<p>From both the SPI and SPEI plots, we observe a noticeable decline in these indices over time across most of the region, indicating an increase in dry conditions. The spatial pattern is also consistent - on average, both indices denote drier conditions in southern and inland locations of the Iberian Peninsula, since 1981. The temporal distribution in these plots shows that higher SPI and SPEI values representing wetter conditions are more frequent in earlier climatology periods (1951-1980 and 1961-1990), while lower values, indicative of drought, are reached in the two most recent periods (1981-2010 and 1991-2020). These maps highlight the tendency for drier conditions. The most notorious SPI/SPEI decrease is in the North east of Portugal. On the contrary, the Pyrenees area shows an actual increase of SPI/SPEI, so wetter conditions are more frequent in the past 30 years.</p>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">start_clim1</span> <span class="o">=</span> <span class="s1">&#39;1960-01-01&#39;</span><span class="p">;</span> <span class="n">end_clim1</span> <span class="o">=</span> <span class="s1">&#39;1989-12-31&#39;</span>
<span class="n">start_clim2</span> <span class="o">=</span> <span class="s1">&#39;1990-01-01&#39;</span><span class="p">;</span> <span class="n">end_clim2</span> <span class="o">=</span> <span class="s1">&#39;2020-12-31&#39;</span>

<span class="n">SPEI_climatology1</span> <span class="o">=</span> <span class="n">spei_values_EOBS_compute</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">start_clim1</span><span class="p">,</span> <span class="n">end_clim1</span><span class="p">))</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">])</span>
<span class="n">SPEI_climatology2</span> <span class="o">=</span> <span class="n">spei_values_EOBS_compute</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">start_clim2</span><span class="p">,</span> <span class="n">end_clim2</span><span class="p">))</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</details>
</div>
</section>
<section id="calculate-linear-trends">
<span id="insitu-insitu-gridded-observations-europe-climate-monitoring-q04-code-section-5"></span><h3>5. Calculate Linear Trends<a class="headerlink" href="#calculate-linear-trends" title="Link to this heading">#</a></h3>
<p>To quantify drought changes over the Iberian Peninsula we will now use the Mann-Kendall test to assess the presence of a statistically significant monotonic trend over time. Additionally, the Sen Slope estimator will be applied to quantify the magnitude of the trend, providing an estimate of the rate of change. We will calculate these trend parameters for SPI and SPEI over this area, considering both the frequency of dry days and the magnitude of both indices (average and minimum).</p>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Helper function to apply Mann-Kendall and Sen&#39;s Slope for a specifi column of a dataframe df</span>
<span class="k">def</span><span class="w"> </span><span class="nf">apply_mk_sen</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">column</span><span class="p">):</span>
    <span class="n">np</span><span class="o">.</span><span class="n">float</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span>
    <span class="n">mk_result</span> <span class="o">=</span> <span class="n">mk</span><span class="o">.</span><span class="n">original_test</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">column</span><span class="p">])</span>
    <span class="n">sen_slope</span> <span class="o">=</span> <span class="n">mk</span><span class="o">.</span><span class="n">sens_slope</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">column</span><span class="p">])</span><span class="o">.</span><span class="n">slope</span>
    <span class="k">return</span> <span class="n">mk_result</span><span class="p">,</span> <span class="n">sen_slope</span>

<span class="c1"># Calculate the adjusted intercept - this is for visualization purposes</span>
<span class="k">def</span><span class="w"> </span><span class="nf">calculate_adjusted_intercept</span><span class="p">(</span><span class="n">intercept</span><span class="p">,</span> <span class="n">slope</span><span class="p">,</span> <span class="n">start_year</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">intercept</span> <span class="o">-</span> <span class="n">slope</span> <span class="o">*</span> <span class="n">start_year</span>

<span class="k">def</span><span class="w"> </span><span class="nf">show_mk_sen_results</span><span class="p">(</span><span class="n">df1</span><span class="p">,</span> <span class="n">df2</span><span class="p">,</span> <span class="n">name1</span><span class="o">=</span><span class="s1">&#39;P_EOBS_1&#39;</span><span class="p">,</span> <span class="n">name2</span><span class="o">=</span><span class="s1">&#39;P_EOBS_2&#39;</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function applies the Mann-Kendall and Sen Slope tests for two datasets and plots results side by side.</span>
<span class="sd">    df1, df2 -&gt; DataFrames for the two datasets</span>
<span class="sd">    name1, name2 -&gt; Names for variables in df1 and df2</span>
<span class="sd">    min -&gt; Boolean to specify whether to calculate minimum or maximum for stats</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">process_df</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="nb">min</span><span class="p">):</span>
        <span class="n">maxmin</span> <span class="o">=</span> <span class="s1">&#39;Min&#39;</span> <span class="k">if</span> <span class="nb">min</span> <span class="k">else</span> <span class="s1">&#39;Max&#39;</span>
        
        <span class="n">count_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Count_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="n">mean_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Mean_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="n">maxmin_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">maxmin</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span>

        <span class="c1"># Apply the Mann-Kendall and Sen&#39;s Slope tests</span>
        <span class="n">mk_count</span><span class="p">,</span> <span class="n">sen_slope_count</span> <span class="o">=</span> <span class="n">apply_mk_sen</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">count_name</span><span class="p">)</span>
        <span class="n">mk_mean</span><span class="p">,</span> <span class="n">sen_slope_mean</span> <span class="o">=</span> <span class="n">apply_mk_sen</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">mean_name</span><span class="p">)</span>
        <span class="n">mk_maxmin</span><span class="p">,</span> <span class="n">sen_slope_maxmin</span> <span class="o">=</span> <span class="n">apply_mk_sen</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">maxmin_name</span><span class="p">)</span>

        <span class="c1"># Adjust intercept for the year range</span>
        <span class="n">start_year</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Year&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">adjusted_intercept_count</span> <span class="o">=</span> <span class="n">calculate_adjusted_intercept</span><span class="p">(</span><span class="n">mk_count</span><span class="o">.</span><span class="n">intercept</span><span class="p">,</span> <span class="n">sen_slope_count</span><span class="p">,</span> <span class="n">start_year</span><span class="p">)</span>
        <span class="n">adjusted_intercept_mean</span> <span class="o">=</span> <span class="n">calculate_adjusted_intercept</span><span class="p">(</span><span class="n">mk_mean</span><span class="o">.</span><span class="n">intercept</span><span class="p">,</span> <span class="n">sen_slope_mean</span><span class="p">,</span> <span class="n">start_year</span><span class="p">)</span>
        <span class="n">adjusted_intercept_max</span> <span class="o">=</span> <span class="n">calculate_adjusted_intercept</span><span class="p">(</span><span class="n">mk_maxmin</span><span class="o">.</span><span class="n">intercept</span><span class="p">,</span> <span class="n">sen_slope_maxmin</span><span class="p">,</span> <span class="n">start_year</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">mk_count</span><span class="p">,</span> <span class="n">sen_slope_count</span><span class="p">,</span> <span class="n">adjusted_intercept_count</span><span class="p">,</span>
                <span class="n">mk_mean</span><span class="p">,</span> <span class="n">sen_slope_mean</span><span class="p">,</span> <span class="n">adjusted_intercept_mean</span><span class="p">,</span>
                <span class="n">mk_maxmin</span><span class="p">,</span> <span class="n">sen_slope_maxmin</span><span class="p">,</span> <span class="n">adjusted_intercept_max</span><span class="p">,</span>
                <span class="n">count_name</span><span class="p">,</span> <span class="n">mean_name</span><span class="p">,</span> <span class="n">maxmin_name</span><span class="p">,</span> <span class="n">maxmin</span><span class="p">)</span>

    <span class="c1"># Process both dataframes</span>
    <span class="n">results1</span> <span class="o">=</span> <span class="n">process_df</span><span class="p">(</span><span class="n">df1</span><span class="p">,</span> <span class="n">name1</span><span class="p">,</span> <span class="nb">min</span><span class="p">)</span>
    <span class="n">results2</span> <span class="o">=</span> <span class="n">process_df</span><span class="p">(</span><span class="n">df2</span><span class="p">,</span> <span class="n">name2</span><span class="p">,</span> <span class="nb">min</span><span class="p">)</span>

    <span class="c1"># Create a 2x3 grid of subplots</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">))</span>  <span class="c1"># 3 rows, 2 columns</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">plot_results</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">results</span><span class="p">,</span> <span class="n">ax_col</span><span class="p">):</span>
        <span class="p">(</span><span class="n">mk_count</span><span class="p">,</span> <span class="n">sen_slope_count</span><span class="p">,</span> <span class="n">adjusted_intercept_count</span><span class="p">,</span>
         <span class="n">mk_mean</span><span class="p">,</span> <span class="n">sen_slope_mean</span><span class="p">,</span> <span class="n">adjusted_intercept_mean</span><span class="p">,</span>
         <span class="n">mk_maxmin</span><span class="p">,</span> <span class="n">sen_slope_maxmin</span><span class="p">,</span> <span class="n">adjusted_intercept_max</span><span class="p">,</span>
         <span class="n">count_name</span><span class="p">,</span> <span class="n">mean_name</span><span class="p">,</span> <span class="n">maxmin_name</span><span class="p">,</span> <span class="n">maxmin</span><span class="p">)</span> <span class="o">=</span> <span class="n">results</span>

        <span class="c1"># Plot &#39;Count&#39; variable</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">ax_col</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Year&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="n">count_name</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Count&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">ax_col</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Year&#39;</span><span class="p">],</span> <span class="n">sen_slope_count</span> <span class="o">*</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Year&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">adjusted_intercept_count</span><span class="p">,</span>
                            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Sen&#39;s Slope&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">ax_col</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">count_name</span><span class="si">}</span><span class="s1"> with MK and Sen</span><span class="se">\&#39;</span><span class="s1">s Slope&#39;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">ax_col</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Year&#39;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">ax_col</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Count </span><span class="si">{</span><span class="n">count_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">ax_col</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">ax_col</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Slope: </span><span class="si">{</span><span class="n">sen_slope_count</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> dry days/year</span><span class="se">\n</span><span class="s2">P-value: </span><span class="si">{</span><span class="n">mk_count</span><span class="o">.</span><span class="n">p</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="se">\n</span><span class="s2">Tau: </span><span class="si">{</span><span class="n">mk_count</span><span class="o">.</span><span class="n">Tau</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="se">\n</span><span class="s2">Intercept: </span><span class="si">{</span><span class="n">mk_count</span><span class="o">.</span><span class="n">intercept</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> Events&quot;</span><span class="p">,</span>
                            <span class="n">transform</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">ax_col</span><span class="p">]</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>

        <span class="c1"># Plot &#39;Mean&#39;</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">ax_col</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Year&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="n">mean_name</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Mean&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">ax_col</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Year&#39;</span><span class="p">],</span> <span class="n">sen_slope_mean</span> <span class="o">*</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Year&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">adjusted_intercept_mean</span><span class="p">,</span>
                            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Sen&#39;s Slope&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">ax_col</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">mean_name</span><span class="si">}</span><span class="s1"> with MK and Sen</span><span class="se">\&#39;</span><span class="s1">s Slope&#39;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">ax_col</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Year&#39;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">ax_col</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">mean_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">ax_col</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">ax_col</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Slope: </span><span class="si">{</span><span class="n">sen_slope_mean</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> idx/year</span><span class="se">\n</span><span class="s2">P-value: </span><span class="si">{</span><span class="n">mk_mean</span><span class="o">.</span><span class="n">p</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="se">\n</span><span class="s2">Tau: </span><span class="si">{</span><span class="n">mk_mean</span><span class="o">.</span><span class="n">Tau</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="se">\n</span><span class="s2">Intercept: </span><span class="si">{</span><span class="n">mk_mean</span><span class="o">.</span><span class="n">intercept</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> idx&quot;</span><span class="p">,</span>
                            <span class="n">transform</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">ax_col</span><span class="p">]</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>

        <span class="c1"># Plot &#39;Max/Min&#39;</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">ax_col</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Year&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="n">maxmin_name</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">maxmin</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">ax_col</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Year&#39;</span><span class="p">],</span> <span class="n">sen_slope_maxmin</span> <span class="o">*</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Year&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">adjusted_intercept_max</span><span class="p">,</span>
                            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Sen&#39;s Slope&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">ax_col</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">maxmin_name</span><span class="si">}</span><span class="s1"> with MK and Sen</span><span class="se">\&#39;</span><span class="s1">s Slope&#39;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">ax_col</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Year&#39;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">ax_col</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">maxmin_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">ax_col</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">ax_col</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Slope: </span><span class="si">{</span><span class="n">sen_slope_maxmin</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> idx/year</span><span class="se">\n</span><span class="s2">P-value: </span><span class="si">{</span><span class="n">mk_maxmin</span><span class="o">.</span><span class="n">p</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="se">\n</span><span class="s2">Tau: </span><span class="si">{</span><span class="n">mk_maxmin</span><span class="o">.</span><span class="n">Tau</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="se">\n</span><span class="s2">Intercept: </span><span class="si">{</span><span class="n">mk_maxmin</span><span class="o">.</span><span class="n">intercept</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> idx&quot;</span><span class="p">,</span>
                            <span class="n">transform</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">ax_col</span><span class="p">]</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>

    <span class="c1"># Plot results for both datasets side by side</span>
    <span class="n">plot_results</span><span class="p">(</span><span class="n">df1</span><span class="p">,</span> <span class="n">results1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">plot_results</span><span class="p">(</span><span class="n">df2</span><span class="p">,</span> <span class="n">results2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Adjust layout</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
</div>
<p>To use the Mann-Kendall method on drought frequency, we discretize the SPI/SPEI values by creating ‚Äúdry_events‚Äù. We chose a threshold of -0.5 (and below) to create a singular dry event day (pixel wise and per timestep). This threshold grants a minimum statistical significance of number of events. You can experiment with this value, possibly to evaluate the more extreme dry conditions (e.g. -1 or below).</p>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># chosen SPI/SPEI maximum value for a drier event. Change this value to analyse different intervals, which will result in less or more total events.</span>
<span class="n">dryindex_threshold</span><span class="o">=-</span><span class="mf">0.5</span>

<span class="n">df_spi</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;Date&#39;</span><span class="p">:</span> <span class="n">spi_mean_EOBS</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="s1">&#39;Year&#39;</span><span class="p">:</span> <span class="n">spi_mean_EOBS</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="s1">&#39;daily_weighted&#39;</span><span class="p">:</span> <span class="n">spi_mean_EOBS</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="s1">&#39;dry_events&#39;</span><span class="p">:</span> <span class="n">spi_mean_EOBS</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">spi_mean_EOBS</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
<span class="p">})</span>

<span class="c1"># Group by year to calculate the required statistics</span>
<span class="n">df_spi_events_stats</span> <span class="o">=</span> <span class="n">df_spi</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;Year&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span>
    <span class="n">Count_spi</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;dry_events&#39;</span><span class="p">,</span> <span class="s1">&#39;count&#39;</span><span class="p">),</span>
    <span class="n">Mean_spi</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;daily_weighted&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">),</span>
    <span class="n">Min_spi</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;daily_weighted&#39;</span><span class="p">,</span> <span class="s1">&#39;min&#39;</span><span class="p">)</span>
<span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

<span class="n">df_spei</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;Date&#39;</span><span class="p">:</span> <span class="n">spei_mean_EOBS</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="s1">&#39;Year&#39;</span><span class="p">:</span> <span class="n">spei_mean_EOBS</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="s1">&#39;daily_weighted&#39;</span><span class="p">:</span> <span class="n">spei_mean_EOBS</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="s1">&#39;dry_events&#39;</span><span class="p">:</span> <span class="n">spei_mean_EOBS</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">spei_mean_EOBS</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
<span class="p">})</span>

<span class="c1"># Group by year to calculate the required statistics</span>
<span class="n">df_spei_events_stats</span> <span class="o">=</span> <span class="n">df_spei</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;Year&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span>
    <span class="n">Count_spei</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;dry_events&#39;</span><span class="p">,</span> <span class="s1">&#39;count&#39;</span><span class="p">),</span>
    <span class="n">Mean_spei</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;daily_weighted&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">),</span>
    <span class="n">Min_spei</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;daily_weighted&#39;</span><span class="p">,</span> <span class="s1">&#39;min&#39;</span><span class="p">)</span>
<span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

<span class="n">df_spei_events_stats</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Year</th>
      <th>Count_spei</th>
      <th>Mean_spei</th>
      <th>Min_spei</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1950</td>
      <td>129</td>
      <td>-0.283698</td>
      <td>-1.087246</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1951</td>
      <td>0</td>
      <td>0.404486</td>
      <td>0.131531</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1952</td>
      <td>0</td>
      <td>0.143075</td>
      <td>-0.468173</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1953</td>
      <td>188</td>
      <td>-0.474460</td>
      <td>-1.157757</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1954</td>
      <td>0</td>
      <td>-0.212683</td>
      <td>-0.468797</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot linear trend of SPI and SPEI</span>
<span class="n">show_mk_sen_results</span><span class="p">(</span><span class="n">df_spi_events_stats</span><span class="p">,</span> <span class="n">df_spei_events_stats</span><span class="p">,</span> <span class="n">name1</span><span class="o">=</span><span class="s1">&#39;spi&#39;</span><span class="p">,</span> <span class="n">name2</span><span class="o">=</span><span class="s1">&#39;spei&#39;</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/c3feb04ca0c17bb23d27f1f6e17dd12dab52894e558c75332405e0864aaeb8fa.png" src="../_images/c3feb04ca0c17bb23d27f1f6e17dd12dab52894e558c75332405e0864aaeb8fa.png" />
</div>
</div>
<p>From the above plots, we can see that the Mann-Kendall test results indicate that SPEI exhibits significantly more dry events, compared to SPI. Indeed, only SPEI denotes a significant upward trend in the frequency of dry days, with a linear change of 0.93 dry days per year. Likewise, only SPEI shows statistically significant magnitude changes, with SPEI index decreasing by 0.006 (mean) and 0.011 (minimum) per index value per year. Despite non-significant results, SPI also shows lower values and a decreasing Sen‚Äôs slope estimates. Finally, let‚Äôs inspect the spatial patterns of these trends to understand which regions show greater drought exposure.</p>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Helper function to calculate trend and significance</span>
<span class="k">def</span><span class="w"> </span><span class="nf">calculate_trend_and_significance</span><span class="p">(</span><span class="n">data_array</span><span class="p">):</span>
    <span class="c1"># Ensure the input array is a DataArray</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data_array</span><span class="p">,</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Input must be an xarray DataArray&quot;</span><span class="p">)</span>

    <span class="c1"># Rechunk the time dimension to a single chunk</span>
    <span class="n">data_array</span> <span class="o">=</span> <span class="n">data_array</span><span class="o">.</span><span class="n">chunk</span><span class="p">({</span><span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">})</span>

    <span class="c1"># Get the time dimension name</span>
    <span class="n">time_dim</span> <span class="o">=</span> <span class="s1">&#39;time&#39;</span>

    <span class="c1"># Calculate the slope using np.polyfit</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">polyfit_slope</span><span class="p">(</span><span class="n">y</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">slope</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">apply_ufunc</span><span class="p">(</span>
        <span class="n">polyfit_slope</span><span class="p">,</span>
        <span class="n">data_array</span><span class="p">,</span>
        <span class="n">vectorize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">input_core_dims</span><span class="o">=</span><span class="p">[[</span><span class="n">time_dim</span><span class="p">]],</span>
        <span class="n">dask</span><span class="o">=</span><span class="s2">&quot;parallelized&quot;</span><span class="p">,</span>
        <span class="n">output_dtypes</span><span class="o">=</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="c1"># Apply Mann-Kendall test</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">mann_kendall_p</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">mk</span><span class="o">.</span><span class="n">original_test</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">p</span>

    <span class="n">significance</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">apply_ufunc</span><span class="p">(</span>
        <span class="n">mann_kendall_p</span><span class="p">,</span>
        <span class="n">data_array</span><span class="p">,</span>
        <span class="n">vectorize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">input_core_dims</span><span class="o">=</span><span class="p">[[</span><span class="n">time_dim</span><span class="p">]],</span>
        <span class="n">dask</span><span class="o">=</span><span class="s2">&quot;parallelized&quot;</span><span class="p">,</span>
        <span class="n">output_dtypes</span><span class="o">=</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">slope</span><span class="p">,</span> <span class="n">significance</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Calculate the slope and significance per pixel</span>
<span class="n">slope_spi</span><span class="p">,</span> <span class="n">significance_spi</span> <span class="o">=</span> <span class="n">calculate_trend_and_significance</span><span class="p">(</span><span class="n">spi_values_EOBS_compute</span><span class="p">)</span>
<span class="n">slope_spei</span><span class="p">,</span> <span class="n">significance_spei</span> <span class="o">=</span> <span class="n">calculate_trend_and_significance</span><span class="p">(</span><span class="n">spei_values_EOBS_compute</span><span class="p">)</span>

<span class="c1"># Plot the results</span>
<span class="n">plot_maps</span><span class="p">(</span><span class="n">slope_spi</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">slope_spi</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">),</span> <span class="n">slope_spei</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">slope_spei</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;coolwarm_r&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="mf">0.015</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mf">0.015</span><span class="p">,</span> <span class="n">cbar_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;fraction&#39;</span><span class="p">:</span> <span class="mf">0.03</span><span class="p">,</span> <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="s1">&#39;Slope&#39;</span><span class="p">})</span>

<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Sen Slope (E-OBS) with Significant Areas: SPI (Left) vs SPEI (Right)&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>

<span class="c1"># Adjust layout to prevent overlap</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/1ceda091268fc1f693bd5ee946e1aef4546bd53ddb6d770a8bf286e625ec8e38.png" src="../_images/1ceda091268fc1f693bd5ee946e1aef4546bd53ddb6d770a8bf286e625ec8e38.png" />
</div>
</div>
<p>As with the time series and trend analysis plots, SPEI values are greater, denoting higher sensitivity in detecting drought conditions. While SPI trends have very low magnitudes (thus resulting in non-significant linear changes), the SPEI results indicate a more or less homogenous tendency for drier conditions over the Iberian Peninsula, particularly in the inland northern part of Portugal, and over the south and inland parts of Spain, where evapotranspiration is more significant (see the evapotranspiration plot above). Some exceptions with a positive slope towards wetter conditions (SPEI) are visible in the Pyrenees, Asturias and Valencia regions. Together with the climatology maps and the time series and trend analysis shown before, these results showcase how much the Iberian Peninsula is subject to drought conditions, recently, agreeing with existing literature <a class="reference external" href="https://doi.org/10.1016/j.wace.2021.100320" rel="noreferrer" target="_blank">[7]</a> and suggesting that some of the foreseen impacts of climate change over this region are already underway.</p>
<hr class="docutils" />
<section id="discussion">
<h4>Discussion<a class="headerlink" href="#discussion" title="Link to this heading">#</a></h4>
<p>The analysis of drought exposure across regions, based on the SPI and SPEI indices, provides valuable insights into changing drought patterns from 1950 to 2020. One of the main findings is that SPEI, which incorporates evapotranspiration, offers a more sensitive depiction of severe drought events compared with SPI, which focuses solely on precipitation. This distinction is particularly important in regions where evapotranspiration significantly influences water availability.</p>
<p>The use of the Mann‚ÄìKendall test and Sen‚Äôs slope analysis has helped disclose the magnitude of change over this area and identify which regions are most exposed to droughts. The analysis clearly indicates that the northeast of Portugal is among the regions most affected by increases in drought frequency and severity, as are the inland and southern parts of Spain. The Sen‚Äôs slope graphs, which show a more negative trend in SPEI values, support this conclusion, highlighting a more pronounced drying trend in these areas compared with others, even though results are overall homogeneous across the Iberian Peninsula.</p>
<p>Conversely, some regions, such as the Pyrenees and parts of Asturias and Valencia, show a trend towards wetter conditions over the last 30 years. This suggests that while many regions are becoming drier, there are localised areas that are experiencing increased precipitation and moisture.</p>
<p>The analysis reveals that from 1985 to 2020, there has been a significant increase in moderate to severe drought periods, particularly in the second half of this timeframe. The SPI and SPEI plots both show a marked decline in these indices over time, with wetter conditions being more frequent in the earlier years of the study period. This temporal shift in SPI and SPEI values points to a clear intensification of droughts, with dry conditions becoming more common in recent decades. Nevertheless, precipitation shows substantial interannual variability.</p>
<p>The results of the Mann‚ÄìKendall test further reinforce this observation. The upward trend in the frequency of dry events is particularly noticeable in the SPEI dataset, where a positive slope of 0.93 dry days per year reflects the increasing severity of droughts. This trend is particularly pronounced in southern and inland Spain, where high evapotranspiration rates exacerbate drying conditions.</p>
<p>Overall, the SPEI index derived from E-OBS provides a more sensitive assessment of drought trends, capturing not only the lack of precipitation but also the impact of increasing temperatures and evaporation rates. This makes E-OBS suitable for long-term drought monitoring, particularly in regions where evapotranspiration plays a critical role.</p>
</section>
</section>
<section id="main-takeaways">
<span id="insitu-insitu-gridded-observations-europe-climate-monitoring-q04-code-section-6"></span><h3>6. Main Takeaways<a class="headerlink" href="#main-takeaways" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>The SPEI index, which accounts for evapotranspiration, provides a more sensitive depiction of severe droughts compared with SPI, which focuses solely on precipitation. This highlights its importance in regions where evapotranspiration significantly affects water availability.</p></li>
<li><p>The northeast of Portugal and southern/inland Spain show the greatest increase in drought frequency and severity, supported by negative trends in SPEI values. Conversely, localised areas such as the Pyrenees and parts of Asturias and Valencia indicate wetter trends over the last 30 years.</p></li>
<li><p>From 1985 to 2020, there has been a significant rise in moderate to severe drought periods, with dry conditions becoming more frequent in recent decades. The SPI and SPEI plots show wetter conditions in earlier years, transitioning towards intensified droughts with marked interannual variability.</p></li>
<li><p>The SPEI index derived from E-OBS captures both precipitation deficits and the impacts of rising temperatures and evaporation rates, making it more effective for long-term drought monitoring in regions where evapotranspiration plays a critical role.</p></li>
</ul>
</section>
</section>
<section id="i-if-you-want-to-know-more">
<h2>‚ÑπÔ∏è If you want to know more<a class="headerlink" href="#i-if-you-want-to-know-more" title="Link to this heading">#</a></h2>
<section id="key-resources">
<h3>Key resources<a class="headerlink" href="#key-resources" title="Link to this heading">#</a></h3>
<p>Some key resources and further reading were linked throughout this assessment.</p>
<p>The CDS catalogue entry for the data used were:</p>
<ul class="simple">
<li><p>E-OBS daily gridded meteorological data for Europe from 1950 to present derived from in-situ observations:
<a class="reference external" href="https://cds.climate.copernicus.eu/datasets/insitu-gridded-observations-europe?tab=overview" rel="noreferrer" target="_blank">https://cds.climate.copernicus.eu/datasets/insitu-gridded-observations-europe?tab=overview</a></p></li>
<li><p>ERA5 hourly data on pressure levels from 1940 to present:
<a class="reference external" href="https://cds.climate.copernicus.eu/datasets/reanalysis-era5-pressure-levels?tab=overview" rel="noreferrer" target="_blank">https://cds.climate.copernicus.eu/datasets/reanalysis-era5-pressure-levels?tab=overview</a></p></li>
</ul>
<p>Code libraries used:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/bopen/c3s-eqc-automatic-quality-control/tree/main/c3s_eqc_automatic_quality_control" rel="noreferrer" target="_blank">C3S EQC custom functions</a>, <code class="docutils literal notranslate"><span class="pre">c3s_eqc_automatic_quality_control</span></code>,  prepared by <a class="reference external" href="https://www.bopen.eu/" rel="noreferrer" target="_blank">B-Open</a></p></li>
</ul>
</section>
<section id="references">
<h3>References:<a class="headerlink" href="#references" title="Link to this heading">#</a></h3>
<p><a class="reference external" href="https://climate.copernicus.eu/esotc/2023" rel="noreferrer" target="_blank">[1]</a> Copernicus Climate Change Service. 2024. European State of the Climate 2023.</p>
<p><a class="reference external" href="https://climpact-sci.org/" rel="noreferrer" target="_blank">[2]</a> Climpact. 2024.</p>
<p><a class="reference external" href="https://library.wmo.int/index.php?lvl=notice_display&amp;amp;id=20130" rel="noreferrer" target="_blank">[3]</a> World Meteorological Organization (WMO) Guidelines on the Calculation of Climate Normals.</p>
<p><a class="reference external" href="https://doi.org/full/10.1029/2017JD028200" rel="noreferrer" target="_blank">[4]</a> Cornes, R., G. van der Schrier, E.J.M. van den Besselaar, and P.D. Jones. (2018). An Ensemble Version of the E-OBS Temperature and Precipitation Datasets, J. Geophys. Res. (Atmospheres), 123.</p>
<p><a class="reference external" href="https://doi.org/10.1002/joc.7269" rel="noreferrer" target="_blank">[5]</a> Bandhauer, M., Isotta, F., Lakatos, M., Lussana, C., B√•serud, L., Izs√°k, B., Szentes, O., Tveito, O. E., &amp; Frei, C. (2022). Evaluation of daily precipitation analyses in E-OBS (v19.0e) and ERA5 by comparison to regional high-resolution datasets in European regions. International Journal of Climatology, 42(2), 727-747.</p>
<p><a class="reference external" href="https://doi.org/10.1002/joc.6950" rel="noreferrer" target="_blank">[6]</a> Mavromatis, T. &amp; Voulanas, Dimitrios. (2020). Evaluating ERA‚ÄêInterim, Agri4Cast, and E‚ÄêOBS gridded products in reproducing spatiotemporal characteristics of precipitation and drought over a data poor region: The Case of Greece. International Journal of Climatology. 41.</p>
<p><a class="reference external" href="https://doi.org/10.1016/j.wace.2021.100320" rel="noreferrer" target="_blank">[7]</a> P√°scoa, Patr√≠cia, Russo, Ana, Gouveia, C√©lia. M., Soares, Pedro M.M., Cardoso, Rita M., Careto, Jo√£o A.M., Ribeiro, Andreia F.S. (2021). A high-resolution view of the recent drought trends over the Iberian Peninsula. Weather and Climate Extremes, Volume 32, 100320.</p>
<p><a class="reference external" href="https://github.com/monocongo/climate_indices" rel="noreferrer" target="_blank">[8]</a> Adams, J. (2017). Climate_indices, an open source Python library providing reference implementations of commonly used climate indices.</p>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./In_Situ"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="insitu.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title"><span class="section-number">2. </span>Insitu Observations</p>
      </div>
    </a>
    <a class="right-next"
       href="../Reanalyses/reanalysis.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title"><span class="section-number">3. </span>Reanalysis</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#use-case-adaptation-to-climate-extremes">üåç Use case: Adaptation to Climate Extremes.</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#quality-assessment-question">‚ùì Quality assessment question</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#quality-assessment-statement">üì¢ Quality assessment statement</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#methodology">üìã Methodology</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#analysis-and-results">üìà Analysis and results</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#define-the-aoi-search-and-download-e-obs">1. Define the AoI, search and download E-OBS</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#import-all-the-libraries-packages">Import all the libraries/packages</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#data-overview">Data Overview</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#download-and-prepare-e-obs-data">1.1. Download and prepare E-OBS data</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#inspect-and-view-data">1.2. Inspect and view data</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#calculate-standardized-precipitation-index-spi">2. Calculate Standardized Precipitation Index (SPI)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#calculate-standardized-precipitation-evapotranspiration-index-spei">3. Calculate Standardized Precipitation Evapotranspiration Index (SPEI)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#comparing-spi-and-spei-climatologies">4. Comparing SPI and SPEI Climatologies</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#calculate-linear-trends">5. Calculate Linear Trends</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#discussion">Discussion</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#main-takeaways">6. Main Takeaways</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#i-if-you-want-to-know-more">‚ÑπÔ∏è If you want to know more</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#key-resources">Key resources</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#references">References:</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By the Copernicus Climate Change Service (C3S), entrusted to ECMWF (European Centre for Medium-Range Weather Forecasts)
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      ¬© Copyright 2024.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>