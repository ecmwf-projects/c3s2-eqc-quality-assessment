
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>5.1.4. Biases in energy-consumption-related indices in Europe &#8212; eqcbook</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'Climate_Projections/CMIP6/climate_projections-cmip6_climate-impact-indicators_q01';</script>
    <link rel="icon" href="../../_static/C3S_favicon.png"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="5.1.5. Uncertainty in projected changes of energy consumption in Europe" href="climate_projections-cmip6_climate-impact-indicators_q02.html" />
    <link rel="prev" title="5.1.3. Uncertainty in projected changes in extreme temperature indices at a 2¬∞C Global Warming Level for the reinsurance sector" href="climate_projections-cmip6_climate-and-weather-extremes_q03.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>
<aside class="bd-header-announcement" aria-label="Announcement">
  <div class="bd-header-announcement__content">‚ö†Ô∏èThis is under development!‚ö†Ô∏è</div>
</aside>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/C3S‚ÄìPOS‚ÄìLINE.png" class="logo__image only-light" alt="eqcbook - Home"/>
    <script>document.write(`<img src="../../_static/C3S‚ÄìPOS‚ÄìLINE.png" class="logo__image only-dark" alt="eqcbook - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../intro.html">
                    C3S EQC quality assessments
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">‚û°Ô∏è Satellite Observations</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../Satellite_ECVs/satellite.html">1. Quality assessments for Satellite Observations</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../Satellite_ECVs/Atmosphere_Physics/Atmosphere_Physics.html">1.1. Atmosphere Physics</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="simple">
</ul>
</details></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../Satellite_ECVs/Atmospheric_Composition/Atmospheric_Composition.html">1.2. Atmospheric Composition</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../../Satellite_ECVs/Atmospheric_Composition/satellite_satellite-carbon-dioxide_trend-assessment_q01.html">1.2.1. Carbon dioxide satellite observations completeness assessment for greenhouse gas monitoring</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../Satellite_ECVs/Atmospheric_Composition/satellite_satellite-carbon-dioxide_uncertainty-quality-flags_q02.html">1.2.2. Spatial and temporal completeness and uncertainties of carbon dioxide satellite observations for quantifying atmospheric greenhouse gas variability</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../Satellite_ECVs/Atmospheric_Composition/satellite_satellite-methane_uncertainty_q01.html">1.2.3. Methane satellite observations uncertainty and completeness assessment for carbon cycle</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../Satellite_ECVs/Atmospheric_Composition/satellite_satellite-ozone-v1_climate-monitoring_q01.html">1.2.4. Temporal and spatial completeness of the satellite-derived Ozone for policy making and variability studies</a></li>
</ul>
</details></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../Satellite_ECVs/Cryosphere/Cryosphere.html">1.3. Cryosphere</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../../Satellite_ECVs/Cryosphere/satellite_derived-gridded-glacier-mass-change_data-completeness_q01.html">1.3.1. Glacier mass change data from satellite and in-situ observations: uncertainty analysis for glaciological and climate change monitoring</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../Satellite_ECVs/Cryosphere/satellite_satellite-ice-sheet-elevation-change_consistency-assessment_q02.html">1.3.2. Spatio-temporal data completeness and consistency of remote sensing-derived ice sheet surface elevation changes over Antarctica</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../Satellite_ECVs/Cryosphere/satellite_satellite-ice-sheet-elevation-change_trend-assessment_q01.html">1.3.3. Uncertainty of ice sheet surface elevation change¬†data over Greenland for volume and mass change trend assessments</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../Satellite_ECVs/Cryosphere/satellite_satellite-ice-sheet-mass-balance_trend-assessment_q02.html">1.3.4. Gravimetric mass balance data from satellite observations: utility analysis for mass change monitoring of the ice sheets</a></li>
</ul>
</details></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../Satellite_ECVs/Land_Biosphere/Land_Biosphere.html">1.4. Land Biosphere</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../../Satellite_ECVs/Land_Biosphere/satellite_satellite-fire-burned-area_climate-and-weather-extremes_q01.html">1.4.1. Satellite fire burned area completeness for seasonal climatology maps</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../Satellite_ECVs/Land_Biosphere/satellite_satellite-fire-burned-area_trend-assessment_q02.html">1.4.2. Satellite fire burned area trends assessment for climate monitoring</a></li>
</ul>
</details></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../Satellite_ECVs/Land_Hydrology/Land_Hydrology.html">1.5. Land Hydrology</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="simple">
</ul>
</details></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../Satellite_ECVs/Ocean/Ocean.html">1.6. Ocean</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../../Satellite_ECVs/Ocean/satellite_satellite-ocean-colour_consistency-assessment_q01.html">1.6.1. Impact of using successive satellites on Ocean Colour time series</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../Satellite_ECVs/Ocean/satellite_satellite-sea-ice-edge-type_intercomparison_q01.html">1.6.2. Intercomparison of satellite multi-year sea ice extent estimates</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../Satellite_ECVs/Ocean/satellite_satellite-sea-ice-thickness_trend-assessment_q01.html">1.6.3. Suitability of satellite sea ice thickness data for studying climate change</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../Satellite_ECVs/Ocean/satellite_satellite-sea-level-global_trend-assessment_q01.html">1.6.4. Regional sea level trend assessment in the Mediterranean Sea from Satellite (observations) at basin and sub-basin scale</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../Satellite_ECVs/Ocean/satellite_satellite-sea-surface-temperature_consistency_q01.html">1.6.5. Consistency Assessment of Satellite Sea Surface Temperature for Climate Monitoring</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../Satellite_ECVs/Ocean/satellite_satellite-sea-surface-temperature_consistency_q02.html">1.6.6. Satellite Sea Surface Temperature Consistency in representing Ocean Warming Trends</a></li>
</ul>
</details></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">‚û°Ô∏è Insitu Observations</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../In_Situ/insitu.html">2. Quality assessments for Insitu Observations</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="simple">
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">‚û°Ô∏è Reanalysis</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../Reanalyses/reanalysis.html">3. Quality assessments for Reanalysis</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="simple">
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">‚û°Ô∏è Seasonal Forecasts</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../Seasonal_Forecasts/seasonal.html">4. Quality assessments for Seasonal Forecasts</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../Seasonal_Forecasts/seasonal_seasonal-monthly-single-levels_forecast-skill_q02.html">4.1. Seasonal forecasts bias assessment for impact models</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../Seasonal_Forecasts/seasonal_seasonal-monthly-single-levels_forecast-skill_q04.html">4.2. Evaluation of the hit-rate of seasonal forecasts for tercile categories of monthly anomalies</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../Seasonal_Forecasts/seasonal_seasonal-monthly-single-levels_uncertainty-quality-flags_q01.html">4.3. Assessing possible outcomes of seasonal temperature forecast</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">‚û°Ô∏è Climate Projections</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 current active has-children"><a class="reference internal" href="../climate.html">5. Quality assessments for Climate Projections</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="current">
<li class="toctree-l2 current active has-children"><a class="reference internal" href="CMIP6.html">5.1. CMIP6</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="climate_projections-cmip6_climate-and-weather-extremes_q01.html">5.1.1. Bias in extreme temperature indices for the reinsurance sector</a></li>
<li class="toctree-l3"><a class="reference internal" href="climate_projections-cmip6_climate-and-weather-extremes_q02.html">5.1.2. Uncertainty in projected changes in extreme temperature indices for the reinsurance sector</a></li>
<li class="toctree-l3"><a class="reference internal" href="climate_projections-cmip6_climate-and-weather-extremes_q03.html">5.1.3. Uncertainty in projected changes in extreme temperature indices at a 2¬∞C Global Warming Level for the reinsurance sector</a></li>
<li class="toctree-l3 current active"><a class="current reference internal" href="#">5.1.4. Biases in energy-consumption-related indices in Europe</a></li>
<li class="toctree-l3"><a class="reference internal" href="climate_projections-cmip6_climate-impact-indicators_q02.html">5.1.5. Uncertainty in projected changes of energy consumption in Europe</a></li>
<li class="toctree-l3"><a class="reference internal" href="climate_projections-cmip6_climate-impact-indicators_q03.html">5.1.6. Uncertainty in projected changes of energy consumption in Europe at a 2¬∞C Global Warming Level</a></li>
<li class="toctree-l3"><a class="reference internal" href="climate_projections-cmip6_climate-impact-indicators_q04.html">5.1.7. Projections of future ice-free periods for the Arctic and Antarctic</a></li>
<li class="toctree-l3"><a class="reference internal" href="climate_projections-cmip6_model-performance_q02.html">5.1.8. Historical accuracy of sea ice extent in the CMIP6 projections</a></li>
<li class="toctree-l3"><a class="reference internal" href="climate_projections-cmip6_model-performance_q03.html">5.1.9. Evaluation of the Arctic sea ice thickness in the CMIP6 historical experiments</a></li>
<li class="toctree-l3"><a class="reference internal" href="climate_projections-cmip6_validation_q10.html">5.1.10. Testing the capability of CMIP6 GCMs to represent precipitation inter-annual variability</a></li>
<li class="toctree-l3"><a class="reference internal" href="climate_projections-cmip6_validation_q11.html">5.1.11. Testing the capability of CMIP6 GCMs to represent precipitation intra-seasonal variability</a></li>
</ul>
</details></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../CORDEX/CORDEX.html">5.2. CORDEX</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../CORDEX/climate_projections-cordex-domains-single-levels_climate-and-weather-extremes_q01.html">5.2.1. Bias in extreme temperature indices for the reinsurance sector</a></li>
<li class="toctree-l3"><a class="reference internal" href="../CORDEX/climate_projections-cordex-domains-single-levels_climate-and-weather-extremes_q02.html">5.2.2. Uncertainty in projected changes in extreme temperature indices for the reinsurance sector</a></li>
<li class="toctree-l3"><a class="reference internal" href="../CORDEX/climate_projections-cordex-domains-single-levels_climate-and-weather-extremes_q03.html">5.2.3. Bias in precipitation-based indices for impact models</a></li>
<li class="toctree-l3"><a class="reference internal" href="../CORDEX/climate_projections-cordex-domains-single-levels_climate-and-weather-extremes_q04.html">5.2.4. Projected changes in precipitation-based indices for impact models</a></li>
<li class="toctree-l3"><a class="reference internal" href="../CORDEX/climate_projections-cordex-domains-single-levels_validation_q05.html">5.2.5. CORDEX temperature biases over the Alpine region for the ski and hydrological sectors.</a></li>
</ul>
</details></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">‚û°Ô∏è Climate Indicators</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../Indicators/indicator.html">6. Quality assessments for Climate Indicators</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="simple">
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">‚û°Ô∏è Derived Datasets</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../Derived_Datasets/derived.html">7. Quality assessments for Derived Datasets</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="simple">
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">‚û°Ô∏è Applications</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../Applications/application.html">8. Quality assessments for C3S Applications</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="simple">
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Quality assessment template</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../templates/template_instructions.html">Template instructions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../templates/template.html">Template</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/ecmwf-projects/c3s2-eqc-quality-assessment" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/ecmwf-projects/c3s2-eqc-quality-assessment/issues/new?title=Issue%20on%20page%20%2FClimate_Projections/CMIP6/climate_projections-cmip6_climate-impact-indicators_q01.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/Climate_Projections/CMIP6/climate_projections-cmip6_climate-impact-indicators_q01.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Biases in energy-consumption-related indices in Europe</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#use-case-assessing-possible-impacts-of-climate-change-on-energy-demand-in-europe">üåç Use case: Assessing possible impacts of climate change on energy demand in Europe</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#quality-assessment-question">‚ùì Quality assessment question</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#quality-assessment-statement">üì¢ Quality assessment statement</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#methodology">üìã Methodology</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#analysis-and-results">üìà Analysis and results</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#parameters-requests-and-functions-definition">1. Parameters, requests and functions definition</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#import-packages">1.1. Import packages</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#define-parameters">1.2. Define Parameters</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#define-models">1.3. Define models</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#define-era5-request">1.4. Define ERA5 request</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#define-model-requests">1.5. Define model requests</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#functions-to-cache">1.6. Functions to cache</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#downloading-and-processing">2. Downloading and processing</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#download-and-transform-era5">2.1. Download and transform ERA5</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#download-and-transform-models">2.2. Download and transform models</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#apply-land-sea-mask-change-attributes-and-cut-the-region-to-show">2.3. Apply land-sea mask, change attributes and cut the region to show</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-and-describe-results">3. Plot and describe results</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#define-plotting-functions">3.1. Define plotting functions</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-ensemble-maps">3.2. Plot ensemble maps</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-model-maps">3.3. Plot model maps</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-bias-maps">3.4. Plot bias maps</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#boxplots-of-the-historical-trend">3.5. Boxplots of the historical trend</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#results-summary-and-discussion">3.6. Results summary and discussion</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#i-if-you-want-to-know-more">‚ÑπÔ∏è If you want to know more</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#key-resources">Key resources</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#references">References</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <p><img alt="logo" src="../../_images/LogoLine_horizon_C3S1.png" /></p>
<section class="tex2jax_ignore mathjax_ignore" id="biases-in-energy-consumption-related-indices-in-europe">
<h1><span class="section-number">5.1.4. </span>Biases in energy-consumption-related indices in Europe<a class="headerlink" href="#biases-in-energy-consumption-related-indices-in-europe" title="Link to this heading">#</a></h1>
<p>Production date: 22-05-2024</p>
<p>Produced by: CMCC foundation - Euro-Mediterranean Center on Climate Change. Albert Martinez Boti.</p>
<section id="use-case-assessing-possible-impacts-of-climate-change-on-energy-demand-in-europe">
<h2>üåç Use case: Assessing possible impacts of climate change on energy demand in Europe<a class="headerlink" href="#use-case-assessing-possible-impacts-of-climate-change-on-energy-demand-in-europe" title="Link to this heading">#</a></h2>
</section>
<section id="quality-assessment-question">
<h2>‚ùì Quality assessment question<a class="headerlink" href="#quality-assessment-question" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p><strong>How well do the CMIP6 projections represent Energy Degree Days climatology and trend over a historic period?</strong></p></li>
</ul>
<p>Sectors affected by climate change are varied including agriculture <a class="reference external" href="https://doi.org/10.1007/s10113-010-0173-x" rel="noreferrer" target="_blank">[1]</a>, forest ecosystems <a class="reference external" href="https://doi.org/10.1016/j.foreco.2009.09.023" rel="noreferrer" target="_blank">[2]</a>, and energy consumption <a class="reference external" href="https://doi.org/10.1016/j.enbuild.2014.09.052" rel="noreferrer" target="_blank">[3]</a>. Under projected future global warming over Europe <a class="reference external" href="https://doi.org/10.1007/s10113-013-0499-2" rel="noreferrer" target="_blank">[4]</a><a class="reference external" href="http://hdl.handle.net/10013/epic.45156.d001" rel="noreferrer" target="_blank">[5]</a>, the current increase in energy demand is expected to persist until the end of this century and beyond <a class="reference external" href="https://doi.org/10.1002/joc.5362" rel="noreferrer" target="_blank">[6]</a>. Identifying which climate-change-related impacts are likely to increase, by how much, and inherent regional patterns, is important for any effective strategy for managing future climate risks. This notebook utilises data from a subset of models from <a class="reference external" href="https://cds.climate.copernicus.eu/datasets/projections-cmip6?tab=overview" rel="noreferrer" target="_blank">CMIP6</a> Global Climate Models (GCMs) and compares them with <a class="reference external" href="https://cds.climate.copernicus.eu/datasets/reanalysis-era5-complete?tab=doc" rel="noreferrer" target="_blank">ERA5</a> reanalysis, serving as the reference product. Two energy-consumption-related indices are calculated from daily mean temperatures using the <a class="reference external" href="https://icclim.readthedocs.io/en/stable/" rel="noreferrer" target="_blank">icclim</a> Python package: Cooling Degree Days (CDDs) and Heating Degree Days (HDDs). Degree days measure how much warmer or colder it is compared to standard temperatures (usually 15.5¬∞C for heating and 22¬∞C for cooling). Higher degree day numbers indicate more extreme temperatures, which typically lead to increased energy use for heating or cooling buildings. In the presented code, CDD calculations use summer aggregation (CDD22), while HDD calculations focus on winter (HDD15.5), presenting results as daily averages rather than cumulative values. Within this notebook, these calculations are performed over the historical period spanning from 1971 to 2000. It is important to note that the results presented here pertain to a specific subset of the CMIP6 ensemble and may not be generalisable to the entire dataset. Also note that a separate assessment examines the representation of trends of these indices for the same models during a fixed future period (2015-2099), while another assessment looks at the projected climate signal of these indices for the same models at a 2¬∞C Global Warming Level.</p>
</section>
<section id="quality-assessment-statement">
<h2>üì¢ Quality assessment statement<a class="headerlink" href="#quality-assessment-statement" title="Link to this heading">#</a></h2>
<div class="note admonition">
<p class="admonition-title">These are the key outcomes of this assessment</p>
<ul class="simple">
<li><p>CMIP6 projections provide valuable insights into trends and climatology of Energy Degree Days across Europe, though with inherent uncertainties, and differences compared to the reference dataset (ERA5). During the historical period (1971-2000), GCMs exhibited biases in capturing both mean values and trends for energy-consumption-related indices.</p></li>
<li><p>For the 16 models considered, biases were observed in mean values of Heating Degree Days (‚ÄòHDD15.5‚Äô) over DJF and Cooling Degree Days (‚ÄòCDD22‚Äô) over JJA. Specifically, for most of the models, there is an overestimation of HDD15.5 mean values for DJF (except in regions with complex orography where there was underestimation) and CDD22 mean values for JJA across most of the Mediterranean Basin.</p></li>
<li><p>The subset of CMIP6 models show a decrease in the energy needed for heating during winter within the historical period across Europe, especially in the eastern and northern regions. This aligns with results obtained using the ERA5 reference product, except in the Balkans where there is an increase in required heating energy during this period. The ERA5 reference product also shows an increase of the amount of energy needed for cooling buildings in summer during this period, particularly across the Mediterranean Basin. This trend is well captured by the subset of CMIP6 models. Depending on the region, these results may enhance confidence in using these models for analysing future trends, although they do not guarantee accuracy.</p></li>
<li><p>Despite the biases and high inter-model spread in some regions, the outcomes of this notebook offer valuable insights for decisions sensitive to future energy demand. These results may enhance confidence in using these models to analyse future trends, although their accuracy is not assured. To improve the accuracy of these insights, biases should be considered and corrected <a class="reference external" href="https://doi.org/10.1002/joc.5362" rel="noreferrer" target="_blank">[6]</a><a class="reference external" href="https://doi.org/10.1038/s41467-021-25504-8" rel="noreferrer" target="_blank">[7]</a>.</p></li>
</ul>
</div>
<figure class="align-default" id="id1">
<a class="reference internal image-reference" href="../../_images/83f3529b-f7ec-456a-aab1-9dee68ba895b.png"><img alt="Mean Bias HDD" src="../../_images/83f3529b-f7ec-456a-aab1-9dee68ba895b.png" style="width: 900px;" />
</a>
<figcaption>
<p><span class="caption-number">Fig. 5.1.4.1 </span><span class="caption-text">Heating Degree Days daily average calculated using the winter comfort threshold of 15.5¬∞C (‚ÄòHDD15.5‚Äô) for the temporal aggreggtion of ‚ÄòDJF‚Äô. Mean bias for the historical period (1971 - 2000) of each individual CMIP6 model. The colorbar chosen for representing biases for the HDD15.5 index ranges from red to blue. In this color scheme, negative bias values (red colors) indicate that the Heating Degree Days displayed by the models are lower than those shown by ERA5. Instead, blueish colors denote more Heating Degree Days, indicating a positive bias compared to ERA5. This selection is based on the rationale that more Heating Degree Days are associated with colder conditions, typically represented by blueish colors, while fewer Heating Degree Days imply warmer conditions, depicted by reddish colors.</span><a class="headerlink" href="#id1" title="Link to this image">#</a></p>
</figcaption>
</figure>
</section>
<section id="methodology">
<h2>üìã Methodology<a class="headerlink" href="#methodology" title="Link to this heading">#</a></h2>
<p>The reference methodology used here for the indices calculation is similar to the one followed by Scoccimarro et al., (2023) <a class="reference external" href="https://doi.org/10.1038/s43247-023-00878-3" rel="noreferrer" target="_blank">[8]</a>. However the thermal comfort thresholds used in this notebook are slightly different. A winter comfort temperature of 15.5¬∞C and a summer comfort temperature of 22.0¬∞C are used here (as in the <a class="reference external" href="https://dast.copernicus-climate.eu/documents/app-heating-cooling-degree-days/C3S_EEA_HDD_CDD_application_user_guide_v0.9.pdf" rel="noreferrer" target="_blank">CDS application</a>). In the presented code, the CDD calculations are based on the JJA aggregation, with a comfort temperature of 22¬∞C (CDD22), while HDD calculations focus on winter (DJF) with a comfort temperature of 15.5¬∞C (HDD15.5). More specifically, to calculate CDD22, the sum of the differences between the daily mean temperature and the thermal comfort temperature of 22¬∞C is computed. This calculation occurs only when the mean temperature is above the thermal comfort level; otherwise, the CDD22 for that day is set to 0. For example, a day with a mean temperature of 28¬∞C would result in 6¬∞C. Two consecutive hot days like this would total 12¬∞C over the two-day period. Similarly, to calculate HDD15.5, the sum of the differences between the thermal comfort temperature of 15.5¬∞C and the daily mean temperature is determined. This happens only when the mean temperature is below the thermal comfort level; otherwise, the HDD15.5 for that day is set to 0. Finally, to obtain more intuitive values, the sum is averaged over the number of days in the season to produce daily average values. This approach differs from the <a class="reference external" href="https://dast.copernicus-climate.eu/documents/app-heating-cooling-degree-days/C3S_EEA_HDD_CDD_application_user_guide_v0.9.pdf" rel="noreferrer" target="_blank">CDS application</a>, where both the sum over a period and the daily average values can be displayed.  In Spinoni et al., (2018) <a class="reference external" href="https://doi.org/10.1002/joc.5362" rel="noreferrer" target="_blank">[6]</a>, as well as in the <a class="reference external" href="https://dast.copernicus-climate.eu/documents/app-heating-cooling-degree-days/C3S_EEA_HDD_CDD_application_user_guide_v0.9.pdf" rel="noreferrer" target="_blank">CDS application</a>, more advanced methods for calculating CDD and HDD involve considering maximum, minimum, and mean temperatures. However, to prevent overloading the notebook and maintain simplicity while ensuring compatibility with the <a class="reference external" href="https://icclim.readthedocs.io/en/stable/" rel="noreferrer" target="_blank">icclim</a> Python package, we opted to utilise a single variable (2m mean temperature).</p>
<p>This notebook provides an assessment of the systematic errors (trend and climate mean) in a subset of 16 models from <a class="reference external" href="https://cds.climate.copernicus.eu/datasets/projections-cmip6?tab=overview" rel="noreferrer" target="_blank">CMIP6</a>. It achieves this by comparing the model predictions with the ERA5 reanalysis for the energy-consumption-related indices ‚ÄòHDD15.5‚Äô and ‚ÄòCDD22‚Äô for the historical period spanning from 1971 to 2000. In particular, spatial patterns of climate mean and trend, along with biases, are examined and displayed for each model and the ensemble median (calculated for each grid cell). Additionally, spatially-averaged trend values are analysed and presented using box plots to provide an overview of trend behavior across the distribution of the chosen subset of models when averaged across Europe.</p>
<p>The analysis and results follow the next outline:</p>
<p><strong><a class="reference internal" href="#climate-projections-cmip6-climate-impact-indicators-q01-section-1"><span class="std std-ref">1. Parameters, requests and functions definition</span></a></strong></p>
<ul class="simple">
<li><p><a class="reference internal" href="#climate-projections-cmip6-climate-impact-indicators-q01-section-1-1"><span class="std std-ref">1.1. Import packages</span></a></p></li>
<li><p><a class="reference internal" href="#climate-projections-cmip6-climate-impact-indicators-q01-section-1-2"><span class="std std-ref">1.2. Define Parameters</span></a></p></li>
<li><p><a class="reference internal" href="#climate-projections-cmip6-climate-impact-indicators-q01-section-1-3"><span class="std std-ref">1.3. Define models</span></a></p></li>
<li><p><a class="reference internal" href="#climate-projections-cmip6-climate-impact-indicators-q01-section-1-4"><span class="std std-ref">1.4. Define ERA5 request</span></a></p></li>
<li><p><a class="reference internal" href="#climate-projections-cmip6-climate-impact-indicators-q01-section-1-5"><span class="std std-ref">1.5. Define model requests</span></a></p></li>
<li><p><a class="reference internal" href="#climate-projections-cmip6-climate-impact-indicators-q01-section-1-6"><span class="std std-ref">1.6. Functions to cache</span></a></p></li>
</ul>
<p><strong><a class="reference internal" href="#climate-projections-cmip6-climate-impact-indicators-q01-section-2"><span class="std std-ref">2. Downloading and processing</span></a></strong></p>
<ul class="simple">
<li><p><a class="reference internal" href="#climate-projections-cmip6-climate-impact-indicators-q01-section-2-1"><span class="std std-ref">2.1. Download and transform ERA5</span></a></p></li>
<li><p><a class="reference internal" href="#climate-projections-cmip6-climate-impact-indicators-q01-section-2-2"><span class="std std-ref">2.2. Download and transform models</span></a></p></li>
<li><p><a class="reference internal" href="#climate-projections-cmip6-climate-impact-indicators-q01-section-2-3"><span class="std std-ref">2.3. Apply land-sea mask, change attributes and cut the region to show</span></a></p></li>
</ul>
<p><strong><a class="reference internal" href="#climate-projections-cmip6-climate-impact-indicators-q01-section-3"><span class="std std-ref">3. Plot and describe results</span></a></strong></p>
<ul class="simple">
<li><p><a class="reference internal" href="#climate-projections-cmip6-climate-impact-indicators-q01-section-3-1"><span class="std std-ref">3.1. Define plotting functions</span></a></p></li>
<li><p><a class="reference internal" href="#climate-projections-cmip6-climate-impact-indicators-q01-section-3-2"><span class="std std-ref">3.2. Plot ensemble maps</span></a></p></li>
<li><p><a class="reference internal" href="#climate-projections-cmip6-climate-impact-indicators-q01-section-3-3"><span class="std std-ref">3.3. Plot model maps</span></a></p></li>
<li><p><a class="reference internal" href="#climate-projections-cmip6-climate-impact-indicators-q01-section-3-4"><span class="std std-ref">3.4. Plot bias maps</span></a></p></li>
<li><p><a class="reference internal" href="#climate-projections-cmip6-climate-impact-indicators-q01-section-3-5"><span class="std std-ref">3.5. Boxplots of the historical trend</span></a></p></li>
<li><p><a class="reference internal" href="#climate-projections-cmip6-climate-impact-indicators-q01-section-3-6"><span class="std std-ref">3.6. Results summary and discussion</span></a></p></li>
</ul>
</section>
<section id="analysis-and-results">
<h2>üìà Analysis and results<a class="headerlink" href="#analysis-and-results" title="Link to this heading">#</a></h2>
<section id="parameters-requests-and-functions-definition">
<span id="climate-projections-cmip6-climate-impact-indicators-q01-section-1"></span><h3>1. Parameters, requests and functions definition<a class="headerlink" href="#parameters-requests-and-functions-definition" title="Link to this heading">#</a></h3>
<section id="import-packages">
<span id="climate-projections-cmip6-climate-impact-indicators-q01-section-1-1"></span><h4>1.1. Import packages<a class="headerlink" href="#import-packages" title="Link to this heading">#</a></h4>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">math</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">tempfile</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">textwrap</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">cartopy.crs</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">ccrs</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">icclim</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">xarray</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">xr</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">c3s_eqc_automatic_quality_control</span><span class="w"> </span><span class="kn">import</span> <span class="n">diagnostics</span><span class="p">,</span> <span class="n">download</span><span class="p">,</span> <span class="n">plot</span><span class="p">,</span> <span class="n">utils</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">xarrayMannKendall</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mann_Kendall_test</span>

<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s2">&quot;seaborn-v0_8-notebook&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;hatch.linewidth&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span>
</pre></div>
</div>
</div>
</details>
</div>
</section>
<section id="define-parameters">
<span id="climate-projections-cmip6-climate-impact-indicators-q01-section-1-2"></span><h4>1.2. Define Parameters<a class="headerlink" href="#define-parameters" title="Link to this heading">#</a></h4>
<p>In the ‚ÄúDefine Parameters‚Äù section, various customisable options for the notebook are specified:</p>
<ul class="simple">
<li><p>The initial and ending year used for the historical period can be specified by changing the parameters <code class="docutils literal notranslate"><span class="pre">year_start</span></code> and <code class="docutils literal notranslate"><span class="pre">year_stop</span></code> (1971-2000 is chosen for consistency between CORDEX and CMIP6).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">index_timeseries</span></code> is a dictionary that set the temporal aggregation for every index considered within this notebook (‚ÄòHDD15.5‚Äô and ‚ÄòCDD22‚Äô). In the presented code, the CDD calculations are always based on the JJA aggregation, with a comfort temperature of 22¬∞C (CDD22), while HDD calculations focus on winter (DJF) with a comfort temperature of 15.5¬∞C (HDD15.5).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">collection_id</span></code> sets the family of models. Only CMIP6 is implemented for this notebook.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">area</span></code> allows specifying the geographical domain of interest.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">interpolation_method</span></code> parameter allows selecting the interpolation method when regridding is performed over the indices.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">chunk</span></code> selection allows the user to define if dividing into chunks when downloading the data on their local machine. Although it does not significantly affect the analysis, it is recommended to keep the default value for optimal performance.</p></li>
</ul>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Time period</span>
<span class="n">year_start</span> <span class="o">=</span> <span class="mi">1971</span>
<span class="n">year_stop</span> <span class="o">=</span> <span class="mi">2000</span>

<span class="c1"># Choose annual or seasonal timeseries</span>
<span class="n">index_timeseries</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;HDD15.5&quot;</span><span class="p">:</span> <span class="s2">&quot;DJF&quot;</span><span class="p">,</span>
    <span class="s2">&quot;CDD22&quot;</span><span class="p">:</span> <span class="s2">&quot;JJA&quot;</span><span class="p">,</span>
<span class="p">}</span>
<span class="k">if</span> <span class="s2">&quot;annual&quot;</span> <span class="ow">in</span> <span class="n">index_timeseries</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
    <span class="k">assert</span> <span class="nb">set</span><span class="p">(</span><span class="n">index_timeseries</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">==</span> <span class="p">{</span><span class="s2">&quot;annual&quot;</span><span class="p">}</span>

<span class="c1"># Interpolation method</span>
<span class="n">interpolation_method</span> <span class="o">=</span> <span class="s2">&quot;bilinear&quot;</span>

<span class="c1"># Select the family of models </span>
<span class="n">collection_id</span> <span class="o">=</span> <span class="s2">&quot;CMIP6&quot;</span>
<span class="k">assert</span> <span class="n">collection_id</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;CMIP6&quot;</span><span class="p">)</span>

<span class="c1"># Area to show</span>
<span class="n">area</span> <span class="o">=</span> <span class="p">[</span><span class="mi">72</span><span class="p">,</span> <span class="o">-</span><span class="mi">22</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mi">45</span><span class="p">]</span>

<span class="c1"># Chunks for download</span>
<span class="n">chunks</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
</pre></div>
</div>
</div>
</details>
</div>
</section>
<section id="define-models">
<span id="climate-projections-cmip6-climate-impact-indicators-q01-section-1-3"></span><h4>1.3. Define models<a class="headerlink" href="#define-models" title="Link to this heading">#</a></h4>
<p>The following climate analyses are performed considering a subset of GCMs from CMIP6. Models names are listed in the parameters below. Some variable-dependent parameters are also selected.</p>
<p>The selected CMIP6 models have available both experiments the historical and the SSP8.5.</p>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define models</span>
<span class="n">models_cmip6</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;access_cm2&quot;</span><span class="p">,</span>
            <span class="s2">&quot;awi_cm_1_1_mr&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cmcc_esm2&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cnrm_cm6_1_hr&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cnrm_esm2_1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ec_earth3_cc&quot;</span><span class="p">,</span>
            <span class="s2">&quot;gfdl_esm4&quot;</span><span class="p">,</span>
            <span class="s2">&quot;inm_cm4_8&quot;</span><span class="p">,</span>
            <span class="s2">&quot;inm_cm5_0&quot;</span><span class="p">,</span>
            <span class="s2">&quot;kiost_esm&quot;</span><span class="p">,</span>
            <span class="s2">&quot;mpi_esm1_2_lr&quot;</span><span class="p">,</span>
            <span class="s2">&quot;miroc6&quot;</span><span class="p">,</span>
            <span class="s2">&quot;miroc_es2l&quot;</span><span class="p">,</span> 
            <span class="s2">&quot;mri_esm2_0&quot;</span><span class="p">,</span>
            <span class="s2">&quot;noresm2_mm&quot;</span><span class="p">,</span>
            <span class="s2">&quot;nesm3&quot;</span><span class="p">,</span>    
        <span class="p">)</span>   

<span class="c1"># Colormaps</span>
<span class="n">cmaps</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;HDD15.5&quot;</span><span class="p">:</span> <span class="s2">&quot;Blues&quot;</span><span class="p">,</span> <span class="s2">&quot;CDD22&quot;</span><span class="p">:</span> <span class="s2">&quot;Reds&quot;</span><span class="p">}</span>
<span class="n">cmaps_trend</span> <span class="o">=</span> <span class="n">cmaps_bias</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;HDD15.5&quot;</span><span class="p">:</span> <span class="s2">&quot;RdBu&quot;</span><span class="p">,</span> <span class="s2">&quot;CDD22&quot;</span><span class="p">:</span> <span class="s2">&quot;RdBu_r&quot;</span><span class="p">}</span>

<span class="c1">#Define dictionaries to use in titles and caption</span>
<span class="n">long_name</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;HDD15.5&quot;</span><span class="p">:</span><span class="s2">&quot;Heating Degree Days daily average calculated using the winter comfort threshold of 15.5¬∞C&quot;</span> <span class="p">,</span> 
    <span class="s2">&quot;CDD22&quot;</span><span class="p">:</span><span class="s2">&quot;Cooling Degree Days daily average calculated using the summer comfort threshold of 22¬∞C&quot;</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</details>
</div>
</section>
<section id="define-era5-request">
<span id="climate-projections-cmip6-climate-impact-indicators-q01-section-1-4"></span><h4>1.4. Define ERA5 request<a class="headerlink" href="#define-era5-request" title="Link to this heading">#</a></h4>
<p>Within this notebook, ERA5 serves as the reference product. In this section, we set the required parameters for the cds-api data-request of ERA5.</p>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">request_era</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s2">&quot;reanalysis-era5-single-levels&quot;</span><span class="p">,</span>
    <span class="p">{</span>
        <span class="s2">&quot;product_type&quot;</span><span class="p">:</span> <span class="s2">&quot;reanalysis&quot;</span><span class="p">,</span>
        <span class="s2">&quot;format&quot;</span><span class="p">:</span> <span class="s2">&quot;netcdf&quot;</span><span class="p">,</span>
        <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">hour</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">:00&quot;</span> <span class="k">for</span> <span class="n">hour</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">24</span><span class="p">)],</span>
        <span class="s2">&quot;variable&quot;</span><span class="p">:</span> <span class="s2">&quot;2m_temperature&quot;</span><span class="p">,</span>
        <span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">)</span> <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">year_start</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">year_stop</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">],</span>  <span class="c1"># Include D(year-1)</span>
        <span class="s2">&quot;month&quot;</span><span class="p">:</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">month</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">month</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">13</span><span class="p">)],</span>
        <span class="s2">&quot;day&quot;</span><span class="p">:</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">day</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">day</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">32</span><span class="p">)],</span>
        <span class="s2">&quot;area&quot;</span><span class="p">:</span> <span class="n">area</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">)</span>

<span class="n">request_lsm</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">request_era</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
    <span class="n">request_era</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="o">|</span> <span class="p">{</span>
        <span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="s2">&quot;1940&quot;</span><span class="p">,</span>
        <span class="s2">&quot;month&quot;</span><span class="p">:</span> <span class="s2">&quot;01&quot;</span><span class="p">,</span>
        <span class="s2">&quot;day&quot;</span><span class="p">:</span> <span class="s2">&quot;01&quot;</span><span class="p">,</span>
        <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="s2">&quot;00:00&quot;</span><span class="p">,</span>
        <span class="s2">&quot;variable&quot;</span><span class="p">:</span> <span class="s2">&quot;land_sea_mask&quot;</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</details>
</div>
</section>
<section id="define-model-requests">
<span id="climate-projections-cmip6-climate-impact-indicators-q01-section-1-5"></span><h4>1.5. Define model requests<a class="headerlink" href="#define-model-requests" title="Link to this heading">#</a></h4>
<p>In this section we set the required parameters for the cds-api data-request.</p>
<p>When <code class="docutils literal notranslate"><span class="pre">weights</span> <span class="pre">=</span> <span class="pre">True</span></code>, spatial weighting is applied for calculations requiring spatial data aggregation. This is particularly relevant for CMIP6 GCMs with regular lon-lat grids that do not consider varying surface extensions at different latitudes.</p>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">request_cmip6</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;format&quot;</span><span class="p">:</span> <span class="s2">&quot;zip&quot;</span><span class="p">,</span>
    <span class="s2">&quot;temporal_resolution&quot;</span><span class="p">:</span> <span class="s2">&quot;daily&quot;</span><span class="p">,</span>
    <span class="s2">&quot;experiment&quot;</span><span class="p">:</span> <span class="s2">&quot;historical&quot;</span><span class="p">,</span>
    <span class="s2">&quot;variable&quot;</span><span class="p">:</span> <span class="s2">&quot;near_surface_air_temperature&quot;</span><span class="p">,</span>
    <span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">)</span> <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">year_start</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">year_stop</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">],</span>  <span class="c1"># Include D(year-1)</span>
    <span class="s2">&quot;month&quot;</span><span class="p">:</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">month</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">month</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">13</span><span class="p">)],</span>
    <span class="s2">&quot;day&quot;</span><span class="p">:</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">day</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">day</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">32</span><span class="p">)],</span>
    <span class="s2">&quot;area&quot;</span><span class="p">:</span> <span class="n">area</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">model_requests</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">models_cmip6</span><span class="p">:</span>
    <span class="n">model_requests</span><span class="p">[</span><span class="n">model</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;projections-cmip6&quot;</span><span class="p">,</span>
        <span class="n">download</span><span class="o">.</span><span class="n">split_request</span><span class="p">(</span><span class="n">request_cmip6</span> <span class="o">|</span> <span class="p">{</span><span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="n">model</span><span class="p">},</span> <span class="n">chunks</span><span class="o">=</span><span class="n">chunks</span><span class="p">),</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
</details>
</div>
</section>
<section id="functions-to-cache">
<span id="climate-projections-cmip6-climate-impact-indicators-q01-section-1-6"></span><h4>1.6. Functions to cache<a class="headerlink" href="#functions-to-cache" title="Link to this heading">#</a></h4>
<p>In this section, functions that will be executed in the caching phase are defined. Caching is the process of storing copies of files in a temporary storage location, so that they can be accessed more quickly. This process also checks if the user has already downloaded a file, avoiding redundant downloads.</p>
<p>Functions description:</p>
<ul class="simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">select_timeseries</span></code> function subsets the dataset based on the chosen <code class="docutils literal notranslate"><span class="pre">timeseries</span></code> parameter.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">compute_indices</span></code> function utilises the icclim package to calculate the energy-consumption-related indices.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">compute_trends</span></code> function employs the Mann-Kendall test for trend calculation.</p></li>
<li><p>Finally, the <code class="docutils literal notranslate"><span class="pre">compute_indices_and_trends</span></code> computes the daily mean temperature (only if we are dealing with ERA5), calculates the energy consumption-related indices for the corresponding temporal aggregation using the <code class="docutils literal notranslate"><span class="pre">compute_indices</span></code> function, determines the indices mean over the historical period (1971-2000), obtain the trends using the <code class="docutils literal notranslate"><span class="pre">compute_trends</span></code> function, and offers an option for regridding to ERA5 if required.</p></li>
</ul>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">select_timeseries</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">index_timeseries</span><span class="p">,</span> <span class="n">year_start</span><span class="p">,</span> <span class="n">year_stop</span><span class="p">):</span>
    <span class="n">timeseries</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">index_timeseries</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">timeseries</span> <span class="o">==</span> <span class="p">{</span><span class="s2">&quot;annual&quot;</span><span class="p">}:</span>
        <span class="k">return</span> <span class="n">ds</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">year_start</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">year_stop</span><span class="p">)))</span>
    <span class="k">assert</span> <span class="s2">&quot;annual&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">timeseries</span>
    <span class="k">return</span> <span class="n">ds</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">year_start</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">-12&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">year_stop</span><span class="si">}</span><span class="s2">-11&quot;</span><span class="p">))</span>


<span class="k">def</span><span class="w"> </span><span class="nf">compute_indices</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">index_timeseries</span><span class="p">,</span> <span class="n">tmpdir</span><span class="p">):</span>
    <span class="n">labels</span><span class="p">,</span> <span class="n">datasets</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">ds</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;time.year&quot;</span><span class="p">))</span>
    <span class="n">paths</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tmpdir</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">.nc&quot;</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">]</span>
    <span class="n">datasets</span> <span class="o">=</span> <span class="p">[</span><span class="n">ds</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">ds</span> <span class="ow">in</span> <span class="n">datasets</span><span class="p">]</span>
    <span class="n">xr</span><span class="o">.</span><span class="n">save_mfdataset</span><span class="p">(</span><span class="n">datasets</span><span class="p">,</span> <span class="n">paths</span><span class="p">)</span>

    <span class="n">ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_mfdataset</span><span class="p">(</span><span class="n">paths</span><span class="p">)</span>
    <span class="n">in_files</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tmpdir</span><span class="si">}</span><span class="s2">/rechunked.zarr&quot;</span>
    <span class="n">chunks</span> <span class="o">=</span> <span class="p">{</span><span class="n">dim</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="n">dim</span> <span class="o">==</span> <span class="s2">&quot;time&quot;</span> <span class="k">else</span> <span class="s2">&quot;auto&quot;</span> <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">dims</span><span class="p">}</span>
    <span class="n">ds</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="n">chunks</span><span class="p">)</span><span class="o">.</span><span class="n">to_zarr</span><span class="p">(</span><span class="n">in_files</span><span class="p">)</span>

    <span class="n">dataarrays</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">index_name</span><span class="p">,</span> <span class="n">timeseries</span> <span class="ow">in</span> <span class="n">index_timeseries</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;in_files&quot;</span><span class="p">:</span> <span class="n">in_files</span><span class="p">,</span>
            <span class="s2">&quot;out_file&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tmpdir</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">index_name</span><span class="si">}</span><span class="s2">.nc&quot;</span><span class="p">,</span>
            <span class="s2">&quot;slice_mode&quot;</span><span class="p">:</span> <span class="s2">&quot;year&quot;</span> <span class="k">if</span> <span class="n">timeseries</span> <span class="o">==</span> <span class="s2">&quot;annual&quot;</span> <span class="k">else</span> <span class="n">timeseries</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">index_name</span> <span class="o">==</span> <span class="s2">&quot;HDD15.5&quot;</span><span class="p">:</span>
            <span class="n">ds_index</span> <span class="o">=</span> <span class="n">icclim</span><span class="o">.</span><span class="n">index</span><span class="p">(</span>
                <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
                <span class="n">index_name</span><span class="o">=</span><span class="s2">&quot;deficit&quot;</span><span class="p">,</span>
                <span class="n">threshold</span><span class="o">=</span><span class="n">icclim</span><span class="o">.</span><span class="n">build_threshold</span><span class="p">(</span><span class="s2">&quot;15.5 degC&quot;</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">index_name</span> <span class="o">==</span> <span class="s2">&quot;CDD22&quot;</span><span class="p">:</span>
            <span class="n">ds_index</span> <span class="o">=</span> <span class="n">icclim</span><span class="o">.</span><span class="n">excess</span><span class="p">(</span>
                <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
                <span class="n">threshold</span><span class="o">=</span><span class="n">icclim</span><span class="o">.</span><span class="n">build_threshold</span><span class="p">(</span><span class="s2">&quot;22 degC&quot;</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">index_name</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="p">(</span><span class="n">da</span><span class="p">,)</span> <span class="o">=</span> <span class="n">ds_index</span><span class="o">.</span><span class="n">drop_dims</span><span class="p">(</span><span class="s2">&quot;bounds&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">data_vars</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
        <span class="n">num_days</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;DJF&quot;</span><span class="p">:</span> <span class="mi">90</span><span class="p">,</span> <span class="s2">&quot;MAM&quot;</span><span class="p">:</span> <span class="mi">92</span><span class="p">,</span> <span class="s2">&quot;JJA&quot;</span><span class="p">:</span> <span class="mi">92</span><span class="p">,</span> <span class="s2">&quot;SON&quot;</span><span class="p">:</span> <span class="mi">91</span><span class="p">}</span>
        <span class="k">with</span> <span class="n">xr</span><span class="o">.</span><span class="n">set_options</span><span class="p">(</span><span class="n">keep_attrs</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="n">da</span> <span class="o">/=</span> <span class="p">(</span>
                <span class="n">num_days</span><span class="p">[</span><span class="n">timeseries</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">timeseries</span> <span class="o">!=</span> <span class="s2">&quot;annual&quot;</span>
                <span class="k">else</span> <span class="nb">sum</span><span class="p">(</span><span class="n">num_days</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
            <span class="p">)</span>
        <span class="n">da</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; d&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">dataarrays</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">da</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">index_name</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">xr</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">dataarrays</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">compute_trends</span><span class="p">(</span><span class="n">ds</span><span class="p">):</span>
    <span class="n">datasets</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="p">(</span><span class="n">lat</span><span class="p">,)</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">cf</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="s2">&quot;Y&quot;</span><span class="p">])</span>
    <span class="p">(</span><span class="n">lon</span><span class="p">,)</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">cf</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="s2">&quot;X&quot;</span><span class="p">])</span>
    <span class="n">coords_name</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="s2">&quot;time&quot;</span><span class="p">,</span>
        <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">lat</span><span class="p">,</span>
        <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">lon</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">da</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">data_vars</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">Mann_Kendall_test</span><span class="p">(</span>
            <span class="n">da</span> <span class="o">-</span> <span class="n">da</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">),</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
            <span class="n">method</span><span class="o">=</span><span class="s2">&quot;theilslopes&quot;</span><span class="p">,</span>
            <span class="n">coords_name</span><span class="o">=</span><span class="n">coords_name</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">coords_name</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">dims</span><span class="p">})</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">({</span><span class="n">dim</span><span class="p">:</span> <span class="n">da</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">dims</span><span class="p">})</span>
        <span class="n">datasets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="n">index</span><span class="p">]))</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">datasets</span><span class="p">,</span> <span class="s2">&quot;index&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ds</span>


<span class="k">def</span><span class="w"> </span><span class="nf">add_bounds</span><span class="p">(</span><span class="n">ds</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;latitude&quot;</span><span class="p">,</span> <span class="s2">&quot;longitude&quot;</span><span class="p">}</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">cf</span><span class="o">.</span><span class="n">bounds</span><span class="p">):</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">cf</span><span class="o">.</span><span class="n">add_bounds</span><span class="p">(</span><span class="n">coord</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ds</span>


<span class="k">def</span><span class="w"> </span><span class="nf">get_grid_out</span><span class="p">(</span><span class="n">request_grid_out</span><span class="p">,</span> <span class="n">method</span><span class="p">):</span>
    <span class="n">ds_regrid</span> <span class="o">=</span> <span class="n">download</span><span class="o">.</span><span class="n">download_and_transform</span><span class="p">(</span><span class="o">*</span><span class="n">request_grid_out</span><span class="p">)</span>
    <span class="n">coords</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;latitude&quot;</span><span class="p">,</span> <span class="s2">&quot;longitude&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;conservative&quot;</span><span class="p">:</span>
        <span class="n">ds_regrid</span> <span class="o">=</span> <span class="n">add_bounds</span><span class="p">(</span><span class="n">ds_regrid</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">coords</span><span class="p">):</span>
            <span class="n">coords</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">ds_regrid</span><span class="o">.</span><span class="n">cf</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="n">coord</span><span class="p">])</span>
    <span class="n">grid_out</span> <span class="o">=</span> <span class="n">ds_regrid</span><span class="p">[</span><span class="n">coords</span><span class="p">]</span>
    <span class="n">coords_to_drop</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">grid_out</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">grid_out</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span>
    <span class="n">grid_out</span> <span class="o">=</span> <span class="n">ds_regrid</span><span class="p">[</span><span class="n">coords</span><span class="p">]</span><span class="o">.</span><span class="n">reset_coords</span><span class="p">(</span><span class="n">coords_to_drop</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">grid_out</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">return</span> <span class="n">grid_out</span>

<span class="k">def</span><span class="w"> </span><span class="nf">compute_indices_and_trends</span><span class="p">(</span>
    <span class="n">ds</span><span class="p">,</span>
    <span class="n">index_timeseries</span><span class="p">,</span>
    <span class="n">year_start</span><span class="p">,</span>
    <span class="n">year_stop</span><span class="p">,</span>
    <span class="n">resample_reduction</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">request_grid_out</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">regrid_kwargs</span><span class="p">,</span>
<span class="p">):</span>
    <span class="k">assert</span> <span class="p">(</span><span class="n">request_grid_out</span> <span class="ow">and</span> <span class="n">regrid_kwargs</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="p">(</span>
        <span class="n">request_grid_out</span> <span class="ow">or</span> <span class="n">regrid_kwargs</span>
    <span class="p">)</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">([</span><span class="n">var</span> <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">da</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">data_vars</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">da</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">])</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">data_vars</span><span class="p">)]</span>

    <span class="c1"># Original bounds for conservative interpolation</span>
    <span class="k">if</span> <span class="n">regrid_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;method&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;conservative&quot;</span><span class="p">:</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">add_bounds</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span>
        <span class="n">bounds</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">ds</span><span class="o">.</span><span class="n">cf</span><span class="o">.</span><span class="n">get_bounds</span><span class="p">(</span><span class="n">coord</span><span class="p">)</span><span class="o">.</span><span class="n">reset_coords</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;latitude&quot;</span><span class="p">,</span> <span class="s2">&quot;longitude&quot;</span><span class="p">)</span>
        <span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">bounds</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">ds</span> <span class="o">=</span> <span class="n">select_timeseries</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">index_timeseries</span><span class="p">,</span> <span class="n">year_start</span><span class="p">,</span> <span class="n">year_stop</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">resample_reduction</span><span class="p">:</span>
        <span class="n">resampled</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="s2">&quot;1D&quot;</span><span class="p">)</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">resampled</span><span class="p">,</span> <span class="n">resample_reduction</span><span class="p">)(</span><span class="n">keep_attrs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">resample_reduction</span> <span class="o">==</span> <span class="s2">&quot;sum&quot;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">da</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">data_vars</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">da</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">da</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> / day&quot;</span>
    <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">tmpdir</span><span class="p">:</span>
        <span class="n">ds_indices</span> <span class="o">=</span> <span class="n">compute_indices</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">index_timeseries</span><span class="p">,</span> <span class="n">tmpdir</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
        <span class="n">ds_trends</span> <span class="o">=</span> <span class="n">compute_trends</span><span class="p">(</span><span class="n">ds_indices</span><span class="p">)</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">ds_indices</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="n">keep_attrs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">ds_trends</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">request_grid_out</span><span class="p">:</span>
            <span class="n">ds</span> <span class="o">=</span> <span class="n">diagnostics</span><span class="o">.</span><span class="n">regrid</span><span class="p">(</span>
                <span class="n">ds</span><span class="o">.</span><span class="n">merge</span><span class="p">({</span><span class="n">da</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">da</span> <span class="k">for</span> <span class="n">da</span> <span class="ow">in</span> <span class="n">bounds</span><span class="p">}),</span>
                <span class="n">grid_out</span><span class="o">=</span><span class="n">get_grid_out</span><span class="p">(</span><span class="n">request_grid_out</span><span class="p">,</span> <span class="n">regrid_kwargs</span><span class="p">[</span><span class="s2">&quot;method&quot;</span><span class="p">]),</span>
                <span class="o">**</span><span class="n">regrid_kwargs</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">ds</span>
</pre></div>
</div>
</div>
</details>
</div>
</section>
</section>
<section id="downloading-and-processing">
<span id="climate-projections-cmip6-climate-impact-indicators-q01-section-2"></span><h3>2. Downloading and processing<a class="headerlink" href="#downloading-and-processing" title="Link to this heading">#</a></h3>
<section id="download-and-transform-era5">
<span id="climate-projections-cmip6-climate-impact-indicators-q01-section-2-1"></span><h4>2.1. Download and transform ERA5<a class="headerlink" href="#download-and-transform-era5" title="Link to this heading">#</a></h4>
<p>In this section, the <code class="docutils literal notranslate"><span class="pre">download.download_and_transform</span></code> function from the ‚Äòc3s_eqc_automatic_quality_control‚Äô package is employed to download ERA5 reference data, obtain the daily mean temperature from hourly data, compute the energy-consumption-related indices for the selected temporal aggregation (‚ÄúDJF‚Äù for HDD and ‚ÄúJJA‚Äù for CDD), calculate the mean and trend over the historical period (1971-2000) and cache the result (to avoid redundant downloads and processing).</p>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">transform_func_kwargs</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;index_timeseries&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">index_timeseries</span><span class="o">.</span><span class="n">items</span><span class="p">())),</span>
    <span class="s2">&quot;year_start&quot;</span><span class="p">:</span> <span class="n">year_start</span><span class="p">,</span>
    <span class="s2">&quot;year_stop&quot;</span><span class="p">:</span> <span class="n">year_stop</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">ds_era5</span> <span class="o">=</span> <span class="n">download</span><span class="o">.</span><span class="n">download_and_transform</span><span class="p">(</span>
    <span class="o">*</span><span class="n">request_era</span><span class="p">,</span>
    <span class="n">chunks</span><span class="o">=</span><span class="n">chunks</span><span class="p">,</span>
    <span class="n">transform_chunks</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">transform_func</span><span class="o">=</span><span class="n">compute_indices_and_trends</span><span class="p">,</span>
    <span class="n">transform_func_kwargs</span><span class="o">=</span><span class="n">transform_func_kwargs</span> <span class="o">|</span> <span class="p">{</span><span class="s2">&quot;resample_reduction&quot;</span><span class="p">:</span> <span class="s2">&quot;mean&quot;</span><span class="p">},</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</details>
</div>
</section>
<section id="download-and-transform-models">
<span id="climate-projections-cmip6-climate-impact-indicators-q01-section-2-2"></span><h4>2.2. Download and transform models<a class="headerlink" href="#download-and-transform-models" title="Link to this heading">#</a></h4>
<p>In this section, the <code class="docutils literal notranslate"><span class="pre">download.download_and_transform</span></code> function from the ‚Äòc3s_eqc_automatic_quality_control‚Äô package is employed to download daily data from the CMIP6 models, compute the energy-consumption-related indices for the selected temporal aggregation (‚ÄúDJF‚Äù for HDD and ‚ÄúJJA‚Äù for CDD), calculate the mean and trend over the historical period (1971-2000), interpolate to ERA5‚Äôs grid (only for the cases in which it is specified, in the other cases, the original model‚Äôs grid is mantained), and cache the result (to avoid redundant downloads and processing).</p>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">interpolated_datasets</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">model_datasets</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">model</span><span class="p">,</span> <span class="n">requests</span> <span class="ow">in</span> <span class="n">model_requests</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">model_kwargs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;chunks&quot;</span><span class="p">:</span> <span class="n">chunks</span><span class="p">,</span>
        <span class="s2">&quot;transform_chunks&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;transform_func&quot;</span><span class="p">:</span> <span class="n">compute_indices_and_trends</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="c1"># Original model</span>
    <span class="n">model_datasets</span><span class="p">[</span><span class="n">model</span><span class="p">]</span> <span class="o">=</span> <span class="n">download</span><span class="o">.</span><span class="n">download_and_transform</span><span class="p">(</span>
        <span class="o">*</span><span class="n">requests</span><span class="p">,</span>
        <span class="o">**</span><span class="n">model_kwargs</span><span class="p">,</span>
        <span class="n">transform_func_kwargs</span><span class="o">=</span><span class="n">transform_func_kwargs</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Interpolated model</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">download</span><span class="o">.</span><span class="n">download_and_transform</span><span class="p">(</span>
        <span class="o">*</span><span class="n">requests</span><span class="p">,</span>
        <span class="o">**</span><span class="n">model_kwargs</span><span class="p">,</span>
        <span class="n">transform_func_kwargs</span><span class="o">=</span><span class="n">transform_func_kwargs</span>
        <span class="o">|</span> <span class="p">{</span>
            <span class="s2">&quot;request_grid_out&quot;</span><span class="p">:</span> <span class="n">request_lsm</span><span class="p">,</span>
            <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="n">interpolation_method</span><span class="p">,</span>
            <span class="s2">&quot;skipna&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">)</span>
    <span class="n">interpolated_datasets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="p">[</span><span class="n">model</span><span class="p">]))</span>

<span class="n">ds_interpolated</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">interpolated_datasets</span><span class="p">,</span> <span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span><span class="s1">&#39;minimal&#39;</span><span class="p">,</span> <span class="n">compat</span><span class="o">=</span><span class="s1">&#39;override&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>model=&#39;access_cm2&#39;
model=&#39;awi_cm_1_1_mr&#39;
model=&#39;cmcc_esm2&#39;
model=&#39;cnrm_cm6_1_hr&#39;
model=&#39;cnrm_esm2_1&#39;
model=&#39;ec_earth3_cc&#39;
model=&#39;gfdl_esm4&#39;
model=&#39;inm_cm4_8&#39;
model=&#39;inm_cm5_0&#39;
model=&#39;kiost_esm&#39;
model=&#39;mpi_esm1_2_lr&#39;
model=&#39;miroc6&#39;
model=&#39;miroc_es2l&#39;
model=&#39;mri_esm2_0&#39;
model=&#39;noresm2_mm&#39;
model=&#39;nesm3&#39;
</pre></div>
</div>
</div>
</div>
</section>
<section id="apply-land-sea-mask-change-attributes-and-cut-the-region-to-show">
<span id="climate-projections-cmip6-climate-impact-indicators-q01-section-2-3"></span><h4>2.3. Apply land-sea mask, change attributes and cut the region to show<a class="headerlink" href="#apply-land-sea-mask-change-attributes-and-cut-the-region-to-show" title="Link to this heading">#</a></h4>
<p>This section performs the following tasks:</p>
<ol class="arabic simple">
<li><p>Cut the region of interest.</p></li>
<li><p>Downloads the sea mask for ERA5.</p></li>
<li><p>Applies the sea mask to both ERA5 data and the model data, which were previously regridded to ERA5‚Äôs grid (i.e., it applies the ERA5 sea mask to <code class="docutils literal notranslate"><span class="pre">ds_interpolated</span></code>).</p></li>
<li><p>Regrids the ERA5 land-sea mask to the model‚Äôs grid and applies it to them.</p></li>
<li><p>Change some variable attributes for plotting purposes.</p></li>
</ol>
<p><strong>Note:</strong> <code class="docutils literal notranslate"><span class="pre">ds_interpolated</span></code> contains data from the models (mean and trend over the historical period, p-value of the trends‚Ä¶) regridded to ERA5. <code class="docutils literal notranslate"><span class="pre">model_datasets</span></code> contain the same data but in the original grid of each model.</p>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lsm</span> <span class="o">=</span> <span class="n">download</span><span class="o">.</span><span class="n">download_and_transform</span><span class="p">(</span><span class="o">*</span><span class="n">request_lsm</span><span class="p">)[</span><span class="s2">&quot;lsm&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Cutout</span>
<span class="n">regionalise_kwargs</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;lon_slice&quot;</span><span class="p">:</span> <span class="nb">slice</span><span class="p">(</span><span class="n">area</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">area</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span>
    <span class="s2">&quot;lat_slice&quot;</span><span class="p">:</span> <span class="nb">slice</span><span class="p">(</span><span class="n">area</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">area</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
<span class="p">}</span>
<span class="n">lsm</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">regionalise</span><span class="p">(</span><span class="n">lsm</span><span class="p">,</span> <span class="o">**</span><span class="n">regionalise_kwargs</span><span class="p">)</span>
<span class="n">ds_interpolated</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">regionalise</span><span class="p">(</span><span class="n">ds_interpolated</span><span class="p">,</span> <span class="o">**</span><span class="n">regionalise_kwargs</span><span class="p">)</span>
<span class="n">model_datasets</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">utils</span><span class="o">.</span><span class="n">regionalise</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="o">**</span><span class="n">regionalise_kwargs</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">model</span><span class="p">,</span> <span class="n">ds</span> <span class="ow">in</span> <span class="n">model_datasets</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
<span class="p">}</span>

<span class="c1"># Mask</span>
<span class="n">ds_era5</span> <span class="o">=</span> <span class="n">ds_era5</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">lsm</span><span class="p">)</span>
<span class="n">ds_interpolated</span> <span class="o">=</span> <span class="n">ds_interpolated</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">lsm</span><span class="p">)</span>
<span class="n">model_datasets</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">ds</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">diagnostics</span><span class="o">.</span><span class="n">regrid</span><span class="p">(</span><span class="n">lsm</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;bilinear&quot;</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">model</span><span class="p">,</span> <span class="n">ds</span> <span class="ow">in</span> <span class="n">model_datasets</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
<span class="p">}</span>

<span class="c1"># Edit attributes</span>
<span class="k">for</span> <span class="n">ds</span> <span class="ow">in</span> <span class="p">(</span><span class="n">ds_era5</span><span class="p">,</span> <span class="n">ds_interpolated</span><span class="p">,</span> <span class="o">*</span><span class="n">model_datasets</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
    <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;trend&quot;</span><span class="p">]</span> <span class="o">*=</span> <span class="mi">10</span>
    <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;trend&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;long_name&quot;</span><span class="p">:</span> <span class="s2">&quot;trend&quot;</span><span class="p">}</span>
    <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">index_timeseries</span><span class="p">:</span>
        <span class="n">ds</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;long_name&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;units&quot;</span><span class="p">:</span> <span class="s2">&quot;¬∞C&quot;</span> <span class="k">if</span> <span class="n">ds</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;K&quot;</span>
                                <span class="k">else</span> <span class="p">(</span><span class="n">ds</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">])}</span>
    
</pre></div>
</div>
</div>
</details>
</div>
</section>
</section>
<section id="plot-and-describe-results">
<span id="climate-projections-cmip6-climate-impact-indicators-q01-section-3"></span><h3>3. Plot and describe results<a class="headerlink" href="#plot-and-describe-results" title="Link to this heading">#</a></h3>
<p>This section will display the following results:</p>
<ul class="simple">
<li><p>Maps representing the spatial distribution of the <strong>historical mean values</strong> (1971-2000) of the indices ‚ÄòHDD15.5‚Äô and ‚ÄòCDD22‚Äô for ERA5, each model individually, the ensemble median (understood as the median of the mean values of the chosen subset of models calculated for each grid cell), and the ensemble spread (derived as the standard deviation of the distribution of the chosen subset of models).</p></li>
<li><p>Maps representing the spatial distribution of the <strong>historical trends</strong> (1971-2000) of the considered indices. Similar to the first analysis, this includes ERA5, each model individually, the ensemble median (understood as the median of the trend values of the chosen subset of models calculated for each grid cell), and the ensemble spread (derived as the standard deviation of the distribution of the chosen subset of models).</p></li>
<li><p><strong>Bias maps of the historical mean values</strong>.</p></li>
<li><p><strong>Trend bias maps</strong>.</p></li>
<li><p><strong>Boxplots</strong> representing statistical distributions (PDF) built on the spatially-averaged historical trends from each considered model, displayed together with ERA5.</p></li>
</ul>
<section id="define-plotting-functions">
<span id="climate-projections-cmip6-climate-impact-indicators-q01-section-3-1"></span><h4>3.1. Define plotting functions<a class="headerlink" href="#define-plotting-functions" title="Link to this heading">#</a></h4>
<p>The functions presented here are used to plot the mean values and trends calculated over the historical period (1971-2000) for each of the indices (‚ÄòHDD15.5‚Äô and ‚ÄòCDD22‚Äô).</p>
<p>For a selected index, three layout types can be displayed, depending on the chosen function:</p>
<ol class="arabic simple">
<li><p>Layout including the reference ERA5 product, the ensemble median, the bias of the ensemble median, and the ensemble spread: <code class="docutils literal notranslate"><span class="pre">plot_ensemble()</span></code> is used.</p></li>
<li><p>Layout including every model (for the trend and mean values): <code class="docutils literal notranslate"><span class="pre">plot_models()</span></code> is employed.</p></li>
<li><p>Layout including the bias of every model (for the trend and mean values): <code class="docutils literal notranslate"><span class="pre">plot_models()</span></code> is used again.</p></li>
</ol>
<p><code class="docutils literal notranslate"><span class="pre">trend==True</span></code> argument allows displaying trend values over the historical period, while <code class="docutils literal notranslate"><span class="pre">trend==False</span></code> will show mean values. When the <code class="docutils literal notranslate"><span class="pre">trend</span></code> argument is set to <code class="docutils literal notranslate"><span class="pre">True</span></code>, regions with no significance are hatched. For individual models and ERA5, a grid point is considered to have a statistically significant trend when the p-value is lower than 0.05 (in such cases, no hatching is shown). However, for determining trend significance for the ensemble median (understood as the median of the trend values of the chosen subset of models calculated for each grid cell), reliance is placed on agreement categories, following the advanced approach proposed in AR6 <a class="reference external" href="https://www.ipcc.ch/report/ar6/wg1/downloads/report/IPCC_AR6_WGI_Atlas.pdf" rel="noreferrer" target="_blank">IPCC</a> on pages 1945-1950. The <code class="docutils literal notranslate"><span class="pre">hatch_p_value_ensemble()</span></code> function is used to distinguish, for each grid point, between three possible cases:</p>
<ol class="arabic simple">
<li><p>If more than 66% of the models are statistically significant (p-value &lt; 0.05) and more than 80% of the models share the same sign, we consider the ensemble median trend to be statistically significant, and there is agreement on the sign. To represent this, no hatching is used.</p></li>
<li><p>If less than 66% of the models are statistically significant, regardless of agreement on the sign of the trend, hatching is applied (indicating that the ensemble median trend is not statistically significant).</p></li>
<li><p>If more than 66% of the models are statistically significant but less than 80% of the models share the same sign, we consider the ensemble median trend to be statistically significant, but there is no agreement on the sign of the trend. This is represented using crosses.</p></li>
</ol>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Define function to plot the caption of the figures (for the ensemble case)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">add_caption_ensemble</span><span class="p">(</span><span class="n">trend</span><span class="p">,</span><span class="n">exp</span><span class="p">,</span><span class="n">index</span><span class="p">):</span>
    <span class="c1">#Add caption to the figure</span>
    <span class="k">match</span> <span class="n">trend</span><span class="p">:</span>
        <span class="k">case</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">caption_text</span><span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Fig </span><span class="si">{</span><span class="n">fig_number</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">long_name</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="si">}</span><span class="s2"> (&#39;</span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s2">&#39;) for &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;the temporal aggreggtion of &#39;</span><span class="si">{</span><span class="n">index_timeseries</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;. Trend for &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;the </span><span class="si">{</span><span class="n">exp</span><span class="si">}</span><span class="s2"> period (</span><span class="si">{</span><span class="n">year_start</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">year_stop</span><span class="si">}</span><span class="s2">). The layout &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;includes data corresponding to: (a) ERA5, (b) the ensemble median &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;(understood as the median of the trend values of the chosen subset of models &quot;</span> 
                <span class="sa">f</span><span class="s2">&quot;calculated for each grid cell), &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;(c) the bias of the ensemble median and (d) the ensemble spread &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;(derived as the standard deviation of the distribution of the chosen &quot;</span> 
                <span class="sa">f</span><span class="s2">&quot;subset of models).&quot;</span>
            <span class="p">)</span>
        <span class="k">case</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">caption_text</span><span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Fig </span><span class="si">{</span><span class="n">fig_number</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">long_name</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="si">}</span><span class="s2"> (&#39;</span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s2">&#39;) for &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;the temporal aggreggtion of &#39;</span><span class="si">{</span><span class="n">index_timeseries</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;. Mean for &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;the </span><span class="si">{</span><span class="n">exp</span><span class="si">}</span><span class="s2"> period (</span><span class="si">{</span><span class="n">year_start</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">year_stop</span><span class="si">}</span><span class="s2">). The layout &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;includes data corresponding to: (a) ERA5, (b) the ensemble median &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;(understood as the median of the mean values of the chosen subset of models &quot;</span> 
                <span class="sa">f</span><span class="s2">&quot;calculated for each grid cell), &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;(c) the bias of the ensemble median and (d) the ensemble spread &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;(derived as the standard deviation of the distribution of the chosen &quot;</span> 
                <span class="sa">f</span><span class="s2">&quot;subset of models).&quot;</span>
            <span class="p">)</span>
            
    <span class="n">wrapped_lines</span> <span class="o">=</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="n">caption_text</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">105</span><span class="p">)</span>
    <span class="c1"># Add each line to the figure</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">wrapped_lines</span><span class="p">):</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.05</span>  <span class="o">-</span> <span class="n">i</span> <span class="o">*</span> <span class="mf">0.03</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="c1">#end captioning</span>


<span class="c1">#Define function to plot the caption of the figures (for the individual models case)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">add_caption_models</span><span class="p">(</span><span class="n">trend</span><span class="p">,</span><span class="n">bias</span><span class="p">,</span><span class="n">exp</span><span class="p">,</span><span class="n">index</span><span class="p">):</span>
    <span class="c1">#Add caption to the figure</span>
    <span class="k">if</span> <span class="n">bias</span><span class="p">:</span> 
        <span class="k">match</span> <span class="n">trend</span><span class="p">:</span>
            <span class="k">case</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">caption_text</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Fig </span><span class="si">{</span><span class="n">fig_number</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">long_name</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="si">}</span><span class="s2"> (&#39;</span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s2">&#39;) for the &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;temporal aggregation of &#39;</span><span class="si">{</span><span class="n">index_timeseries</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;. Trend bias for the &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">exp</span><span class="si">}</span><span class="s2"> period (</span><span class="si">{</span><span class="n">year_start</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">year_stop</span><span class="si">}</span><span class="s2">) of each individual &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">collection_id</span><span class="si">}</span><span class="s2"> model.&quot;</span>
                <span class="p">)</span>
            <span class="k">case</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">caption_text</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Fig </span><span class="si">{</span><span class="n">fig_number</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">long_name</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="si">}</span><span class="s2"> (&#39;</span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s2">&#39;) for the &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;temporal aggreggtion of &#39;</span><span class="si">{</span><span class="n">index_timeseries</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;. Mean bias for the &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">exp</span><span class="si">}</span><span class="s2"> period (</span><span class="si">{</span><span class="n">year_start</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">year_stop</span><span class="si">}</span><span class="s2">) of each individual &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">collection_id</span><span class="si">}</span><span class="s2"> model.&quot;</span>
                <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">match</span> <span class="n">trend</span><span class="p">:</span>
            <span class="k">case</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">caption_text</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Fig </span><span class="si">{</span><span class="n">fig_number</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">long_name</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="si">}</span><span class="s2"> (&#39;</span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s2">&#39;) for the &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;temporal aggreggtion of &#39;</span><span class="si">{</span><span class="n">index_timeseries</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;. Trend for the </span><span class="si">{</span><span class="n">exp</span><span class="si">}</span><span class="s2"> &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;period (</span><span class="si">{</span><span class="n">year_start</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">year_stop</span><span class="si">}</span><span class="s2">) of each individual &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">collection_id</span><span class="si">}</span><span class="s2"> model.&quot;</span>
                <span class="p">)</span> 
            <span class="k">case</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">caption_text</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot; Fig </span><span class="si">{</span><span class="n">fig_number</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">long_name</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="si">}</span><span class="s2"> (&#39;</span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s2">&#39;) for the &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;temporal aggreggtion of &#39;</span><span class="si">{</span><span class="n">index_timeseries</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;. Mean for the </span><span class="si">{</span><span class="n">exp</span><span class="si">}</span><span class="s2"> &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;period (</span><span class="si">{</span><span class="n">year_start</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">year_stop</span><span class="si">}</span><span class="s2">) of each individual &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">collection_id</span><span class="si">}</span><span class="s2"> model.&quot;</span>
                <span class="p">)</span>
    <span class="n">wrapped_lines</span> <span class="o">=</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="n">caption_text</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">120</span><span class="p">)</span>
    <span class="c1"># Add each line to the figure</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">wrapped_lines</span><span class="p">):</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.05</span>  <span class="o">-</span> <span class="n">i</span> <span class="o">*</span> <span class="mf">0.03</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">hatch_p_value</span><span class="p">(</span><span class="n">da</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">default_kwargs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;plot_func&quot;</span><span class="p">:</span> <span class="s2">&quot;contourf&quot;</span><span class="p">,</span>
        <span class="s2">&quot;show_stats&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;cmap&quot;</span><span class="p">:</span> <span class="s2">&quot;none&quot;</span><span class="p">,</span>
        <span class="s2">&quot;add_colorbar&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;levels&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
        <span class="s2">&quot;hatches&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span> <span class="o">*</span> <span class="mi">3</span><span class="p">],</span>
    <span class="p">}</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="n">default_kwargs</span> <span class="o">|</span> <span class="n">kwargs</span>

    <span class="n">title</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_title</span><span class="p">()</span>
    <span class="n">plot_obj</span> <span class="o">=</span> <span class="n">plot</span><span class="o">.</span><span class="n">projected_map</span><span class="p">(</span><span class="n">da</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">plot_obj</span>


<span class="k">def</span><span class="w"> </span><span class="nf">hatch_p_value_ensemble</span><span class="p">(</span><span class="n">trend</span><span class="p">,</span> <span class="n">p_value</span><span class="p">,</span> <span class="n">ax</span><span class="p">):</span>
    <span class="n">n_models</span> <span class="o">=</span> <span class="n">trend</span><span class="o">.</span><span class="n">sizes</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">]</span>
    <span class="n">robust_ratio</span> <span class="o">=</span> <span class="p">(</span><span class="n">p_value</span> <span class="o">&lt;=</span> <span class="mf">0.05</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="n">n_models</span>
    <span class="n">robust_ratio</span> <span class="o">=</span> <span class="n">robust_ratio</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">p_value</span><span class="o">.</span><span class="n">notnull</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">))</span>
    <span class="n">signs</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">([(</span><span class="n">trend</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">),</span> <span class="p">(</span><span class="n">trend</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">)],</span> <span class="s2">&quot;sign&quot;</span><span class="p">)</span>
    <span class="n">sign_ratio</span> <span class="o">=</span> <span class="n">signs</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="s2">&quot;sign&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="n">n_models</span>
    <span class="n">robust_threshold</span> <span class="o">=</span> <span class="mf">0.66</span>
    <span class="n">sign_ratio</span> <span class="o">=</span> <span class="n">sign_ratio</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">robust_ratio</span> <span class="o">&gt;</span> <span class="n">robust_threshold</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">da</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">character</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
        <span class="p">[</span><span class="n">robust_ratio</span><span class="p">,</span> <span class="n">sign_ratio</span><span class="p">],</span> <span class="p">[</span><span class="n">robust_threshold</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">]</span>
    <span class="p">):</span>
        <span class="n">hatch_p_value</span><span class="p">(</span><span class="n">da</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">hatches</span><span class="o">=</span><span class="p">[</span><span class="n">character</span> <span class="o">*</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">])</span>


<span class="k">def</span><span class="w"> </span><span class="nf">set_extent</span><span class="p">(</span><span class="n">da</span><span class="p">,</span> <span class="n">axs</span><span class="p">,</span> <span class="n">area</span><span class="p">):</span>
    <span class="n">extent</span> <span class="o">=</span> <span class="p">[</span><span class="n">area</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">coord</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">extent</span><span class="p">):</span>
        <span class="n">extent</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">2</span> <span class="k">else</span> <span class="o">+</span><span class="mi">1</span>
    <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axs</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_extent</span><span class="p">(</span><span class="n">extent</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">plot_models</span><span class="p">(</span>
    <span class="n">data</span><span class="p">,</span>
    <span class="n">da_for_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">p_values</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">col_wrap</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
    <span class="n">subplot_kw</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;projection&quot;</span><span class="p">:</span> <span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">()},</span>
    <span class="n">figsize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">layout</span><span class="o">=</span><span class="s2">&quot;constrained&quot;</span><span class="p">,</span>
    <span class="n">area</span><span class="o">=</span><span class="n">area</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">da_for_kwargs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">model_dataarrays</span> <span class="o">=</span> <span class="n">data</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">da_for_kwargs</span> <span class="o">=</span> <span class="n">da_for_kwargs</span> <span class="ow">or</span> <span class="n">data</span>
        <span class="n">model_dataarrays</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">p_values</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">model_p_dataarrays</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">p_values</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p_values</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="nb">dict</span><span class="p">(</span><span class="n">p_values</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">))</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">model_p_dataarrays</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Get kwargs</span>
    <span class="n">default_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;robust&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;extend&quot;</span><span class="p">:</span> <span class="s2">&quot;both&quot;</span><span class="p">}</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="n">default_kwargs</span> <span class="o">|</span> <span class="n">kwargs</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">_determine_cmap_params</span><span class="p">(</span><span class="n">da_for_kwargs</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
        <span class="o">*</span><span class="p">(</span><span class="n">col_wrap</span><span class="p">,</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">model_dataarrays</span><span class="p">)</span> <span class="o">/</span> <span class="n">col_wrap</span><span class="p">)),</span>
        <span class="n">subplot_kw</span><span class="o">=</span><span class="n">subplot_kw</span><span class="p">,</span>
        <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span>
        <span class="n">layout</span><span class="o">=</span><span class="n">layout</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">axs</span> <span class="o">=</span> <span class="n">axs</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">da</span><span class="p">),</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">model_dataarrays</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">axs</span><span class="p">):</span>
        <span class="n">pcm</span> <span class="o">=</span> <span class="n">plot</span><span class="o">.</span><span class="n">projected_map</span><span class="p">(</span>
            <span class="n">da</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">show_stats</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">add_colorbar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">model_p_dataarrays</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">hatch_p_value</span><span class="p">(</span><span class="n">model_p_dataarrays</span><span class="p">[</span><span class="n">model</span><span class="p">],</span> <span class="n">ax</span><span class="p">)</span>
    <span class="n">set_extent</span><span class="p">(</span><span class="n">da_for_kwargs</span><span class="p">,</span> <span class="n">axs</span><span class="p">,</span> <span class="n">area</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span>
        <span class="n">pcm</span><span class="p">,</span>
        <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
        <span class="n">extend</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;extend&quot;</span><span class="p">],</span>
        <span class="n">location</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">da_for_kwargs</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;long_name&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">da_for_kwargs</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;units&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">fig</span>


<span class="k">def</span><span class="w"> </span><span class="nf">plot_ensemble</span><span class="p">(</span>
    <span class="n">da_models</span><span class="p">,</span>
    <span class="n">da_era5</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">p_value_era5</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">p_value_models</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">subplot_kw</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;projection&quot;</span><span class="p">:</span> <span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">()},</span>
    <span class="n">figsize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">layout</span><span class="o">=</span><span class="s2">&quot;constrained&quot;</span><span class="p">,</span>
    <span class="n">cbar_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">area</span><span class="o">=</span><span class="n">area</span><span class="p">,</span>
    <span class="n">cmap_bias</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">cmap_std</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">):</span>
    <span class="c1"># Get kwargs</span>
    <span class="n">default_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;robust&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;extend&quot;</span><span class="p">:</span> <span class="s2">&quot;both&quot;</span><span class="p">}</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="n">default_kwargs</span> <span class="o">|</span> <span class="n">kwargs</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">_determine_cmap_params</span><span class="p">(</span>
        <span class="n">da_models</span><span class="o">.</span><span class="n">values</span> <span class="k">if</span> <span class="n">da_era5</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">da_era5</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">da_era5</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">cbar_kwargs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cbar_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;orientation&quot;</span><span class="p">:</span> <span class="s2">&quot;horizontal&quot;</span><span class="p">}</span>

    <span class="c1"># Figure</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
        <span class="o">*</span><span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="n">da_era5</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
        <span class="n">subplot_kw</span><span class="o">=</span><span class="n">subplot_kw</span><span class="p">,</span>
        <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span>
        <span class="n">layout</span><span class="o">=</span><span class="n">layout</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">axs</span> <span class="o">=</span> <span class="n">axs</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">axs_iter</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">axs</span><span class="p">)</span>

    <span class="c1"># ERA5</span>
    <span class="k">if</span> <span class="n">da_era5</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">axs_iter</span><span class="p">)</span>
        <span class="n">plot</span><span class="o">.</span><span class="n">projected_map</span><span class="p">(</span>
            <span class="n">da_era5</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">show_stats</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cbar_kwargs</span><span class="o">=</span><span class="n">cbar_kwargs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">p_value_era5</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">hatch_p_value</span><span class="p">(</span><span class="n">p_value_era5</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;(a) ERA5&quot;</span><span class="p">)</span>

    <span class="c1"># Median</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">axs_iter</span><span class="p">)</span>
    <span class="n">median</span> <span class="o">=</span> <span class="n">da_models</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="n">keep_attrs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">plot</span><span class="o">.</span><span class="n">projected_map</span><span class="p">(</span>
        <span class="n">median</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">show_stats</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cbar_kwargs</span><span class="o">=</span><span class="n">cbar_kwargs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">p_value_models</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">hatch_p_value_ensemble</span><span class="p">(</span><span class="n">trend</span><span class="o">=</span><span class="n">da_models</span><span class="p">,</span> <span class="n">p_value</span><span class="o">=</span><span class="n">p_value_models</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;(b) Ensemble Median&quot;</span> <span class="k">if</span> <span class="n">da_era5</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;(a) Ensemble Median&quot;</span><span class="p">)</span>

    <span class="c1"># Bias</span>
    <span class="k">if</span> <span class="n">da_era5</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">axs_iter</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">xr</span><span class="o">.</span><span class="n">set_options</span><span class="p">(</span><span class="n">keep_attrs</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="n">bias</span> <span class="o">=</span> <span class="n">median</span> <span class="o">-</span> <span class="n">da_era5</span>
        <span class="n">plot</span><span class="o">.</span><span class="n">projected_map</span><span class="p">(</span>
            <span class="n">bias</span><span class="p">,</span>
            <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
            <span class="n">show_stats</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">center</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">cbar_kwargs</span><span class="o">=</span><span class="n">cbar_kwargs</span><span class="p">,</span>
            <span class="o">**</span><span class="p">(</span><span class="n">default_kwargs</span> <span class="o">|</span> <span class="p">{</span><span class="s2">&quot;cmap&quot;</span><span class="p">:</span> <span class="n">cmap_bias</span><span class="p">}),</span>
        <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;(c) Ensemble Median Bias&quot;</span><span class="p">)</span>

    <span class="c1"># Std</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">axs_iter</span><span class="p">)</span>
    <span class="n">std</span> <span class="o">=</span> <span class="n">da_models</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="n">keep_attrs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">plot</span><span class="o">.</span><span class="n">projected_map</span><span class="p">(</span>
        <span class="n">std</span><span class="p">,</span>
        <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
        <span class="n">show_stats</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">cbar_kwargs</span><span class="o">=</span><span class="n">cbar_kwargs</span><span class="p">,</span>
        <span class="o">**</span><span class="p">(</span><span class="n">default_kwargs</span> <span class="o">|</span> <span class="p">{</span><span class="s2">&quot;cmap&quot;</span><span class="p">:</span> <span class="n">cmap_std</span><span class="p">}),</span>
    <span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;(d) Ensemble Standard Deviation&quot;</span> <span class="k">if</span> <span class="n">da_era5</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;(b) Ensemble Standard Deviation&quot;</span><span class="p">)</span>

    <span class="n">set_extent</span><span class="p">(</span><span class="n">da_models</span><span class="p">,</span> <span class="n">axs</span><span class="p">,</span> <span class="n">area</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fig</span>
</pre></div>
</div>
</div>
</details>
</div>
<p><a id='INITIAL NOTE'></a></p>
<div class="alert alert-block alert-warning">  
<b>COLORBAR NOTE</b>:<br> 
The colorbar chosen for representing biases and trends for the HDD15.5 index ranges from red to blue. In this color scheme, negative bias values (red colors) indicate that the Heating Degree Days displayed by the models are lower than those shown by ERA5. Similarly, negative trend values (red colors) indicate a decrease in Heating Degree Days over time. Instead, blueish colors denote more Heating Degree Days, either indicating a positive bias compared to ERA5 or an increase in Heating Degree Days over time. This selection is based on the rationale that more Heating Degree Days are associated with colder conditions, typically represented by blueish colors, while fewer Heating Degree Days imply warmer conditions, depicted by reddish colors.</section>
<section id="plot-ensemble-maps">
<span id="climate-projections-cmip6-climate-impact-indicators-q01-section-3-2"></span><h4>3.2. Plot ensemble maps<a class="headerlink" href="#plot-ensemble-maps" title="Link to this heading">#</a></h4>
<p>In this section, we invoke the <code class="docutils literal notranslate"><span class="pre">plot_ensemble()</span></code> function to visualise the mean values and trends calculated over the historical period (1971-2000) for the model ensemble and ERA5 reference product across Europe. Note that the model data used in this section has previously been interpolated to the ERA5 grid.</p>
<p>Specifically, for each of the indices (‚ÄòHDD15.5‚Äô and ‚ÄòCDD22‚Äô), this section presents two layouts:</p>
<ol class="arabic simple">
<li><p>Mean values of the historical period (1971-2000) for: (a) the reference ERA5 product, (b) the ensemble median (understood as the median of the mean values of the chosen subset of models calculated for each grid cell), (c) the bias of the ensemble median, and (d) the ensemble spread (derived as the standard deviation of the distribution of the chosen subset of models).</p></li>
<li><p>Trend values of the historical period (1971-2000) for: (a) the reference ERA5 product, (b) the ensemble median (understood as the median of the trend values of the chosen subset of models calculated for each grid cell), (c) the bias of the ensemble median, and (d) the ensemble spread (derived as the standard deviation of the distribution of the chosen subset of models).</p></li>
</ol>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Fig number counter</span>
<span class="n">fig_number</span><span class="o">=</span><span class="mi">1</span>

<span class="c1">#Common title</span>
<span class="n">common_title</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Historical period: </span><span class="si">{</span><span class="n">year_start</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">year_stop</span><span class="si">}</span><span class="s2">. Temporal aggregation: &quot;</span>

<span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">index_timeseries</span><span class="p">:</span>
    <span class="c1"># Index</span>
    <span class="n">da</span> <span class="o">=</span> <span class="n">ds_interpolated</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plot_ensemble</span><span class="p">(</span>
        <span class="n">da_models</span><span class="o">=</span><span class="n">da</span><span class="p">,</span>
        <span class="n">da_era5</span><span class="o">=</span><span class="n">ds_era5</span><span class="p">[</span><span class="n">index</span><span class="p">],</span>
        <span class="n">cmap</span><span class="o">=</span><span class="n">cmaps</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">index</span><span class="p">),</span>
        <span class="n">cmap_bias</span><span class="o">=</span><span class="n">cmaps_bias</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">index</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mean of the </span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s2"> daily average (ERA5 vs </span><span class="si">{</span><span class="n">collection_id</span><span class="si">}</span><span class="s2"> ensemble)</span><span class="se">\n</span><span class="s2"> </span><span class="si">{</span><span class="n">common_title</span><span class="si">}{</span><span class="n">index_timeseries</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">add_caption_ensemble</span><span class="p">(</span><span class="n">trend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">exp</span><span class="o">=</span><span class="s2">&quot;historical&quot;</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="n">fig_number</span><span class="o">=</span><span class="n">fig_number</span><span class="o">+</span><span class="mi">1</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Trend</span>
    <span class="n">da_era5_trend</span> <span class="o">=</span> <span class="n">ds_era5</span><span class="p">[</span><span class="s2">&quot;trend&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">)</span>
    <span class="n">da_era5_trend</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">da</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> / decade&quot;</span>
    <span class="n">da_trend</span> <span class="o">=</span> <span class="n">ds_interpolated</span><span class="p">[</span><span class="s2">&quot;trend&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">)</span>
    <span class="n">da_trend</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">da</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> / decade&quot;</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plot_ensemble</span><span class="p">(</span>
        <span class="n">da_models</span><span class="o">=</span><span class="n">da_trend</span><span class="p">,</span>
        <span class="n">da_era5</span><span class="o">=</span><span class="n">da_era5_trend</span><span class="p">,</span>
        <span class="n">p_value_era5</span><span class="o">=</span><span class="n">ds_era5</span><span class="p">[</span><span class="s2">&quot;p&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">),</span>
        <span class="n">p_value_models</span><span class="o">=</span><span class="n">ds_interpolated</span><span class="p">[</span><span class="s2">&quot;p&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">),</span>
        <span class="n">center</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">cmap</span><span class="o">=</span><span class="n">cmaps_trend</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">index</span><span class="p">),</span>
        <span class="n">cmap_bias</span><span class="o">=</span><span class="n">cmaps_bias</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">index</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Trend of the </span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s2"> daily average (ERA5 vs </span><span class="si">{</span><span class="n">collection_id</span><span class="si">}</span><span class="s2"> ensemble)</span><span class="se">\n</span><span class="s2"> </span><span class="si">{</span><span class="n">common_title</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">index_timeseries</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">add_caption_ensemble</span><span class="p">(</span><span class="n">trend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">exp</span><span class="o">=</span><span class="s2">&quot;historical&quot;</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="n">fig_number</span><span class="o">=</span><span class="n">fig_number</span><span class="o">+</span><span class="mi">1</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../../_images/6d1a01a4201ecac0af338cc25c614a46b21f9b7edd5f624602d49124e9992697.png" src="../../_images/6d1a01a4201ecac0af338cc25c614a46b21f9b7edd5f624602d49124e9992697.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<img alt="../../_images/f5ed31cd87813560f3a939e1a1c03a4315a1e42ee83d8127ee5cfb66c0bcfbb7.png" src="../../_images/f5ed31cd87813560f3a939e1a1c03a4315a1e42ee83d8127ee5cfb66c0bcfbb7.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<img alt="../../_images/f45c0f0eb7f60da142faec3626636faf9ee4e750a00689190a83cb8820e5c882.png" src="../../_images/f45c0f0eb7f60da142faec3626636faf9ee4e750a00689190a83cb8820e5c882.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<img alt="../../_images/ea3455720816227b8cc8150703663696ebd9bc793969eeba8236dc8cafddd1b2.png" src="../../_images/ea3455720816227b8cc8150703663696ebd9bc793969eeba8236dc8cafddd1b2.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="plot-model-maps">
<span id="climate-projections-cmip6-climate-impact-indicators-q01-section-3-3"></span><h4>3.3. Plot model maps<a class="headerlink" href="#plot-model-maps" title="Link to this heading">#</a></h4>
<p>In this section, we invoke the <code class="docutils literal notranslate"><span class="pre">plot_models()</span></code> function to visualise the mean values and trends calculated over the historical period (1971-2000) for every model individually across Europe. Note that the model data used in this section maintains its original grid.</p>
<p>Specifically, for each of the indices (‚ÄòHDD15.5‚Äô and ‚ÄòCDD22‚Äô), this section presents two layouts:</p>
<ol class="arabic simple">
<li><p>A layout including the historical mean (1971-2000) of every model.</p></li>
<li><p>A layout including the historical trend (1971-2000) of every model.</p></li>
</ol>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">index_timeseries</span><span class="p">:</span>
    <span class="c1"># Index</span>
    <span class="n">da_for_kwargs</span> <span class="o">=</span> <span class="n">ds_era5</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plot_models</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="n">model</span><span class="p">:</span> <span class="n">ds</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="k">for</span> <span class="n">model</span><span class="p">,</span> <span class="n">ds</span> <span class="ow">in</span> <span class="n">model_datasets</span><span class="o">.</span><span class="n">items</span><span class="p">()},</span>
        <span class="n">da_for_kwargs</span><span class="o">=</span><span class="n">da_for_kwargs</span><span class="p">,</span>
        <span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">9</span><span class="p">,</span><span class="mf">6.5</span><span class="p">],</span>
        <span class="n">cmap</span><span class="o">=</span><span class="n">cmaps</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">index</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mean of the </span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s2"> daily average (</span><span class="si">{</span><span class="n">collection_id</span><span class="si">}</span><span class="s2"> individual models)</span><span class="se">\n</span><span class="s2"> </span><span class="si">{</span><span class="n">common_title</span><span class="si">}{</span><span class="n">index_timeseries</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">add_caption_models</span><span class="p">(</span><span class="n">trend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">exp</span><span class="o">=</span><span class="s2">&quot;historical&quot;</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">fig_number</span><span class="o">=</span><span class="n">fig_number</span><span class="o">+</span><span class="mi">1</span>

    <span class="c1"># Trend</span>
    <span class="n">da_for_kwargs_trends</span> <span class="o">=</span> <span class="n">ds_era5</span><span class="p">[</span><span class="s2">&quot;trend&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">)</span>
    <span class="n">da_for_kwargs_trends</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">da_for_kwargs</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> / decade&quot;</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plot_models</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="p">{</span>
            <span class="n">model</span><span class="p">:</span> <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;trend&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">)</span> <span class="k">for</span> <span class="n">model</span><span class="p">,</span> <span class="n">ds</span> <span class="ow">in</span> <span class="n">model_datasets</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">},</span>
        <span class="n">da_for_kwargs</span><span class="o">=</span><span class="n">da_for_kwargs_trends</span><span class="p">,</span>
        <span class="n">p_values</span><span class="o">=</span><span class="p">{</span>
            <span class="n">model</span><span class="p">:</span> <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;p&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">)</span> <span class="k">for</span> <span class="n">model</span><span class="p">,</span> <span class="n">ds</span> <span class="ow">in</span> <span class="n">model_datasets</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">},</span>
        <span class="n">center</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">9</span><span class="p">,</span><span class="mf">6.5</span><span class="p">],</span>
        <span class="n">cmap</span><span class="o">=</span><span class="n">cmaps_trend</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">index</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Trend of the </span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s2"> daily average (</span><span class="si">{</span><span class="n">collection_id</span><span class="si">}</span><span class="s2"> individual models)</span><span class="se">\n</span><span class="s2"> </span><span class="si">{</span><span class="n">common_title</span><span class="si">}{</span><span class="n">index_timeseries</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">add_caption_models</span><span class="p">(</span><span class="n">trend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">exp</span><span class="o">=</span><span class="s2">&quot;historical&quot;</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">fig_number</span><span class="o">=</span><span class="n">fig_number</span><span class="o">+</span><span class="mi">1</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../../_images/1088ef9b77d3eb73b7a0b24da7adf858e39677863f78c80e55966eb04669e804.png" src="../../_images/1088ef9b77d3eb73b7a0b24da7adf858e39677863f78c80e55966eb04669e804.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<img alt="../../_images/3c960afd90bc8df0003c587075b36f794e18106879a9a638f5d5e434619f7a3c.png" src="../../_images/3c960afd90bc8df0003c587075b36f794e18106879a9a638f5d5e434619f7a3c.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<img alt="../../_images/66f605f996ff7ddb06eb68f575e9b97b2a5891739ffcf5e13e98aec9ebd8ca23.png" src="../../_images/66f605f996ff7ddb06eb68f575e9b97b2a5891739ffcf5e13e98aec9ebd8ca23.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<img alt="../../_images/099a9c753e120404be66221a3d19e06254069ec8d27270ec64aeb4d5de318f96.png" src="../../_images/099a9c753e120404be66221a3d19e06254069ec8d27270ec64aeb4d5de318f96.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="plot-bias-maps">
<span id="climate-projections-cmip6-climate-impact-indicators-q01-section-3-4"></span><h4>3.4. Plot bias maps<a class="headerlink" href="#plot-bias-maps" title="Link to this heading">#</a></h4>
<p>In this section, we invoke the <code class="docutils literal notranslate"><span class="pre">plot_models()</span></code> function to visualise the bias for the mean values and trends calculated over the historical period (1971-2000) for every model individually across Europe. Note that the model data used in this section has previously been interpolated to the ERA5 grid.</p>
<p>Specifically, for each of the indices (‚ÄòHDD15.5‚Äô and ‚ÄòCDD22‚Äô), this section presents two layouts:</p>
<ol class="arabic simple">
<li><p>A layout including the bias for the historical mean (1971-2000) of every model.</p></li>
<li><p>A layout including the bias for the historical trend (1971-2000) of every model.</p></li>
</ol>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">xr</span><span class="o">.</span><span class="n">set_options</span><span class="p">(</span><span class="n">keep_attrs</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">bias</span> <span class="o">=</span> <span class="n">ds_interpolated</span> <span class="o">-</span> <span class="n">ds_era5</span>

<span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">index_timeseries</span><span class="p">:</span>
    <span class="c1"># Index bias</span>
    <span class="n">da</span> <span class="o">=</span> <span class="n">bias</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plot_models</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">da</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmaps_bias</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">index</span><span class="p">),</span><span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">9</span><span class="p">,</span><span class="mf">6.5</span><span class="p">])</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mean bias of the </span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s2"> daily average (</span><span class="si">{</span><span class="n">collection_id</span><span class="si">}</span><span class="s2"> individual models)</span><span class="se">\n</span><span class="s2"> </span><span class="si">{</span><span class="n">common_title</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">add_caption_models</span><span class="p">(</span><span class="n">trend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">bias</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">exp</span><span class="o">=</span><span class="s2">&quot;historical&quot;</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">fig_number</span><span class="o">=</span><span class="n">fig_number</span><span class="o">+</span><span class="mi">1</span>

    <span class="c1"># Trend bias</span>
    <span class="n">da_trend</span> <span class="o">=</span> <span class="n">bias</span><span class="p">[</span><span class="s2">&quot;trend&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">)</span>
    <span class="n">da_trend</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">da</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> / decade&quot;</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plot_models</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">da_trend</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmaps_bias</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">index</span><span class="p">),</span><span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">9</span><span class="p">,</span><span class="mf">6.5</span><span class="p">])</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Trend bias of the </span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s2"> daily average (</span><span class="si">{</span><span class="n">collection_id</span><span class="si">}</span><span class="s2"> individual models)</span><span class="se">\n</span><span class="s2"> </span><span class="si">{</span><span class="n">common_title</span><span class="si">}{</span><span class="n">index_timeseries</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">add_caption_models</span><span class="p">(</span><span class="n">trend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">bias</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">exp</span><span class="o">=</span><span class="s2">&quot;historical&quot;</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">fig_number</span><span class="o">=</span><span class="n">fig_number</span><span class="o">+</span><span class="mi">1</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../../_images/f270222edcce57ea990481c4d250839e90fec944f8ed8d7f6463764b9b682173.png" src="../../_images/f270222edcce57ea990481c4d250839e90fec944f8ed8d7f6463764b9b682173.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<img alt="../../_images/c8f721796df02e4adf9c565304ef1a29b22a52f1126cb691c406f91bdb413459.png" src="../../_images/c8f721796df02e4adf9c565304ef1a29b22a52f1126cb691c406f91bdb413459.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<img alt="../../_images/fc551b891564677bebb4e0afb862dbde56269107b3d2a326c20db9fbd3c87329.png" src="../../_images/fc551b891564677bebb4e0afb862dbde56269107b3d2a326c20db9fbd3c87329.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<img alt="../../_images/ed9cfbd88ead529c8459fea986c0af6661d2b13b592354c8e72846e41cdd8fe9.png" src="../../_images/ed9cfbd88ead529c8459fea986c0af6661d2b13b592354c8e72846e41cdd8fe9.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="boxplots-of-the-historical-trend">
<span id="climate-projections-cmip6-climate-impact-indicators-q01-section-3-5"></span><h4>3.5. Boxplots of the historical trend<a class="headerlink" href="#boxplots-of-the-historical-trend" title="Link to this heading">#</a></h4>
<p>In this last section, we compare the trends of the climate models with the reference trend from ERA5.</p>
<p>Dots represent the spatially-averaged historical trend  over the selected region (change of the number of days per decade) for each model (grey), the ensemble mean (blue), and the reference product (orange). The ensemble median is shown as a green line. Note that the spatially averaged values are calculated for each model from its original grid (i.e., no interpolated data has been used here).</p>
<p>The boxplot visually illustrates the distribution of trends among the climate models, with the box covering the first quartile (Q1 = 25th percentile) to the third quartile (Q3 = 75th percentile), and a green line indicating the ensemble median (Q2 = 50th percentile). Whiskers extend from the edges of the box to show the full data range.</p>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">weights</span> <span class="o">=</span> <span class="n">collection_id</span> <span class="o">==</span> <span class="s2">&quot;CMIP6&quot;</span>
<span class="n">mean_datasets</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">diagnostics</span><span class="o">.</span><span class="n">spatial_weighted_mean</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="p">[</span><span class="n">model</span><span class="p">]),</span> <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">model</span><span class="p">,</span> <span class="n">ds</span> <span class="ow">in</span> <span class="n">model_datasets</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
<span class="p">]</span>
<span class="n">mean_ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">mean_datasets</span><span class="p">,</span> <span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span><span class="s1">&#39;minimal&#39;</span><span class="p">,</span><span class="n">compat</span><span class="o">=</span><span class="s1">&#39;override&#39;</span><span class="p">)</span>
<span class="n">index_str</span><span class="o">=</span><span class="mi">1</span>

<span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">da</span> <span class="ow">in</span> <span class="n">mean_ds</span><span class="p">[</span><span class="s2">&quot;trend&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;index&quot;</span><span class="p">):</span>
    <span class="n">df_slope</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()[[</span><span class="s2">&quot;trend&quot;</span><span class="p">]]</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">df_slope</span><span class="o">.</span><span class="n">boxplot</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
        <span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_slope</span><span class="p">),</span>
        <span class="n">y</span><span class="o">=</span><span class="n">df_slope</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="s2">&quot;grey&quot;</span><span class="p">,</span>
        <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="s2">&quot;models&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Ensemble mean</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="n">da</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">),</span>
            <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">collection_id</span><span class="si">}</span><span class="s2"> Ensemble Mean&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># ERA5</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">collection_id</span><span class="si">}</span><span class="s2"> Ensemble&quot;</span><span class="p">]</span>
    <span class="n">da</span> <span class="o">=</span> <span class="n">ds_era5</span><span class="p">[</span><span class="s2">&quot;trend&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">)</span>
    <span class="n">da</span> <span class="o">=</span> <span class="n">diagnostics</span><span class="o">.</span><span class="n">spatial_weighted_mean</span><span class="p">(</span><span class="n">da</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="n">da</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
            <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;ERA5&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;ERA5&quot;</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">labels</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ds</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> / decade&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="nb">chr</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="s1">&#39;`&#39;</span><span class="p">)</span><span class="o">+</span><span class="n">index_str</span><span class="p">)</span><span class="si">}</span><span class="s2">) Trend of </span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;region: lon [</span><span class="si">{</span><span class="o">-</span><span class="n">area</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">W, </span><span class="si">{</span><span class="n">area</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="si">}</span><span class="s2">E] x lat [</span><span class="si">{</span><span class="n">area</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">N, </span><span class="si">{</span><span class="n">area</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">N] </span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;period: </span><span class="si">{</span><span class="n">year_start</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">year_stop</span><span class="si">}</span><span class="s2">. Temporal aggregation: </span><span class="si">{</span><span class="n">index_timeseries</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span> 
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="n">index_str</span><span class="o">=</span><span class="n">index_str</span><span class="o">+</span><span class="mi">1</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../../_images/48f41ebb9c00c597aae63dd995b6c89488b4e0dfbec5c73731d0d932ffb96d85.png" src="../../_images/48f41ebb9c00c597aae63dd995b6c89488b4e0dfbec5c73731d0d932ffb96d85.png" />
<img alt="../../_images/0dec3bd7d97bbadbe2f3bf1dceb71ede410ea21701fb1125fa1f1696be93f8df.png" src="../../_images/0dec3bd7d97bbadbe2f3bf1dceb71ede410ea21701fb1125fa1f1696be93f8df.png" />
</div>
</div>
<div>
    <div style="max-width: 800px;">
    <p><strong>Fig 13.</strong> Boxplots illustrating the historical trends of the distribution of the chosen subset of models and ERA5 for the Energy Degree Days indices daily averaged: (a) 'CDD22', and (b) 'HDD15.5'. The distribution is created by considering spatially averaged trends across Europe. The ensemble mean and the ensemble median trends are both included. Outliers in the distribution are denoted by a grey circle with a black contour.<p>
</div></section>
<section id="results-summary-and-discussion">
<span id="climate-projections-cmip6-climate-impact-indicators-q01-section-3-6"></span><h4>3.6. Results summary and discussion<a class="headerlink" href="#results-summary-and-discussion" title="Link to this heading">#</a></h4>
<ul class="simple">
<li><p>GCMs struggle to accurately represent the climatology of these indices in regions with complex orography, specially for the mean values of the HDD15.5 index. There is a common overestimation of HDD15.5 mean values for DJF, especially in continental and northern areas. Conversely, underestimation is evident in mountainous regions and in some western zones. For the climatological values of CDD22, there is overestimation for JJA across most of the Mediterranean Basin (except some Saharan regions).</p></li>
<li><p>The ERA5 historical data shows a reduction in Heating Degree Days (HDD) for DJF across most of Europe. However, while the ensemble median of GCMs (calculated for each grid cell) captures the trend behavior for most regions, it does not accurately reflect their magnitude. Indeed, a significant inter-model spread is evident, with differences in trend direction among individual models observed in some regions. This variability is particularly pronounced in the northern and northeastern parts of Europe.</p></li>
<li><p>The ERA5 historical trend shows an increase in Cooling Degree Days during the summer (JJA) across Europe, especially in the Mediterranean Basin. GCMs agree on the direction of the CDD2 trend for summer and replicate the historical trends (1971-2000) of the selected index, although they underestimate its magnitude.</p></li>
<li><p>Boxplots reveal different signs for the spatial-averaged historical trend characterising the distribution of the chosen subset of models for the HDD15.5 and DJF. The CMIP6 ensemble median trend displays a daily average value around -0.15 ¬∞C/10 years, similar to ERA5‚Äôs -0.15 ¬∞C/10 years. The interquantile range of the ensemble ranges from below -0.2 to near -0.05 ¬∞C per decade. When assessing the biases of the trend, it can be seen that the interquantile range of the ensemble for the trend bias goes approximately from -0.1 to 0.1 ¬∞C per decade.</p></li>
<li><p>Boxplots exhibit a consistent positive spatial-averaged historical trend characterising the different models for the CDD22 for JJA. Magnitudes, however, are slightly underestimated when compared to ERA5. The CMIP6 ensemble median displays near 0.08¬∞C/10 years, contrasting with ERA5‚Äôs ~0.11 ¬∞C/10 years. The interquantile range of the ensemble ranges from 0.06 to 0.11 ¬∞C per decade. The interquantile range of the ensemble for the trend bias goes approximately from -0.05 to slightly above 0¬∞C per decade.</p></li>
<li><p>What do the results mean for users? Are the biases relevant?</p>
<ul>
<li><p>Despite the biases and high inter-model spread in some regions, the outcomes of this notebook may offer valuable insights for decisions sensitive to future energy demand. These results, particularly for CDD22 calculated for summer, may increase confidence in using these models to analyse future trends, although their accuracy is not guaranteed. To improve the accuracy of these insights, biases should be considered and corrected <a class="reference external" href="https://doi.org/10.1002/joc.5362" rel="noreferrer" target="_blank">[6]</a><a class="reference external" href="https://doi.org/10.1038/s41467-021-25504-8" rel="noreferrer" target="_blank">[7]</a>.</p></li>
</ul>
</li>
</ul>
<p><a id='RESULTS NOTE'></a></p>
<div class="alert alert-block alert-warning">  
<b>RESULTS NOTE</b>:<br> 
It is important to note that the results presented are specific to the 16 models chosen, and users should aim to assess as wide a range of models as possible before making a sub-selection.</section>
</section>
</section>
<section id="i-if-you-want-to-know-more">
<h2>‚ÑπÔ∏è If you want to know more<a class="headerlink" href="#i-if-you-want-to-know-more" title="Link to this heading">#</a></h2>
<section id="key-resources">
<h3>Key resources<a class="headerlink" href="#key-resources" title="Link to this heading">#</a></h3>
<p>Some key resources and further reading were linked throughout this assessment.</p>
<p>The CDS catalogue entries for the data used were:</p>
<ul class="simple">
<li><p>CMIP6 climate projections (Daily - air temperature): <a class="reference external" href="https://cds.climate.copernicus.eu/datasets/projections-cmip6?tab=overview" rel="noreferrer" target="_blank">https://cds.climate.copernicus.eu/datasets/projections-cmip6?tab=overview</a></p></li>
<li><p>ERA5 hourly data on single levels from 1940 to present (2m temperature): <a class="reference external" href="https://cds.climate.copernicus.eu/datasets/reanalysis-era5-single-levels?tab=overview" rel="noreferrer" target="_blank">https://cds.climate.copernicus.eu/datasets/reanalysis-era5-single-levels?tab=overview</a></p></li>
</ul>
<p>Code libraries used:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/bopen/c3s-eqc-automatic-quality-control/tree/main/c3s_eqc_automatic_quality_control" rel="noreferrer" target="_blank">C3S EQC custom functions</a>, <code class="docutils literal notranslate"><span class="pre">c3s_eqc_automatic_quality_control</span></code>,  prepared by <a class="reference external" href="https://www.bopen.eu/" rel="noreferrer" target="_blank">B-Open</a></p></li>
<li><p><a class="reference external" href="https://icclim.readthedocs.io/en/stable/" rel="noreferrer" target="_blank">icclim</a> Python package</p></li>
</ul>
</section>
<section id="references">
<h3>References<a class="headerlink" href="#references" title="Link to this heading">#</a></h3>
<p><a class="reference external" href="https://doi.org/10.1007/s10113-010-0173-x" rel="noreferrer" target="_blank">[1]</a> Bindi, M., Olesen, J.E. The responses of agriculture in Europe to climate change (2011). Reg Environ Change 11 (Suppl 1), 151‚Äì158. <a class="reference external" href="https://doi.org/10.1007/s10113-010-0173-x" rel="noreferrer" target="_blank">https://doi.org/10.1007/s10113-010-0173-x</a></p>
<p><a class="reference external" href="https://doi.org/10.1016/j.foreco.2009.09.023" rel="noreferrer" target="_blank">[2]</a> Lindner, M., Maroschek, M., Netherer, S., Kremer, A., Barbati, A., Garcia-Gonzalo, J., Seidi, R., Delzon, S., Corona, P., Kolstrom, M., Lexer, M.J., Marchetti, M. (2010). Climate change impacts, adaptive capacity, and vulnerability of European forest ecosystems. For. Ecol. Manage. 259(4): 698‚Äì709. <a class="reference external" href="https://doi.org/10.1016/j.foreco.2009.09.023" rel="noreferrer" target="_blank">https://doi.org/10.1016/j.foreco.2009.09.023</a></p>
<p><a class="reference external" href="https://doi.org/10.1016/j.enbuild.2014.09.052" rel="noreferrer" target="_blank">[3]</a> Santamouris, M., Cartalis, C., Synnefa, A., Kolokotsa, D. (2015). On the impact of urban heat island and global warming on the power demand and electricity consumption of buildings ‚Äì a review. Energy Build. 98: 119‚Äì124. <a class="reference external" href="https://doi.org/10.1016/j.enbuild.2014.09.052" rel="noreferrer" target="_blank">https://doi.org/10.1016/j.enbuild.2014.09.052</a></p>
<p><a class="reference external" href="https://doi.org/10.1007/s10113-013-0499-2" rel="noreferrer" target="_blank">[4]</a> Jacob, D., Petersen, J., Eggert, B. et al. (2014). EURO-CORDEX: new high-resolution climate change projections for European impact research. Reg Environ Change 14, 563‚Äì578. <a class="reference external" href="https://doi.org/10.1007/s10113-013-0499-2" rel="noreferrer" target="_blank">https://doi.org/10.1007/s10113-013-0499-2</a></p>
<p><a class="reference external" href="http://hdl.handle.net/10013/epic.45156.d001" rel="noreferrer" target="_blank">[5]</a> IPCC. 2014. In Climate Change 2014: Synthesis Report. Contribution of Working Groups I, II and III to the Fifth Assessment Report of the Intergovernmental Panel on Climate Change, Core Writing Team, RK Pachauri, LA Meyer (eds). IPCC: Geneva, Switzerland 151 pp.</p>
<p><a class="reference external" href="https://doi.org/10.1002/joc.5362" rel="noreferrer" target="_blank">[6]</a> Spinoni, J., Vogt, J.V., Barbosa, P., Dosio, A., McCormick, N., Bigano, A. and F√ºssel, H.-M. (2018). Changes of heating and cooling degree-days in Europe from 1981 to 2100. Int. J. Climatol, 38: e191-e208. <a class="reference external" href="https://doi.org/10.1002/joc.5362" rel="noreferrer" target="_blank">https://doi.org/10.1002/joc.5362</a></p>
<p><a class="reference external" href="https://doi.org/10.1038/s41467-021-25504-8" rel="noreferrer" target="_blank">[7]</a> Deroubaix, A., Labuhn, I., Camredon, M. et al. (2021). Large uncertainties in trends of energy demand for heating and cooling under climate change. Nat Commun 12, 5197. <a class="reference external" href="https://doi.org/10.1038/s41467-021-25504-8" rel="noreferrer" target="_blank">https://doi.org/10.1038/s41467-021-25504-8</a></p>
<p><a class="reference external" href="https://doi.org/10.1038/s43247-023-00878-3" rel="noreferrer" target="_blank">[8]</a> Scoccimarro, E., Cattaneo, O., Gualdi, S. et al. (2023). Country-level energy demand for cooling has increased over the past two decades. Commun Earth Environ 4, 208. <a class="reference external" href="https://doi.org/10.1038/s43247-023-00878-3" rel="noreferrer" target="_blank">https://doi.org/10.1038/s43247-023-00878-3</a></p>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./Climate_Projections/CMIP6"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="climate_projections-cmip6_climate-and-weather-extremes_q03.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title"><span class="section-number">5.1.3. </span>Uncertainty in projected changes in extreme temperature indices at a 2¬∞C Global Warming Level for the reinsurance sector</p>
      </div>
    </a>
    <a class="right-next"
       href="climate_projections-cmip6_climate-impact-indicators_q02.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title"><span class="section-number">5.1.5. </span>Uncertainty in projected changes of energy consumption in Europe</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#use-case-assessing-possible-impacts-of-climate-change-on-energy-demand-in-europe">üåç Use case: Assessing possible impacts of climate change on energy demand in Europe</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#quality-assessment-question">‚ùì Quality assessment question</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#quality-assessment-statement">üì¢ Quality assessment statement</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#methodology">üìã Methodology</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#analysis-and-results">üìà Analysis and results</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#parameters-requests-and-functions-definition">1. Parameters, requests and functions definition</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#import-packages">1.1. Import packages</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#define-parameters">1.2. Define Parameters</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#define-models">1.3. Define models</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#define-era5-request">1.4. Define ERA5 request</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#define-model-requests">1.5. Define model requests</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#functions-to-cache">1.6. Functions to cache</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#downloading-and-processing">2. Downloading and processing</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#download-and-transform-era5">2.1. Download and transform ERA5</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#download-and-transform-models">2.2. Download and transform models</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#apply-land-sea-mask-change-attributes-and-cut-the-region-to-show">2.3. Apply land-sea mask, change attributes and cut the region to show</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-and-describe-results">3. Plot and describe results</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#define-plotting-functions">3.1. Define plotting functions</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-ensemble-maps">3.2. Plot ensemble maps</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-model-maps">3.3. Plot model maps</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-bias-maps">3.4. Plot bias maps</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#boxplots-of-the-historical-trend">3.5. Boxplots of the historical trend</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#results-summary-and-discussion">3.6. Results summary and discussion</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#i-if-you-want-to-know-more">‚ÑπÔ∏è If you want to know more</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#key-resources">Key resources</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#references">References</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By the Copernicus Climate Change Service (C3S), entrusted to ECMWF (European Centre for Medium-Range Weather Forecasts)
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      ¬© Copyright 2024.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>